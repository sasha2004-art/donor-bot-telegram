==================== –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê ====================

.
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ all_code.txt
‚îú‚îÄ‚îÄ bot
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __init__.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ config_reader.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ db
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __init__.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ admin_requests.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ analytics_requests.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ engine.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ event_requests.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ info_requests.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ merch_requests.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ models.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ qa_management.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ question_requests.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ user_requests.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ filters
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ role.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ handlers
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __init__.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ admin
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __init__.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ analytics.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ event_management.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ info_management.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ mailing.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ merch_management.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ qa_management.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ system.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ user_management.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ common.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ main_admin.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ other.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ student.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ volunteer.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ keyboards
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __init__.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ inline.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ reply.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ middlewares
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __init__.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ block.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ db.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ states
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __init__.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ states.py
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ utils
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ __init__.py
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ analytics_service.py
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ calendar_service.py
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ data_import.py
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ graduation.py
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ qr_service.py
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ scheduler.py
‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ text_messages.py
‚îú‚îÄ‚îÄ cold_tests.md
‚îú‚îÄ‚îÄ collector.py
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ donor_bot_telegram.egg-info
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ PKG-INFO
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ SOURCES.txt
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ dependency_links.txt
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ top_level.txt
‚îú‚îÄ‚îÄ logs
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ pytest-logs.txt
‚îú‚îÄ‚îÄ main.py
‚îú‚îÄ‚îÄ output.log
‚îú‚îÄ‚îÄ populate_db.py
‚îú‚îÄ‚îÄ pyproject.toml
‚îú‚îÄ‚îÄ pytest.ini
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ tests
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __init__.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ conftest.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ test_admin_fsm.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ test_analytics.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ test_calendar_service.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ test_db_requests.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ test_filters.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ test_graduation.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ test_handlers_logic.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ test_keyboards.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ test_mailing_logic.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ test_middlewares.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ test_registration_logic.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ test_scheduler_logic.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ test_security.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ test_survey_logic.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ test_utils.py
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ test_volunteer_fsm.py
‚îú‚îÄ‚îÄ webapp
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ index.html
‚îî‚îÄ‚îÄ —Ñ–∏–Ω–∞–ª—å–Ω–∞ –≤–µ—Ä—Å–∏—è.7z

14 directories, 82 files


==================== –°–û–î–ï–†–ñ–ò–ú–û–ï –§–ê–ô–õ–û–í ====================

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: .env ---

BOT_TOKEN=7404235730:AAHqEYpQpI7c9XY2Qwj-KGhpLr_yl9-s4j0
SUPER_ADMIN_ID=1031233699

NGROK_AUTHTOKEN=1qZfvDIREz2QtiVo9UL6yNY8v0B_5N2XU9ZjX2DoXpPe8tUae

DB_HOST=db
DB_PORT=5432
DB_NAME=donor_bot_db
DB_USER=donor_user
DB_PASS=strong123321
QR_SECRET_KEY=a_very_secret_key_for_hashing_qr_codes_!@#$

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: .env ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: .gitignore ---

__pycache__/ 
*.py[cod] 
*$py.class 
venv/ 
.venv/ 
.env 
.idea/ 
.vscode/ 
*.pyc
db_volume/

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: .gitignore ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: cold_tests.md ---

## –•–æ–ª–æ–¥–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

### –¢–µ—Å—Ç-–∫–µ–π—Å 1: –£—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è —Å –≤—ã–±–æ—Ä–æ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ü–µ–Ω—Ç—Ä–∞ –∫—Ä–æ–≤–∏

**–®–∞–≥–∏:**

1.  –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –∏ –ø–µ—Ä–µ–π—Ç–∏ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å.
2.  –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "–°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ".
3.  –í–≤–µ—Å—Ç–∏ –≤–∞–ª–∏–¥–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.
4.  –í–≤–µ—Å—Ç–∏ –≤–∞–ª–∏–¥–Ω—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è.
5.  –í–≤–µ—Å—Ç–∏ –≤–∞–ª–∏–¥–Ω–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.
6.  –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–µ–æ—Ç–æ—á–∫—É.
7.  –í—ã–±—Ä–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ü–µ–Ω—Ç—Ä –∫—Ä–æ–≤–∏ –∏–∑ —Å–ø–∏—Å–∫–∞.
8.  –í—ã–±—Ä–∞—Ç—å —Ç–∏–ø –¥–æ–Ω–∞—Ü–∏–∏.
9.  –í–≤–µ—Å—Ç–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–ª–æ–≤.
10. –í–≤–µ—Å—Ç–∏ –ª–∏–º–∏—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.
11. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

*   –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ.
*   –í —Å–æ–æ–±—â–µ–Ω–∏–∏ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –æ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞ –∫—Ä–æ–≤–∏.
*   –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –≤ —Ç–∞–±–ª–∏—Ü–µ `events`, –¥–ª—è —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –≤ –ø–æ–ª–µ `blood_center_id` —Å–æ—Ö—Ä–∞–Ω–µ–Ω `id` –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞ –∫—Ä–æ–≤–∏.

### –¢–µ—Å—Ç-–∫–µ–π—Å 2: –£—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞ –∫—Ä–æ–≤–∏

**–®–∞–≥–∏:**

1.  –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –∏ –ø–µ—Ä–µ–π—Ç–∏ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å.
2.  –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "–°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ".
3.  ... (—à–∞–≥–∏ 3-6 –∫–∞–∫ –≤ –¢–µ—Å—Ç-–∫–µ–π—Å–µ 1)
4.  –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π".
5.  –í–≤–µ—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞ –∫—Ä–æ–≤–∏.
6.  ... (—à–∞–≥–∏ 8-11 –∫–∞–∫ –≤ –¢–µ—Å—Ç-–∫–µ–π—Å–µ 1)

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

*   –ù–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä –∫—Ä–æ–≤–∏ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü—É `blood_centers`.
*   –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ.
*   –í —Å–æ–æ–±—â–µ–Ω–∏–∏ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –æ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞ –∫—Ä–æ–≤–∏.
*   –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –≤ —Ç–∞–±–ª–∏—Ü–µ `events`, –¥–ª—è —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –≤ –ø–æ–ª–µ `blood_center_id` —Å–æ—Ö—Ä–∞–Ω–µ–Ω `id` –Ω–æ–≤–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞ –∫—Ä–æ–≤–∏.

### –¢–µ—Å—Ç-–∫–µ–π—Å 3: –ü—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏

**–®–∞–≥–∏:**

1.  –°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ü–µ–Ω—Ç—Ä–∞ –∫—Ä–æ–≤–∏ (–∫–∞–∫ –≤ –¢–µ—Å—Ç-–∫–µ–π—Å–µ 1 –∏–ª–∏ 2).
2.  –ü–µ—Ä–µ–π—Ç–∏ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –≤ —Ä–∞–∑–¥–µ–ª "–ü—Ä–æ—Å–º–æ—Ç—Ä –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π".
3.  –í—ã–±—Ä–∞—Ç—å —Å–æ–∑–¥–∞–Ω–Ω–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ.

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

*   –í –∫–∞—Ä—Ç–æ—á–∫–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –¥–æ–ª–∂–Ω–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ü–µ–Ω—Ç—Ä–µ –∫—Ä–æ–≤–∏.

### –¢–µ—Å—Ç-–∫–µ–π—Å 4: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–∞ –∫—Ä–æ–≤–∏ —É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è

**–®–∞–≥–∏:**

1.  –°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ü–µ–Ω—Ç—Ä–∞ –∫—Ä–æ–≤–∏.
2.  –ü–µ—Ä–µ–π—Ç–∏ –≤ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.
3.  –í—ã–±—Ä–∞—Ç—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª–µ "–¶–µ–Ω—Ç—Ä –∫—Ä–æ–≤–∏".
4.  –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π —Ü–µ–Ω—Ç—Ä –∫—Ä–æ–≤–∏ –∏–∑ —Å–ø–∏—Å–∫–∞.
5.  –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

*   –¶–µ–Ω—Ç—Ä –∫—Ä–æ–≤–∏ —É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω.
*   –í –∫–∞—Ä—Ç–æ—á–∫–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä –∫—Ä–æ–≤–∏.

### –¢–µ—Å—Ç-–∫–µ–π—Å 5: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–∞ –∫—Ä–æ–≤–∏ —É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ

**–®–∞–≥–∏:**

1.  –°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ü–µ–Ω—Ç—Ä–∞ –∫—Ä–æ–≤–∏.
2.  –ü–µ—Ä–µ–π—Ç–∏ –≤ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.
3.  –í—ã–±—Ä–∞—Ç—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª–µ "–¶–µ–Ω—Ç—Ä –∫—Ä–æ–≤–∏".
4.  –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π".
5.  –í–≤–µ—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞ –∫—Ä–æ–≤–∏.
6.  –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

*   –ù–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä –∫—Ä–æ–≤–∏ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü—É `blood_centers`.
*   –¶–µ–Ω—Ç—Ä –∫—Ä–æ–≤–∏ —É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ –Ω–æ–≤—ã–π.
*   –í –∫–∞—Ä—Ç–æ—á–∫–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä –∫—Ä–æ–≤–∏.


--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: cold_tests.md ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: docker-compose.yml ---

version: '3.8'

services:
  db:
    image: postgres:15-alpine
    container_name: donor_db_container
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASS}
    volumes:
      - db_volume:/var/lib/postgresql/data
    ports:
      - "5432:5432" 
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5

  bot:
    build: .
    container_name: donor_bot_container
    env_file: .env
    depends_on:
      - db
    restart: always
    volumes:
      - .:/app
    expose:
      - "8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"] 
      interval: 1m
      timeout: 10s
      retries: 3

  ngrok:
    image: ngrok/ngrok:latest
    container_name: donor_ngrok_container
    restart: always
    depends_on:
      - bot 
    environment:
      NGROK_AUTHTOKEN: ${NGROK_AUTHTOKEN}
    command: http bot:8000 --log=stdout
    ports:
      - "4040:4040"
  redis:
    image: redis:7-alpine
    container_name: donor_redis_container
    restart: always
    volumes:
      - redis_volume:/data

volumes:
  db_volume:
  redis_volume:

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: docker-compose.yml ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: Dockerfile ---

FROM python:3.11-slim
RUN apt-get update && apt-get install -y libzbar0 && rm -rf /var/lib/apt/lists/*
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
CMD ["python", "main.py"]

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: Dockerfile ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: main.py ---

import asyncio
import logging
import uvicorn
from contextlib import asynccontextmanager
from fastapi import FastAPI, Request, HTTPException
from fastapi.staticfiles import StaticFiles
from pydantic import BaseModel, ValidationError
import json
import hmac
import hashlib
from urllib.parse import unquote, parse_qs
import datetime
import aiohttp
import time

import redis.asyncio as redis
from aiogram import Bot, Dispatcher, types
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.client.default import DefaultBotProperties
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.fsm.storage.redis import RedisStorage
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func

from bot.middlewares.block import BlockUserMiddleware
from bot.middlewares.db import DbSessionMiddleware
from bot.config_reader import config
from bot.db.engine import create_db_and_tables, async_session_maker
from bot.db import admin_requests, user_requests, event_requests
from bot.db.models import Survey, UserBlock, InfoText   
from bot.utils.scheduler import setup_scheduler
from bot.handlers import common, student, volunteer, other
from bot.handlers.admin import admin_router
from bot.handlers.student import feedback_router
from bot.utils.text_messages import Text




logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(levelname)s - %(name)s - %(message)s")
logger = logging.getLogger(__name__)


redis_client = redis.Redis(host='redis', port=6379, db=0) # host='redis' - –∏–º—è —Å–µ—Ä–≤–∏—Å–∞ –∏–∑ docker-compose
storage = RedisStorage(redis=redis_client)
bot = Bot(token=config.bot_token.get_secret_value(), default=DefaultBotProperties(parse_mode="HTML"))
dp = Dispatcher(storage=storage)



class SurveyAnswers(BaseModel):
    feeling: str
    weight: str
    symptoms: str
    tattoo: str
    tooth: str
    vaccine: str
    vaccine_type: str | None = None
    antibiotics: str
    aspirin: str
    contact_hepatitis: str
    diseases_absolute: str
    diseases_chronic: str
    travel: str
    alcohol: str

class SurveyPayload(BaseModel):
    survey_data: SurveyAnswers
    auth_string: str

def validate_telegram_data(auth_data: str) -> dict:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç—Ä–æ–∫—É initData, –ø–æ–ª—É—á–µ–Ω–Ω—É—é –æ—Ç Telegram Web App.
    """
    bot_token = config.bot_token.get_secret_value()
    if not auth_data:
        raise HTTPException(status_code=403, detail="auth_data is empty.")
    try:
        parsed_data = parse_qs(auth_data)
        received_hash = parsed_data.pop('hash', [None])[0]
        if not received_hash:
            raise ValueError("Hash not found in auth data")
        data_check_string = "\n".join(
            f"{key}={value[0]}" for key, value in sorted(parsed_data.items())
        )
        secret_key = hmac.new("WebAppData".encode(), bot_token.encode(), hashlib.sha256).digest()
        calculated_hash = hmac.new(secret_key, data_check_string.encode(), hashlib.sha256).hexdigest()
        if calculated_hash != received_hash:
            raise ValueError("Invalid hash")
        user_data_str = parsed_data.get('user', [None])[0]
        if not user_data_str:
            raise ValueError("User data not found")
        return json.loads(user_data_str)
    except Exception as e:
        logger.error(f"Telegram WebApp data validation failed: {e}. Raw auth_data: '{auth_data}'")
        raise HTTPException(status_code=403, detail=str(e))

async def process_survey_rules(answers: SurveyAnswers) -> tuple[str, int | None, str]:
    if answers.diseases_absolute == 'yes' or answers.diseases_chronic == 'yes':
        return ('temp_waiver', 365000, "–ê–±—Å–æ–ª—é—Ç–Ω–æ–µ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏–µ (—Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ/–∏–Ω—Ñ–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è).")
    if answers.feeling == 'bad':
        return ('temp_waiver', 3, "–ü–ª–æ—Ö–æ–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ.")
    if answers.symptoms == 'yes':
        return ('temp_waiver', 14, "–°–∏–º–ø—Ç–æ–º—ã –û–†–í–ò (–≤–∫–ª—é—á–∞—è –Ω–∞—Å–º–æ—Ä–∫, –∫–∞—à–µ–ª—å).")
    if answers.weight == 'yes':
        return ('temp_waiver', 365000, "–í–µ—Å –º–µ–Ω–µ–µ 50 –∫–≥.")
    if answers.tattoo == 'yes':
        return ('temp_waiver', 120, "–ù–∞–ª–∏—á–∏–µ —Å–≤–µ–∂–µ–π —Ç–∞—Ç—É–∏—Ä–æ–≤–∫–∏/–ø–∏—Ä—Å–∏–Ω–≥–∞.")
    if answers.tooth == 'yes':
        return ('temp_waiver', 10, "–ù–µ–¥–∞–≤–Ω–µ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∑—É–±–∞.")
    if answers.vaccine == 'yes':
        days = 30 if answers.vaccine_type == 'live' else 10
        return ('temp_waiver', days, "–ù–µ–¥–∞–≤–Ω—è—è –≤–∞–∫—Ü–∏–Ω–∞—Ü–∏—è.")
    if answers.antibiotics == 'yes':
        return ('temp_waiver', 14, "–ü—Ä–∏–µ–º –∞–Ω—Ç–∏–±–∏–æ—Ç–∏–∫–æ–≤.")
    if answers.aspirin == 'yes':
        return ('temp_waiver', 5, "–ü—Ä–∏–µ–º –∞–Ω–∞–ª—å–≥–µ—Ç–∏–∫–æ–≤/–∞—Å–ø–∏—Ä–∏–Ω–∞.")
    if answers.contact_hepatitis == 'yes':
        return ('temp_waiver', 90, "–ö–æ–Ω—Ç–∞–∫—Ç —Å –±–æ–ª—å–Ω—ã–º –≥–µ–ø–∞—Ç–∏—Ç–æ–º A.")
    if answers.travel == 'yes':
        return ('temp_waiver', 30, "–î–ª–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–µ–±—ã–≤–∞–Ω–∏–µ –≤ —ç–Ω–¥–µ–º–∏—á–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∞—Ö.")
    if answers.alcohol == 'yes':
        return ('temp_waiver', 2, "–£–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –∞–ª–∫–æ–≥–æ–ª—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 48 —á–∞—Å–æ–≤.")
    return ('ok', 0, "–ü—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏–π –Ω–µ –≤—ã—è–≤–ª–µ–Ω–æ.")

async def get_ngrok_url():
    for _ in range(10):
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get("http://ngrok:4040/api/tunnels") as response:
                    if response.status == 200:
                        data = await response.json()
                        for tunnel in data['tunnels']:
                            if tunnel['proto'] == 'https':
                                return tunnel['public_url']
        except aiohttp.ClientConnectorError:
            logger.warning("Ngrok is not ready yet, retrying in 3 seconds...")
        await asyncio.sleep(3)
    return None

async def initial_admin_and_texts_setup(): 
    logger.info("Checking for initial admin and texts setup...")
    async with async_session_maker() as session:
        users_exist = await admin_requests.check_if_users_exist(session)
        if not users_exist:
            super_admin_id = config.super_admin_id
            logger.warning(f"Users table is empty. Creating main admin with ID: {super_admin_id}")
            try:
                await admin_requests.create_main_admin(session=session, tg_id=super_admin_id, tg_username="main_admin", full_name="–ì–ª–∞–≤–Ω—ã–π –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä")
                await session.commit()
                logger.info(f"Main admin user created successfully for TG ID {super_admin_id}.")
            except Exception as e:
                logger.error(f"Failed to create main admin: {e}", exc_info=True)
        else:
            logger.info("Users table is not empty. Skipping admin creation.")
        
        info_texts_in_db = (await session.execute(select(func.count(InfoText.section_key)))).scalar()
        if info_texts_in_db == 0:
            logger.warning("InfoTexts table is empty. Populating from Text class.")
            texts_to_add = [
                InfoText(section_key="prepare", section_title="–ö–∞–∫ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è?", section_text=Text.INFO_PREPARE),
                InfoText(section_key="contraindications", section_title="–ü—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è", section_text=Text.INFO_CONTRAINDICATIONS),
                InfoText(section_key="after", section_title="–ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø–æ—Å–ª–µ?", section_text=Text.INFO_AFTER),
                InfoText(section_key="dkm", section_title="–û –¥–æ–Ω–æ—Ä—Å—Ç–≤–µ –∫–æ—Å—Ç–Ω–æ–≥–æ –º–æ–∑–≥–∞ (–î–ö–ú)", section_text=Text.INFO_DKM),
                InfoText(section_key="mifi_process", section_title="–û –¥–æ–Ω–∞—Ü–∏—è—Ö –≤ –ú–ò–§–ò", section_text=Text.INFO_MIFI_PROCESS),
                InfoText(section_key="contacts", section_title="–°–≤—è–∑–∞—Ç—å—Å—è —Å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞–º–∏", section_text=Text.INFO_CONTACTS)
            ]
            session.add_all(texts_to_add)
            await session.commit()
            logger.info("InfoTexts table populated successfully.")
        else:
            logger.info("InfoTexts table already populated. Skipping.")
            
def setup_aiogram_routers():
    dp.update.middleware(DbSessionMiddleware(session_pool=async_session_maker)) 
    dp.update.middleware(BlockUserMiddleware())
    dp.include_router(common.router)
    dp.include_router(student.router)
    dp.include_router(feedback_router)
    dp.include_router(volunteer.router)
    dp.include_router(admin_router)
    dp.include_router(other.router)

async def submit_survey_logic(session: AsyncSession, payload: SurveyPayload) -> tuple[int, str, types.InlineKeyboardMarkup | None]:
    """
    –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–ø—Ä–æ—Å–Ω–∏–∫–∞.
    –¢–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.
    """
    logger.info("submit_survey_logic: Starting survey processing.")
    try:
        user_data = validate_telegram_data(payload.auth_string)
        user_tg_id = user_data['id']
        user_username = user_data.get('username')
        logger.info(f"submit_survey_logic: Validation successful for user_tg_id: {user_tg_id}, username: {user_username}")
    except HTTPException as e:
        logger.error(f"Survey validation failed: {e.detail}")
        raise

    answers = payload.survey_data
    status, days, reason = await process_survey_rules(answers)
    logger.info(f"submit_survey_logic: Survey rules processed. Status: {status}, Reason: {reason}")
    
    user = await user_requests.get_user_by_tg_id(session, user_tg_id)
    if not user and user_username:
        logger.warning(f"User with tg_id {user_tg_id} not found. Trying to find by username '{user_username}'.")
        found_users = await admin_requests.find_user_for_admin(session, user_username)
        if found_users:
            user = found_users[0]
            logger.info(f"Found user by username: '{user.full_name}'. Updating their tg_id from {user.telegram_id} to {user_tg_id}.")
            user.telegram_id = user_tg_id
            session.add(user)

    if not user:
        logger.error(f"submit_survey_logic: User with tg_id {user_tg_id} or username {user_username} not found in DB.")
        raise HTTPException(status_code=404, detail="User not found in DB")

    logger.info(f"submit_survey_logic: Found user '{user.full_name}' (ID: {user.id}) in DB.")
    survey_record = Survey(user_id=user.id, passed=(status == 'ok'), answers_json=answers.model_dump(), verdict_text=reason)
    session.add(survey_record)

    chat_id_to_send = user_tg_id 
    message_text = ""
    reply_markup = None

    if status == 'ok':
        logger.info(f"submit_survey_logic: Status is OK. Preparing 'success' message.")
        events = await event_requests.get_active_events_for_user(session, user.id)
        message_text = "‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–≤–µ—Ç—ã! –ü—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.\n\n"
        if not events:
            message_text += "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –¥–ª—è –∑–∞–ø–∏—Å–∏ —Å–µ–π—á–∞—Å –Ω–µ—Ç."
        else:
            message_text += "–í–æ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π:"
            builder = InlineKeyboardBuilder() 
            for event in events:
                builder.row(types.InlineKeyboardButton(
                    text=f"{event.event_datetime.strftime('%d.%m.%Y')} - {event.name}",
                    callback_data=f"reg_event_{event.id}"
                ))
            reply_markup = builder.as_markup()
            
    elif status == 'temp_waiver':
        logger.info(f"submit_survey_logic: Status is TEMP_WAIVER. Creating waiver for {days} days.")
        end_date = datetime.date.today() + datetime.timedelta(days=days)
        await admin_requests.create_manual_waiver(session, user.id, end_date, reason, admin_id=0)
        message_text = f"–°–ø–∞—Å–∏–±–æ –∑–∞ —á–µ—Å—Ç–Ω–æ—Å—Ç—å. –£ –≤–∞—Å –≤—ã—è–≤–ª–µ–Ω–æ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏–µ: <b>{reason}</b>\n\n–ú—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –≤–∞–º –º–µ–¥–æ—Ç–≤–æ–¥ –¥–æ <b>{end_date.strftime('%d.%m.%Y')}</b>. –ï—Å–ª–∏ –≤—ã —Å—á–∏—Ç–∞–µ—Ç–µ, —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞–º–∏."
    
    return chat_id_to_send, message_text, reply_markup

async def submit_survey_endpoint(request: Request):
    """
    API —ç–Ω–¥–ø–æ–∏–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç –ª–æ–≥–∏–∫—É –∏ –∑–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ.
    """
    try:
        body = await request.json()
        payload = SurveyPayload.model_validate(body)
    except Exception as e:
        logger.error(f"Error processing survey submission: {e}")
        raise HTTPException(status_code=400, detail="Invalid payload")

    chat_id, text, markup = None, None, None
    async with async_session_maker() as session:
        chat_id, text, markup = await submit_survey_logic(session, payload)
        await session.commit()
    
    if chat_id and text:
        try:
            logger.info(f"Endpoint: Attempting to send message to chat_id: {chat_id}")
            await bot.send_message(chat_id, text, reply_markup=markup, parse_mode="HTML")
            logger.info(f"Endpoint: Successfully sent message to chat_id: {chat_id}")
        except Exception as e:
            logger.error(f"Endpoint: FAILED to send message to chat_id {chat_id}. Error: {e}", exc_info=True)
    else:
        logger.warning("Endpoint: No chat_id or text returned from logic, nothing to send.")
            
    return {"ok": True}

app = FastAPI()
app.mount("/webapp", StaticFiles(directory="webapp"), name="webapp")

@app.get("/health")
async def health_check():
    return {"status": "ok"}

@asynccontextmanager
async def lifespan(app: FastAPI):
    logger.info("Starting up...")
    app.state.ngrok_url = await get_ngrok_url()

    if app.state.ngrok_url:
        logger.info(f"Successfully fetched ngrok URL: {app.state.ngrok_url}")
        dp["ngrok_url"] = app.state.ngrok_url
    else:
        logger.error("Could not get ngrok URL after several attempts. WebApp will not work.")
        dp["ngrok_url"] = None
    
    await create_db_and_tables()
    await initial_admin_and_texts_setup()
    scheduler = setup_scheduler(bot, async_session_maker, storage)
    scheduler.start()
    asyncio.create_task(dp.start_polling(bot, dp=dp))
    yield
    logger.info("Shutting down...")
    scheduler.shutdown()
    await dp.storage.close()
    await bot.session.close()

app.router.lifespan_context = lifespan
app.add_api_route("/api/submit_survey", submit_survey_endpoint, methods=["POST"])

if __name__ == "__main__":
    setup_aiogram_routers()
    uvicorn.run(app, host="0.0.0.0", port=8000)

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: main.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: populate_db.py ---

import asyncio
import datetime
import random
import logging
from faker import Faker
from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker, AsyncSession
from sqlalchemy import delete, select

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ë–î
import os
from dotenv import load_dotenv

load_dotenv()

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥–µ–ª–∏ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
try:
    # –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –ò–ú–ü–û–†–¢–û–í
    from bot.db.models import (
        Base, User, Event, EventRegistration, Donation, MedicalWaiver,
        UserBlock, MerchItem, MerchOrder, Survey, Feedback
    )
    from bot.config_reader import config
except ImportError as e:
    print(f"–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: {e}")
    print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç 'populate_db.py' –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–µ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞.")
    exit()

# –ü–ï–†–ï–û–ü–†–ï–î–ï–õ–Ø–ï–ú –•–û–°–¢ –ë–î –°–ü–ï–¶–ò–ê–õ–¨–ù–û –î–õ–Ø –≠–¢–û–ì–û –°–ö–†–ò–ü–¢–ê
config.db_host = "localhost"


# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s")
logger = logging.getLogger(__name__)

# --- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö ---
USER_COUNT = 1000
VOLUNTEER_COUNT = 5
ADMIN_COUNT = 1
PAST_EVENTS_COUNT = 5
FUTURE_EVENTS_COUNT = 3
REGISTRATION_CHANCE = 0.4
DONATION_CHANCE = 0.7
MANUAL_WAIVER_CHANCE = 0.05

# –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä Faker –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
faker = Faker('ru_RU')

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –≤–∞—à–µ–º—É engine.py) ---
engine = create_async_engine(
    url=config.database_url,
    echo=False
)
async_session_maker = async_sessionmaker(engine, class_=AsyncSession, expire_on_commit=False)

# --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ---
UNIVERSITIES = ["–ù–ò–Ø–£ –ú–ò–§–ò"] * 8 + ["–î—Ä—É–≥–æ–π –í–£–ó"] * 2
FACULTIES_MIFI = ["–ò–ò–ö–°", "–§–ò–ë–°", "–ò–§–¢–≠–ë", "–ò–§–ò–ë", "–∞", "–ò–Ω–Ø–∑", "–ò–ü–¢–ò–°"]
GENDERS = ["male", "female"]
DONATION_TYPES = ['whole_blood', 'plasma', 'platelets']

async def clear_database(session: AsyncSession):
    """–û—á–∏—â–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ –≤–Ω–µ—à–Ω–∏—Ö –∫–ª—é—á–µ–π."""
    logger.info("–û—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
    # –§–ò–ù–ê–õ–¨–ù–´–ô –ü–û–†–Ø–î–û–ö –û–ß–ò–°–¢–ö–ò
    tables_to_clear = [
        Survey, Feedback, Donation, EventRegistration, MedicalWaiver, UserBlock, MerchOrder,
        Event, MerchItem, User
    ]
    for table in tables_to_clear:
        stmt = delete(table)
        await session.execute(stmt)
    await session.commit()
    logger.info("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—á–∏—â–µ–Ω–∞.")


async def create_users(session: AsyncSession) -> list[User]:
    """–°–æ–∑–¥–∞–µ—Ç –ø–∞—á–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –≤–∫–ª—é—á–∞—è –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–≤ –∏ –∞–¥–º–∏–Ω–æ–≤."""
    logger.info(f"–°–æ–∑–¥–∞–Ω–∏–µ {USER_COUNT} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...")
    users_to_create = []

    for i in range(USER_COUNT):
        role = 'student'
        if i < ADMIN_COUNT:
            role = 'admin'
        elif i < ADMIN_COUNT + VOLUNTEER_COUNT:
            role = 'volunteer'

        university = random.choice(UNIVERSITIES)
        faculty = random.choice(FACULTIES_MIFI) if university == "–ù–ò–Ø–£ –ú–ò–§–ò" else "–ù–µ —É–∫–∞–∑–∞–Ω"
        gender = random.choice(GENDERS)

        user = User(
            phone_number=f"+79{random.randint(100000000, 999999999)}",
            telegram_id=1000000000 + i,
            telegram_username=faker.user_name(),
            full_name=faker.name_male() if gender == 'male' else faker.name_female(),
            university=university,
            faculty=faculty,
            study_group=f"{random.choice(['–ë', '–ú', '–°'])}{random.randint(20, 23)}-{random.randint(101, 515)}",
            gender=gender,
            points=random.randint(0, 500),
            role=role,
            is_blocked=False,
            created_at=faker.date_time_between(start_date='-2y', end_date='now')
        )
        users_to_create.append(user)

    session.add_all(users_to_create)
    await session.commit()
    logger.info("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã.")
    
    result = await session.execute(select(User))
    return result.scalars().all()


async def create_events(session: AsyncSession) -> tuple[list[Event], list[Event]]:
    """–°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ—à–µ–¥—à–∏–µ –∏ –±—É–¥—É—â–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è."""
    logger.info(f"–°–æ–∑–¥–∞–Ω–∏–µ {PAST_EVENTS_COUNT} –ø—Ä–æ—à–µ–¥—à–∏—Ö –∏ {FUTURE_EVENTS_COUNT} –±—É–¥—É—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π...")
    past_events = []
    future_events = []
    today = datetime.datetime.now()

    for i in range(PAST_EVENTS_COUNT):
        event_date = today - datetime.timedelta(days=random.randint(15, 365))
        event = Event(
            name=f"–ü—Ä–æ—à–µ–¥—à–∞—è –∞–∫—Ü–∏—è ‚Ññ{i+1}",
            event_datetime=event_date,
            location="–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –©—É–∫–∏–Ω—Å–∫–∞—è, –¥. 6, –∫–æ—Ä–ø. 2",
            latitude=55.807920,
            longitude=37.491633,
            donation_type=random.choice(DONATION_TYPES),
            points_per_donation=random.randint(100, 250),
            participant_limit=random.randint(50, 100),
            is_active=False,
            registration_is_open=False
        )
        past_events.append(event)

    for i in range(FUTURE_EVENTS_COUNT):
        event_date = today + datetime.timedelta(days=random.randint(10, 60))
        event = Event(
            name=f"–ë—É–¥—É—â–∞—è –∞–∫—Ü–∏—è ‚Ññ{i+1}",
            event_datetime=event_date,
            location="–≥. –ú–æ—Å–∫–≤–∞, –ö–∞—à–∏—Ä—Å–∫–æ–µ —à–æ—Å—Å–µ, 31",
            latitude=55.649917,
            longitude=37.662128,
            donation_type=random.choice(DONATION_TYPES),
            points_per_donation=random.randint(100, 250),
            participant_limit=random.randint(60, 120),
            is_active=True,
            registration_is_open=True
        )
        future_events.append(event)

    session.add_all(past_events + future_events)
    await session.commit()
    logger.info("–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã.")
    return past_events, future_events


async def create_registrations_and_donations(session: AsyncSession, users: list[User], events: list[Event]):
    """–°–æ–∑–¥–∞–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –∞ –¥–ª—è –ø—Ä–æ—à–µ–¥—à–∏—Ö - –¥–æ–Ω–∞—Ü–∏–∏ –∏ –º–µ–¥–æ—Ç–≤–æ–¥—ã."""
    logger.info("–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π, –¥–æ–Ω–∞—Ü–∏–π –∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–µ–¥–æ—Ç–≤–æ–¥–æ–≤...")
    regs_to_create = []
    donations_to_create = []
    waivers_to_create = []
    user_updates = {}

    for event in events:
        for user in users:
            if random.random() < REGISTRATION_CHANCE:
                regs_to_create.append(EventRegistration(user_id=user.id, event_id=event.id))
                if not event.is_active and random.random() < DONATION_CHANCE:
                    donation_date = event.event_datetime.date()
                    points_awarded = event.points_per_donation
                    donations_to_create.append(Donation(
                        user_id=user.id,
                        event_id=event.id,
                        donation_date=donation_date,
                        donation_type=event.donation_type,
                        points_awarded=points_awarded
                    ))
                    user_updates[user.id] = user_updates.get(user.id, 0) + points_awarded
                    days_waiver = (90 if user.gender == 'female' else 60) if event.donation_type == 'whole_blood' else 14
                    end_date = donation_date + datetime.timedelta(days=days_waiver)
                    waivers_to_create.append(MedicalWaiver(
                        user_id=user.id,
                        start_date=donation_date,
                        end_date=end_date,
                        reason=f"–°–¥–∞—á–∞ ¬´{event.donation_type}¬ª",
                        created_by='system'
                    ))

    session.add_all(regs_to_create)
    session.add_all(donations_to_create)
    session.add_all(waivers_to_create)
    await session.commit()

    logger.info(f"–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ –¥–ª—è {len(user_updates)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...")
    for user_id, points in user_updates.items():
        user = await session.get(User, user_id)
        if user:
            user.points += points
    await session.commit()
    logger.info("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –¥–æ–Ω–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã.")


async def create_manual_waivers(session: AsyncSession, users: list[User]):
    """–°–æ–∑–¥–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–µ –º–µ–¥–æ—Ç–≤–æ–¥—ã, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º'."""
    logger.info("–°–æ–∑–¥–∞–Ω–∏–µ —Å–ª—É—á–∞–π–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ–¥–æ—Ç–≤–æ–¥–æ–≤...")
    waivers_to_create = []
    users_with_waiver = random.sample(users, int(len(users) * MANUAL_WAIVER_CHANCE))
    today = datetime.date.today()

    for user in users_with_waiver:
        start_date = today - datetime.timedelta(days=random.randint(0, 10))
        end_date = today + datetime.timedelta(days=random.randint(5, 30))
        waiver = MedicalWaiver(
            user_id=user.id,
            start_date=start_date,
            end_date=end_date,
            reason=random.choice(["–ü—Ä–æ—Å—Ç—É–¥–∞", "–ü–ª–æ—Ö–æ–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ", "–ü—Ä–∏–µ–º –ª–µ–∫–∞—Ä—Å—Ç–≤"]),
            created_by='user'
        )
        waivers_to_create.append(waiver)

    session.add_all(waivers_to_create)
    await session.commit()
    logger.info(f"–°–æ–∑–¥–∞–Ω–æ {len(waivers_to_create)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ–¥–æ—Ç–≤–æ–¥–æ–≤.")


async def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ë–î."""
    async with async_session_maker() as session:
        await clear_database(session)
        users = await create_users(session)
        past_events, future_events = await create_events(session)
        all_events = past_events + future_events
        await create_registrations_and_donations(session, users, all_events)
        await create_manual_waivers(session, users)

    logger.info("üéâ –ì–æ—Ç–æ–≤–æ! –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.")


if __name__ == "__main__":
    asyncio.run(main())

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: populate_db.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: pytest.ini ---

[pytest]
asyncio_mode = auto
log_file = logs/pytest-logs.txt

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: pytest.ini ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: README.md ---

# –ü—Ä–æ–µ–∫—Ç "–î–æ–Ω–æ—Ä-–±–æ—Ç –ú–ò–§–ò" (Donor Bot)

–¢–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∏ –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–æ–Ω–æ—Ä—Å–∫–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è –≤ –ù–ò–Ø–£ –ú–ò–§–ò.

## üöÄ –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

*   **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
*   **–°–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π**: –°—Ç—É–¥–µ–Ω—Ç, –í–æ–ª–æ–Ω—Ç–µ—Ä, –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä, –ì–ª–∞–≤–Ω—ã–π –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä.
*   **–ó–∞–ø–∏—Å—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏–π —á–µ—Ä–µ–∑ Web App, –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –º–µ–∂–¥—É –¥–æ–Ω–∞—Ü–∏—è–º–∏ –∏ –≥–æ–¥–æ–≤—ã—Ö –ª–∏–º–∏—Ç–æ–≤.
*   **–ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è**: –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ –∑–∞ –¥–æ–Ω–∞—Ü–∏–∏, –º–∞–≥–∞–∑–∏–Ω –º–µ—Ä—á–∞ –¥–ª—è –æ–±–º–µ–Ω–∞ –±–∞–ª–ª–æ–≤.
*   **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–≤**: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–æ–Ω–∞—Ü–∏–π –ø–æ QR-–∫–æ–¥—É.
*   **–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º–∏, –º–µ—Ä—á–µ–º, –∑–∞–∫–∞–∑–∞–º–∏, —Ä–∞—Å—Å—ã–ª–∫–∞–º–∏.
*   **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞**: –°–±–æ—Ä –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è KPI, –∞–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π.
*   **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**: –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –¥–æ–Ω–∞—Ü–∏—è—Ö, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—Ç–º–µ–Ω–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –º–µ–¥–æ—Ç–≤–æ–¥–æ–≤.

## üèõÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

–ü—Ä–æ–µ–∫—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º —Å—Ç–µ–∫–µ Python –∏ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–ª—é—á–µ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤, —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö –≤ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö.

*   **`main.py`**: –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫ **FastAPI** –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–µ–±—Ö—É–∫–æ–≤ –æ—Ç Telegram –∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã **Telegram Web App**.
*   **Aiogram 3**: –Ø–¥—Ä–æ —Ç–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç–∞, –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π, FSM (–º–∞—à–∏–Ω—É —Å–æ—Å—Ç–æ—è–Ω–∏–π) –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å Telegram Bot API.
*   **SQLAlchemy 2.0 (async)**: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö. –í –∫–∞—á–µ—Å—Ç–≤–µ –¥—Ä–∞–π–≤–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `asyncpg`.
*   **PostgreSQL**: –û—Å–Ω–æ–≤–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö, –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö, –¥–æ–Ω–∞—Ü–∏—è—Ö –∏ —Ç.–¥.
*   **Alembic**: –°–∏—Å—Ç–µ–º–∞ –º–∏–≥—Ä–∞—Ü–∏–π –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
*   **Docker / Docker Compose**: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è –∏ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞ (–±–æ—Ç, –ë–î, Redis).

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π

```
.
‚îú‚îÄ‚îÄ bot/                # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ –±–æ—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ db/             # –ú–æ–¥—É–ª–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î (–º–æ–¥–µ–ª–∏, –∑–∞–ø—Ä–æ—Å—ã)
‚îÇ   ‚îú‚îÄ‚îÄ handlers/       # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∫–æ–ª–±—ç–∫–æ–≤, —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–µ –ø–æ —Ä–æ–ª—è–º
‚îÇ   ‚îú‚îÄ‚îÄ keyboards/      # –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –∫–ª–∞–≤–∏–∞—Ç—É—Ä (inline –∏ reply)
‚îÇ   ‚îú‚îÄ‚îÄ middlewares/    # –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Å–ª–æ–∏ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏, —Å–µ—Å—Å–∏—è –ë–î)
‚îÇ   ‚îú‚îÄ‚îÄ states/         # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π FSM
‚îÇ   ‚îî‚îÄ‚îÄ utils/          # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã (QR, –∫–∞–ª–µ–Ω–¥–∞—Ä—å, –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫)
‚îú‚îÄ‚îÄ tests/              # –ö–∞—Ç–∞–ª–æ–≥ —Å —Ç–µ—Å—Ç–∞–º–∏ Pytest
‚îú‚îÄ‚îÄ webapp/             # –§–∞–π–ª—ã –¥–ª—è Telegram Web App (HTML, CSS, JS)
‚îú‚îÄ‚îÄ alembic/            # –§–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π Alembic
‚îú‚îÄ‚îÄ Dockerfile          # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Å–±–æ—Ä–∫–µ Docker-–æ–±—Ä–∞–∑–∞
‚îú‚îÄ‚îÄ docker-compose.yml  # –§–∞–π–ª –¥–ª—è –∑–∞–ø—É—Å–∫–∞ dev-–æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ main.py             # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (FastAPI + Aiogram)
‚îú‚îÄ‚îÄ requirements.txt    # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞
‚îî‚îÄ‚îÄ README.md           # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

## üõ†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

–î–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –≤–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è **Docker** –∏ **Docker Compose**.

1.  **–ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:**
    ```bash
    git clone <URL –≤–∞—à–µ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è>
    cd <–Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞>
    ```

2.  **–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
    –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª `.env.example` (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å) –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Ñ–∞–π–ª —Å –∏–º–µ–Ω–µ–º `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –µ–≥–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏. –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è:
    ```dotenv
    # –¢–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –±–æ—Ç–∞ –æ—Ç @BotFather
    BOT_TOKEN=12345:ABC-DEF12345
    # –í–∞—à –ª–∏—á–Ω—ã–π Telegram ID –¥–ª—è –ø—Ä–∞–≤ –ì–ª–∞–≤–Ω–æ–≥–æ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    SUPER_ADMIN_ID=123456789

    # –î–∞–Ω–Ω—ã–µ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î (Docker Compose –ø–æ–¥—Å—Ç–∞–≤–∏—Ç –∏—Ö –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä postgres)
    DB_HOST=db
    DB_PORT=5432
    DB_NAME=donor_bot_db
    DB_USER=donor_user
    DB_PASS=strong123321

    # –î–∞–Ω–Ω—ã–µ –¥–ª—è Redis
    REDIS_HOST=redis
    REDIS_PORT=6379

    # –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ QR-–∫–æ–¥–æ–≤
    QR_SECRET_KEY=a_very_secret_key_for_testing
    
    # URL –¥–ª—è –≤–µ–±—Ö—É–∫–∞ (–≤ dev-—Ä–µ–∂–∏–º–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ngrok –∏–ª–∏ –∞–Ω–∞–ª–æ–≥)
    # –í–ê–ñ–ù–û: –¥–ª—è —Ä–∞–±–æ—Ç—ã Web App —ç—Ç–æ—Ç URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ
    WEBHOOK_HOST=https://your-ngrok-url.ngrok.io
    ```

3.  **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç:**
    –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Docker Compose –¥–ª—è —Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–æ–≤ –∏ –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤.
    ```bash
    docker-compose up --build
    ```
    –ö–ª—é—á `--build` –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç –æ–±—Ä–∞–∑ –±–æ—Ç–∞, –µ—Å–ª–∏ –≤ –∫–æ–¥–µ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ `docker-compose up`. –ß—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ, –¥–æ–±–∞–≤—å—Ç–µ –∫–ª—é—á `-d`.

## ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü—Ä–æ–µ–∫—Ç –ø–æ–∫—Ä—ã—Ç —Ç–µ—Å—Ç–∞–º–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `pytest`. –¢–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö SQLite –≤ –ø–∞–º—è—Ç–∏.

–î–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞:
```bash
pytest
```

–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –µ–≥–æ –≤ —Ñ–∞–π–ª (—É–¥–æ–±–Ω–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –±–æ–ª—å—à–∏—Ö –ª–æ–≥–æ–≤ –æ—à–∏–±–æ–∫):
```bash
pytest > test_log.txt 2>&1
```
–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤—ã–≤–æ–¥ (`stdout`) –∏ –≤—ã–≤–æ–¥ –æ—à–∏–±–æ–∫ (`stderr`) –≤ —Ñ–∞–π–ª `test_log.txt`.

## ‚öôÔ∏è –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã

–í –ø—Ä–æ–µ–∫—Ç–µ –µ—Å—Ç—å –¥–≤–∞ —Å–∫—Ä–∏–ø—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ **–Ω–µ —è–≤–ª—è—é—Ç—Å—è —á–∞—Å—Ç—å—é –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**, –Ω–æ –ø–æ–ª–µ–∑–Ω—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –æ—Ç–ª–∞–¥–∫–∏. **–û–Ω–∏ –Ω–µ –¥–æ–ª–∂–Ω—ã –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ —Ä–µ–ª–∏–∑–Ω–æ–π –≤–µ—Ç–∫–µ `main`.**

### `populate_db.py`
–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –Ω–∞–ø–æ–ª–Ω—è–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ñ–µ–π–∫–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –¥–æ–Ω–∞—Ü–∏–∏ –∏ —Ç.–¥.) —Å –ø–æ–º–æ—â—å—é –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ `Faker`. –≠—Ç–æ –∫—Ä–∞–π–Ω–µ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, UI –∏ –ª–æ–≥–∏–∫–∏ –Ω–∞ –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–∞—Ö –¥–∞–Ω–Ω—ã—Ö.

**–í–Ω–∏–º–∞–Ω–∏–µ:** –°–∫—Ä–∏–ø—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é **–æ—á–∏—â–∞–µ—Ç** –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º!

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
1.  –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∞—à–µ dev-–æ–∫—Ä—É–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ (`docker-compose up`).
2.  –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞:
    ```bash
    python populate_db.py
    ```

### `collector.py`
–°–∫—Ä–∏–ø—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Å–±–æ—Ä–∞ –≤—Å–µ–π –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã –ø—Ä–æ–µ–∫—Ç–∞ –≤ –æ–¥–∏–Ω —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª `all_code.txt`. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è:
*   –ü–µ—Ä–µ–¥–∞—á–∏ –∫–æ–¥–∞ –Ω–∞ —Ä–µ–≤—å—é –æ–¥–Ω–∏–º —Ñ–∞–π–ª–æ–º.
*   –ê–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞ —Å –ø–æ–º–æ—â—å—é LLM-–º–æ–¥–µ–ª–µ–π.
*   –ë—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ –≤—Å–µ–º—É –ø—Ä–æ–µ–∫—Ç—É.

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
python collector.py
```

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (Git Flow)

1.  –í—Å—è –Ω–æ–≤–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –≤–µ–¥–µ—Ç—Å—è –≤ –≤–µ—Ç–∫–∞—Ö `feature/*`, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –æ—Ç `develop`.
2.  –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ –∑–∞–¥–∞—á–µ–π —Å–æ–∑–¥–∞–µ—Ç—Å—è Pull Request –∏–∑ `feature/*` –≤ `develop`.
3.  –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ Code Review –∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ –≤–µ—Ç–∫–∞ –≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ `develop`.
4.  –î–ª—è —Ä–µ–ª–∏–∑–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è Pull Request –∏–∑ `develop` –≤ `main`. –í–µ—Ç–∫–∞ `main` —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ, –≥–æ—Ç–æ–≤—ã–µ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é –≤–µ—Ä—Å–∏–∏.

---

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: README.md ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: requirements.txt ---

aiogram==3.4.1
aiogram[redis]==3.4.1
redis==5.0.1 
sqlalchemy[asyncio]==2.0.27
asyncpg==0.29.0
python-dotenv==1.0.1
qrcode[pil]==7.4.2
pyzbar==0.1.9
pillow==10.2.0
apscheduler==3.10.4
alembic==1.13.1
pydantic-settings==2.2.1
ics==0.7.2
greenlet==3.0.3
aiohttp==3.9.1
aiosignal==1.3.1
attrs==23.2.0
frozenlist==1.4.1
multidict==6.0.5
yarl==1.9.4
pytz
fastapi==0.111.0
uvicorn[standard]==0.29.0
python-jose[cryptography]==3.3.0
python-multipart==0.0.9
matplotlib==3.8.4
pandas==2.2.2
openpyxl==3.1.2

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: requirements.txt ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: .pytest_cache/.gitignore ---

# Created by pytest automatically.
*


--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: .pytest_cache/.gitignore ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: .pytest_cache/README.md ---

# pytest cache directory #

This directory contains data from the pytest's cache plugin,
which provides the `--lf` and `--ff` options, as well as the `cache` fixture.

**Do not** commit this to version control.

See [the docs](https://docs.pytest.org/en/stable/how-to/cache.html) for more information.


--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: .pytest_cache/README.md ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/config_reader.py ---

from pydantic_settings import BaseSettings, SettingsConfigDict
from pydantic import SecretStr, StrictStr

class Settings(BaseSettings):
    model_config = SettingsConfigDict(env_file='.env', env_file_encoding='utf-8')
    bot_token: SecretStr
    super_admin_id: int
    ngrok_authtoken: SecretStr 
    db_host: StrictStr
    db_port: int
    db_name: StrictStr
    db_user: StrictStr
    db_pass: SecretStr
    qr_secret_key: SecretStr
    @property
    def database_url(self) -> str:
        return (f"postgresql+asyncpg://{self.db_user}:{self.db_pass.get_secret_value()}"
                f"@{self.db_host}:{self.db_port}/{self.db_name}")


config = Settings()

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/config_reader.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/__init__.py ---



--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/__init__.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/db/admin_requests.py ---

import datetime
import logging # <-- –î–û–ë–ê–í–ò–¢–¨ –≠–¢–£ –°–¢–†–û–ö–£
from sqlalchemy import select, update, or_, func, String, delete, distinct, extract
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from .models import (
    User, Event, EventRegistration, Donation, MedicalWaiver, 
    MerchItem, MerchOrder, UserBlock, BloodCenter
)
from .models import Feedback
from .event_requests import find_specific_registration, add_event_registration, confirm_donation_transaction
import math

logger = logging.getLogger(__name__) 

async def check_if_users_exist(session: AsyncSession) -> bool:
    user_count = await session.scalar(select(func.count(User.id)))
    return user_count > 0


# --- User Management ---
async def find_user_for_admin(session: AsyncSession, query: str) -> User | None:
    stmt = select(User).where(
        or_(
            User.full_name.ilike(f"%{query}%"),
            User.telegram_username.ilike(f"%{query}%"),
            User.telegram_id.cast(String).ilike(f"%{query}%"),
            User.phone_number.ilike(f"%{query}%")
        )
    ).order_by(User.full_name)
    result = await session.execute(stmt)
    return result.scalars().all()

async def get_users_page(session: AsyncSession, page: int = 1, page_size: int = 10) -> tuple[list[User], int]:
    offset = (page - 1) * page_size
    total_count = (await session.execute(select(func.count(User.id)))).scalar_one()
    items_result = await session.execute(select(User).order_by(User.full_name).offset(offset).limit(page_size))
    items = items_result.scalars().all()
    total_pages = math.ceil(total_count / page_size) if total_count > 0 else 1
    return items, total_pages

async def get_all_users(session: AsyncSession) -> list[User]:
    stmt = select(User).order_by(User.full_name)
    result = await session.execute(stmt)
    return result.scalars().all()

async def change_user_role(session: AsyncSession, user_id: int, new_role: str):
    stmt = update(User).where(User.id == user_id).values(role=new_role)
    await session.execute(stmt)
    await session.commit()

async def add_points_to_user(session: AsyncSession, user_id: int, points: int, reason: str):
    user = await session.get(User, user_id)
    user.points += points
    # log: # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
    await session.commit()

async def block_user(session: AsyncSession, user_id: int, admin_id: int, reason: str):
    user = await session.get(User, user_id)
    user.is_blocked = True
    block_record = UserBlock(user_id=user_id, admin_id=admin_id, reason=reason, is_active=True)
    session.add(block_record)
    # log: # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    await session.commit()

async def unblock_user(session: AsyncSession, user_id: int):
    user = await session.get(User, user_id)
    user.is_blocked = False
    stmt = update(UserBlock).where(UserBlock.user_id == user_id, UserBlock.is_active == True).values(is_active=False)
    await session.execute(stmt)
    # log: # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    await session.commit()

# --- Event Management ---
async def create_event(session: AsyncSession, data: dict) -> Event:
    event = Event(**data)
    session.add(event)
    await session.commit()
    return event

async def update_event_field(session: AsyncSession, event_id: int, field_name: str, new_value: any):
    if not hasattr(Event, field_name):
        return
    stmt = update(Event).where(Event.id == event_id).values({field_name: new_value})
    await session.execute(stmt)
    await session.commit()


async def get_all_blood_centers(session: AsyncSession) -> list[BloodCenter]:
    stmt = select(BloodCenter).order_by(BloodCenter.name)
    result = await session.execute(stmt)
    return result.scalars().all()


async def create_blood_center(session: AsyncSession, name: str) -> BloodCenter:
    blood_center = BloodCenter(name=name)
    session.add(blood_center)
    await session.commit()
    return blood_center


async def get_blood_center_by_id(session: AsyncSession, blood_center_id: int) -> BloodCenter | None:
    return await session.get(BloodCenter, blood_center_id)

# --- Merch Management ---
async def create_merch_item(session: AsyncSession, data: dict) -> MerchItem:
    item = MerchItem(**data)
    session.add(item)
    await session.commit()
    return item

# --- Order Processing ---
async def get_pending_orders(session: AsyncSession) -> list[MerchOrder]:
    stmt = select(MerchOrder).options(joinedload(MerchOrder.user), joinedload(MerchOrder.item)).where(MerchOrder.status == 'pending_pickup').order_by(MerchOrder.order_date)
    result = await session.execute(stmt)
    return result.scalars().all()

async def complete_order(session: AsyncSession, order_id: int, admin_id: int):
    order = await session.get(MerchOrder, order_id)
    if order:
        order.status = 'completed'
        order.completed_by_admin_id = admin_id
        order.completion_date = datetime.datetime.now()
        # log: # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
        await session.commit()

# --- Manual Waiver ---
async def create_manual_waiver(session: AsyncSession, user_id: int, end_date: datetime.date, reason: str, admin_id: int):
    waiver = MedicalWaiver(
        user_id=user_id,
        start_date=datetime.date.today(),
        end_date=end_date,
        reason=reason,
        created_by=str(admin_id)
    )
    session.add(waiver)
    # log: # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –º–µ–¥–æ—Ç–≤–æ–¥–∞
    await session.commit()

# --- Export Functions ---
async def get_all_donations(session: AsyncSession) -> list:
    stmt = select(Donation).options(
        joinedload(Donation.user),
        joinedload(Donation.event)
    ).order_by(Donation.donation_date.desc())
    result = await session.execute(stmt)
    return result.scalars().all()

# --- Main Admin Setup ---
async def create_main_admin(session: AsyncSession, tg_id: int, tg_username: str, full_name: str):
    new_admin = User(
        phone_number=f"admin_{tg_id}",
        telegram_id=tg_id,
        telegram_username=tg_username,
        full_name=full_name,
        role='main_admin',
        university="–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è"  # <-- –ò–°–ü–†–ê–í–õ–ï–ù–û
    )
    session.add(new_admin)

async def update_main_admin_data(session: AsyncSession, tg_id: int, tg_username: str, full_name: str):
    stmt = (
        update(User)
        .where(User.telegram_id == tg_id)
        .values(
            role='main_admin',
            telegram_username=tg_username,
            full_name=full_name
        )
    )
    await session.execute(stmt)
    await session.commit()

async def get_event_registrations_count(session: AsyncSession, event_id: int) -> int:
    stmt = select(func.count(EventRegistration.id)).where(EventRegistration.event_id == event_id)
    result = await session.execute(stmt)
    return result.scalar_one()

async def get_event_with_participants(session: AsyncSession, event_id: int):
    stmt = select(Event).options(selectinload(Event.registrations).joinedload(EventRegistration.user)).where(Event.id == event_id)
    result = await session.execute(stmt)
    event = result.scalar_one_or_none()
    if not event:
        return None, []
    return event, event.registrations

async def deactivate_event(session: AsyncSession, event_id: int):
    stmt = update(Event).where(Event.id == event_id).values(is_active=False)
    await session.execute(stmt)
    await session.commit()

async def get_all_merch_items(session: AsyncSession) -> list[MerchItem]:
    stmt = select(MerchItem).order_by(MerchItem.id)
    result = await session.execute(stmt)
    return result.scalars().all()

async def get_merch_item_by_id(session: AsyncSession, item_id: int) -> MerchItem | None:
    return await session.get(MerchItem, item_id)

async def update_merch_item_field(session: AsyncSession, item_id: int, field_name: str, new_value: any):
    if not hasattr(MerchItem, field_name):
        return
    stmt = update(MerchItem).where(MerchItem.id == item_id).values({field_name: new_value})
    await session.execute(stmt)
    await session.commit()

async def toggle_merch_item_availability(session: AsyncSession, item_id: int) -> bool:
    item = await session.get(MerchItem, item_id)
    if not item:
        return False
    item.is_available = not item.is_available
    await session.commit()
    return item.is_available

async def delete_merch_item_by_id(session: AsyncSession, item_id: int):
    item = await session.get(MerchItem, item_id)
    if item:
        await session.delete(item)
        await session.commit()

# --- Export Functions ---
async def get_all_data_for_export(session: AsyncSession) -> dict:
    data_to_export = {
        "users": (await session.execute(select(User))).scalars().all(),
        "events": (await session.execute(select(Event))).scalars().all(),
        "event_registrations": (await session.execute(select(EventRegistration))).scalars().all(),
        "donations": (await session.execute(select(Donation))).scalars().all(),
        "medical_waivers": (await session.execute(select(MedicalWaiver))).scalars().all(),
        "merch_items": (await session.execute(select(MerchItem))).scalars().all(),
        "merch_orders": (await session.execute(select(MerchOrder))).scalars().all(),
        "user_blocks": (await session.execute(select(UserBlock))).scalars().all(),
    }
    return data_to_export



async def toggle_event_registration_status(session: AsyncSession, event_id: int) -> bool:
    """–ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ (–æ—Ç–∫—Ä—ã—Ç–∞/–∑–∞–∫—Ä—ã—Ç–∞)."""
    event = await session.get(Event, event_id)
    if not event:
        return False
    event.registration_is_open = not event.registration_is_open
    await session.commit()
    return event.registration_is_open



async def get_user_registrations(session: AsyncSession, user_id: int) -> list[EventRegistration]:
    """–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –±—É–¥—É—â–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è."""
    stmt = (
        select(EventRegistration)
        .join(EventRegistration.event)
        .where(
            EventRegistration.user_id == user_id,
            Event.event_date >= datetime.date.today(),
            EventRegistration.status == 'registered'
        )
        .options(joinedload(EventRegistration.event))
        .order_by(Event.event_date)
    )
    result = await session.execute(stmt)
    return result.scalars().all()


async def manually_register_user(session: AsyncSession, user: User, event: Event) -> tuple[bool, str]:
    """
    –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –≤—Ä—É—á–Ω—É—é –æ—Ç –∏–º–µ–Ω–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ —É—Å–ª–æ–≤–∏—è, –∫—Ä–æ–º–µ —Å—Ç–∞—Ç—É—Å–∞ –æ—Ç–∫—Ä—ã—Ç–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
    """
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
    if user.is_blocked:
        return False, "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω."

    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    existing_reg = await find_specific_registration(session, user.id, event.id)
    if existing_reg:
        return False, "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ —ç—Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ."

    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–µ–¥–æ—Ç–≤–æ–¥—ã (—á–∞—Å—Ç–∏—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–≥–∏–∫—É –∏–∑ check_registration_eligibility)
    waiver_stmt = select(MedicalWaiver).where(MedicalWaiver.user_id == user.id, MedicalWaiver.end_date >= event.event_date)
    active_waiver = (await session.execute(waiver_stmt)).scalar_one_or_none()
    if active_waiver:
        return False, f"–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–µ–π—Å—Ç–≤—É–µ—Ç –æ—Ç–≤–æ–¥ –¥–æ {active_waiver.end_date.strftime('%d.%m.%Y')}."

    # –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã, —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º
    await add_event_registration(session, user.id, event.id)
    return True, f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.full_name} —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω –Ω–∞ {event.name}."


async def get_all_user_active_waivers(session: AsyncSession, user_id: int) -> list[MedicalWaiver]:
    """–ü–æ–ª—É—á–∞–µ—Ç –í–°–ï –∞–∫—Ç–∏–≤–Ω—ã–µ –º–µ–¥–æ—Ç–≤–æ–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ, –∏ –ª–∏—á–Ω—ã–µ)."""
    stmt = select(MedicalWaiver).where(
        MedicalWaiver.user_id == user_id,
        MedicalWaiver.end_date >= datetime.date.today()
    ).order_by(MedicalWaiver.end_date)
    result = await session.execute(stmt)
    return result.scalars().all()


async def force_delete_waiver(session: AsyncSession, waiver_id: int) -> bool:
    """–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª—è–µ—Ç –º–µ–¥–æ—Ç–≤–æ–¥ –ø–æ –µ–≥–æ ID. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True –≤ —Å–ª—É—á–∞–µ —É—Å–ø–µ—Ö–∞."""
    stmt = delete(MedicalWaiver).where(MedicalWaiver.id == waiver_id)
    result = await session.execute(stmt)
    await session.commit()
    return result.rowcount > 0


async def get_feedback_for_event(session: AsyncSession, event_id: int) -> list[Feedback]:
    stmt = (
        select(Feedback)
        .options(joinedload(Feedback.user))
        .where(Feedback.event_id == event_id)
        .order_by(Feedback.created_at.desc())
    )
    result = await session.execute(stmt)
    return result.scalars().all()

async def get_distinct_universities(session: AsyncSession) -> list[str]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–æ–≤ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã users."""
    stmt = select(distinct(User.university)).order_by(User.university)
    result = await session.execute(stmt)
    return result.scalars().all()

async def get_distinct_faculties(session: AsyncSession) -> list[str]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–æ–≤ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã users, –∏—Å–∫–ª—é—á–∞—è NULL."""
    stmt = (
        select(distinct(User.faculty))
        .where(User.faculty.is_not(None)) 
        .order_by(User.faculty)
    )
    result = await session.execute(stmt)
    return result.scalars().all()


async def manually_confirm_donation(session: AsyncSession, user_id: int, event_id: int, became_dkm_donor: bool) -> tuple[bool, str]:
    """
    –í—Ä—É—á–Ω—É—é –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –¥–æ–Ω–∞—Ü–∏—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (—É—Å–ø–µ—Ö, —Å–æ–æ–±—â–µ–Ω–∏–µ).
    """
    user = await session.get(User, user_id)
    event = await session.get(Event, event_id)
    if not user or not event:
        return False, "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–ª–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."

    registration = await find_specific_registration(session, user_id, event_id)
    if not registration:    
        registration = EventRegistration(user_id=user_id, event_id=event_id)
        session.add(registration)
        await session.flush()

    if registration.status == 'attended':
        return False, f"–î–æ–Ω–∞—Ü–∏—è –¥–ª—è {user.full_name} —É–∂–µ –±—ã–ª–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞."

    try:
        await confirm_donation_transaction(session, user, registration)
        if became_dkm_donor and not user.is_dkm_donor:
            user.is_dkm_donor = True
            
        await session.commit()
        return True, f"–î–æ–Ω–∞—Ü–∏—è –¥–ª—è {user.full_name} –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞."
    except Exception as e:
        await session.rollback()
        logger.error(f"Error in manually_confirm_donation for user {user_id}: {e}")
        return False, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –¥–ª—è {user.full_name}: {e}"


async def get_min_user_id(session: AsyncSession) -> int:
    """
    Gets the minimum user ID from the database.
    """
    result = await session.execute(select(func.min(User.telegram_id)))
    min_id = result.scalar_one_or_none()
    return min_id if min_id is not None else 0

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/db/admin_requests.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/db/analytics_requests.py ---

import datetime
from sqlalchemy import select, func, and_, distinct, text
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload

from .models import User, Event, Donation, EventRegistration, Survey, MedicalWaiver

async def get_main_kpi(session: AsyncSession) -> dict:
    """–°–æ–±–∏—Ä–∞–µ—Ç –∫–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –¥–∞—à–±–æ—Ä–¥–∞."""
    
    thirty_days_ago = datetime.datetime.now() - datetime.timedelta(days=30)
    new_users_stmt = select(func.count(User.id)).where(User.created_at >= thirty_days_ago)
    new_users_count = (await session.execute(new_users_stmt)).scalar_one()

    ninety_days_ago = datetime.date.today() - datetime.timedelta(days=90)
    active_donors_stmt = select(func.count(distinct(Donation.user_id))).where(Donation.donation_date >= ninety_days_ago)
    active_donors_count = (await session.execute(active_donors_stmt)).scalar_one()
    
    waiver_stmt = select(func.count(distinct(User.id))).join(User.waivers).where(MedicalWaiver.end_date >= datetime.date.today())
    on_waiver_count = (await session.execute(waiver_stmt)).scalar_one()

    next_event_stmt = select(Event).where(Event.is_active == True, Event.event_datetime >= datetime.datetime.now()).order_by(Event.event_datetime).limit(1)
    next_event = (await session.execute(next_event_stmt)).scalar_one_or_none()
    
    next_event_info = None
    if next_event:
        regs_count = (await session.execute(select(func.count(EventRegistration.id)).where(EventRegistration.event_id == next_event.id))).scalar_one()
        next_event_info = {
            "name": next_event.name,
            "registered": regs_count,
            "limit": next_event.participant_limit,
            "date": next_event.event_datetime
        }
        
    return {
        "new_users_30d": new_users_count,
        "active_donors_90d": active_donors_count,
        "on_waiver_now": on_waiver_count,
        "next_event": next_event_info
    }

async def get_donations_by_month(session: AsyncSession, months: int = 6) -> list[tuple]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–Ω–∞—Ü–∏–π –ø–æ –º–µ—Å—è—Ü–∞–º –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –º–µ—Å—è—Ü–µ–≤.
    –ò–°–ü–û–õ–¨–ó–£–ï–¢ date_trunc –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å PostgreSQL.
    """
    today = datetime.date.today()
    start_date = (today.replace(day=1) - datetime.timedelta(days=1)).replace(day=1)
    for _ in range(months - 1):
        start_date = (start_date - datetime.timedelta(days=1)).replace(day=1)

    stmt = text("""
        SELECT
            date_trunc('month', donation_date)::DATE as month_date,
            count(id) as count
        FROM donations
        WHERE donation_date >= :start_date
        GROUP BY month_date
        ORDER BY month_date
    """)
    
    result = await session.execute(stmt, {"start_date": start_date})
    
    return [(row.month_date, row.count) for row in result]

async def get_past_events_for_analysis(session: AsyncSession) -> list[Event]:
    """–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø—Ä–æ—à–µ–¥—à–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –¥–ª—è –≤—ã–±–æ—Ä–∞."""
    stmt = select(Event).where(Event.event_datetime < datetime.datetime.now()).order_by(Event.event_datetime.desc()).limit(15)
    result = await session.execute(stmt)
    return result.scalars().all()

async def get_event_analysis_data(session: AsyncSession, event_id: int) -> dict:
    """–°–æ–±–∏—Ä–∞–µ—Ç –≤—Å—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø—Ä–æ—à–µ–¥—à–µ–º—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é."""
    event = await session.get(Event, event_id)
    if not event:
        return None

    stmt_registrations = select(func.count(EventRegistration.id)).where(EventRegistration.event_id == event_id)
    registered_count = (await session.execute(stmt_registrations)).scalar_one()
    
    stmt_donations = select(func.count(Donation.id)).where(Donation.event_id == event_id)
    attended_count = (await session.execute(stmt_donations)).scalar_one()
    
    stmt_attended_users = (
        select(User)
        .join(Donation)
        .where(Donation.event_id == event_id)
    )
    # –ó–î–ï–°–¨ –ë–´–õ–ê –û–®–ò–ë–ö–ê, –¢–ï–ü–ï–†–¨ –û–ù–ê –ò–°–ü–†–ê–í–õ–ï–ù–ê –ë–õ–ê–ì–û–î–ê–†–Ø –ò–ú–ü–û–†–¢–£
    attended_users_result = await session.execute(stmt_attended_users.options(selectinload(User.donations)))
    attended_users = attended_users_result.scalars().unique().all()
    
    newcomers_count = sum(1 for user in attended_users if len(user.donations) == 1)
    
    faculties_dist = {}
    for user in attended_users:
        faculty = user.faculty or "–ù–µ —É–∫–∞–∑–∞–Ω"
        faculties_dist[faculty] = faculties_dist.get(faculty, 0) + 1

    return {
        "event_name": event.name,
        "registered_count": registered_count,
        "attended_count": attended_count,
        "conversion_rate": (attended_count / registered_count * 100) if registered_count > 0 else 0,
        "newcomers_count": newcomers_count,
        "veterans_count": attended_count - newcomers_count,
        "faculties_distribution": faculties_dist
    }

async def get_one_time_donors(session: AsyncSession) -> list[dict]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ–Ω–æ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Å–¥–∞–ª–∏ –∫—Ä–æ–≤—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑."""
    stmt = (
        select(User, func.count(Donation.id).label("donation_count"))
        .join(Donation)
        .group_by(User)
        .having(func.count(Donation.id) == 1)
    )
    result = await session.execute(stmt)
    return [{"full_name": row.User.full_name, "telegram_username": row.User.telegram_username} for row in result]

async def get_no_show_donors(session: AsyncSession) -> list[dict]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ–Ω–æ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å, –Ω–æ –Ω–µ –ø—Ä–∏—à–ª–∏."""
    stmt = (
        select(User)
        .join(EventRegistration)
        .where(EventRegistration.status == "no_show_survey_sent")
    )
    result = await session.execute(stmt)
    return [{"full_name": row.User.full_name, "telegram_username": row.User.telegram_username} for row in result]

async def get_dkm_donors(session: AsyncSession) -> list[dict]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ–Ω–æ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —è–≤–ª—è—é—Ç—Å—è –¥–æ–Ω–æ—Ä–∞–º–∏ –∫–æ—Å—Ç–Ω–æ–≥–æ –º–æ–∑–≥–∞."""
    stmt = select(User).where(User.is_dkm_donor == True)
    result = await session.execute(stmt)
    return [{"full_name": row.User.full_name, "telegram_username": row.User.telegram_username} for row in result]

async def get_students(session: AsyncSession) -> list[dict]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ–Ω–æ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —è–≤–ª—è—é—Ç—Å—è —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏."""
    stmt = select(User).where(User.category == "student")
    result = await session.execute(stmt)
    return [{"full_name": row.User.full_name, "telegram_username": row.User.telegram_username} for row in result]

async def get_employees(session: AsyncSession) -> list[dict]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ–Ω–æ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —è–≤–ª—è—é—Ç—Å—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏."""
    stmt = select(User).where(User.category == "employee")
    result = await session.execute(stmt)
    return [{"full_name": row.User.full_name, "telegram_username": row.User.telegram_username} for row in result]

async def get_external_donors(session: AsyncSession) -> list[dict]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ–Ω–æ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —è–≤–ª—è—é—Ç—Å—è –≤–Ω–µ—à–Ω–∏–º–∏ –¥–æ–Ω–æ—Ä–∞–º–∏."""
    stmt = select(User).where(User.category == "external")
    result = await session.execute(stmt)
    return [{"full_name": row.User.full_name, "telegram_username": row.User.telegram_username} for row in result]

async def get_graduated_donors(session: AsyncSession) -> list[dict]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ–Ω–æ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø—É—Å—Ç–∏–ª–∏—Å—å –∏–∑ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞."""
    # This is a placeholder. The actual implementation will depend on how graduation is determined.
    return []

async def get_churn_donors(session: AsyncSession) -> list[dict]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–æ–Ω–æ—Ä–æ–≤-–æ–¥–Ω–æ–¥–Ω–µ–≤–æ–∫.
    –õ–æ–≥–∏–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö —Ä–æ–≤–Ω–æ 1 –¥–æ–Ω–∞—Ü–∏—è, –∏ –æ–Ω–∞ –±—ã–ª–∞ –±–æ–ª–µ–µ 6 –º–µ—Å—è—Ü–µ–≤ –Ω–∞–∑–∞–¥.
    """
    six_months_ago = datetime.datetime.now() - datetime.timedelta(days=180)

    # –ü–æ–¥–∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –æ–¥–Ω–æ–π –¥–æ–Ω–∞—Ü–∏–µ–π
    subquery = (
        select(Donation.user_id)
        .group_by(Donation.user_id)
        .having(func.count(Donation.id) == 1)
    ).alias("one_donation_users")

    # –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—Ä–æ—Å
    stmt = (
        select(User.full_name, User.telegram_username, Donation.donation_date)
        .join(subquery, User.id == subquery.c.user_id)
        .join(Donation, User.id == Donation.user_id)
        .where(Donation.donation_date < six_months_ago)
    )

    result = await session.execute(stmt)
    return [
        {"full_name": row.full_name, "username": row.telegram_username, "donation_date": row.donation_date}
        for row in result
    ]

async def get_lapsed_donors(session: AsyncSession) -> list[dict]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–≥–∞—Å–∞—é—â–∏—Ö –¥–æ–Ω–æ—Ä–æ–≤.
    –õ–æ–≥–∏–∫–∞: 2+ –¥–æ–Ω–∞—Ü–∏–∏, –ø–æ—Å–ª–µ–¥–Ω—è—è > 9 –º–µ—Å. –Ω–∞–∑–∞–¥, –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–µ–¥–æ—Ç–≤–æ–¥–æ–≤.
    """
    nine_months_ago = datetime.datetime.now() - datetime.timedelta(days=270)
    today = datetime.date.today()

    # –ü–æ–¥–∑–∞–ø—Ä–æ—Å: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å 2+ –¥–æ–Ω–∞—Ü–∏—è–º–∏ –∏ –¥–∞—Ç–æ–π –ø–æ—Å–ª–µ–¥–Ω–µ–π –¥–æ–Ω–∞—Ü–∏–∏
    subquery = (
        select(
            Donation.user_id,
            func.count(Donation.id).label("donations_count"),
            func.max(Donation.donation_date).label("last_donation_date")
        )
        .group_by(Donation.user_id)
        .having(func.count(Donation.id) >= 2)
        .alias("lapsed_candidates")
    )

    # –ü–æ–¥–∑–∞–ø—Ä–æ—Å: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –º–µ–¥–æ—Ç–≤–æ–¥–∞–º–∏
    active_waiver_subquery = (
        select(MedicalWaiver.user_id)
        .where(MedicalWaiver.end_date >= today)
    ).alias("active_waivers")

    # –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—Ä–æ—Å
    stmt = (
        select(
            User.full_name,
            User.telegram_username,
            subquery.c.donations_count,
            subquery.c.last_donation_date
        )
        .join(subquery, User.id == subquery.c.user_id)
        .outerjoin(active_waiver_subquery, User.id == active_waiver_subquery.c.user_id)
        .where(
            subquery.c.last_donation_date < nine_months_ago,
            active_waiver_subquery.c.user_id == None # –£—Å–ª–æ–≤–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –≤ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–µ —Å –º–µ–¥–æ—Ç–≤–æ–¥–∞–º–∏
        )
    )

    result = await session.execute(stmt)
    return [
        {
            "full_name": row.full_name,
            "username": row.telegram_username,
            "donation_count": row.donations_count,
            "last_donation_date": row.last_donation_date
        }
        for row in result
    ]

async def get_top_donors(session: AsyncSession) -> list[dict]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ø-20 –¥–æ–Ω–æ—Ä–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –¥–æ–Ω–∞—Ü–∏–π.
    """
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–∫–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è
    stmt = (
        select(
            User.full_name,
            User.telegram_username,
            func.count(Donation.id).label("donation_count"),
            func.rank().over(order_by=func.count(Donation.id).desc()).label("rank")
        )
        .join(Donation, User.id == Donation.user_id)
        .group_by(User.id)
        .order_by(text("rank")) # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–∞–Ω–≥—É
        .limit(20)
    )

    result = await session.execute(stmt)
    return [
        {
            "rank": row.rank,
            "full_name": row.full_name,
            "username": row.telegram_username,
            "donation_count": row.donation_count
        }
        for row in result
    ]

async def get_rare_blood_donors(session: AsyncSession) -> list[dict]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–æ–Ω–æ—Ä–æ–≤ —Å —Ä–µ–¥–∫–æ–π –≥—Ä—É–ø–ø–æ–π –∫—Ä–æ–≤–∏.
    –õ–æ–≥–∏–∫–∞: rh_factor = '-' –ò–õ–ò blood_type = 'AB(IV)'.
    """
    stmt = (
        select(User.full_name, User.telegram_username, User.blood_type, User.rh_factor)
        .where(
            (User.rh_factor == '-') |
            (User.blood_type == 'AB(IV)')
        )
        .order_by(User.full_name)
    )

    result = await session.execute(stmt)
    return [
        {
            "full_name": row.full_name,
            "username": row.telegram_username,
            "blood_group": f"{row.blood_type}{row.rh_factor}"
        }
        for row in result
    ]

async def get_top_faculties(session: AsyncSession) -> list[dict]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∞–º—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç—ã –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –¥–æ–Ω–∞—Ü–∏–π.
    –õ–æ–≥–∏–∫–∞: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–æ–Ω–∞—Ü–∏–π –ø–æ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –ù–ò–Ø–£ –ú–ò–§–ò.
    """
    stmt = (
        select(User.faculty, func.count(Donation.id).label("donation_count"))
        .join(Donation, User.id == Donation.user_id)
        .where(User.university == "–ù–ò–Ø–£ –ú–ò–§–ò", User.faculty != None)
        .group_by(User.faculty)
        .order_by(func.count(Donation.id).desc())
    )

    result = await session.execute(stmt)
    return [
        {"faculty_name": row.faculty, "donation_count": row.donation_count}
        for row in result
    ]

async def get_dkm_candidates(session: AsyncSession) -> list[dict]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –≤ —Ä–µ–≥–∏—Å—Ç—Ä –î–ö–ú.
    –õ–æ–≥–∏–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å 2+ –¥–æ–Ω–∞—Ü–∏—è–º–∏, –Ω–æ is_dkm_donor = False.
    """
    subquery = (
        select(Donation.user_id, func.count(Donation.id).label("donation_count"))
        .group_by(Donation.user_id)
        .having(func.count(Donation.id) >= 2)
    ).alias("two_plus_donations")

    stmt = (
        select(User.full_name, User.telegram_username, two_plus_donations.c.donation_count)
        .join(two_plus_donations, User.id == two_plus_donations.c.user_id)
        .where(User.is_dkm_donor == False)
        .order_by(User.full_name)
    )

    result = await session.execute(stmt)
    return [
        {
            "full_name": row.full_name,
            "username": row.telegram_username,
            "donation_count": row.donation_count
        }
        for row in result
    ]

async def get_survey_dropoff(session: AsyncSession) -> list[dict]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, "–ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö" –ø–æ—Å–ª–µ –æ–ø—Ä–æ—Å–Ω–∏–∫–∞.
    –õ–æ–≥–∏–∫–∞: –ï—Å—Ç—å —É—Å–ø–µ—à–Ω—ã–π –æ–ø—Ä–æ—Å–Ω–∏–∫, –Ω–æ –Ω–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –ø–æ—Å–ª–µ –Ω–µ–≥–æ.
    """
    # –ü–æ–¥–∑–∞–ø—Ä–æ—Å: –ø–æ—Å–ª–µ–¥–Ω—è—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    last_reg_subquery = (
        select(
            EventRegistration.user_id,
            func.max(EventRegistration.registration_date).label("last_reg_date")
        )
        .group_by(EventRegistration.user_id)
    ).alias("last_regs")

    # –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—Ä–æ—Å
    stmt = (
        select(User.full_name, User.telegram_username, Survey.created_at)
        .join(Survey, User.id == Survey.user_id)
        .outerjoin(last_reg_subquery, User.id == last_reg_subquery.c.user_id)
        .where(
            (Survey.passed == True) &
            (
                (last_reg_subquery.c.last_reg_date == None) |
                (Survey.created_at > last_reg_subquery.c.last_reg_date)
            )
        )
        # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –±–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–ø–∏—Å—å –æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏ –æ–ø—Ä–æ—Å–Ω–∏–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        .distinct(User.id)
        .order_by(User.id, Survey.created_at.desc())
    )

    result = await session.execute(stmt)
    return [
        {
            "full_name": row.full_name,
            "username": row.telegram_username,
            "survey_date": row.created_at
        }
        for row in result
    ]

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/db/analytics_requests.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/db/engine.py ---

from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker, AsyncSession
from bot.config_reader import config
from bot.db.models import Base

engine = create_async_engine(
    url=config.database_url,
    echo=False 
)

async_session_maker = async_sessionmaker(engine, class_=AsyncSession, expire_on_commit=False)

async def create_db_and_tables():
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/db/engine.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/db/event_requests.py ---

import datetime
from sqlalchemy import select, func, delete, or_
from sqlalchemy.ext.asyncio import AsyncSession
from .models import User, Event, EventRegistration, Donation, MedicalWaiver
from sqlalchemy.orm import joinedload
from bot.utils.text_messages import Text

async def get_active_events(session: AsyncSession) -> list[Event]:
    """–ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è."""
    stmt = (
        select(Event)
        .where(Event.is_active == True)
        .order_by(Event.event_datetime.desc())
    )
    result = await session.execute(stmt)
    return result.scalars().all()

async def get_active_events_for_user(session: AsyncSession, user_id: int) -> list[Event]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≤–∫–ª—é—á–∞—è —Ç–µ, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –æ–Ω —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω,
    –¥–∞–∂–µ –µ—Å–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –Ω–∏—Ö –∑–∞–∫—Ä—ã—Ç–∞.
    """
    user_registrations_subquery = select(EventRegistration.event_id).where(EventRegistration.user_id == user_id)
    stmt = (
        select(Event)
        .where(
            Event.is_active == True,
            Event.event_datetime >= datetime.datetime.now(),
            or_(
                Event.registration_is_open == True,
                Event.id.in_(user_registrations_subquery)
            )
        )
        .order_by(Event.event_datetime)
    )
    result = await session.execute(stmt)
    return result.scalars().all()

async def get_upcoming_events(session: AsyncSession) -> list[Event]:
    """–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –±—É–¥—É—â–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è (–¥–ª—è –∞–¥–º–∏–Ω–∫–∏)."""
    stmt = (
        select(Event)
        .where(
            Event.is_active == True,
            Event.event_datetime >= datetime.datetime.now()
        )
        .order_by(Event.event_datetime)
    )
    result = await session.execute(stmt)
    return result.scalars().all()

async def get_event_by_id(session: AsyncSession, event_id: int) -> Event | None:
    """–ü–æ–ª—É—á–∞–µ—Ç –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –ø–æ –µ–≥–æ ID."""
    stmt = select(Event).options(joinedload(Event.blood_center)).where(Event.id == event_id)
    result = await session.execute(stmt)
    return result.scalar_one_or_none()

async def get_today_event(session: AsyncSession) -> Event | None:
    """–ü–æ–ª—É—á–∞–µ—Ç –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Å–µ–≥–æ–¥–Ω—è."""
    today = datetime.date.today()
    stmt = (
        select(Event)
        .where(
            Event.is_active == True,
            func.date(Event.event_datetime) == today
        )
    )
    result = await session.execute(stmt)
    return result.scalar_one_or_none()

async def check_registration_eligibility(session: AsyncSession, user: User, event: Event) -> tuple[bool, str]:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ."""
    # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–∞—Ç—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å –º–µ–¥–æ—Ç–≤–æ–¥–∞–º–∏
    event_date = event.event_datetime.date()

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ë–∞–∑–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
    if not event.registration_is_open:
        return False, "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —ç—Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∑–∞–∫—Ä—ã—Ç–∞."

    existing_registration = await find_specific_registration(session, user.id, event.id)
    if existing_registration:
        return False, f"–í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —ç—Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ ({event.name})."

    reg_count = await session.scalar(select(func.count(EventRegistration.id)).where(EventRegistration.event_id == event.id))
    if reg_count >= event.participant_limit:
        return False, f"–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ({event.participant_limit})."

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ–¥–æ—Ç–≤–æ–¥—ã –∏–∑ —Ç–∞–±–ª–∏—Ü—ã MedicalWaiver
    active_waiver_stmt = select(MedicalWaiver).where(
        MedicalWaiver.user_id == user.id,
        MedicalWaiver.end_date >= event_date
    ).order_by(MedicalWaiver.end_date.desc()).limit(1)
    active_waiver = (await session.execute(active_waiver_stmt)).scalar_one_or_none()
    if active_waiver:
        return False, f"–£ –≤–∞—Å –¥–µ–π—Å—Ç–≤—É–µ—Ç –æ—Ç–≤–æ–¥ –¥–æ {active_waiver.end_date.strftime('%d.%m.%Y')}. –ü—Ä–∏—á–∏–Ω–∞: {active_waiver.reason}."

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –º–µ–¥–æ—Ç–≤–æ–¥—ã –æ—Ç –î–†–£–ì–ò–• –±—É–¥—É—â–∏—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π
    future_registrations_stmt = (
        select(EventRegistration)
        .join(EventRegistration.event)
        .where(
            EventRegistration.user_id == user.id,
            EventRegistration.status == 'registered',
            Event.event_datetime < event.event_datetime
        )
        .options(joinedload(EventRegistration.event))
        .order_by(Event.event_datetime)
    )
    future_registrations = (await session.execute(future_registrations_stmt)).scalars().all()

    for reg in future_registrations:
        registered_event = reg.event
        if registered_event.donation_type == 'whole_blood':
            interval = 90 if user.gender == 'female' else 60
        else:
            interval = 14

        potential_waiver_end_date = registered_event.event_datetime.date() + datetime.timedelta(days=interval)

        if event_date <= potential_waiver_end_date:
            return False, (f"–ó–∞–ø–∏—Å—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞. –£ –≤–∞—Å –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –¥–æ–Ω–∞—Ü–∏—è "
                           f"¬´{registered_event.name}¬ª –Ω–∞ {registered_event.event_datetime.strftime('%d.%m.%Y')}, "
                           f"–ø–æ—Å–ª–µ –∫–æ—Ç–æ—Ä–æ–π –±—É–¥–µ—Ç –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –º–µ–¥–æ—Ç–≤–æ–¥.")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: –ì–æ–¥–æ–≤–æ–π –ª–∏–º–∏—Ç –¥–æ–Ω–∞—Ü–∏–π (—Å —É—á–µ—Ç–æ–º –±—É–¥—É—â–∏—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π)
    donation_type = event.donation_type
    
    # –°—á–∏—Ç–∞–µ–º –ü–†–û–®–ï–î–®–ò–ï –¥–æ–Ω–∞—Ü–∏–∏
    past_donations_stmt = select(func.count(Donation.id)).where(
        Donation.user_id == user.id,
        Donation.donation_type == donation_type
    )
    past_donations_count = (await session.execute(past_donations_stmt)).scalar_one()

    # –°—á–∏—Ç–∞–µ–º –ë–£–î–£–©–ò–ï –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–æ–Ω–∞—Ü–∏–∏ —Ç–∞–∫–æ–≥–æ –∂–µ —Ç–∏–ø–∞
    future_registrations_stmt = (
        select(func.count(EventRegistration.id))
        .join(Event)
        .where(
            EventRegistration.user_id == user.id,
            EventRegistration.status == 'registered',
            Event.donation_type == donation_type
        )
    )
    future_registrations_count = (await session.execute(future_registrations_stmt)).scalar_one()

    total_committed_donations = past_donations_count + future_registrations_count
    limit = 0
    limit_reason = ""

    if donation_type == 'whole_blood':
        limit = 4 if user.gender == 'female' else 5
        limit_reason = (f"–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –≥–æ–¥–æ–≤–æ–≥–æ –ª–∏–º–∏—Ç–∞ ({limit}) –Ω–∞ —Å–¥–∞—á—É —Ü–µ–ª—å–Ω–æ–π –∫—Ä–æ–≤–∏, "
                        f"—É—á–∏—Ç—ã–≤–∞—è –ø—Ä–æ—à–ª—ã–µ –∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–æ–Ω–∞—Ü–∏–∏.")
    elif donation_type in ['plasma', 'platelets', 'erythrocytes']:
        limit = 12
        limit_reason = (f"–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –≥–æ–¥–æ–≤–æ–≥–æ –ª–∏–º–∏—Ç–∞ ({limit}) –Ω–∞ —Å–¥–∞—á—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤, "
                        f"—É—á–∏—Ç—ã–≤–∞—è –ø—Ä–æ—à–ª—ã–µ –∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–æ–Ω–∞—Ü–∏–∏.")

    if limit > 0 and total_committed_donations >= limit:
        return False, limit_reason

    return True, "–í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã."


async def add_event_registration(session: AsyncSession, user_id: int, event_id: int) -> EventRegistration:
    """–î–æ–±–∞–≤–ª—è–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ."""
    registration = EventRegistration(user_id=user_id, event_id=event_id)
    session.add(registration)
    await session.flush()

    event = await session.get(Event, event_id)
    if event:
        reg_count_stmt = select(func.count(EventRegistration.id)).where(EventRegistration.event_id == event_id)
        reg_count = (await session.execute(reg_count_stmt)).scalar_one()
        if reg_count >= event.participant_limit:
            event.registration_is_open = False
            
    await session.commit()
    return registration

async def find_specific_registration(session: AsyncSession, user_id: int, event_id: int) -> EventRegistration | None:
    """–ù–∞—Ö–æ–¥–∏—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ."""
    stmt = select(EventRegistration).options(
        joinedload(EventRegistration.event)
    ).where(
        EventRegistration.user_id == user_id,
        EventRegistration.event_id == event_id,
        EventRegistration.status == 'registered'
    )
    result = await session.execute(stmt)
    return result.scalar_one_or_none()

async def confirm_donation_transaction(session: AsyncSession, user: User, registration: EventRegistration) -> tuple[int, datetime.date]:
    """–ü—Ä–æ–≤–æ–¥–∏—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–æ–Ω–∞—Ü–∏–∏: –Ω–∞—á–∏—Å–ª—è–µ—Ç –±–∞–ª–ª—ã, —Å–æ–∑–¥–∞–µ—Ç –º–µ–¥–æ—Ç–≤–æ–¥."""
    event = await session.get(Event, registration.event_id)
    event_date = event.event_datetime.date() # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–∞—Ç—É –¥–ª—è –¥–æ–Ω–∞—Ü–∏–∏ –∏ –º–µ–¥–æ—Ç–≤–æ–¥–∞
            
    points_to_award = event.points_per_donation

    # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ –¥–æ–Ω–∞—Ü–∏–∏
    donation = Donation(
        user_id=user.id,
        event_id=event.id,
        donation_date=event_date,
        donation_type=event.donation_type,
        points_awarded=points_to_award
    )
    
    # –°–æ–∑–¥–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –º–µ–¥–æ—Ç–≤–æ–¥
    days_waiver = (90 if user.gender == 'female' else 60) if event.donation_type == 'whole_blood' else 14
    end_date = event_date + datetime.timedelta(days=days_waiver)
    russian_donation_type = Text.DONATION_TYPE_RU.get(event.donation_type, event.donation_type)
    waiver = MedicalWaiver(
        user_id=user.id,
        start_date=event_date,
        end_date=end_date,
        reason=f"–°–¥–∞—á–∞ ¬´{russian_donation_type}¬ª",
        created_by='system'
    )

    # –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    user.points += points_to_award
    registration.status = 'attended'

    session.add_all([donation, waiver])
    await session.commit()
    return points_to_award, end_date

async def cancel_registration(session: AsyncSession, user_id: int, event_id: int) -> bool:
    """–û—Ç–º–µ–Ω—è–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ."""
    stmt = delete(EventRegistration).where(
        EventRegistration.user_id == user_id,
        EventRegistration.event_id == event_id
    )
    result = await session.execute(stmt)
    await session.commit()
    return result.rowcount > 0

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/db/event_requests.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/db/info_requests.py ---

from sqlalchemy import select, update
from sqlalchemy.ext.asyncio import AsyncSession
from .models import InfoText

async def get_info_text(session: AsyncSession, section_key: str) -> str | None:
    """–ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏–Ω—Ñ–æ-—Ä–∞–∑–¥–µ–ª–∞ –ø–æ –∫–ª—é—á—É."""
    text_obj = await session.get(InfoText, section_key)
    return text_obj.section_text if text_obj else "–†–∞–∑–¥–µ–ª –Ω–µ –Ω–∞–π–¥–µ–Ω."

async def get_all_info_sections(session: AsyncSession) -> list[InfoText]:
    """–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∏–Ω—Ñ–æ-—Ä–∞–∑–¥–µ–ª—ã –¥–ª—è –º–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è."""
    result = await session.execute(select(InfoText).order_by(InfoText.section_key))
    return result.scalars().all()

async def update_info_text(session: AsyncSession, section_key: str, new_text: str):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –∏–Ω—Ñ–æ-—Ä–∞–∑–¥–µ–ª–∞."""
    stmt = (
        update(InfoText)
        .where(InfoText.section_key == section_key)
        .values(section_text=new_text)
    )
    await session.execute(stmt)
    await session.commit()

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/db/info_requests.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/db/merch_requests.py ---

import math
from sqlalchemy import select, func
from sqlalchemy.orm import joinedload
from sqlalchemy.ext.asyncio import AsyncSession
from .models import User, MerchItem, MerchOrder

async def get_merch_page(session: AsyncSession, page: int = 1) -> tuple[MerchItem | None, int]:
    page_size = 1
    offset = (page - 1) * page_size
    total_count_stmt = select(func.count(MerchItem.id)).where(MerchItem.is_available == True)
    total_items = (await session.execute(total_count_stmt)).scalar_one()
    
    if total_items == 0:
        return None, 0
    item_stmt = select(MerchItem).where(MerchItem.is_available == True).order_by(MerchItem.id).offset(offset).limit(page_size)
    item_result = await session.execute(item_stmt)
    item = item_result.scalar_one_or_none()
    
    return item, total_items

async def get_merch_item_by_id(session: AsyncSession, item_id: int) -> MerchItem | None:
    return await session.get(MerchItem, item_id)

async def create_merch_order(session: AsyncSession, user: User, item: MerchItem) -> tuple[bool, str]:
    if user.points < item.price:
        return False, "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤."

    user.points -= item.price
    order = MerchOrder(user_id=user.id, item_id=item.id)
    session.add(order)
    return True, f"–ü–æ–∫—É–ø–∫–∞ —Å–æ–≤–µ—Ä—à–µ–Ω–∞! –í–∞—à –±–∞–ª–∞–Ω—Å: {user.points} –±–∞–ª–ª–æ–≤."

async def get_user_orders(session: AsyncSession, user_id: int) -> list[MerchOrder]:
    stmt = select(MerchOrder).options(joinedload(MerchOrder.item)).where(MerchOrder.user_id == user_id).order_by(MerchOrder.order_date.desc())
    result = await session.execute(stmt)
    return result.scalars().all()

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/db/merch_requests.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/db/models.py ---

import datetime
from typing import List
from sqlalchemy import (
    String, BigInteger, ForeignKey,
    Integer, Boolean, DateTime, Date, Text, func, Float, JSON
)
from sqlalchemy.orm import DeclarativeBase, Mapped, mapped_column, relationship

class Base(DeclarativeBase):
    pass

class User(Base):
    __tablename__ = 'users'
    id: Mapped[int] = mapped_column(primary_key=True)
    phone_number: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    telegram_id: Mapped[int] = mapped_column(BigInteger, unique=True, nullable=False, index=True)
    telegram_username: Mapped[str] = mapped_column(String(255), nullable=True, index=True)
    full_name: Mapped[str] = mapped_column(String(255), index=True)
    university: Mapped[str] = mapped_column(String(100), nullable=True, index=True)
    faculty: Mapped[str] = mapped_column(String(100), nullable=True)
    study_group: Mapped[str] = mapped_column(String(50), nullable=True)
    gender: Mapped[str] = mapped_column(String(10), nullable=True)
    points: Mapped[int] = mapped_column(Integer, default=0)
    role: Mapped[str] = mapped_column(String(50), default='student', index=True)
    is_blocked: Mapped[bool] = mapped_column(Boolean, default=False)
    created_at: Mapped[datetime.datetime] = mapped_column(DateTime(timezone=True), server_default=func.now())
    category: Mapped[str] = mapped_column(String(50), default='student', server_default='student')
    is_dkm_donor: Mapped[bool] = mapped_column(Boolean, default=False, server_default='f')
    consent_given: Mapped[bool] = mapped_column(Boolean, default=False, server_default='f')
    graduation_year: Mapped[int] = mapped_column(Integer, nullable=True)

    donations: Mapped[List["Donation"]] = relationship(back_populates="user")
    registrations: Mapped[List["EventRegistration"]] = relationship(back_populates="user", cascade="all, delete-orphan")
    waivers: Mapped[List["MedicalWaiver"]] = relationship(back_populates="user")
    orders: Mapped[List["MerchOrder"]] = relationship(foreign_keys="MerchOrder.user_id", back_populates="user", cascade="all, delete-orphan")
    blocks_given: Mapped[List["UserBlock"]] = relationship(foreign_keys="UserBlock.admin_id", back_populates="admin")
    blocks_received: Mapped[List["UserBlock"]] = relationship(foreign_keys="UserBlock.user_id", back_populates="blocked_user")


class Event(Base):
    __tablename__ = 'events'
    id: Mapped[int] = mapped_column(primary_key=True)
    name: Mapped[str] = mapped_column(String(255))
    event_datetime: Mapped[datetime.datetime] = mapped_column(DateTime)
    location: Mapped[str] = mapped_column(Text)
    blood_center_id: Mapped[int] = mapped_column(ForeignKey('blood_centers.id'), nullable=True)
    
    latitude: Mapped[float] = mapped_column(Float, nullable=True)
    longitude: Mapped[float] = mapped_column(Float, nullable=True)
    donation_type: Mapped[str] = mapped_column(String(50))
    points_per_donation: Mapped[int] = mapped_column(Integer)
    participant_limit: Mapped[int] = mapped_column(Integer)
    is_active: Mapped[bool] = mapped_column(Boolean, default=True)
    registration_is_open: Mapped[bool] = mapped_column(Boolean, default=True, server_default='t')

    blood_center: Mapped["BloodCenter"] = relationship(back_populates="events")
    registrations: Mapped[List["EventRegistration"]] = relationship(back_populates="event")
    feedbacks: Mapped[List["Feedback"]] = relationship(back_populates="event")


class EventRegistration(Base):
    __tablename__ = 'event_registrations'
    id: Mapped[int] = mapped_column(primary_key=True)
    user_id: Mapped[int] = mapped_column(ForeignKey('users.id'), index=True)
    event_id: Mapped[int] = mapped_column(ForeignKey('events.id'), index=True)
    status: Mapped[str] = mapped_column(String(50), default='registered')
    registration_date: Mapped[datetime.datetime] = mapped_column(DateTime(timezone=True), server_default=func.now())

    user: Mapped["User"] = relationship(back_populates="registrations")
    event: Mapped["Event"] = relationship(back_populates="registrations")

class Donation(Base):
    __tablename__ = 'donations'
    id: Mapped[int] = mapped_column(primary_key=True)
    user_id: Mapped[int] = mapped_column(ForeignKey('users.id'), index=True)
    event_id: Mapped[int] = mapped_column(ForeignKey('events.id'), nullable=True, index=True)
    donation_date: Mapped[datetime.date] = mapped_column(Date)
    donation_type: Mapped[str] = mapped_column(String(50))
    points_awarded: Mapped[int] = mapped_column(Integer)
    feedback_requested: Mapped[bool] = mapped_column(Boolean, default=False, server_default='f', nullable=False)

    user: Mapped["User"] = relationship(back_populates="donations")
    event: Mapped["Event"] = relationship()
    
class Feedback(Base):
    __tablename__ = 'feedbacks'
    id: Mapped[int] = mapped_column(primary_key=True)
    user_id: Mapped[int] = mapped_column(ForeignKey('users.id'))
    event_id: Mapped[int] = mapped_column(ForeignKey('events.id'))
    
    well_being_score: Mapped[int] = mapped_column(Integer, nullable=True) # 1-5
    well_being_comment: Mapped[str] = mapped_column(Text, nullable=True)
    
    organization_score: Mapped[int] = mapped_column(Integer, nullable=True) # 1-10
    what_liked: Mapped[str] = mapped_column(Text, nullable=True)
    what_disliked: Mapped[str] = mapped_column(Text, nullable=True)
    other_suggestions: Mapped[str] = mapped_column(Text, nullable=True)
    
    created_at: Mapped[datetime.datetime] = mapped_column(DateTime(timezone=True), server_default=func.now())

    user: Mapped["User"] = relationship()
    event: Mapped["Event"] = relationship(back_populates="feedbacks")

class MedicalWaiver(Base):
    __tablename__ = 'medical_waivers'
    id: Mapped[int] = mapped_column(primary_key=True)
    user_id: Mapped[int] = mapped_column(ForeignKey('users.id'))
    start_date: Mapped[datetime.date] = mapped_column(Date)
    end_date: Mapped[datetime.date] = mapped_column(Date)
    reason: Mapped[str] = mapped_column(Text)
    created_by: Mapped[str] = mapped_column(String(50))

    user: Mapped["User"] = relationship(back_populates="waivers")

class MerchItem(Base):
    __tablename__ = 'merch_items'
    id: Mapped[int] = mapped_column(primary_key=True)
    name: Mapped[str] = mapped_column(String(255))
    description: Mapped[str] = mapped_column(Text)
    price: Mapped[int] = mapped_column(Integer)
    photo_file_id: Mapped[str] = mapped_column(String(255))
    is_available: Mapped[bool] = mapped_column(Boolean, default=True)

    orders: Mapped[List["MerchOrder"]] = relationship(back_populates="item")

class MerchOrder(Base):
    __tablename__ = 'merch_orders'
    id: Mapped[int] = mapped_column(primary_key=True)
    user_id: Mapped[int] = mapped_column(ForeignKey('users.id'), index=True)
    item_id: Mapped[int] = mapped_column(ForeignKey('merch_items.id'))
    order_date: Mapped[datetime.datetime] = mapped_column(DateTime(timezone=True), server_default=func.now())
    status: Mapped[str] = mapped_column(String(50), default='pending_pickup')
    completed_by_admin_id: Mapped[int] = mapped_column(ForeignKey('users.id'), nullable=True)
    completion_date: Mapped[datetime.datetime] = mapped_column(DateTime(timezone=True), nullable=True)

    user: Mapped["User"] = relationship(foreign_keys=[user_id], back_populates="orders")
    item: Mapped["MerchItem"] = relationship(back_populates="orders")
    completed_by_admin: Mapped["User"] = relationship(foreign_keys=[completed_by_admin_id])


class UserBlock(Base):
    __tablename__ = 'user_blocks'
    id: Mapped[int] = mapped_column(primary_key=True)
    user_id: Mapped[int] = mapped_column(ForeignKey('users.id'))
    admin_id: Mapped[int] = mapped_column(ForeignKey('users.id'))
    block_date: Mapped[datetime.datetime] = mapped_column(DateTime(timezone=True), server_default=func.now())
    reason: Mapped[str] = mapped_column(Text)
    is_active: Mapped[bool] = mapped_column(Boolean, default=True)
    
    blocked_user: Mapped["User"] = relationship(foreign_keys=[user_id], back_populates="blocks_received")
    admin: Mapped["User"] = relationship(foreign_keys=[admin_id], back_populates="blocks_given")
    
class Survey(Base):
    __tablename__ = 'surveys'
    id: Mapped[int] = mapped_column(primary_key=True)
    user_id: Mapped[int] = mapped_column(ForeignKey('users.id'), index=True)
    created_at: Mapped[datetime.datetime] = mapped_column(DateTime(timezone=True), server_default=func.now())
    passed: Mapped[bool] = mapped_column(Boolean, nullable=False)
    answers_json: Mapped[dict] = mapped_column(JSON, nullable=False)
    verdict_text: Mapped[str] = mapped_column(Text, nullable=True)
    
    user: Mapped["User"] = relationship()
    
    
class InfoText(Base):
    __tablename__ = 'info_texts'
    section_key: Mapped[str] = mapped_column(String(50), primary_key=True)
    section_title: Mapped[str] = mapped_column(String(100))
    section_text: Mapped[str] = mapped_column(Text)
    
class Question(Base):
    __tablename__ = 'questions'
    id: Mapped[int] = mapped_column(primary_key=True)
    user_id: Mapped[int] = mapped_column(ForeignKey('users.id'), index=True)
    
    question_text: Mapped[str] = mapped_column(Text)
    answer_text: Mapped[str] = mapped_column(Text, nullable=True)
    
    status: Mapped[str] = mapped_column(String(50), default='unanswered', index=True) # unanswered, answered
    
    created_at: Mapped[datetime.datetime] = mapped_column(DateTime(timezone=True), server_default=func.now())
    answered_at: Mapped[datetime.datetime] = mapped_column(DateTime(timezone=True), nullable=True)
    answered_by_admin_id: Mapped[int] = mapped_column(ForeignKey('users.id'), nullable=True)

    user: Mapped["User"] = relationship(foreign_keys=[user_id])
    answered_by_admin: Mapped["User"] = relationship(foreign_keys=[answered_by_admin_id])
    
    
    
class NoShowReport(Base):
    __tablename__ = 'no_show_reports'
    id: Mapped[int] = mapped_column(primary_key=True)
    user_id: Mapped[int] = mapped_column(ForeignKey('users.id'), index=True)
    event_id: Mapped[int] = mapped_column(ForeignKey('events.id'), index=True)
    reason: Mapped[str] = mapped_column(String(100))
    created_at: Mapped[datetime.datetime] = mapped_column(DateTime(timezone=True), server_default=func.now())
    user: Mapped["User"] = relationship()
    event: Mapped["Event"] = relationship()
    
class BloodCenter(Base):
    __tablename__ = 'blood_centers'
    id: Mapped[int] = mapped_column(primary_key=True)
    name: Mapped[str] = mapped_column(String(255), unique=True, nullable=False)

    events: Mapped[List["Event"]] = relationship(back_populates="blood_center")


class Report(Base):
    __tablename__ = 'reports'
    id: Mapped[int] = mapped_column(primary_key=True)
    name: Mapped[str] = mapped_column(String(255))
    data: Mapped[dict] = mapped_column(JSON)
    created_at: Mapped[datetime.datetime] = mapped_column(DateTime(timezone=True), server_default=func.now())

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/db/models.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/db/qa_management.py ---

from aiogram import Router, F, types, Bot
from aiogram.fsm.context import FSMContext
from sqlalchemy.ext.asyncio import AsyncSession

from bot.db import question_requests, user_requests
from bot.filters.role import RoleFilter
from bot.states.states import AnswerQuestion
from bot.keyboards import inline
from bot.utils.text_messages import Text

router = Router(name="admin_qa_management")

@router.callback_query(F.data == "admin_answer_questions", RoleFilter('admin'))
async def show_unanswered_questions(callback: types.CallbackQuery, session: AsyncSession):
    questions = await question_requests.get_unanswered_questions(session)
    if not questions:
        await callback.answer("–ù–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç.", show_alert=True)
        return

    builder = types.InlineKeyboardBuilder()
    for q in questions:
        builder.row(types.InlineKeyboardButton(
            text=f"–û—Ç {q.user.full_name}: {q.question_text[:30]}...",
            callback_data=f"answer_q_{q.id}"
        ))
    builder.row(types.InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="admin_panel"))
    
    await callback.message.edit_text(
        "<b>–ù–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã:</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å, —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å:",
        reply_markup=builder.as_markup()
    )
    await callback.answer()

@router.callback_query(F.data.startswith("answer_q_"), RoleFilter('admin'))
async def start_answering_question(callback: types.CallbackQuery, state: FSMContext, session: AsyncSession):
    question_id = int(callback.data.split("_")[-1])
    question = await session.get(question_requests.Question, question_id)
    if not question:
        await callback.answer("–í–æ–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
        return
        
    await state.set_state(AnswerQuestion.awaiting_answer)
    await state.update_data(question_id=question.id, user_to_answer_id=question.user.telegram_id)
    
    await callback.message.edit_text(
        f"<b>–í–æ–ø—Ä–æ—Å –æ—Ç:</b> {question.user.full_name}\n"
        f"<b>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</b>\n<i>{Text.escape_html(question.question_text)}</i>\n\n"
        f"<b>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç:</b>"
    )
    await callback.answer()

@router.message(AnswerQuestion.awaiting_answer)
async def process_answer(message: types.Message, state: FSMContext, session: AsyncSession, bot: Bot):
    data = await state.get_data()
    question_id = data.get("question_id")
    user_to_answer_id = data.get("user_to_answer_id")
    admin_user = await user_requests.get_user_by_tg_id(session, message.from_user.id)
    
    await question_requests.answer_question(session, question_id, message.text, admin_user.id)
    
    question = await session.get(question_requests.Question, question_id)

    try:
        await bot.send_message(
            chat_id=user_to_answer_id,
            text=(
                f"üì® <b>–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –Ω–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å!</b>\n\n"
                f"<b>–í–∞—à –≤–æ–ø—Ä–æ—Å:</b>\n<i>{Text.escape_html(question.question_text)}</i>\n\n"
                f"<b>–û—Ç–≤–µ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–≤:</b>\n{Text.escape_html(message.text)}"
            )
        )
    except Exception as e:
        await message.answer(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –û—à–∏–±–∫–∞: {e}")

    await state.clear()
    await message.answer("‚úÖ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.", reply_markup=inline.get_back_to_admin_panel_keyboard())

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/db/qa_management.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/db/question_requests.py ---

import datetime
from sqlalchemy import select, update
from sqlalchemy.orm import joinedload
from sqlalchemy.ext.asyncio import AsyncSession
from .models import Question, User

async def create_question(session: AsyncSession, user_id: int, question_text: str):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    new_question = Question(user_id=user_id, question_text=question_text)
    session.add(new_question)
    await session.commit()

async def get_unanswered_questions(session: AsyncSession) -> list[Question]:
    """–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –Ω–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ."""
    stmt = (
        select(Question)
        .options(joinedload(Question.user))
        .where(Question.status == 'unanswered')
        .order_by(Question.created_at)
    )
    result = await session.execute(stmt)
    return result.scalars().all()

async def answer_question(session: AsyncSession, question_id: int, answer_text: str, admin_id: int):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –µ–≥–æ —Å—Ç–∞—Ç—É—Å."""
    stmt = (
        update(Question)
        .where(Question.id == question_id)
        .values(
            answer_text=answer_text,
            status='answered',
            answered_at=datetime.datetime.now(),
            answered_by_admin_id=admin_id
        )
    )
    await session.execute(stmt)
    await session.commit()

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/db/question_requests.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/db/user_requests.py ---

import datetime
from sqlalchemy import select, func, update, delete 
from sqlalchemy.ext.asyncio import AsyncSession
from .models import User, Donation, MedicalWaiver
from sqlalchemy import and_, or_, not_
from sqlalchemy.orm import aliased, joinedload 
from .models import User, Donation, MedicalWaiver, Event, Survey
import logging
logger = logging.getLogger(__name__)


async def update_user_credentials(session: AsyncSession, user_id: int, new_tg_id: int, new_username: str | None):
    # –û–±–Ω–æ–≤–∏—Ç—å Telegram ID –∏ username
    stmt = update(User).where(User.id == user_id).values(
        telegram_id=new_tg_id,
        telegram_username=new_username
    )
    await session.execute(stmt)
    await session.commit()


async def get_user_by_phone(session: AsyncSession, phone: str) -> User | None:
    # –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
    stmt = select(User).where(User.phone_number == phone)
    result = await session.execute(stmt)
    return result.scalar_one_or_none()

async def get_user_by_tg_id(session: AsyncSession, tg_id: int) -> User | None:
    # –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ Telegram ID
    stmt = select(User).where(User.telegram_id == tg_id)
    result = await session.execute(stmt)
    return result.scalar_one_or_none()

# --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–±–∏—Ä–∞–µ–º commit –∏–∑ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ ---
async def add_user(session: AsyncSession, data: dict) -> User:
    # –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user = User(**data)
    session.add(user)
    # await session.commit()  # <-- –£–ë–ò–†–ê–ï–ú –≠–¢–£ –°–¢–†–û–ö–£
    return user
# --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---

async def update_user_tg_id(session: AsyncSession, user_id: int, new_tg_id: int):
    # –û–±–Ω–æ–≤–∏—Ç—å Telegram ID
    stmt = update(User).where(User.id == user_id).values(telegram_id=new_tg_id)
    await session.execute(stmt)
    await session.commit()
    
async def update_user_profile(session: AsyncSession, user_id: int, data: dict):
    # –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    stmt = update(User).where(User.id == user_id).values(**data)
    await session.execute(stmt)
    await session.commit()

async def get_user_profile_info(session: AsyncSession, user_id: int) -> dict | None:
    user = await session.get(User, user_id)
    if not user:
        return None

    stmt_last_donation = (
        select(Donation)
        .options(joinedload(Donation.event))
        .where(Donation.user_id == user.id)
        .order_by(Donation.donation_date.desc())
        .limit(1)
    )
    last_donation_obj = (await session.execute(stmt_last_donation)).scalar_one_or_none()

    today = datetime.date.today()
    stmt_waiver = select(MedicalWaiver.end_date).where(MedicalWaiver.user_id == user.id, MedicalWaiver.end_date >= today).order_by(MedicalWaiver.end_date.desc()).limit(1)
    active_waiver_end_date = (await session.execute(stmt_waiver)).scalar_one_or_none()
    
    next_possible_donation = today
    if active_waiver_end_date:
        next_possible_donation = active_waiver_end_date + datetime.timedelta(days=1)
    
    if last_donation_obj:
        last_date = last_donation_obj.donation_date
        last_type = last_donation_obj.donation_type
        if last_type == 'whole_blood':
            interval = 90 if user.gender == 'female' else 60
            possible_date = last_date + datetime.timedelta(days=interval)
        else:
            interval = 14
            possible_date = last_date + datetime.timedelta(days=interval)
        next_possible_donation = max(next_possible_donation, possible_date)

    total_donations = await session.scalar(select(func.count(Donation.id)).where(Donation.user_id == user.id))

    return {
        "user": user,
        "total_donations": total_donations,
        "next_possible_donation": next_possible_donation,
        "last_donation": last_donation_obj 
    }

async def get_user_donation_history(session: AsyncSession, user_id: int) -> list[Donation]:
    # –ò—Å—Ç–æ—Ä–∏—è –¥–æ–Ω–∞—Ü–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    stmt = select(Donation).where(Donation.user_id == user_id).order_by(Donation.donation_date.desc())
    result = await session.execute(stmt)
    return result.scalars().all()

async def get_user_active_waivers(session: AsyncSession, user_id: int) -> list[MedicalWaiver]:
    # –ê–∫—Ç–∏–≤–Ω—ã–µ –º–µ–¥–æ—Ç–≤–æ–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    stmt = select(MedicalWaiver).where(
        MedicalWaiver.user_id == user_id,
        MedicalWaiver.end_date >= datetime.date.today()
    ).order_by(MedicalWaiver.end_date)
    result = await session.execute(stmt)
    return result.scalars().all()

async def get_user_by_id(session: AsyncSession, user_id: int) -> User | None:
    # –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID
    return await session.get(User, user_id)

async def get_all_users(session: AsyncSession) -> list[User]:
    # –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
    stmt = select(User).order_by(User.full_name)
    result = await session.execute(stmt)
    return result.scalars().all()

async def get_users_for_event_notification(session: AsyncSession, event: Event) -> list[User]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω—ã –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏.
    –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ –∞–∫—Ç–∏–≤–Ω—ã–º –º–µ–¥–æ—Ç–≤–æ–¥–∞–º, –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º –º–µ–∂–¥—É –¥–æ–Ω–∞—Ü–∏—è–º–∏ –∏ –≥–æ–¥–æ–≤—ã–º –ª–∏–º–∏—Ç–∞–º.
    """
    event_date_only = event.event_datetime.date()

    # 1. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —É –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–µ–¥–æ—Ç–≤–æ–¥–æ–≤ –Ω–∞ –¥–∞—Ç—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
    active_waiver_subquery = select(MedicalWaiver.user_id).where(MedicalWaiver.end_date >= event_date_only).distinct()
    query = select(User).where(not_(User.id.in_(active_waiver_subquery)))
    initial_users = (await session.execute(query)).scalars().all()
    
    final_users_to_notify = []
    one_year_ago = event_date_only - datetime.timedelta(days=365)
    
    for user in initial_users:
        # –ü–æ–ª—É—á–∞–µ–º –¥–æ–Ω–∞—Ü–∏–∏ –∑–∞ –≥–æ–¥
        donations_stmt = select(Donation).where(
            Donation.user_id == user.id,
            Donation.donation_date >= one_year_ago
        ).order_by(Donation.donation_date.desc())
        user_donations = (await session.execute(donations_stmt)).scalars().all()

        # --- –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ì–æ–¥–æ–≤—ã–µ –ª–∏–º–∏—Ç—ã ---
        donations_of_event_type = [d for d in user_donations if d.donation_type == event.donation_type]
        
        if event.donation_type == 'whole_blood':
            limit = 4 if user.gender == 'female' else 5
            if len(donations_of_event_type) >= limit:
                continue
        else: # –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
            limit = 12
            if len(donations_of_event_type) >= limit:
                continue

        # --- –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã ---
        if not user_donations:
            final_users_to_notify.append(user)
            continue
            
        # –ü—Ä–∞–≤–∏–ª–æ 2.1: –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–æ–¥ –æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –¥–æ–Ω–∞—Ü–∏–∏ –õ–Æ–ë–û–ì–û —Ç–∏–ø–∞
        last_donation = user_donations[0]
        
        if last_donation.donation_type == 'whole_blood':
            interval = 90 if user.gender == 'female' else 60
        else:
            interval = 14
        
        # –î–∞—Ç–∞, –∫–æ–≥–¥–∞ –æ—Ç–≤–æ–¥ –æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –¥–æ–Ω–∞—Ü–∏–∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è.
        waiver_end_date_from_last = last_donation.donation_date + datetime.timedelta(days=interval)
        
        # –ï—Å–ª–∏ –¥–∞—Ç–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –º–µ–Ω—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–∞ –¥–∞—Ç–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ—Ç–≤–æ–¥–∞, —Ç–æ —Å–¥–∞–≤–∞—Ç—å –Ω–µ–ª—å–∑—è.
        if event_date_only <= waiver_end_date_from_last:
            continue

        # –ü—Ä–∞–≤–∏–ª–æ 2.2: –ï—Å–ª–∏ –ø—Ä–µ–¥—Å—Ç–æ–∏—Ç —Å–¥–∞—á–∞ –¶–ï–õ–¨–ù–û–ô –ö–†–û–í–ò, –Ω—É–∂–Ω–∞ –¥–æ–ø. –ø—Ä–æ–≤–µ—Ä–∫–∞
        if event.donation_type == 'whole_blood':
            donations_whole_blood = [d for d in user_donations if d.donation_type == 'whole_blood']
            if donations_whole_blood:
                last_whole_blood_donation = donations_whole_blood[0]
                interval_whole = 90 if user.gender == 'female' else 60
                
                waiver_end_date_from_last_whole = last_whole_blood_donation.donation_date + datetime.timedelta(days=interval_whole)
                
                if event_date_only <= waiver_end_date_from_last_whole:
                    continue
        
        final_users_to_notify.append(user)
            
    return final_users_to_notify

async def get_users_for_mailing(session: AsyncSession, filters: dict) -> list[User]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–±–æ—Ä–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤.
    """
    stmt = select(User)
    
    # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä—ã, —á—Ç–æ–±—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏–∑–º–µ–Ω—è—Ç—å –∏—Ö
    filters_to_apply = filters.copy()
    
    # –°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ä–æ–ª—è–º
    if 'role' in filters_to_apply:
        role_filter = filters_to_apply.pop('role') # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º, —á—Ç–æ–±—ã –Ω–µ –ø–æ–ø–∞—Å—Ç—å –≤ —Ü–∏–∫–ª –Ω–∏–∂–µ
        if role_filter == 'volunteers':
            stmt = stmt.where(User.role.in_(['volunteer', 'admin', 'main_admin']))
        elif role_filter == 'admins':
            stmt = stmt.where(User.role.in_(['admin', 'main_admin']))
        # –ï—Å–ª–∏ role_filter == 'all', —Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, —ç—Ç–æ —Ñ–∏–ª—å—Ç—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

    # –ü—Ä–∏–º–µ–Ω—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –∞—Ç—Ä–∏–±—É—Ç–∞–º
    for key, value in filters_to_apply.items():
        if hasattr(User, key):
            stmt = stmt.where(getattr(User, key) == value)

    result = await session.execute(stmt.order_by(User.id))
    return result.scalars().all()


async def add_user_waiver(session: AsyncSession, user_id: int, end_date: datetime.date, reason: str):
    """–°–æ–∑–¥–∞–µ—Ç –º–µ–¥–æ—Ç–≤–æ–¥ –æ—Ç –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    waiver = MedicalWaiver(
        user_id=user_id,
        start_date=datetime.date.today(),
        end_date=end_date,
        reason=reason,
        created_by='user' 
    )
    session.add(waiver)
    await session.commit()

async def delete_user_waiver(session: AsyncSession, waiver_id: int, user_id: int) -> bool:
    """
    –£–¥–∞–ª—è–µ—Ç –º–µ–¥–æ—Ç–≤–æ–¥, –µ—Å–ª–∏ –æ–Ω –±—ã–ª —Å–æ–∑–¥–∞–Ω —ç—Ç–∏–º –∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True –≤ —Å–ª—É—á–∞–µ —É—Å–ø–µ—Ö–∞.
    """
    stmt = (
        delete(MedicalWaiver)
        .where(
            MedicalWaiver.id == waiver_id,
            MedicalWaiver.user_id == user_id,
            MedicalWaiver.created_by == 'user'
        )
    )
    result = await session.execute(stmt)
    await session.commit()
    return result.rowcount > 0

async def check_recent_survey(session: AsyncSession, user_id: int) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø—Ä–æ—Ö–æ–¥–∏–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –æ–ø—Ä–æ—Å–Ω–∏–∫ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ –¥–∞, –∏–Ω–∞—á–µ False.
    """
    twenty_four_hours_ago = datetime.datetime.now(datetime.timezone.utc) - datetime.timedelta(hours=24)
    
    stmt = (
        select(Survey)
        .where(
            Survey.user_id == user_id,
            Survey.passed == True,
            Survey.created_at >= twenty_four_hours_ago
        )
        .order_by(Survey.created_at.desc())
        .limit(1)
    )
    
    result = await session.execute(stmt)
    recent_survey = result.scalar_one_or_none()
    
    return recent_survey is not None


async def get_unlinked_user_by_fio(session: AsyncSession, full_name: str) -> User | None:
    """
    –ò—â–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –§–ò–û —Å—Ä–µ–¥–∏ —Ç–µ—Ö, —É –∫–æ–≥–æ telegram_id <= 0.
    """
    stmt = select(User).where(
        User.full_name == full_name,
        User.telegram_id <= 0
    )
    result = await session.execute(stmt)
    return result.scalar_one_or_none()


async def is_profile_complete(session: AsyncSession, user_id: int) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –≤—Å–µ –ª–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã.
    """
    user = await session.get(User, user_id)
    if not user:
        return False

    required_fields = ['full_name', 'phone_number', 'university', 'faculty', 'study_group', 'gender']
    for field in required_fields:
        if not getattr(user, field):
            return False
    return True

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/db/user_requests.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/db/__init__.py ---

from . import user_requests
from . import event_requests
from . import merch_requests
from . import admin_requests
from . import info_requests
from . import question_requests

__all__ = [
    "user_requests",
    "event_requests",
    "merch_requests",
    "admin_requests",
    "info_requests",
    "question_requests",
]

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/db/__init__.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/filters/role.py ---

from typing import Union
from aiogram.filters import BaseFilter
from aiogram.types import Message, CallbackQuery
from bot.db import user_requests
from sqlalchemy.ext.asyncio import AsyncSession

ROLE_HIERARCHY = {
    'student': 0,
    'volunteer': 1,
    'admin': 2,
    'main_admin': 3
}

class RoleFilter(BaseFilter):
    def __init__(self, required_role: str):
        self.required_level = ROLE_HIERARCHY.get(required_role, 0)

    async def __call__(self, event: Union[Message, CallbackQuery], session: AsyncSession) -> bool:
        user = await user_requests.get_user_by_tg_id(session, event.from_user.id)
        if not user:
            return False
        
        if user.is_blocked:
            return False
            
        user_level = ROLE_HIERARCHY.get(user.role, 0)
        return user_level >= self.required_level

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/filters/role.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/handlers/common.py ---

from aiogram import Router, F, types
from aiogram.filters import CommandStart, Command, StateFilter
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import any_state
from aiogram.types import ReplyKeyboardRemove
from sqlalchemy.ext.asyncio import AsyncSession
from aiogram.exceptions import TelegramBadRequest

from bot.db import user_requests
from bot.states.states import Registration
from bot.keyboards import reply, inline
from bot.utils.text_messages import Text
from bot.utils.graduation import calculate_graduation_year
from bot.filters.role import RoleFilter

ROLE_MENU_MAP = {
    'student': inline.get_student_main_menu,
    'volunteer': inline.get_volunteer_main_menu,
    'admin': inline.get_admin_main_menu,
    'main_admin': inline.get_main_admin_main_menu
}

router = Router()

# =============================================================================
# --- –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò/–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ú–ï–ù–Æ ---
# =============================================================================

async def send_or_edit_main_menu(
    event: types.Message | types.CallbackQuery, 
    session: AsyncSession, 
    welcome_text: str = None, 
    force_role: str = None
):
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é –û–î–ù–ò–ú —Å–æ–æ–±—â–µ–Ω–∏–µ–º.
    """
    user = await user_requests.get_user_by_tg_id(session, event.from_user.id)
    message_to_handle = getattr(event, 'message', event)
    
    
    if not user:
        if isinstance(event, types.CallbackQuery):
            await event.answer(Text.ERROR_PROFILE_NOT_FOUND, show_alert=True)
        else:
            await message_to_handle.answer(Text.WELCOME, reply_markup=reply.get_contact_keyboard())
        return

    if user.is_blocked:
        await message_to_handle.answer(Text.USER_BLOCKED_MESSAGE, reply_markup=ReplyKeyboardRemove())
        return

    if welcome_text:
        greeting = welcome_text
    elif force_role == 'student':
        greeting = Text.SWITCH_TO_DONOR_VIEW
    else:
        greeting = Text.WELCOME_BACK.format(name=user.full_name)

    combined_text = f"{greeting}\n\n{Text.MAIN_MENU_PROMPT}"
    effective_role = force_role if force_role else user.role
    menu_func = ROLE_MENU_MAP.get(effective_role, inline.get_student_main_menu)
    inline_kbd = menu_func(viewer_role=user.role)

    if isinstance(event, types.Message):
        await message_to_handle.answer(
            combined_text,
            reply_markup=inline_kbd,
            parse_mode="HTML"
        )
    elif isinstance(event, types.CallbackQuery):
        try:
            await message_to_handle.edit_text(combined_text, reply_markup=inline_kbd, parse_mode="HTML")
        except TelegramBadRequest as e:
            if "message is not modified" in str(e):
                await event.answer()
            else:
                await message_to_handle.delete()
                await message_to_handle.answer(combined_text, reply_markup=inline_kbd, parse_mode="HTML")
        await event.answer()


@router.message(F.text == "üè† –î–æ–º–æ–π")
@router.message(CommandStart())
async def cmd_start_or_home(message: types.Message, session: AsyncSession):
    await send_or_edit_main_menu(message, session)


@router.callback_query(F.data == "back_to_main_menu")
async def handle_back_to_main_menu(callback: types.CallbackQuery, session: AsyncSession):
    await send_or_edit_main_menu(callback, session)


@router.callback_query(F.data == "switch_to_donor_view")
async def handle_switch_to_donor_view(callback: types.CallbackQuery, session: AsyncSession):
    await send_or_edit_main_menu(callback, session, force_role='student')


# =============================================================================
# --- –õ–û–ì–ò–ö–ê –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø) ---
# =============================================================================

@router.message(F.contact)
async def handle_contact(message: types.Message, session: AsyncSession, state: FSMContext):
    user = await user_requests.get_user_by_tg_id(session, message.from_user.id)
    if user:
        await send_or_edit_main_menu(message, session, welcome_text=Text.ALREADY_REGISTERED.format(name=user.full_name))
        return

    contact = message.contact
    phone_number = contact.phone_number
    if not phone_number.startswith('+'):
        phone_number = '+' + phone_number

    user_by_phone = await user_requests.get_user_by_phone(session, phone_number)
    if user_by_phone:
        if user_by_phone.is_blocked:
            await message.answer(Text.USER_BLOCKED_ON_AUTH, reply_markup=ReplyKeyboardRemove())
            return

        await user_requests.update_user_credentials(session, user_by_phone.id, message.from_user.id, message.from_user.username)
        await session.commit()

        if not await user_requests.is_profile_complete(session, user_by_phone.id):
            await message.answer("–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å –±—ã–ª –Ω–∞–π–¥–µ–Ω, –Ω–æ –æ–Ω –Ω–µ –ø–æ–ª–æ–Ω. –î–∞–≤–∞–π—Ç–µ –µ–≥–æ –¥–æ–∑–∞–ø–æ–ª–Ω–∏–º.")
            await state.update_data(
                phone_number=user_by_phone.phone_number,
                telegram_id=message.from_user.id,
                telegram_username=message.from_user.username
            )
            await state.set_state(Registration.awaiting_full_name)
            await message.answer(Text.GET_FULL_NAME)
        else:
            await send_or_edit_main_menu(message, session, welcome_text=Text.AUTH_SUCCESS.format(name=user_by_phone.full_name))
    else:
        await state.update_data(
            phone_number=phone_number,
            telegram_id=message.from_user.id,
            telegram_username=message.from_user.username
        )
        await message.answer(Text.START_REGISTRATION, reply_markup=ReplyKeyboardRemove())
        await message.answer(Text.GET_FULL_NAME)
        await state.set_state(Registration.awaiting_full_name)


@router.message(Registration.awaiting_full_name)
async def process_full_name(message: types.Message, state: FSMContext, session: AsyncSession):
    full_name = message.text.strip()

    allowed_chars = "–∞–±–≤–≥–¥–µ—ë–∂–∑–∏–π–∫–ª–º–Ω–æ–ø—Ä—Å—Ç—É—Ñ—Ö—Ü—á—à—â—ä—ã—å—ç—é—è-"
    if not all(c.lower() in allowed_chars or c.isspace() for c in full_name):
        await message.answer(Text.FIO_VALIDATION_ERROR)
        return

    name_parts = full_name.split()
    if len(name_parts) < 2:
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–∞–∫ –º–∏–Ω–∏–º—É–º –§–∞–º–∏–ª–∏—é –∏ –ò–º—è.")
        return

    corrected_name = " ".join([part.strip().capitalize() for part in name_parts])

    user_by_fio = await user_requests.get_unlinked_user_by_fio(session, corrected_name)
    if user_by_fio:
        user_data = await state.get_data()
        await user_requests.update_user_credentials(session, user_by_fio.id, user_data['telegram_id'], user_data['telegram_username'])
        await session.commit()

        if not await user_requests.is_profile_complete(session, user_by_fio.id):
            await message.answer("–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å –±—ã–ª –Ω–∞–π–¥–µ–Ω, –Ω–æ –æ–Ω –Ω–µ –ø–æ–ª–æ–Ω. –î–∞–≤–∞–π—Ç–µ –µ–≥–æ –¥–æ–∑–∞–ø–æ–ª–Ω–∏–º.")
            await state.update_data(full_name=corrected_name)
            await message.answer(Text.GET_CATEGORY, reply_markup=inline.get_category_keyboard())
            await state.set_state(Registration.awaiting_category)
        else:
            await state.clear()
            await send_or_edit_main_menu(message, session,
                                           welcome_text=Text.AUTH_SUCCESS.format(name=user_by_fio.full_name))
        return

    await state.update_data(full_name=corrected_name)

    await message.answer(Text.GET_CATEGORY, reply_markup=inline.get_category_keyboard())
    await state.set_state(Registration.awaiting_category)


# --- –ù–û–í–´–ô –•–ï–ù–î–õ–ï–†: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ---
@router.callback_query(Registration.awaiting_category, F.data.startswith('category_'))
async def process_category(callback: types.CallbackQuery, state: FSMContext):
    category = callback.data.split('_', 1)[1]
    await state.update_data(category=category)

    if category == 'external':
        await state.update_data(university="–í–Ω–µ—à–Ω–∏–π –¥–æ–Ω–æ—Ä", faculty="–ù–µ –ø—Ä–∏–º–µ–Ω–∏–º–æ", study_group="-")
        await callback.message.edit_text(Text.GET_GENDER, reply_markup=inline.get_gender_inline_keyboard())
        await state.set_state(Registration.awaiting_gender)
    elif category == 'student':
        await state.update_data(university="–ù–ò–Ø–£ –ú–ò–§–ò")
        await callback.message.edit_text(Text.GET_FACULTY, reply_markup=inline.get_faculties_keyboard())
        await state.set_state(Registration.awaiting_faculty)
    else: # employee
        await state.update_data(university="–ù–ò–Ø–£ –ú–ò–§–ò", faculty="–°–æ—Ç—Ä—É–¥–Ω–∏–∫", study_group="-")
        await callback.message.edit_text(Text.GET_GENDER, reply_markup=inline.get_gender_inline_keyboard())
        await state.set_state(Registration.awaiting_gender)

    await callback.answer()




@router.callback_query(Registration.awaiting_faculty, F.data.startswith('faculty_'))
async def process_faculty(callback: types.CallbackQuery, state: FSMContext):
    faculty = callback.data.split('_', 1)[1]
    
    if faculty == 'Other':
        await callback.message.edit_text(Text.GET_CUSTOM_FACULTY)
        await state.set_state(Registration.awaiting_custom_faculty_name)
    else:
        await state.update_data(faculty=faculty)
        await callback.message.edit_text(Text.FACULTY_SELECTED.format(faculty=faculty))
        await callback.message.answer(Text.GET_GROUP)
        await state.set_state(Registration.awaiting_study_group)
    
    await callback.answer()


@router.message(Registration.awaiting_custom_faculty_name)
async def process_custom_faculty_name(message: types.Message, state: FSMContext):
    await state.update_data(faculty=message.text)
    await message.answer(Text.GET_GROUP)
    await state.set_state(Registration.awaiting_study_group)


@router.message(Registration.awaiting_study_group)
async def process_study_group(message: types.Message, state: FSMContext):
    group_name = message.text.strip().lower()
    if group_name and group_name[0] not in ['–±', '—Å', '–º', '–∞']:
        await message.answer(
            "–ù–∞–∑–≤–∞–Ω–∏–µ —É—á–µ–±–Ω–æ–π –≥—Ä—É–ø–ø—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.\n"
            "–ü–µ—Ä–≤–∞—è –±—É–∫–≤–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ–¥–Ω–æ–π –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö: "
            "–± - –±–∞–∫–∞–ª–∞–≤—Ä–∏–∞—Ç, —Å - —Å–ø–µ—Ü–∏–∞–ª–∏—Ç–µ—Ç, –º - –º–∞–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä–∞, –∞ - –∞—Å–ø–∏—Ä–∞–Ω—Ç—É—Ä–∞."
        )
        return

    await state.update_data(study_group=message.text)
    await message.answer(Text.GET_GENDER, reply_markup=inline.get_gender_inline_keyboard())
    await state.set_state(Registration.awaiting_gender)


@router.callback_query(Registration.awaiting_gender, F.data.startswith("gender_"))
async def process_gender(callback: types.CallbackQuery, state: FSMContext):
    gender = callback.data.split('_', 1)[1]
    gender_text = "–ú—É–∂—Å–∫–æ–π" if gender == "male" else "–ñ–µ–Ω—Å–∫–∏–π"
    
    await callback.message.edit_text(Text.GENDER_SELECTED.format(gender=gender_text))
    await state.update_data(gender=gender)
    
    await callback.message.answer(
        Text.CONSENT_TEXT, 
        reply_markup=inline.get_consent_keyboard(),
        parse_mode="HTML"
    )
    await state.set_state(Registration.awaiting_consent)
    await callback.answer()



@router.callback_query(Registration.awaiting_consent, F.data == "consent_given")
async def process_consent(callback: types.CallbackQuery, state: FSMContext, session: AsyncSession):
    user_data = await state.get_data()
    telegram_id = user_data.get('telegram_id')

    existing_user = await user_requests.get_user_by_tg_id(session, telegram_id)

    if existing_user:
        update_data = {
            'full_name': user_data.get('full_name'),
            'university': user_data.get('university'),
            'faculty': user_data.get('faculty'),
            'study_group': user_data.get('study_group'),
            'gender': user_data.get('gender'),
            'graduation_year': calculate_graduation_year(user_data.get('study_group')),
        }
        await user_requests.update_user_profile(session, existing_user.id, update_data)
        user_to_greet = await user_requests.get_user_by_id(session, existing_user.id)
    else:
        user_data['consent_given'] = True
        user_data['graduation_year'] = calculate_graduation_year(user_data.get('study_group'))
        user_to_greet = await user_requests.add_user(session, user_data)

    await session.commit()
    await state.clear()

    await callback.message.delete()

    await callback.message.answer(
        text=f"{Text.REGISTRATION_COMPLETE.format(name=user_to_greet.full_name)}\n\n{Text.MAIN_MENU_PROMPT}",
        reply_markup=ROLE_MENU_MAP.get(user_to_greet.role, inline.get_student_main_menu)(
            viewer_role=user_to_greet.role)
    )

    await callback.message.answer(
        text="–¢–µ–ø–µ—Ä—å –≤–∞–º –¥–æ—Å—Ç—É–ø–Ω–æ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.",
        reply_markup=reply.get_home_keyboard()
    )

    await callback.answer()


# =============================================================================
# –ü–†–û–ß–ò–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò
# =============================================================================

@router.message(Command("cancel"), StateFilter(any_state))
@router.callback_query(F.data == "cancel_fsm", StateFilter(any_state))
async def cancel_fsm_handler(event: types.Message | types.CallbackQuery, state: FSMContext, session: AsyncSession):
    current_state = await state.get_state()
    if current_state is None:
        if isinstance(event, types.CallbackQuery): await event.answer()
        return

    await state.clear()
    
    message_to_use = event.message if isinstance(event, types.CallbackQuery) else event
    
    if isinstance(event, types.CallbackQuery):
        await event.message.edit_text(Text.ACTION_CANCELLED)
    else:
        await event.answer(Text.ACTION_CANCELLED)
    
    await send_or_edit_main_menu(message_to_use, session)
    if isinstance(event, types.CallbackQuery):
        await event.answer()


@router.message(Command("secret_admin_123"), RoleFilter('admin'))
async def secret_admin_panel(message: types.Message, session: AsyncSession):
    fake_callback = types.CallbackQuery(
        id=str(message.message_id),
        from_user=message.from_user,
        chat_instance="instance",
        message=message,
        data="admin_panel"
    )
    
    from .admin import show_admin_panel
    await show_admin_panel(fake_callback, session)
    await message.delete()


@router.callback_query(F.data == "switch_to_volunteer_view", RoleFilter('admin'))
async def switch_to_volunteer_view_handler(callback: types.CallbackQuery):
    from aiogram.utils.keyboard import InlineKeyboardBuilder
    builder = InlineKeyboardBuilder()
    builder.row(types.InlineKeyboardButton(text="üì∑ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–æ–Ω–∞—Ü–∏—é (QR)", callback_data="confirm_donation_qr"))
    builder.row(types.InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é –¥–æ–Ω–æ—Ä–∞", callback_data="switch_to_donor_view"))
    await callback.message.edit_text(
        Text.ADMIN_SWITCH_TO_VOLUNTEER_VIEW,
        reply_markup=builder.as_markup(),
        parse_mode="HTML"
    )
    await callback.answer()

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/handlers/common.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/handlers/main_admin.py ---

import io
import csv
import logging
import zipfile 
import datetime
from aiogram import Router, F, types, Bot
from aiogram.fsm.context import FSMContext
from sqlalchemy.ext.asyncio import AsyncSession

from bot.db import admin_requests, user_requests
from bot.states.states import AdminManagement, BlockUser
from bot.keyboards import inline
from bot.filters.role import RoleFilter
from .admin import show_admin_panel as show_admin_panel_logic

# logging.basicConfig(level=logging.INFO)  # –õ–æ–≥–∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã

router = Router()

@router.callback_query(F.data == "main_admin_panel", RoleFilter('main_admin'))
async def show_unified_admin_panel(callback: types.CallbackQuery, session: AsyncSession):
    # –ì–ª–∞–≤–Ω–∞—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Å –¥–æ–ø. –∫–Ω–æ–ø–∫–∞–º–∏ –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∞
    viewer = await user_requests.get_user_by_tg_id(session, callback.from_user.id)
    if not viewer: 
        await callback.answer("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å.", show_alert=True)
        return

    # –ò–°–ü–†–ê–í–õ–ï–ù–û: parse_mode="HTML" –∏ —Ç–µ–∫—Å—Ç —Å HTML —Ç–µ–≥–∞–º–∏
    await callback.message.edit_text(
        text="‚öôÔ∏è <b>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</b>",
        reply_markup=inline.get_admin_panel_keyboard(viewer.role),
        parse_mode="HTML"
    )
    await callback.answer()


# @router.callback_query(F.data == "main_admin_panel", RoleFilter('main_admin'))
# async def show_main_admin_panel(callback: types.CallbackQuery):
#     await callback.message.edit_text(
#         text="üëë *–ü–∞–Ω–µ–ª—å –ì–ª–∞–≤–Ω–æ–≥–æ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞*",
#         reply_markup=inline.get_main_admin_panel_keyboard(),
#         parse_mode="Markdown"
#     )
#     await callback.answer()

# @router.callback_query(F.data == "admin_panel", RoleFilter('main_admin'))
# async def show_admin_panel_for_main_admin(callback: types.CallbackQuery):
#     await show_admin_panel_logic(callback)

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/handlers/main_admin.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/handlers/other.py ---

from aiogram import Router, types
from sqlalchemy.ext.asyncio import AsyncSession
from bot.db import user_requests
from bot.keyboards import reply
from bot.utils.text_messages import Text

router = Router()

@router.message()
async def handle_unknown_message(message: types.Message, session: AsyncSession):
    user = await user_requests.get_user_by_tg_id(session, message.from_user.id)
    if not user:
        await message.answer(Text.WELCOME, reply_markup=reply.get_contact_keyboard())
    else:
        await message.answer(Text.UNKNOWN_COMMAND)

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/handlers/other.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/handlers/student.py ---

import datetime
import math
import logging
import time
from aiogram import Router, F, types, Bot
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State 
from sqlalchemy.ext.asyncio import AsyncSession
from bot.db import user_requests, event_requests, merch_requests
from bot.config_reader import config
from bot.keyboards import inline
from bot.utils.qr_service import generate_qr
from bot.utils.text_messages import Text
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.exceptions import TelegramBadRequest
from bot.db.models import MerchItem, Feedback, NoShowReport
from bot.states.states import UserWaiver, FeedbackSurvey
from aiogram.types import BufferedInputFile, WebAppInfo
from bot.utils.calendar_service import generate_ics_file
from bot.db import info_requests

from bot.states.states import UserWaiver, FeedbackSurvey, AskQuestion
from bot.db import user_requests, event_requests, merch_requests, question_requests 


router = Router()
logger = logging.getLogger(__name__)

# --- –ù–û–í–ê–Ø –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ---
async def show_events_for_registration(message: types.Message, session: AsyncSession, user_id: int):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
    –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö.
    """
    events = await event_requests.get_active_events_for_user(session, user_id)
    text = ""
    reply_markup = None

    if not events:
        text = "‚úÖ –ü—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.\n\n–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –¥–ª—è –∑–∞–ø–∏—Å–∏ —Å–µ–π—á–∞—Å –Ω–µ—Ç."
        builder = InlineKeyboardBuilder()
        builder.row(types.InlineKeyboardButton(text="‚Ü©Ô∏è –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main_menu"))
        reply_markup = builder.as_markup()
    else:
        text = "‚úÖ –ü—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.\n\n–í–æ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π:"
        builder = InlineKeyboardBuilder()
        for event in events:
            builder.row(types.InlineKeyboardButton(
                text=f"{event.event_datetime.strftime('%d.%m.%Y')} - {event.name}",
                callback_data=f"reg_event_{event.id}"
            ))
        builder.row(types.InlineKeyboardButton(text="‚Ü©Ô∏è –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main_menu"))
        reply_markup = builder.as_markup()
    
    # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ, –∏–Ω–∞—á–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
    try:
        await message.edit_text(text, reply_markup=reply_markup)
    except TelegramBadRequest:
        try:
            await message.delete()
        except TelegramBadRequest:
            pass # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å - –Ω–µ —Å—Ç—Ä–∞—à–Ω–æ
        await message.answer(text, reply_markup=reply_markup)


# --- üë§ –ú–û–ô –ü–†–û–§–ò–õ–¨ ---

@router.callback_query(F.data == "my_profile")
async def show_profile_menu(callback: types.CallbackQuery):
    await callback.message.edit_text(
        text=Text.PROFILE_MENU_HEADER,
        reply_markup=inline.get_profile_menu_keyboard(),
        parse_mode="HTML"
    )
    await callback.answer()

@router.callback_query(F.data == "profile_data")
async def show_profile_data(callback: types.CallbackQuery, session: AsyncSession):
    user = await user_requests.get_user_by_tg_id(session, callback.from_user.id)
    profile_data = await user_requests.get_user_profile_info(session, user.id)
    if not profile_data:
        await callback.answer(Text.PROFILE_LOAD_ERROR, show_alert=True)
        return
    
    user_obj = profile_data['user']
    last_donation = profile_data['last_donation']
    
    if last_donation:
        blood_center = last_donation.event.blood_center_name if last_donation.event else "–ù–µ —É–∫–∞–∑–∞–Ω"
        last_donation_info = f"{last_donation.donation_date.strftime('%d.%m.%Y')} ({Text.escape_html(blood_center)})"
    else:
        last_donation_info = "–ï—â–µ –Ω–µ –±—ã–ª–æ"

    dkm_status = "–î–∞" if user_obj.is_dkm_donor else "–ù–µ—Ç"

    text = Text.PROFILE_DATA_TEMPLATE.format(
        full_name=Text.escape_html(user_obj.full_name),
        university=Text.escape_html(user_obj.university),
        faculty=Text.escape_html(user_obj.faculty or '–ù–µ —É–∫–∞–∑–∞–Ω'),
        study_group=Text.escape_html(user_obj.study_group or '–ù–µ —É–∫–∞–∑–∞–Ω–∞'),
        points=user_obj.points,
        total_donations=profile_data['total_donations'],
        next_date=profile_data['next_possible_donation'].strftime('%d.%m.%Y'),
        last_donation_info=last_donation_info,
        dkm_status=dkm_status
    )
    
    await callback.message.edit_text(text, reply_markup=inline.get_back_to_profile_menu_keyboard(), parse_mode="HTML")
    await callback.answer()

@router.callback_query(F.data == "profile_history")
async def show_donation_history(callback: types.CallbackQuery, session: AsyncSession):
    user = await user_requests.get_user_by_tg_id(session, callback.from_user.id)
    donations = await user_requests.get_user_donation_history(session, user.id)
    if not donations:
        await callback.message.edit_text(Text.NO_DONATION_HISTORY, reply_markup=inline.get_back_to_profile_menu_keyboard())
        return
    history_text = Text.DONATION_HISTORY_HEADER
    for donation in donations:
        donation_type_ru = Text.DONATION_TYPE_RU.get(donation.donation_type, donation.donation_type)
        history_text += Text.DONATION_HISTORY_ITEM.format(
            date=donation.donation_date.strftime('%d.%m.%Y'),
            type=Text.escape_html(donation_type_ru), 
            points=donation.points_awarded
        )
    await callback.message.edit_text(history_text, reply_markup=inline.get_back_to_profile_menu_keyboard(), parse_mode="HTML")
    await callback.answer()

# --- üìÖ –ó–ê–ü–ò–°–¨ –ù–ê –î–û–ù–ê–¶–ò–Æ ---

@router.callback_query(F.data == "register_donation")
async def show_survey_or_events(callback: types.CallbackQuery, session: AsyncSession, ngrok_url: str):
    """
    –ì–ª–∞–≤–Ω—ã–π —Ö–µ–Ω–¥–ª–µ—Ä –¥–ª—è "–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –¥–æ–Ω–∞—Ü–∏—é".
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Å–≤–µ–∂–µ–π –∞–Ω–∫–µ—Ç—ã. –ï—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.
    –ï—Å–ª–∏ –Ω–µ—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç WebApp –¥–ª—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –æ–ø—Ä–æ—Å–∞.
    """
    user = await user_requests.get_user_by_tg_id(session, callback.from_user.id)
    if not user:
        await callback.answer(Text.ERROR_PROFILE_NOT_FOUND, show_alert=True)
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–µ–≥–æ–¥–Ω—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
    events = await event_requests.get_active_events_for_user(session, user.id)
    today = datetime.date.today()
    is_today_event_available = any(event.event_datetime.date() == today for event in events)

    if is_today_event_available:
        await show_events_for_registration(callback.message, session, user.id)
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–¥–∞–≤–Ω–µ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–ø—Ä–æ—Å–Ω–∏–∫–∞
    has_recent_survey = await user_requests.check_recent_survey(session, user.id)

    if has_recent_survey:
        # –ï—Å–ª–∏ –æ–ø—Ä–æ—Å–Ω–∏–∫ –ø—Ä–æ–π–¥–µ–Ω, —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
        await callback.answer("–í—ã —É–∂–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ –æ–ø—Ä–æ—Å–Ω–∏–∫. –ü–æ–∫–∞–∑—ã–≤–∞—é –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.")
        await show_events_for_registration(callback.message, session, user.id)
    else:
        # –ï—Å–ª–∏ –æ–ø—Ä–æ—Å–Ω–∏–∫–∞ –Ω–µ—Ç, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ WebApp
        if not ngrok_url:
            await callback.answer("–û—à–∏–±–∫–∞: –°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.", show_alert=True)
            return

        cache_buster = int(time.time())
        webapp_url = f"{ngrok_url}/webapp/index.html?v={cache_buster}"
        
        keyboard = types.InlineKeyboardMarkup(
            inline_keyboard=[[
                types.InlineKeyboardButton(
                    text="üìù –ü—Ä–æ–π—Ç–∏ –æ–ø—Ä–æ—Å –ø–µ—Ä–µ–¥ –¥–æ–Ω–∞—Ü–∏–µ–π",
                    web_app=WebAppInfo(url=webapp_url)
                )
            ],[
                types.InlineKeyboardButton(text="‚Ü©Ô∏è –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main_menu")
            ]]
        )
        
        try:
            await callback.message.edit_text(
                "–ü–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é –Ω–∞ –¥–æ–Ω–∞—Ü–∏—é –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–π—Ç–∏ –Ω–µ–±–æ–ª—å—à–æ–π –æ–ø—Ä–æ—Å –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏–π. "
                "–≠—Ç–æ –∑–∞–π–º–µ—Ç –Ω–µ –±–æ–ª–µ–µ –º–∏–Ω—É—Ç—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—á–∞–π—Ç–µ —á–µ—Å—Ç–Ω–æ.",
                reply_markup=keyboard
            )
        except TelegramBadRequest:
            try:
                await callback.message.delete()
            except TelegramBadRequest:
                pass
            await callback.message.answer(
                "–ü–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é –Ω–∞ –¥–æ–Ω–∞—Ü–∏—é –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–π—Ç–∏ –Ω–µ–±–æ–ª—å—à–æ–π –æ–ø—Ä–æ—Å –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏–π. "
                "–≠—Ç–æ –∑–∞–π–º–µ—Ç –Ω–µ –±–æ–ª–µ–µ –º–∏–Ω—É—Ç—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—á–∞–π—Ç–µ —á–µ—Å—Ç–Ω–æ.",
                reply_markup=keyboard
            )
        await callback.answer()


@router.callback_query(F.data.startswith("reg_event_"))
async def process_event_registration(callback: types.CallbackQuery, session: AsyncSession):
    event_id = int(callback.data.split('_')[-1])
    user = await user_requests.get_user_by_tg_id(session, callback.from_user.id)
    event = await event_requests.get_event_by_id(session, event_id)
    if not user or not event:
        await callback.answer(Text.ERROR_GENERIC_ALERT, show_alert=True)
        return

    safe_event_name = Text.escape_html(event.name)
    
    # –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø—Ä—è–º–æ –∑–¥–µ—Å—å –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
    def get_reg_success_kbd(ev_id: int):
        builder = InlineKeyboardBuilder()
        builder.row(types.InlineKeyboardButton(text="üî≤ –ú–æ–π QR-–∫–æ–¥ –¥–ª—è —ç—Ç–æ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è", callback_data=f"get_event_qr_{ev_id}"))
        builder.row(types.InlineKeyboardButton(text="üóìÔ∏è –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å", callback_data=f"add_to_calendar_{ev_id}"))
        builder.row(types.InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –º–æ—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é", callback_data=f"cancel_reg_{ev_id}"))
        builder.row(types.InlineKeyboardButton(text="‚Ü©Ô∏è –ö —Å–ø–∏—Å–∫—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π", callback_data="register_donation"))
        return builder.as_markup()

    existing_registration = await event_requests.find_specific_registration(session, user.id, event.id)
    if existing_registration:
        location_link = Text.format_location_link(event.location, event.latitude, event.longitude)
        await callback.message.edit_text(
            text=Text.ALREADY_REGISTERED_FOR_EVENT.format(
                event_name=safe_event_name,
                event_location=location_link,
                blood_center_name=event.blood_center.name if event.blood_center else "–ù–µ —É–∫–∞–∑–∞–Ω"
            ),
            reply_markup=get_reg_success_kbd(event.id),
            parse_mode="HTML",
            disable_web_page_preview=True
        )
        await callback.answer()
        return

    is_eligible, reason = await event_requests.check_registration_eligibility(session, user, event)
    if is_eligible:
        await event_requests.add_event_registration(session, user.id, event_id)
        location_link = Text.format_location_link(event.location, event.latitude, event.longitude)
        
        await callback.message.edit_text(
            text=Text.REGISTRATION_SUCCESSFUL.format(
                event_name=safe_event_name,
                event_location=location_link,
                blood_center_name=event.blood_center.name if event.blood_center else "–ù–µ —É–∫–∞–∑–∞–Ω"
            ),
            reply_markup=get_reg_success_kbd(event.id),
            parse_mode="HTML",
            disable_web_page_preview=True 
        )
    else:
        await callback.answer(Text.REGISTRATION_FAILED.format(reason=reason), show_alert=True)


@router.callback_query(F.data.startswith("cancel_reg_"))
async def cancel_my_registration(callback: types.CallbackQuery, session: AsyncSession):
    event_id = int(callback.data.split('_')[-1])
    telegram_id = callback.from_user.id
    user = await user_requests.get_user_by_tg_id(session, telegram_id)
    if not user:
        await callback.answer(Text.ERROR_PROFILE_NOT_FOUND, show_alert=True)
        return
    success = await event_requests.cancel_registration(session, user.id, event_id)
    if success:
        await callback.message.edit_text(
            Text.REGISTRATION_CANCELLED_SUCCESS,
            reply_markup=inline.get_back_to_main_menu_keyboard()
        )
    else:
        await callback.message.edit_text(
            Text.REGISTRATION_CANCELLED_FAIL,
            reply_markup=inline.get_back_to_main_menu_keyboard()
        )
    await callback.answer()

# --- üéÅ –ú–ê–ì–ê–ó–ò–ù –ú–ï–†–ß–ê ---

@router.callback_query(F.data == "merch_store")
@router.callback_query(F.data.startswith("merch_page_"))
async def show_merch_store(callback: types.CallbackQuery, session: AsyncSession):
    page = 1
    if callback.data.startswith("merch_page_"):
        page = int(callback.data.split('_')[-1])
    item, total_items = await merch_requests.get_merch_page(session, page=page)
    if not item:
        await callback.answer(Text.MERCH_NO_ITEMS, show_alert=True)
        return
    user = await user_requests.get_user_by_tg_id(session, callback.from_user.id)
    caption = Text.MERCH_ITEM_CAPTION.format(
        item_name=item.name,
        item_description=item.description,
        item_price=item.price,
        user_points=user.points
    )
    keyboard = inline.get_merch_store_keyboard(item, page, total_items)
    try:
        await callback.message.edit_media(
            media=types.InputMediaPhoto(media=item.photo_file_id, caption=caption, parse_mode="HTML"),
            reply_markup=keyboard
        )
    except TelegramBadRequest as e:
        if "message is not modified" in str(e):
             await callback.answer()
             return
        await callback.message.delete()
        await callback.message.answer_photo(
            photo=item.photo_file_id,
            caption=caption,
            reply_markup=keyboard,
            parse_mode="HTML"
        )
    await callback.answer()

@router.callback_query(F.data.startswith("buy_merch_"))
async def confirm_purchase(callback: types.CallbackQuery, session: AsyncSession):
    item_id = int(callback.data.split('_')[-1])
    item = await merch_requests.get_merch_item_by_id(session, item_id)
    user = await user_requests.get_user_by_tg_id(session, callback.from_user.id)
    if not item:
        await callback.answer(Text.MERCH_ITEM_NOT_FOUND, show_alert=True)
        return
    if user.points < item.price:
        await callback.answer(Text.MERCH_PURCHASE_INSUFFICIENT_FUNDS.format(price=item.price, points=user.points), show_alert=True)
        return
    text = Text.MERCH_PURCHASE_CONFIRMATION.format(
        item_name=item.name,
        item_price=item.price,
        new_balance=user.points - item.price
    )
    await callback.message.edit_caption(
        caption=text,
        reply_markup=inline.get_purchase_confirmation_keyboard(item_id),
        parse_mode="HTML"
    )
    await callback.answer()

@router.callback_query(F.data.startswith("confirm_buy_"))
async def process_purchase(callback: types.CallbackQuery, session: AsyncSession):
    item_id = int(callback.data.split('_')[-1])
    item = await merch_requests.get_merch_item_by_id(session, item_id)
    user = await user_requests.get_user_by_tg_id(session, callback.from_user.id)
    success, message = await merch_requests.create_merch_order(session, user, item)
    if success:
        await session.commit() 
        await callback.message.edit_caption(
            caption=Text.MERCH_PURCHASE_SUCCESS.format(message=message),
            reply_markup=inline.get_back_to_merch_keyboard()
        )
    else:
        await session.rollback() 
        await callback.answer(Text.MERCH_PURCHASE_ERROR.format(message=message), show_alert=True)
    await callback.answer()

@router.callback_query(F.data == "my_orders")
async def show_my_orders(callback: types.CallbackQuery, session: AsyncSession):
    user_id = callback.from_user.id
    user = await user_requests.get_user_by_tg_id(session, user_id)
    orders = await merch_requests.get_user_orders(session, user.id)
    if not orders:
        text = Text.MERCH_NO_ORDERS
    else:
        text = Text.MERCH_ORDERS_HEADER
        for order in orders:
            text += Text.MERCH_ORDER_ITEM.format(
                item_name=Text.escape_html(order.item.name),
                date=order.order_date.strftime('%d.%m.%Y'),
                status=Text.escape_html(Text.MERCH_STATUS_MAP.get(order.status, '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'))
            )
    try:
        await callback.message.edit_text(
            text,
            reply_markup=inline.get_back_to_merch_keyboard(),
            parse_mode="HTML"
        )
    except TelegramBadRequest:
        await callback.answer(Text.MERCH_UPDATE_ERROR, show_alert=True)
    await callback.answer()


# --- ‚öïÔ∏è –ú–û–ò –ú–ï–î–û–¢–í–û–î–´ ---

async def send_waivers_menu(message_to_answer: types.Message, user_tg_id: int, session: AsyncSession):
    user = await user_requests.get_user_by_tg_id(session, user_tg_id)
    
    if not user:
        await message_to_answer.answer(Text.ERROR_PROFILE_NOT_FOUND)
        return

    all_waivers = await user_requests.get_user_active_waivers(session, user.id)
    
    user_created_waivers = [w for w in all_waivers if w.created_by == 'user']
    system_waivers = [w for w in all_waivers if w.created_by != 'user']

    text_parts = [Text.WAIVERS_MENU_HEADER]

    if not all_waivers:
        text_parts.append(Text.NO_ACTIVE_WAIVERS)
    else:
        if system_waivers:
            text_parts.append(Text.SYSTEM_WAIVERS_HEADER)
            for waiver in system_waivers:
                text_parts.append(Text.WAIVER_ITEM_FORMAT.format(
                    end_date=waiver.end_date.strftime('%d.%m.%Y'),
                    reason=Text.escape_html(waiver.reason)
                ))
        
        if user_created_waivers:
            text_parts.append(Text.USER_WAIVERS_HEADER)
            for waiver in user_created_waivers:
                text_parts.append(Text.WAIVER_ITEM_FORMAT.format(
                    end_date=waiver.end_date.strftime('%d.%m.%Y'),
                    reason=Text.escape_html(waiver.reason)
                ))

    text = "\n".join(text_parts)
    keyboard = inline.get_my_waivers_keyboard(user_waivers_exist=bool(user_created_waivers))

    await message_to_answer.answer(text, reply_markup=keyboard, parse_mode="HTML")


@router.callback_query(F.data == "my_waivers")
async def show_my_waivers(callback: types.CallbackQuery, session: AsyncSession):
    try:
        await callback.message.delete()
    except TelegramBadRequest:
        logger.warning("Could not delete message in show_my_waivers, it might have been deleted already.")
    
    await send_waivers_menu(callback.message, callback.from_user.id, session)
    await callback.answer()


@router.callback_query(F.data == "set_user_waiver")
async def set_user_waiver_start(callback: types.CallbackQuery, state: FSMContext):
    await state.set_state(UserWaiver.awaiting_end_date)
    await callback.message.edit_text(Text.WAIVER_SET_PROMPT, parse_mode="HTML")
    await callback.answer()

@router.message(UserWaiver.awaiting_end_date)
async def process_user_waiver_date(message: types.Message, state: FSMContext):
    try:
        end_date = datetime.datetime.strptime(message.text, "%d.%m.%Y").date()
        if end_date <= datetime.date.today():
            await message.answer(Text.WAIVER_DATE_IN_PAST_ERROR)
            return
            
        await state.update_data(end_date=end_date)
        await state.set_state(UserWaiver.awaiting_reason)
        await message.answer(Text.WAIVER_REASON_PROMPT)
    except ValueError:
        await message.answer(Text.DATE_FORMAT_ERROR, parse_mode="HTML")

@router.message(UserWaiver.awaiting_reason)
async def process_user_waiver_reason(message: types.Message, state: FSMContext, session: AsyncSession):
    data = await state.get_data()
    end_date = data['end_date']
    reason = message.text

    user = await user_requests.get_user_by_tg_id(session, message.from_user.id)
    await user_requests.add_user_waiver(session, user.id, end_date, reason)
    
    await state.clear()
    
    await message.answer(Text.WAIVER_SET_SUCCESS.format(end_date=end_date.strftime('%d.%m.%Y')))
    
    await send_waivers_menu(message, message.from_user.id, session)

@router.callback_query(F.data == "cancel_user_waiver")
async def cancel_user_waiver_start(callback: types.CallbackQuery, session: AsyncSession):
    user = await user_requests.get_user_by_tg_id(session, callback.from_user.id)
    all_waivers = await user_requests.get_user_active_waivers(session, user.id)
    user_created_waivers = [w for w in all_waivers if w.created_by == 'user']
    
    if not user_created_waivers:
        await callback.answer(Text.WAIVER_NOTHING_TO_CANCEL, show_alert=True)
        return

    await callback.message.edit_text(
        Text.WAIVER_CANCELLATION_PROMPT,
        reply_markup=inline.get_waiver_cancellation_keyboard(user_created_waivers)
    )
    await callback.answer()

@router.callback_query(F.data.startswith("delete_waiver_"))
async def process_waiver_deletion(callback: types.CallbackQuery, session: AsyncSession):
    waiver_id = int(callback.data.split('_')[-1])
    
    user = await user_requests.get_user_by_tg_id(session, callback.from_user.id)
    if not user:
        await callback.answer(Text.ERROR_PROFILE_NOT_FOUND, show_alert=True)
        return

    user_internal_id = user.id
    success = await user_requests.delete_user_waiver(session, waiver_id, user_internal_id)
    
    if success:
        await callback.answer(Text.WAIVER_CANCEL_SUCCESS, show_alert=True)
    else:
        await callback.answer(Text.WAIVER_CANCEL_FAIL, show_alert=True)
    
    try:
        await callback.message.delete()
    except TelegramBadRequest:
        logger.warning("Could not delete message in process_waiver_deletion.")

    await send_waivers_menu(callback.message, callback.from_user.id, session)


# --- ‚ÑπÔ∏è –ü–û–õ–ï–ó–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø ---

@router.callback_query(F.data == "info")
async def show_info_menu(callback: types.CallbackQuery):
    await callback.message.edit_text(
        text=Text.INFO_MENU_HEADER,
        reply_markup=inline.get_info_menu_keyboard(),
        parse_mode="HTML"
    )
    await callback.answer()


@router.callback_query(F.data.startswith("info_"))
async def show_info_text(callback: types.CallbackQuery, session: AsyncSession):
    section = callback.data.split('_', 1)[1]
    text_to_show = await info_requests.get_info_text(session, section)

    await callback.message.edit_text(text_to_show, reply_markup=inline.get_back_to_info_menu_keyboard(), parse_mode="HTML", disable_web_page_preview=True)
    await callback.answer()

# --- üî≤ –ú–û–ô QR-–ö–û–î ---

@router.callback_query(F.data == "my_qr_code")
async def send_qr_code(callback: types.CallbackQuery):
    await callback.answer(Text.QR_GENERATING)
    qr_data = {"user_id": callback.from_user.id} 
    qr_image_bytes = await generate_qr(qr_data)
    await callback.message.answer_photo(
        photo=types.BufferedInputFile(qr_image_bytes, filename="my_qr.png"),
        caption=Text.QR_GENERAL_CAPTION
    )

@router.callback_query(F.data.startswith("get_event_qr_"))
async def send_event_qr_code(callback: types.CallbackQuery):
    event_id = int(callback.data.split('_')[-1])
    user_id = callback.from_user.id
    qr_data = {
        "user_id": user_id,
        "event_id": event_id
    }
    await callback.answer(Text.QR_GENERATING)
    qr_image_bytes = await generate_qr(qr_data)
    await callback.message.answer_photo(
        photo=types.BufferedInputFile(qr_image_bytes, filename="event_qr.png"),
        caption=Text.QR_EVENT_CAPTION
    )

# --- –ù–û–í–´–ô –•–ï–ù–î–õ–ï–†: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å ---
@router.callback_query(F.data.startswith("add_to_calendar_"))
async def send_calendar_file(callback: types.CallbackQuery, session: AsyncSession):
    event_id = int(callback.data.split('_')[-1])
    event = await event_requests.get_event_by_id(session, event_id)
    if not event:
        await callback.answer("–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.", show_alert=True)
        return

    ics_content = generate_ics_file(event)
    file_to_send = BufferedInputFile(
        file=ics_content.encode('utf-8'),
        filename=f"event_{event.id}.ics"
    )
    
    await callback.message.answer_document(
        document=file_to_send,
        caption=f"üóìÔ∏è –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è ¬´{event.name}¬ª.\n–û—Ç–∫—Ä–æ–π—Ç–µ –µ–≥–æ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –≤ –≤–∞—à –∫–∞–ª–µ–Ω–¥–∞—Ä—å."
    )
    await callback.answer()

# --- FSM –î–õ–Ø –û–ë–†–ê–¢–ù–û–ô –°–í–Ø–ó–ò ---

feedback_router = Router()

@feedback_router.callback_query(FeedbackSurvey.awaiting_well_being, F.data.startswith("fb_wb_"))
async def process_well_being(callback: types.CallbackQuery, state: FSMContext):
    score = int(callback.data.split('_')[-1])
    await state.update_data(well_being_score=score)
    
    if score <= 3: 
        await callback.message.edit_text(Text.FEEDBACK_WELL_BEING_BAD)
        await state.set_state(FeedbackSurvey.awaiting_well_being_comment)
    else:
        await callback.message.edit_text(Text.FEEDBACK_GET_ORGANIZATION_SCORE, reply_markup=inline.get_feedback_organization_keyboard())
        await state.set_state(FeedbackSurvey.awaiting_organization_score)
    await callback.answer()

@feedback_router.message(FeedbackSurvey.awaiting_well_being_comment)
async def process_well_being_comment(message: types.Message, state: FSMContext):
    await state.update_data(well_being_comment=message.text)
    await message.answer(Text.FEEDBACK_GET_ORGANIZATION_SCORE, reply_markup=inline.get_feedback_organization_keyboard())
    await state.set_state(FeedbackSurvey.awaiting_organization_score)

@feedback_router.callback_query(FeedbackSurvey.awaiting_organization_score, F.data.startswith("fb_org_"))
async def process_org_score(callback: types.CallbackQuery, state: FSMContext):
    score = int(callback.data.split('_')[-1])
    await state.update_data(organization_score=score)
    await callback.message.edit_text(Text.FEEDBACK_GET_WHAT_LIKED, reply_markup=inline.get_feedback_skip_keyboard())
    await state.set_state(FeedbackSurvey.awaiting_what_liked)
    await callback.answer()

async def skip_or_process_text(event: types.Message | types.CallbackQuery, state: FSMContext, field_name: str, next_state: State, next_text: str, next_keyboard=None):
    is_callback = hasattr(event, 'message')
    message_to_edit = event.message if is_callback else event
    
    if not is_callback: 
        await state.update_data(**{field_name: event.text})
        try:
            await event.delete()
        except TelegramBadRequest:
            pass
    else:
        await state.update_data(**{field_name: "–ü—Ä–æ–ø—É—â–µ–Ω–æ"})
        await event.answer()

    try:
        await message_to_edit.edit_text(next_text, reply_markup=next_keyboard)
    except TelegramBadRequest:
        await message_to_edit.delete()
        await message_to_edit.answer(next_text, reply_markup=next_keyboard)
        
    await state.set_state(next_state)

@feedback_router.message(FeedbackSurvey.awaiting_what_liked)
@feedback_router.callback_query(FeedbackSurvey.awaiting_what_liked, F.data == "fb_skip_step")
async def process_what_liked(event: types.Message | types.CallbackQuery, state: FSMContext):
    await skip_or_process_text(event, state, 'what_liked', FeedbackSurvey.awaiting_what_disliked, Text.FEEDBACK_GET_WHAT_DISLIKED, inline.get_feedback_skip_keyboard())

@feedback_router.message(FeedbackSurvey.awaiting_what_disliked)
@feedback_router.callback_query(FeedbackSurvey.awaiting_what_disliked, F.data == "fb_skip_step")
async def process_what_disliked(event: types.Message | types.CallbackQuery, state: FSMContext):
    await skip_or_process_text(event, state, 'what_disliked', FeedbackSurvey.awaiting_other_suggestions, Text.FEEDBACK_GET_OTHER_SUGGESTIONS, inline.get_feedback_skip_keyboard())

@feedback_router.message(FeedbackSurvey.awaiting_other_suggestions)
@feedback_router.callback_query(FeedbackSurvey.awaiting_other_suggestions, F.data == "fb_skip_step")
async def process_other_suggestions(event: types.Message | types.CallbackQuery, state: FSMContext, session: AsyncSession):
    is_callback = hasattr(event, 'message')
    message_to_use = event.message if is_callback else event
    data = await state.get_data()

    if not is_callback:
        final_suggestion = event.text
    else:  
        final_suggestion = "–ü—Ä–æ–ø—É—â–µ–Ω–æ"
        await event.answer()

    user = await user_requests.get_user_by_tg_id(session, event.from_user.id)
    
    feedback = Feedback(
        user_id=user.id,
        event_id=data.get('event_id'),
        well_being_score=data.get('well_being_score'),
        well_being_comment=data.get('well_being_comment'),
        organization_score=data.get('organization_score'),
        what_liked=data.get('what_liked'),
        what_disliked=data.get('what_disliked'),
        other_suggestions=final_suggestion
    )
    session.add(feedback)
    await session.commit()
    
    await state.clear()
    
    try:
        await message_to_use.edit_text(Text.FEEDBACK_FINISH)
    except TelegramBadRequest:
        await message_to_use.answer(Text.FEEDBACK_FINISH)
        
        
@router.callback_query(F.data == "ask_question")
async def start_asking_question(callback: types.CallbackQuery, state: FSMContext):
    await state.set_state(AskQuestion.awaiting_question)
    await callback.message.edit_text("–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å, –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—ã —Å–∫–æ—Ä–æ –Ω–∞ –Ω–µ–≥–æ –æ—Ç–≤–µ—Ç—è—Ç.")
    await callback.answer()

@router.message(AskQuestion.awaiting_question)
async def process_question(message: types.Message, state: FSMContext, session: AsyncSession):
    user = await user_requests.get_user_by_tg_id(session, message.from_user.id)
    await question_requests.create_question(session, user.id, message.text)
    await state.clear()
    await message.answer(
        "–°–ø–∞—Å–∏–±–æ! –í–∞—à –≤–æ–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞–º. –û—Ç–≤–µ—Ç –ø—Ä–∏–¥–µ—Ç —Å—é–¥–∞ –∂–µ, –≤ —ç—Ç–æ—Ç —á–∞—Ç.",
        reply_markup=inline.get_back_to_main_menu_keyboard()
    )
    
    
@router.callback_query(F.data.startswith("no_show_"))
async def process_no_show_reason(callback: types.CallbackQuery, session: AsyncSession):
    _, event_id_str, reason = callback.data.split("_")
    event_id = int(event_id_str)
    user = await user_requests.get_user_by_tg_id(session, callback.from_user.id)

    report = NoShowReport(user_id=user.id, event_id=event_id, reason=reason)
    session.add(report)
    await session.commit()
    
    await callback.message.edit_text("–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–≤–µ—Ç! –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –Ω–∞–º –≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –±—É–¥—É—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π.")
    await callback.answer()

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/handlers/student.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/handlers/volunteer.py ---

import datetime
import logging
from aiogram import Router, F, types, Bot
from aiogram.fsm.context import FSMContext
from sqlalchemy.ext.asyncio import AsyncSession
from aiogram.utils.keyboard import InlineKeyboardBuilder

from bot.db import user_requests, event_requests
from bot.filters.role import RoleFilter
from bot.states.states import VolunteerActions
from bot.utils.qr_service import read_qr
from bot.keyboards import inline
from bot.utils.text_messages import Text

router = Router()
logger = logging.getLogger(__name__)

@router.callback_query(F.data == "volunteer_panel", RoleFilter('volunteer'))
async def show_volunteer_panel(callback: types.CallbackQuery):
    await callback.message.edit_text(
        Text.VOLUNTEER_MENU_HEADER,
        reply_markup=inline.get_volunteer_panel_keyboard(),
        parse_mode="HTML"  # –ò–°–ü–†–ê–í–õ–ï–ù–û
    )
    await callback.answer()

@router.callback_query(F.data == "confirm_donation_qr", RoleFilter('volunteer'))
async def start_qr_confirmation(callback: types.CallbackQuery, state: FSMContext):
    await state.clear()
    await state.set_state(VolunteerActions.awaiting_qr_photo)
    await callback.message.edit_text(Text.VOLUNTEER_SEND_QR_PROMPT)
    await callback.answer()

@router.message(VolunteerActions.awaiting_qr_photo, F.photo)
async def process_qr_photo(message: types.Message, state: FSMContext, session: AsyncSession, bot: Bot):
    photo_bytes = (await bot.download(message.photo[-1].file_id)).read()
    qr_data = await read_qr(photo_bytes)

    if not qr_data or "user_id" not in qr_data or "event_id" not in qr_data:
        await message.answer(Text.QR_READ_ERROR)
        await state.clear()
        return

    try:
        donor_tg_id = int(qr_data["user_id"])
        event_id_from_qr = int(qr_data["event_id"])
    except (ValueError, TypeError):
        await message.answer(Text.QR_INVALID_DATA_ERROR)
        await state.clear()
        return

    donor = await user_requests.get_user_by_tg_id(session, donor_tg_id)
    event = await event_requests.get_event_by_id(session, event_id_from_qr)
    
    if not donor or not event:
        await message.answer(Text.QR_DB_LOOKUP_ERROR)
        await state.clear()
        return

    registration = await event_requests.find_specific_registration(session, donor.id, event.id)
    if not registration:
        # –î–ª—è —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ parse_mode –Ω–µ –Ω—É–∂–µ–Ω, —Ç.–∫. –≤ —Ç–µ–∫—Å—Ç–µ –æ—à–∏–±–∫–∏ –Ω–µ—Ç —Ç–µ–≥–æ–≤, –Ω–æ –ª—É—á—à–µ –±—ã—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º
        await message.answer(Text.QR_DONOR_NOT_REGISTERED_ERROR.format(donor_name=donor.full_name), parse_mode="HTML")
        await state.clear()
        return

    if event.event_datetime.date() != datetime.date.today():
        await message.answer(Text.QR_WRONG_DAY_ERROR) # –ó–¥–µ—Å—å –Ω–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, parse_mode –Ω–µ –Ω—É–∂–µ–Ω
        await state.clear()
        return

    await state.update_data(
        donor_id=donor.id,
        event_id=event.id,
        donor_tg_id=donor.telegram_id,
        donor_name=donor.full_name,
        event_name=event.name
    )
    await state.set_state(VolunteerActions.awaiting_confirmation)

    await message.answer(
        Text.VOLUNTEER_CONFIRMATION_PROMPT.format(donor_name=donor.full_name, event_name=event.name),
        reply_markup=inline.get_donation_confirmation_keyboard(donor.id, event.id),
        parse_mode="HTML"  # –ò–°–ü–†–ê–í–õ–ï–ù–û
    )

@router.callback_query(VolunteerActions.awaiting_confirmation, F.data.startswith("confirm_donation_"))
async def process_donation_confirmation(callback: types.CallbackQuery, state: FSMContext, session: AsyncSession, bot: Bot):
    data = await state.get_data()
    donor_id_from_state = data.get("donor_id")
    event_id_from_state = data.get("event_id")
    
    parts = callback.data.split('_')
    donor_id_from_cb = parts[2]
    event_id_from_cb = parts[3]
    
    if not (donor_id_from_state == int(donor_id_from_cb) and event_id_from_state == int(event_id_from_cb)):
        await callback.message.edit_text(Text.VOLUNTEER_CONFIRMATION_ERROR)
        await state.clear()
        return

    await state.clear()
    await callback.message.edit_text(Text.DONATION_CONFIRMING)
    
    donor = await user_requests.get_user_by_id(session, donor_id_from_state)
    registration = await event_requests.find_specific_registration(session, donor_id_from_state, event_id_from_state)

    if not donor or not registration:
        await callback.message.edit_text(Text.DONATION_CONFIRM_ERROR_NO_REG)
        return

    try:
        points_awarded, waiver_end_date = await event_requests.confirm_donation_transaction(session, donor, registration)
        
        success_text = Text.DONATION_CONFIRM_SUCCESS.format(
            donor_name=donor.full_name,
            event_name=registration.event.name,
            points=points_awarded
        )
        await callback.message.edit_text(
            success_text,
            reply_markup=inline.get_volunteer_panel_keyboard(),
            parse_mode="HTML"  # –ò–°–ü–†–ê–í–õ–ï–ù–û
        )
    except Exception as e:
        logger.error(f"Critical error during donation confirmation for user {donor.id}: {e}", exc_info=True)
        await callback.message.edit_text(Text.DONATION_CONFIRM_CRITICAL_ERROR.format(error=e))

    await callback.answer()

@router.message(VolunteerActions.awaiting_qr_photo)
async def process_qr_invalid_input(message: types.Message):
    await message.answer(Text.VOLUNTEER_INVALID_INPUT_QR)

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/handlers/volunteer.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/handlers/__init__.py ---



--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/handlers/__init__.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/handlers/admin/analytics.py ---

import datetime
from aiogram import Router, F, types, Bot
from aiogram.fsm.context import FSMContext
from sqlalchemy.ext.asyncio import AsyncSession

from bot.db import analytics_requests 
from bot.filters.role import RoleFilter
from bot.keyboards import inline
from bot.utils import analytics_service 
from bot.states.states import AdminAnalytics

router = Router(name="admin_analytics")

@router.callback_query(F.data == "admin_analytics", RoleFilter('admin'))
async def show_analytics_menu(callback: types.CallbackQuery):
    await callback.message.edit_text(
        "üìä <b>–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –¥–∞—à–±–æ—Ä–¥</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª:",
        reply_markup=inline.get_analytics_main_menu_keyboard(),
        parse_mode="HTML"
    )
    await callback.answer()

@router.callback_query(F.data == "analytics_kpi", RoleFilter('admin'))
async def show_main_kpi(callback: types.CallbackQuery, session: AsyncSession):
    await callback.answer("‚è≥ –°–æ–±–∏—Ä–∞—é –¥–∞–Ω–Ω—ã–µ...")
    kpi_data = await analytics_requests.get_main_kpi(session)

    text_parts = ["üìà <b>–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (KPI)</b>\n"]
    text_parts.append(f"<b>–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (30–¥):</b> {kpi_data['new_users_30d']}")
    text_parts.append(f"<b>–ê–∫—Ç–∏–≤–Ω—ã–µ –¥–æ–Ω–æ—Ä—ã (90–¥):</b> {kpi_data['active_donors_90d']}")
    text_parts.append(f"<b>–°–µ–π—á–∞—Å –Ω–∞ –º–µ–¥–æ—Ç–≤–æ–¥–µ:</b> {kpi_data['on_waiver_now']}")

    if kpi_data['next_event']:
        event = kpi_data['next_event']
        days_left = (event['date'] - datetime.datetime.now()).days
        text_parts.append(f"\nüîú <b>–ë–ª–∏–∂–∞–π—à–µ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ:</b> ¬´{event['name']}¬ª")
        text_parts.append(f"   - <b>–ó–∞–ø–∏—Å–∞–Ω–æ:</b> {event['registered']}/{event['limit']}")
        text_parts.append(f"   - <b>–û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π:</b> {days_left}")
    else:
        text_parts.append("\n‚ùå –ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π.")
        
    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
    plot_data = await analytics_requests.get_donations_by_month(session)
    plot_image = analytics_service.plot_donations_by_month(plot_data)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é —á–∞—Å—Ç—å
    await callback.message.edit_text(
        "\n".join(text_parts), 
        reply_markup=inline.get_analytics_main_menu_keyboard(),
        parse_mode="HTML"
    )
    # –ï—Å–ª–∏ –≥—Ä–∞—Ñ–∏–∫ —Å–æ–∑–¥–∞–ª—Å—è, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–≥–æ –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
    if plot_image:
        await callback.message.answer_photo(
            photo=types.BufferedInputFile(plot_image.read(), filename="donations_plot.png")
        )

@router.callback_query(F.data == "analytics_events_select", RoleFilter('admin'))
async def select_event_for_analysis(callback: types.CallbackQuery, session: AsyncSession, state: FSMContext):
    past_events = await analytics_requests.get_past_events_for_analysis(session)
    if not past_events:
        await callback.answer("–ï—â–µ –Ω–µ –±—ã–ª–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –ø—Ä–æ—à–µ–¥—à–µ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.", show_alert=True)
        return

    await callback.message.edit_text(
        "üìÖ <b>–ê–Ω–∞–ª–∏–∑ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞:",
        reply_markup=inline.get_events_for_analysis_keyboard(past_events)
    )
    await state.set_state(AdminAnalytics.choosing_event_for_analysis)
    await callback.answer()

@router.callback_query(AdminAnalytics.choosing_event_for_analysis, F.data.startswith("analyze_event_"))
async def show_event_analysis(callback: types.CallbackQuery, session: AsyncSession, state: FSMContext):
    await state.clear()
    event_id = int(callback.data.split("_")[-1])
    
    await callback.answer("‚è≥ –°–æ–±–∏—Ä–∞—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é...")
    data = await analytics_requests.get_event_analysis_data(session, event_id)

    if not data:
        await callback.message.edit_text("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ —ç—Ç–æ–º—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é.")
        return

    text = [
        f"üìä <b>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é ¬´{data['event_name']}¬ª</b>\n",
        "<b>–í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è:</b>",
        f"  - –ó–∞–ø–∏—Å–∞–ª–æ—Å—å: {data['registered_count']}",
        f"  - –ü—Ä–∏—à–ª–æ: {data['attended_count']}",
        f"  - –ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ —è–≤–∫—É: {data['conversion_rate']:.1f}%\n",
        "<b>–ü–æ—Ä—Ç—Ä–µ—Ç –∞—É–¥–∏—Ç–æ—Ä–∏–∏:</b>",
        f"  - –ù–æ–≤–∏—á–∫–∏: {data['newcomers_count']}",
        f"  - '–í–µ—Ç–µ—Ä–∞–Ω—ã': {data['veterans_count']}\n",
        "<b>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∞–º (–ø—Ä–∏—à–µ–¥—à–∏–µ):</b>"
    ]
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ–∞–∫—É–ª—å—Ç–µ—Ç—ã –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    sorted_faculties = sorted(data['faculties_distribution'].items(), key=lambda item: item[1], reverse=True)
    for faculty, count in sorted_faculties:
        text.append(f"  - {faculty}: {count} —á–µ–ª.")

    await callback.message.edit_text(
        "\n".join(text),
        parse_mode="HTML",
        reply_markup=inline.get_analytics_main_menu_keyboard()
    )

@router.callback_query(F.data == "analytics_reports", RoleFilter('admin'))
async def show_reports_menu(callback: types.CallbackQuery):
    await callback.message.edit_text(
        "üìÑ <b>–û—Ç—á–µ—Ç—ã</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –æ—Ç—á–µ—Ç–∞:",
        reply_markup=inline.get_reports_menu_keyboard(),
        parse_mode="HTML"
    )
    await callback.answer()

@router.callback_query(F.data.startswith("report_"), RoleFilter('admin'))
async def generate_report(callback: types.CallbackQuery, session: AsyncSession, bot: Bot):
    report_type = callback.data.split("_", 1)[1]
    report_titles = {
        "churn_donors": "–î–æ–Ω–æ—Ä—ã-–æ–¥–Ω–æ–¥–Ω–µ–≤–∫–∏",
        "lapsed_donors": "–£–≥–∞—Å–∞—é—â–∏–µ –¥–æ–Ω–æ—Ä—ã",
        "top_donors": "–î–æ–Ω–æ—Ä—ã-—á–µ–º–ø–∏–æ–Ω—ã",
        "rare_blood_donors": "–î–æ–Ω–æ—Ä—ã —Ä–µ–¥–∫–æ–π –∫—Ä–æ–≤–∏",
        "top_faculties": "–°–∞–º—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç—ã",
        "dkm_candidates": "–ö–∞–Ω–¥–∏–¥–∞—Ç—ã –≤ —Ä–µ–≥–∏—Å—Ç—Ä –î–ö–ú",
        "survey_dropoff": "–ü–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –æ–ø—Ä–æ—Å–Ω–∏–∫–∞"
    }
    report_title = report_titles.get(report_type, "–û—Ç—á–µ—Ç")

    await callback.answer("‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –æ—Ç—á–µ—Ç...")

    report_data = await analytics_service.create_report(session, report_type)

    if not report_data:
        await callback.message.answer("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç—Ç–æ–≥–æ –æ—Ç—á–µ—Ç–∞.")
        return

    # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –≤ –≤–∏–¥–µ —Ç–∞–±–ª–∏—Ü—ã
    headers = list(report_data[0].keys())
    # –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
    header_map = {
        "full_name": "–§–ò–û", "username": "Username", "donation_date": "–î–∞—Ç–∞ –¥–æ–Ω–∞—Ü–∏–∏",
        "donation_count": "–î–æ–Ω–∞—Ü–∏–π", "last_donation_date": "–ü–æ—Å–ª–µ–¥–Ω—è—è –¥–æ–Ω–∞—Ü–∏—è", "rank": "–†–∞–Ω–≥",
        "blood_group": "–ì—Ä—É–ø–ø–∞ –∫—Ä–æ–≤–∏", "faculty_name": "–§–∞–∫—É–ª—å—Ç–µ—Ç", "survey_date": "–î–∞—Ç–∞ –æ–ø—Ä–æ—Å–Ω–∏–∫–∞"
    }
    pretty_headers = [header_map.get(h, h) for h in headers]

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–æ–∫
    col_widths = {h: len(pretty_headers[i]) for i, h in enumerate(headers)}
    for row in report_data:
        for key, value in row.items():
            col_widths[key] = max(col_widths[key], len(str(value)))

    # –°–æ–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
    report_lines = []
    report_lines.append(f"–û—Ç—á–µ—Ç: {report_title}")
    report_lines.append("=" * (sum(col_widths.values()) + len(col_widths) * 3 -1))

    header_line = "  ".join(h.ljust(col_widths[headers[i]]) for i, h in enumerate(pretty_headers))
    report_lines.append(header_line)
    report_lines.append("-" * len(header_line))

    for row in report_data:
        row_list = []
        for header in headers:
            value = row.get(header, "")
            if isinstance(value, datetime.datetime) or isinstance(value, datetime.date):
                value = value.strftime('%Y-%m-%d')
            row_list.append(str(value).ljust(col_widths[header]))
        report_lines.append("  ".join(row_list))

    report_text = "\n".join(report_lines)

    await bot.send_document(
        chat_id=callback.from_user.id,
        document=types.BufferedInputFile(
            report_text.encode("utf-8"),
            filename=f"report_{report_type}.txt"
        ),
        caption=f"–û—Ç—á–µ—Ç: {report_title}"
    )

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/handlers/admin/analytics.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/handlers/admin/event_management.py ---

import logging
import datetime
import asyncio
import io
import csv
from aiogram import Router, F, types, Bot
from aiogram.fsm.context import FSMContext
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.utils.markdown import hbold
from aiogram.exceptions import TelegramBadRequest, TelegramForbiddenError
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func

from bot.db import admin_requests, event_requests, user_requests
from bot.db.engine import async_session_maker
from bot.filters.role import RoleFilter
from bot.states.states import EventCreation, EventEditing, PostEventProcessing
from bot.keyboards import inline
from bot.db.models import Event, User
from bot.utils.text_messages import Text
from bot.db import analytics_requests


router = Router(name="admin_event_management")
logger = logging.getLogger(__name__)


# =============================================================================
# --- üóìÔ∏è –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–ï–†–û–ü–†–ò–Ø–¢–ò–Ø–ú–ò ---
# =============================================================================

@router.callback_query(F.data == "admin_create_event", RoleFilter('admin'))
async def start_event_creation(callback: types.CallbackQuery, state: FSMContext):
    await state.clear()
    await state.set_state(EventCreation.awaiting_name)
    await callback.message.edit_text(Text.EVENT_CREATE_STEP_1_NAME)
    await callback.answer()

@router.message(EventCreation.awaiting_name)
async def process_event_name(message: types.Message, state: FSMContext):
    await state.update_data(name=message.text)
    await state.set_state(EventCreation.awaiting_datetime)
    await message.answer(Text.EVENT_CREATE_STEP_2_DATE, parse_mode="HTML")

@router.message(EventCreation.awaiting_datetime)
async def process_event_datetime(message: types.Message, state: FSMContext):
    try:
        event_dt = datetime.datetime.strptime(message.text, "%d.%m.%Y %H:%M")
        await state.update_data(event_datetime=event_dt.isoformat())
        await state.set_state(EventCreation.awaiting_location_text)
        await message.answer(Text.EVENT_CREATE_STEP_3_LOCATION_TEXT)
    except ValueError:
        await message.answer(Text.DATE_FORMAT_ERROR, parse_mode="HTML")

@router.message(EventCreation.awaiting_location_text)
async def process_event_location_text(message: types.Message, state: FSMContext):
    await state.update_data(location=message.text)
    await state.set_state(EventCreation.awaiting_location_point)
    await message.answer(Text.EVENT_CREATE_STEP_4_LOCATION_POINT)

@router.message(EventCreation.awaiting_location_point, F.location)
async def process_event_location_point(message: types.Message, state: FSMContext, session: AsyncSession):
    await state.update_data(
        latitude=message.location.latitude,
        longitude=message.location.longitude
    )
    await state.set_state(EventCreation.awaiting_blood_center)

    blood_centers = await admin_requests.get_all_blood_centers(session)
    await message.answer(
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–Ω—Ç—Ä –∫—Ä–æ–≤–∏ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π:",
        reply_markup=inline.get_blood_centers_keyboard(blood_centers)
    )


@router.callback_query(EventCreation.awaiting_blood_center, F.data.startswith("select_blood_center_"))
async def process_blood_center_selection(callback: types.CallbackQuery, state: FSMContext):
    blood_center_id = int(callback.data.split("_")[-1])
    await state.update_data(blood_center_id=blood_center_id)
    await state.set_state(EventCreation.awaiting_donation_type)
    await callback.message.edit_text(
        Text.EVENT_CREATE_STEP_5_TYPE,
        reply_markup=inline.get_donation_type_keyboard()
    )


@router.callback_query(EventCreation.awaiting_blood_center, F.data == "add_new_blood_center")
async def add_new_blood_center(callback: types.CallbackQuery, state: FSMContext):
    await state.set_state(EventCreation.awaiting_new_blood_center_name)
    await callback.message.edit_text("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞ –∫—Ä–æ–≤–∏:")


@router.message(EventCreation.awaiting_new_blood_center_name)
async def process_new_blood_center_name(message: types.Message, state: FSMContext, session: AsyncSession):
    new_blood_center = await admin_requests.create_blood_center(session, message.text)
    await state.update_data(blood_center_id=new_blood_center.id)
    await state.set_state(EventCreation.awaiting_donation_type)
    await message.answer(
        Text.EVENT_CREATE_STEP_5_TYPE,
        reply_markup=inline.get_donation_type_keyboard()
    )

@router.callback_query(EventCreation.awaiting_donation_type, F.data.startswith("settype_"))
async def process_event_donation_type(callback: types.CallbackQuery, state: FSMContext):
    donation_type = callback.data.split('_', 1)[1]
    await state.update_data(donation_type=donation_type)
    await state.set_state(EventCreation.awaiting_points)
    await callback.message.edit_text(Text.EVENT_CREATE_STEP_6_POINTS.format(donation_type=donation_type))
    await callback.answer()

@router.message(EventCreation.awaiting_points)
async def process_event_points(message: types.Message, state: FSMContext):
    try:
        points = int(message.text)
        await state.update_data(points_per_donation=points)
        await state.set_state(EventCreation.awaiting_limit)
        await message.answer(Text.EVENT_CREATE_STEP_7_LIMIT)
    except ValueError:
        await message.answer(Text.EVENT_POINTS_NAN_ERROR)


@router.message(EventCreation.awaiting_limit)
async def process_event_limit(message: types.Message, state: FSMContext, session: AsyncSession):
    try:
        limit = int(message.text)
        await state.update_data(participant_limit=limit)
        await state.set_state(EventCreation.awaiting_confirmation)
        
        event_data = await state.get_data()

        blood_center = await admin_requests.get_blood_center_by_id(session, event_data['blood_center_id'])

        text = Text.EVENT_CREATE_CONFIRMATION.format(
            name=event_data['name'],
            datetime=datetime.datetime.fromisoformat(event_data['event_datetime']).strftime('%d.%m.%Y –≤ %H:%M'),
            location=event_data['location'],
            blood_center_name=blood_center.name,
            location_set="–£–∫–∞–∑–∞–Ω–∞" if event_data.get('latitude') else "–ù–µ —É–∫–∞–∑–∞–Ω–∞",
            type=event_data['donation_type'],
            points=event_data['points_per_donation'],
            limit=event_data['participant_limit']
        )
        
        await message.answer(text, reply_markup=inline.get_event_creation_confirmation_keyboard())
    except ValueError:
        await message.answer(Text.EVENT_LIMIT_NAN_ERROR)

@router.callback_query(EventCreation.awaiting_confirmation, F.data == "confirm_create_event")
async def confirm_event_creation_and_notify(callback: types.CallbackQuery, state: FSMContext, session: AsyncSession, bot: Bot):
    await callback.message.edit_text(Text.EVENT_CREATING_IN_PROGRESS)
    
    event_data = await state.get_data()
    await state.clear()
    
    event_data['event_datetime'] = datetime.datetime.fromisoformat(event_data['event_datetime'])
    new_event = await admin_requests.create_event(session, event_data)
    await session.commit()
    
    await callback.message.answer(Text.EVENT_CREATE_SUCCESS, reply_markup=inline.get_back_to_admin_panel_keyboard())
    
    msg = await callback.message.answer(Text.MAILING_STARTED_NOTIFICATION)
    
    asyncio.create_task(send_new_event_notifications(new_event, bot, msg))
    
    await callback.answer()

async def _send_notification_safe(bot: Bot, user: User, text: str, **kwargs):
    """–ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–¥–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –ª–æ–≤–∏—Ç –æ—à–∏–±–∫–∏."""
    try:
        await bot.send_message(chat_id=user.telegram_id, text=text, **kwargs)
        return True
    except TelegramForbiddenError:
        logger.warning(f"Failed to send notification to user {user.id}. Bot was blocked.")
    except TelegramBadRequest as e:
        if "chat not found" in str(e):
            logger.warning(f"Failed to send notification to user {user.id}. Chat not found.")
        else:
            logger.error(f"Failed to send new event notification to user {user.id}. Error: {e}")
    except Exception as e:
        logger.error(f"Failed to send new event notification to user {user.id}. Unexpected error: {e}")
    return False

async def send_new_event_notifications(event: Event, bot: Bot, status_message: types.Message):
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–∞—Å—Å—ã–ª–∫—É –æ –Ω–æ–≤–æ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, –∏—Å–ø–æ–ª—å–∑—É—è asyncio.gather –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞.
    """
    async with async_session_maker() as session:
        try:
            users_to_notify = await user_requests.get_users_for_event_notification(session, event)
            total_users = len(users_to_notify)
            logger.info(f"Starting mailing for event '{event.name}'. Found {total_users} users.")

            if total_users == 0:
                await status_message.edit_text("‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ü–æ–¥—Ö–æ–¥—è—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
                return

            tasks = []
            for user in users_to_notify:
                location_link = Text.format_location_link(event.location, event.latitude, event.longitude)
                safe_event_name = Text.escape_html(event.name)
                
                text = Text.NEW_EVENT_NOTIFICATION.format(
                    event_name=safe_event_name,
                    event_date=event.event_datetime.strftime('%d.%m.%Y'),
                    event_time=event.event_datetime.strftime('%H:%M'),
                    event_location=location_link 
                )
                tasks.append(
                    _send_notification_safe(
                        bot,
                        user, # –ü–µ—Ä–µ–¥–∞–µ–º –≤–µ—Å—å –æ–±—ä–µ–∫—Ç user
                        text,
                        parse_mode="HTML",
                        disable_web_page_preview=True
                    )
                )
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
            results = await asyncio.gather(*tasks)
            
            success_count = sum(1 for r in results if r)
            fail_count = total_users - success_count
            
            await status_message.edit_text(Text.MAILING_FINISHED_NOTIFICATION.format(success=success_count, fail=fail_count))
        except Exception as e:
            logger.error(f"Critical error during new event mailing for event {event.id}: {e}", exc_info=True)
            await status_message.edit_text(Text.MAILING_ERROR)


@router.callback_query(F.data == "admin_view_events", RoleFilter('admin'))
async def view_active_events(callback: types.CallbackQuery, session: AsyncSession):
    events = await event_requests.get_active_events(session)
    if not events:
        await callback.message.edit_text(Text.ADMIN_NO_ACTIVE_EVENTS, reply_markup=inline.get_events_management_keyboard())
        await callback.answer()
        return

    builder = InlineKeyboardBuilder()
    for event in events:
        prefix = "‚úÖ" if event.registration_is_open else "üîí"
        builder.row(types.InlineKeyboardButton(
            text=f"{prefix} {event.event_datetime.strftime('%d.%m')} - {event.name}", 
            callback_data=f"admin_show_event_{event.id}"
        ))
    builder.row(types.InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="admin_manage_events"))
    
    await callback.message.edit_text(Text.ADMIN_CHOOSE_EVENT_TO_MANAGE, reply_markup=builder.as_markup())
    await callback.answer()

@router.callback_query(F.data.startswith("admin_show_event_"), RoleFilter('admin'))
async def show_single_event_card(callback: types.CallbackQuery, session: AsyncSession):
    event_id = int(callback.data.split('_')[-1])
    event = await event_requests.get_event_by_id(session, event_id)
    if not event:
        await callback.answer(Text.EVENT_NOT_FOUND, show_alert=True)
        return
    
    reg_count = await admin_requests.get_event_registrations_count(session, event_id)
    donation_type_ru = Text.DONATION_TYPE_RU.get(event.donation_type, event.donation_type)
    
    feedback_count = await session.scalar(select(func.count(admin_requests.Feedback.id)).where(admin_requests.Feedback.event_id == event_id))
        
    text = Text.EVENT_CARD_TEMPLATE.format(
        name=hbold(event.name),
        date_header=hbold('–î–∞—Ç–∞:'),
        datetime=event.event_datetime.strftime('%d.%m.%Y –≤ %H:%M'),
        location_header=hbold('–ú–µ—Å—Ç–æ:'),
        location=Text.escape_html(event.location),
        blood_center_name=event.blood_center.name if event.blood_center else "–ù–µ —É–∫–∞–∑–∞–Ω",
        type_header=hbold('–¢–∏–ø –¥–æ–Ω–∞—Ü–∏–∏:'),
        donation_type=donation_type_ru,
        points_header=hbold('–ë–∞–ª–ª—ã:'),
        points_per_donation=event.points_per_donation,
        limit_header=hbold('–ó–∞–ø–∏—Å–∞–Ω–æ/–õ–∏–º–∏—Ç:'),
        reg_count=reg_count,
        participant_limit=event.participant_limit,
        status_header=hbold('–°—Ç–∞—Ç—É—Å:'),
        is_active='–ê–∫—Ç–∏–≤–Ω–æ' if event.is_active else '–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–æ',
        reg_status_header=hbold('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:'),
        reg_is_open='–û—Ç–∫—Ä—ã—Ç–∞' if event.registration_is_open else '–ó–∞–∫—Ä—ã—Ç–∞'
    )

    await callback.message.edit_text(
        text, 
        reply_markup=inline.get_single_event_management_keyboard(event.id, event.registration_is_open, has_feedback=(feedback_count > 0)), 
        parse_mode="HTML"
    )
    await callback.answer()

@router.callback_query(F.data.startswith("admin_toggle_reg_"), RoleFilter('admin'))
async def toggle_event_registration(callback: types.CallbackQuery, session: AsyncSession):
    event_id = int(callback.data.split('_')[-1])
    new_status = await admin_requests.toggle_event_registration_status(session, event_id)
    await session.commit()
    alert_text = Text.EVENT_TOGGLE_REG_OPEN if new_status else Text.EVENT_TOGGLE_REG_CLOSED
    await callback.answer(alert_text, show_alert=True)
    await show_single_event_card(callback, session)

@router.callback_query(F.data.startswith("admin_edit_event_"), RoleFilter('admin'))
async def start_event_editing(callback: types.CallbackQuery, state: FSMContext, session: AsyncSession):
    await state.clear()
    event_id = int(callback.data.split('_')[-1])
    event = await event_requests.get_event_by_id(session, event_id)
    if not event: return
    
    await state.update_data(event_id=event_id)
    await state.set_state(EventEditing.choosing_field)
    
    fields = {"name": "–ù–∞–∑–≤–∞–Ω–∏–µ", "event_date": "–î–∞—Ç–∞", "location": "–ú–µ—Å—Ç–æ", "blood_center_id": "–¶–µ–Ω—Ç—Ä –∫—Ä–æ–≤–∏", "points_per_donation": "–ë–∞–ª–ª—ã", "participant_limit": "–õ–∏–º–∏—Ç"}
    builder = InlineKeyboardBuilder()
    for key, name in fields.items():
        builder.row(types.InlineKeyboardButton(text=f"–ò–∑–º–µ–Ω–∏—Ç—å: {name}", callback_data=f"edit_field_{key}"))
    builder.row(types.InlineKeyboardButton(text="‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å", callback_data=f"admin_show_event_{event_id}"))
    
    await callback.message.edit_text(Text.EVENT_EDIT_PROMPT.format(event_name=event.name), reply_markup=builder.as_markup(), parse_mode="HTML")
    await callback.answer()

@router.callback_query(EventEditing.choosing_field, F.data.startswith("edit_field_"))
async def choose_field_to_edit(callback: types.CallbackQuery, state: FSMContext, session: AsyncSession):
    field_to_edit = callback.data.split('_', 2)[-1]
    await state.update_data(field_to_edit=field_to_edit)

    if field_to_edit == "blood_center_id":
        await state.set_state(EventEditing.awaiting_new_value)
        blood_centers = await admin_requests.get_all_blood_centers(session)
        await callback.message.edit_text(
            "–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä –∫—Ä–æ–≤–∏:",
            reply_markup=inline.get_blood_centers_keyboard(blood_centers, edit_mode=True)
        )
    else:
        await state.set_state(EventEditing.awaiting_new_value)
        prompt = Text.EVENT_EDIT_FIELD_PROMPTS.get(field_to_edit, "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:")
        await callback.message.edit_text(prompt)

    await callback.answer()

@router.message(EventEditing.awaiting_new_value, F.text)
async def process_new_value_for_event(message: types.Message, state: FSMContext, session: AsyncSession):
    data = await state.get_data()
    field, event_id, new_value_str = data.get("field_to_edit"), data.get("event_id"), message.text
    
    try:
        if field == "event_date": update_value = datetime.datetime.strptime(new_value_str, "%d.%m.%Y %H:%M")
        elif field in ["points_per_donation", "participant_limit"]: update_value = int(new_value_str)
        else: update_value = new_value_str
    except ValueError:
        await message.answer(Text.EVENT_EDIT_INVALID_FORMAT)
        return
        
    await admin_requests.update_event_field(session, event_id, field, update_value)
    await session.commit()
    await state.clear()
    await message.answer(Text.EVENT_EDIT_SUCCESS, reply_markup=inline.get_back_to_admin_panel_keyboard())

@router.callback_query(EventEditing.awaiting_new_value, F.data.startswith("select_blood_center_"))
async def process_new_blood_center_for_event(callback: types.CallbackQuery, state: FSMContext, session: AsyncSession):
    data = await state.get_data()
    event_id = data.get("event_id")
    new_blood_center_id = int(callback.data.split("_")[-1])

    await admin_requests.update_event_field(session, event_id, "blood_center_id", new_blood_center_id)
    await session.commit()
    await state.clear()
    await callback.message.edit_text(Text.EVENT_EDIT_SUCCESS, reply_markup=inline.get_back_to_admin_panel_keyboard())


@router.callback_query(EventEditing.awaiting_new_value, F.data == "add_new_blood_center_edit")
async def add_new_blood_center_for_edit(callback: types.CallbackQuery, state: FSMContext):
    await state.set_state(EventEditing.awaiting_new_blood_center_name_for_edit)
    await callback.message.edit_text("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞ –∫—Ä–æ–≤–∏:")


@router.message(EventEditing.awaiting_new_blood_center_name_for_edit)
async def process_new_blood_center_name_for_edit(message: types.Message, state: FSMContext, session: AsyncSession):
    data = await state.get_data()
    event_id = data.get("event_id")
    new_blood_center = await admin_requests.create_blood_center(session, message.text)

    await admin_requests.update_event_field(session, event_id, "blood_center_id", new_blood_center.id)
    await session.commit()
    await state.clear()
    await message.answer(Text.EVENT_EDIT_SUCCESS, reply_markup=inline.get_back_to_admin_panel_keyboard())

@router.callback_query(F.data.startswith("admin_event_participants_"), RoleFilter('admin'))
async def get_event_participants(callback: types.CallbackQuery, session: AsyncSession):
    event_id = int(callback.data.split('_')[-1])
    event, participants_regs = await admin_requests.get_event_with_participants(session, event_id)
    if not event: return await callback.answer(Text.EVENT_NOT_FOUND, show_alert=True)
    if not participants_regs: return await callback.answer(Text.EVENT_NO_PARTICIPANTS.format(event_name=event.name), show_alert=True)

    output = io.StringIO()
    writer = csv.writer(output, delimiter=';')
    writer.writerow(['ID', '–§–ò–û', '–¢–µ–ª–µ—Ñ–æ–Ω', '–§–∞–∫—É–ª—å—Ç–µ—Ç', '–ì—Ä—É–ø–ø–∞', '–°—Ç–∞—Ç—É—Å'])
    for reg in participants_regs:
        writer.writerow([reg.user.id, reg.user.full_name, reg.user.phone_number, reg.user.faculty, reg.user.study_group, reg.status])
    
    output.seek(0)
    file = types.BufferedInputFile(output.getvalue().encode('utf-8-sig'), filename=f"participants_{event.id}.csv")
    await callback.message.answer_document(file, caption=Text.EVENT_PARTICIPANTS_CAPTION.format(event_name=event.name))
    await callback.answer()

@router.callback_query(F.data.startswith("admin_cancel_event_"), RoleFilter('admin'))
async def ask_for_cancellation_confirmation(callback: types.CallbackQuery, session: AsyncSession):
    event_id = int(callback.data.split('_')[-1])
    event = await event_requests.get_event_by_id(session, event_id)
    if not event: return await callback.answer(Text.EVENT_NOT_FOUND, show_alert=True)
    reg_count = await admin_requests.get_event_registrations_count(session, event_id)
    await callback.message.edit_text(
        Text.EVENT_CANCEL_CONFIRMATION.format(event_name=event.name, reg_count=reg_count),
        reply_markup=inline.get_event_cancellation_confirmation_keyboard(event_id),
        parse_mode="HTML"
    )
    await callback.answer()

@router.callback_query(F.data.startswith("admin_confirm_cancel_"), RoleFilter('admin'))
async def confirm_and_cancel_event(callback: types.CallbackQuery, session: AsyncSession, bot: Bot):
    await callback.message.edit_text(Text.EVENT_CANCELLING_IN_PROGRESS)
    event_id = int(callback.data.split('_')[-1])
    event, participants_regs = await admin_requests.get_event_with_participants(session, event_id)
    if not event: return

    success_count, fail_count = 0, 0
    for reg in participants_regs:
        try:
            safe_event_name = Text.escape_html(event.name)
            safe_datetime = Text.escape_html(event.event_datetime.strftime('%d.%m.%Y –≤ %H:%M'))
            text = Text.EVENT_CANCEL_NOTIFICATION_TEXT.format(
                event_name=safe_event_name,
                datetime=safe_datetime
            )
            await bot.send_message(chat_id=reg.user.telegram_id, text=text, parse_mode="HTML")
            success_count += 1
        except Exception as e:
            fail_count += 1
            logger.error(f"Failed to send cancellation to user {reg.user_id} for event {event.id}. Error: {e}")
        await asyncio.sleep(0.1)

    await admin_requests.deactivate_event(session, event_id)
    await session.commit()
    await callback.message.edit_text(
        Text.EVENT_CANCEL_SUCCESS_REPORT.format(event_name=event.name, success=success_count, fail=fail_count),
        reply_markup=inline.get_back_to_events_menu_keyboard(),
        parse_mode="HTML"
    )
    await callback.answer()

@router.callback_query(F.data.startswith("admin_view_feedback_"), RoleFilter('admin'))
async def view_event_feedback(callback: types.CallbackQuery, session: AsyncSession):
    event_id = int(callback.data.split('_')[-1])
    event = await event_requests.get_event_by_id(session, event_id)
    feedbacks = await admin_requests.get_feedback_for_event(session, event_id)

    if not feedbacks:
        await callback.answer(Text.FEEDBACK_ADMIN_NO_FEEDBACK, show_alert=True)
        return

    report = Text.FEEDBACK_ADMIN_HEADER.format(event_name=Text.escape_html(event.name))
    for fb in feedbacks:
        report += Text.FEEDBACK_ADMIN_ITEM.format(
            user_name=Text.escape_html(fb.user.full_name),
            wb_score=fb.well_being_score or "-",
            wb_comment=Text.escape_html(fb.well_being_comment or "-"),
            org_score=fb.organization_score or "-",
            liked=Text.escape_html(fb.what_liked or "-"),
            disliked=Text.escape_html(fb.what_disliked or "-"),
            suggestions=Text.escape_html(fb.other_suggestions or "-")
        )
    
    try:
        await callback.message.delete()
    except Exception:
        logger.warning("Could not delete message in view_event_feedback")

    if len(report) > 4000: # Telegram message limit
        await callback.message.answer("–û—Ç–∑—ã–≤–æ–≤ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ, –æ—Ç–ø—Ä–∞–≤–ª—è—é —Ñ–∞–π–ª–æ–º.")
        file = types.BufferedInputFile(report.encode('utf-8'), filename=f"feedback_{event_id}.txt")
        await callback.message.answer_document(file)
    else:
        try:
            await callback.message.answer(
                report,
                reply_markup=inline.get_back_to_events_menu_keyboard(),
                parse_mode="HTML"
            )
        except TelegramBadRequest:
            await callback.message.delete()
            await callback.message.answer(
                report,
                reply_markup=inline.get_back_to_events_menu_keyboard(),
                parse_mode="HTML"
            )
    
    await callback.answer()
    
    
    
@router.callback_query(F.data == "admin_post_process_dd", RoleFilter('admin'))
async def start_post_processing(callback: types.CallbackQuery, state: FSMContext, session: AsyncSession):
    """–ù–∞—á–∞–ª–æ FSM: –í—ã–±–æ—Ä –ø—Ä–æ—à–µ–¥—à–µ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è."""
    await state.clear()
    past_events = await analytics_requests.get_past_events_for_analysis(session)
    if not past_events:
        await callback.answer("–ù–µ—Ç –ø—Ä–æ—à–µ–¥—à–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.", show_alert=True)
        return

    await state.set_state(PostEventProcessing.choosing_event)
    await callback.message.edit_text(
        "–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ —Ö–æ—Ç–∏—Ç–µ –≤–Ω–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã–µ:",
        reply_markup=inline.get_events_for_post_processing_keyboard(past_events)
    )
    await callback.answer()

async def show_participant_marking_menu(message: types.Message, state: FSMContext, session: AsyncSession):
    """–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ–Ω—é –æ—Ç–º–µ—Ç–∫–∏."""
    data = await state.get_data()
    event_id = data.get("event_id")
    marked_donations = data.get("marked_donations", set())
    marked_dkm = data.get("marked_dkm", set())

    _, participants = await admin_requests.get_event_with_participants(session, event_id)
    if not participants:
        await message.edit_text("–ù–∞ —ç—Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –Ω–µ –±—ã–ª–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.", reply_markup=inline.get_back_to_events_menu_keyboard())
        await state.clear()
        return

    await message.edit_text(
        "–û—Ç–º–µ—Ç—å—Ç–µ, –∫—Ç–æ —Å–¥–∞–ª –∫—Ä–æ–≤—å –∏/–∏–ª–∏ –≤—Å—Ç—É–ø–∏–ª –≤ —Ä–µ–≥–∏—Å—Ç—Ä –î–ö–ú.\n(üü¢ - –æ—Ç–º–µ—á–µ–Ω–æ, ‚ö™Ô∏è - –Ω–µ—Ç)",
        reply_markup=inline.get_participant_marking_keyboard(event_id, participants, marked_donations, marked_dkm)
    )

@router.callback_query(PostEventProcessing.choosing_event, F.data.startswith("post_process_event_"))
async def choose_event_for_processing(callback: types.CallbackQuery, state: FSMContext, session: AsyncSession):
    """–®–∞–≥ 2: –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –≤—ã–±—Ä–∞–Ω–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤."""
    event_id = int(callback.data.split("_")[-1])
    await state.update_data(event_id=event_id, marked_donations=set(), marked_dkm=set())
    await state.set_state(PostEventProcessing.marking_participants)
    await show_participant_marking_menu(callback.message, state, session)
    await callback.answer()
    
@router.callback_query(PostEventProcessing.marking_participants, F.data.startswith("mark_participant_"))
async def mark_participant(callback: types.CallbackQuery, state: FSMContext, session: AsyncSession):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É –æ—Ç–º–µ—Ç–∫–∏ (toggle)."""
    _, _, event_id_str, user_id_str, action = callback.data.split("_")
    user_id = int(user_id_str)

    data = await state.get_data()
    target_set_name = "marked_donations" if action == "donation" else "marked_dkm"
    target_set = data.get(target_set_name, set())

    if user_id in target_set:
        target_set.remove(user_id)
    else:
        target_set.add(user_id)
    
    await state.update_data(**{target_set_name: target_set})
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ
    await show_participant_marking_menu(callback.message, state, session)
    await callback.answer()

@router.callback_query(PostEventProcessing.marking_participants, F.data.startswith("finish_marking_"))
async def finish_marking(callback: types.CallbackQuery, state: FSMContext, session: AsyncSession):
    """–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –æ—Ç–º–µ—Ç–∫–∏ –≤ –ë–î."""
    data = await state.get_data()
    event_id = data.get("event_id")
    marked_donations = data.get("marked_donations", set())
    marked_dkm = data.get("marked_dkm", set())
    await state.clear()

    if not marked_donations:
        await callback.answer("–ù–∏ –æ–¥–∏–Ω —É—á–∞—Å—Ç–Ω–∏–∫ –Ω–µ –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ —Å–¥–∞–≤—à–∏–π –∫—Ä–æ–≤—å.", show_alert=True)
        return
        
    await callback.message.edit_text("‚è≥ –°–æ—Ö—Ä–∞–Ω—è—é –¥–∞–Ω–Ω—ã–µ... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.")

    report_lines = []
    for user_id in marked_donations:
        is_dkm = user_id in marked_dkm
        success, message = await admin_requests.manually_confirm_donation(session, user_id, event_id, is_dkm)
        report_lines.append(message)
    
    await session.commit()
    
    final_report = "‚úÖ <b>–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.</b>\n\n<b>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</b>\n" + "\n".join(report_lines)
    await callback.message.edit_text(final_report, reply_markup=inline.get_back_to_events_menu_keyboard())
    await callback.answer("–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!", show_alert=True)

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/handlers/admin/event_management.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/handlers/admin/info_management.py ---

import logging
from aiogram import Router, F, types
from aiogram.fsm.context import FSMContext
from sqlalchemy.ext.asyncio import AsyncSession

from bot.db import info_requests
from bot.filters.role import RoleFilter
from bot.states.states import EditInfoSection
from bot.keyboards import inline

router = Router(name="admin_info_management")
logger = logging.getLogger(__name__)

@router.callback_query(F.data == "admin_edit_info", RoleFilter('admin'))
async def start_info_editing(callback: types.CallbackQuery, state: FSMContext, session: AsyncSession):
    await state.clear()
    sections = await info_requests.get_all_info_sections(session)
    if not sections:
        await callback.answer("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.", show_alert=True)
        return
        
    await state.set_state(EditInfoSection.choosing_section)
    await callback.message.edit_text(
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ç–∏—Ç–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å:",
        reply_markup=inline.get_info_sections_for_editing_keyboard(sections)
    )
    await callback.answer()

@router.callback_query(EditInfoSection.choosing_section, F.data.startswith("edit_info_"))
async def choose_section_to_edit(callback: types.CallbackQuery, state: FSMContext, session: AsyncSession):
    section_key = callback.data.split("_", 2)[-1]
    current_text = await info_requests.get_info_text(session, section_key)
    
    await state.update_data(section_key=section_key)
    await state.set_state(EditInfoSection.awaiting_new_text)
    
    await callback.message.edit_text(
        f"<b>–¢–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç —Ä–∞–∑–¥–µ–ª–∞ (–¥–ª—è —Å–ø—Ä–∞–≤–∫–∏):</b>\n\n{current_text}\n\n"
        f"<b>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTML-—Ç–µ–≥–∏.</b>",
        parse_mode="HTML"
    )
    await callback.answer()

@router.message(EditInfoSection.awaiting_new_text)
async def process_new_info_text(message: types.Message, state: FSMContext, session: AsyncSession):
    data = await state.get_data()
    section_key = data.get("section_key")
    
    if not section_key:
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        await state.clear()
        return

    await info_requests.update_info_text(session, section_key, message.html_text)
    await state.clear()
    
    await message.answer(
        "‚úÖ –¢–µ–∫—Å—Ç —Ä–∞–∑–¥–µ–ª–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!",
        reply_markup=inline.get_back_to_admin_panel_keyboard()
    )

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/handlers/admin/info_management.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/handlers/admin/mailing.py ---

import logging
import asyncio
from aiogram import Router, F, types, Bot
from aiogram.fsm.context import FSMContext
from sqlalchemy.ext.asyncio import AsyncSession
from aiogram.exceptions import TelegramBadRequest, TelegramForbiddenError

from bot.db.engine import async_session_maker
from bot.db import user_requests, admin_requests
from bot.filters.role import RoleFilter
from bot.states.states import Mailing
from bot.keyboards import inline
from bot.utils.text_messages import Text

router = Router(name="admin_mailing")
logger = logging.getLogger(__name__)


async def show_audience_choice_menu(message: types.Message, state: FSMContext):
    """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –∞—É–¥–∏—Ç–æ—Ä–∏–∏ —Å —Ç–µ–∫—É—â–∏–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏."""
    data = await state.get_data()
    current_filters = data.get("filters", {})
    
    text_parts = [Text.MAILING_STEP_3_AUDIENCE_PROMPT]
    if current_filters:
        text_parts.append("\n<b>–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:</b>")
        for key, value in current_filters.items():
            text_parts.append(f"  - {key.replace('_', ' ').capitalize()}: <code>{value}</code>")
    
    prompt_text = "\n".join(text_parts)

    await message.answer(
        text=prompt_text,
        reply_markup=inline.get_mailing_audience_keyboard(current_filters),
        parse_mode="HTML"
    )

# =============================================================================
# --- üì£ –†–ê–°–°–´–õ–ö–ò (FSM) ---
# =============================================================================

@router.callback_query(F.data == "admin_mailing", RoleFilter('admin'))
async def start_mailing(callback: types.CallbackQuery, state: FSMContext):
    """–®–∞–≥ 1: –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏."""
    await state.clear()
    await state.set_state(Mailing.awaiting_message_text)
    await callback.message.edit_text(Text.MAILING_STEP_1_TEXT_PROMPT, parse_mode="HTML")
    await callback.answer()


@router.message(Mailing.awaiting_message_text)
async def get_mailing_text(message: types.Message, state: FSMContext):
    """–®–∞–≥ 2: –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –º–µ–¥–∏–∞."""
    await state.update_data(
        message_text=message.html_text,
        photo_id=None,
        video_id=None,
        filters={}
    )
    await state.set_state(Mailing.awaiting_media)
    await message.answer(Text.MAILING_STEP_2_MEDIA_PROMPT, reply_markup=inline.get_skip_media_keyboard(), parse_mode="HTML")


@router.message(Mailing.awaiting_media, F.photo)
async def get_mailing_photo(message: types.Message, state: FSMContext):
    await state.update_data(photo_id=message.photo[-1].file_id)
    await state.set_state(Mailing.awaiting_audience_choice)
    await show_audience_choice_menu(message, state)


@router.message(Mailing.awaiting_media, F.video)
async def get_mailing_video(message: types.Message, state: FSMContext):
    await state.update_data(video_id=message.video.file_id)
    await state.set_state(Mailing.awaiting_audience_choice)
    await show_audience_choice_menu(message, state)


@router.callback_query(Mailing.awaiting_media, F.data == "skip_media")
async def skip_media_step(callback: types.CallbackQuery, state: FSMContext):
    await state.set_state(Mailing.awaiting_audience_choice)
    await callback.message.delete()
    await show_audience_choice_menu(callback.message, state)
    await callback.answer()


@router.callback_query(Mailing.awaiting_audience_choice, F.data.startswith("mail_audience_type_"))
async def choose_audience_filter_type(callback: types.CallbackQuery, state: FSMContext, session: AsyncSession):
    """–®–∞–≥ 3.1: –ê–¥–º–∏–Ω –≤—ã–±—Ä–∞–ª —Ç–∏–ø —Ñ–∏–ª—å—Ç—Ä–∞ (–í–£–ó, —Ñ–∞–∫—É–ª—å—Ç–µ—Ç, –≥—Ä—É–ø–ø–∞ –∫—Ä–æ–≤–∏)."""
    filter_type = callback.data.split('_')[-1]
    
    items = []
    prompt_text = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Ñ–∏–ª—å—Ç—Ä–∞"
    
    if filter_type == "university":
        items = await admin_requests.get_distinct_universities(session)
        prompt_text = "–í—ã–±–µ—Ä–∏—Ç–µ –í–£–ó –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:"
    elif filter_type == "faculty":
        items = await admin_requests.get_distinct_faculties(session)
        prompt_text = "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:"

    if not items:
        await callback.answer("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞.", show_alert=True)
        return

    keyboard = inline.get_dynamic_mailing_filter_keyboard(items, filter_type, "mail_audience_back")
    await callback.message.edit_text(prompt_text, reply_markup=keyboard)
    await callback.answer()


@router.callback_query(Mailing.awaiting_audience_choice, F.data.startswith("mail_filter_"))
async def set_audience_filter(callback: types.CallbackQuery, state: FSMContext):
    """–®–∞–≥ 3.2: –ê–¥–º–∏–Ω –≤—ã–±—Ä–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ. –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –º–µ–Ω—é."""
    parts = callback.data.split('_')
    filter_key = parts[2]
    filter_value = '_'.join(parts[3:])

    data = await state.get_data()
    current_filters = data.get("filters", {})
    current_filters[filter_key] = filter_value
    await state.update_data(filters=current_filters)
    
    await callback.message.delete()
    await show_audience_choice_menu(callback.message, state)
    await callback.answer(f"–§–∏–ª—å—Ç—Ä '{filter_value}' –¥–æ–±–∞–≤–ª–µ–Ω!")


@router.callback_query(Mailing.awaiting_audience_choice, F.data == "mail_audience_back")
async def back_to_audience_choice_menu(callback: types.CallbackQuery, state: FSMContext):
    """–í–æ–∑–≤—Ä–∞—Ç –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –∏–∑ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –∑–Ω–∞—á–µ–Ω–∏—è."""
    await callback.message.delete()
    await show_audience_choice_menu(callback.message, state)
    await callback.answer()


@router.callback_query(Mailing.awaiting_audience_choice, F.data == "mail_audience_reset")
async def reset_audience_filters(callback: types.CallbackQuery, state: FSMContext):
    """–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã."""
    await state.update_data(filters={})
    await callback.message.delete()
    await show_audience_choice_menu(callback.message, state)
    await callback.answer("–í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã.", show_alert=True)


@router.callback_query(Mailing.awaiting_audience_choice, F.data == "mail_audience_finish")
async def finish_audience_selection(callback: types.CallbackQuery, state: FSMContext, session: AsyncSession):
    """–®–∞–≥ 4: –ê–¥–º–∏–Ω –Ω–∞–∂–∞–ª '–ì–æ—Ç–æ–≤–æ'. –ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—é."""
    data = await state.get_data()
    filters = data.get("filters", {})
    
    if not filters:
        await callback.answer("–í—ã –Ω–µ –≤—ã–±—Ä–∞–ª–∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞!", show_alert=True)
        return

    audience_text_parts = []
    for key, value in filters.items():
        audience_text_parts.append(f"{key.replace('_', ' ').capitalize()}: {value}")
    audience_text = " –∏ ".join(audience_text_parts)

    users_to_notify = await user_requests.get_users_for_mailing(session, filters)
    recipient_count = len(users_to_notify)

    message_text = data.get("message_text")
    photo_id = data.get("photo_id")
    video_id = data.get("video_id")
    
    preview_text = Text.MAILING_PREVIEW_HEADER.format(audience=audience_text, count=recipient_count)
    if photo_id: preview_text += Text.MAILING_PREVIEW_WITH_PHOTO
    if video_id: preview_text += Text.MAILING_PREVIEW_WITH_VIDEO
    preview_text += Text.MAILING_PREVIEW_TEXT_HEADER.format(text=message_text)
            
    await state.set_state(Mailing.awaiting_confirmation)
    
    await callback.message.delete()
    await callback.message.answer(preview_text, reply_markup=inline.get_mailing_confirmation_keyboard(), parse_mode="HTML")
    await callback.answer()


# --- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫ ---

@router.callback_query(Mailing.awaiting_confirmation, F.data == "confirm_mailing")
async def confirm_and_start_mailing(callback: types.CallbackQuery, state: FSMContext, bot: Bot):
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç —Ä–∞—Å—Å—ã–ª–∫—É –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ."""
    data = await state.get_data()
    await state.clear()
    
    await callback.message.edit_text(
        Text.MAILING_CONFIRMED_AND_RUNNING,
        reply_markup=inline.get_back_to_admin_panel_keyboard()
    )
    
    asyncio.create_task(do_mailing(
        filters=data.get("filters", {}),
        message_text=data.get("message_text"),
        photo_id=data.get("photo_id"),
        video_id=data.get("video_id"),
        bot=bot
    ))
    await callback.answer()


async def _send_broadcast_safe(bot: Bot, user_id: int, text: str, photo_id: str | None, video_id: str | None):
    """–ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —à–∏—Ä–æ–∫–æ–≤–µ—â–∞—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ."""
    try:
        if photo_id:
            await bot.send_photo(user_id, photo_id, caption=text, parse_mode="HTML")
        elif video_id:
            await bot.send_video(user_id, video_id, caption=text, parse_mode="HTML")
        else:
            await bot.send_message(user_id, text, parse_mode="HTML")
        return True
    except TelegramForbiddenError:
        logger.warning(f"Failed to send broadcast to user {user_id}. Bot was blocked or user deactivated.")
    except TelegramBadRequest as e:
         if "chat not found" in str(e):
             logger.warning(f"Failed to send broadcast to user {user_id}. Chat not found.")
         else:
             logger.error(f"Failed to send broadcast to user {user_id}. Error: {e}")
    except Exception as e:
        logger.error(f"Unexpected error sending broadcast to user {user_id}: {e}")
    return False


async def do_mailing(filters: dict, message_text: str, photo_id: str | None, video_id: str | None, bot: Bot):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º asyncio.gather."""
    logger.info(f"Starting mailing for filters: {filters}")
    async with async_session_maker() as session:
        try:
            users = await user_requests.get_users_for_mailing(session, filters)
            if not users:
                logger.warning("No users found for this mailing criteria.")
                return

            total_users = len(users)
            logger.info(f"Found {total_users} users for mailing.")

            tasks = [
                _send_broadcast_safe(bot, user.telegram_id, message_text, photo_id, video_id)
                for user in users
            ]

            results = await asyncio.gather(*tasks)

            success_count = sum(1 for r in results if r)
            fail_count = total_users - success_count

            logger.info(f"Mailing finished. Sent: {success_count}, Failed: {fail_count}.")

        except Exception as e:
            logger.error(f"Critical error during mailing: {e}", exc_info=True)

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/handlers/admin/mailing.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/handlers/admin/merch_management.py ---

import logging
from aiogram import Router, F, types, Bot
from aiogram.fsm.context import FSMContext
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.exceptions import TelegramBadRequest
from aiogram.utils.markdown import hbold, hlink
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload

from bot.db import admin_requests, user_requests
from bot.filters.role import RoleFilter
from bot.states.states import MerchCreation, MerchEditing
from bot.keyboards import inline
from bot.db.models import MerchOrder
from bot.utils.text_messages import Text

router = Router(name="admin_merch_management")
logger = logging.getLogger(__name__)


# =============================================================================
# --- üõçÔ∏è –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–ê–ì–ê–ó–ò–ù–û–ú ---
# =============================================================================
@router.callback_query(F.data == "admin_manage_merch", RoleFilter('admin'))
async def manage_merch_panel(callback: types.CallbackQuery):
    # –ò–°–ü–†–ê–í–õ–ï–ù–û: parse_mode="HTML"
    await callback.message.edit_text(Text.ADMIN_MERCH_HEADER, reply_markup=inline.get_merch_management_keyboard(), parse_mode="HTML")
    await callback.answer()

# --- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ ---
@router.callback_query(F.data == "admin_create_merch", RoleFilter('admin'))
async def start_merch_creation(callback: types.CallbackQuery, state: FSMContext):
    await state.clear()
    await state.set_state(MerchCreation.awaiting_photo)
    await callback.message.edit_text(Text.MERCH_CREATE_STEP_1_PHOTO)
    await callback.answer()

@router.message(MerchCreation.awaiting_photo, F.photo)
async def process_merch_photo(message: types.Message, state: FSMContext):
    photo_file_id = message.photo[-1].file_id
    await state.update_data(photo_file_id=photo_file_id)
    await state.set_state(MerchCreation.awaiting_name)
    await message.answer(Text.MERCH_PHOTO_RECEIVED)

@router.message(MerchCreation.awaiting_name)
async def process_merch_name(message: types.Message, state: FSMContext):
    await state.update_data(name=message.text)
    await state.set_state(MerchCreation.awaiting_description)
    await message.answer(Text.MERCH_NAME_RECEIVED)

@router.message(MerchCreation.awaiting_description)
async def process_merch_description(message: types.Message, state: FSMContext):
    await state.update_data(description=message.text)
    await state.set_state(MerchCreation.awaiting_price)
    await message.answer(Text.MERCH_DESC_RECEIVED)
    
@router.message(MerchCreation.awaiting_price)
async def process_merch_price(message: types.Message, state: FSMContext, session: AsyncSession):
    try:
        price = int(message.text)
        await state.update_data(price=price)
        item_data = await state.get_data()
        
        if 'photo_file_id' not in item_data or not item_data['photo_file_id']:
            logger.error("photo_file_id is missing from FSM data during merch creation!")
            await message.answer(Text.MERCH_CREATE_PHOTO_ID_ERROR)
            await state.clear()
            return

        await admin_requests.create_merch_item(session, item_data)
        await session.commit()
        await state.clear()
        
        await message.answer(Text.MERCH_CREATE_SUCCESS, reply_markup=inline.get_back_to_admin_panel_keyboard())
    except ValueError:
        await message.answer(Text.MERCH_PRICE_NAN_ERROR)

# --- –ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ ---
@router.callback_query(F.data == "admin_view_merch", RoleFilter('admin'))
async def view_merch_items(callback: types.CallbackQuery, session: AsyncSession):
    items = await admin_requests.get_all_merch_items(session)
    if not items:
        await callback.message.edit_text(Text.ADMIN_NO_MERCH_ITEMS, reply_markup=inline.get_merch_management_keyboard())
        return

    builder = InlineKeyboardBuilder()
    for item in items:
        status = "‚úÖ" if item.is_available else "‚ùå"
        builder.row(types.InlineKeyboardButton(text=f"{status} {item.name} ({item.price}–ë)", callback_data=f"admin_show_merch_{item.id}"))
    builder.row(types.InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="admin_manage_merch"))

    try:
        await callback.message.edit_text(Text.ADMIN_CHOOSE_MERCH_TO_MANAGE, reply_markup=builder.as_markup())
    except TelegramBadRequest:
        await callback.message.delete()
        await callback.message.answer(Text.ADMIN_CHOOSE_MERCH_TO_MANAGE, reply_markup=builder.as_markup())
    await callback.answer()

@router.callback_query(F.data.startswith("admin_show_merch_"), RoleFilter('admin'))
async def show_single_merch_card(callback: types.CallbackQuery, session: AsyncSession):
    item_id = int(callback.data.split('_')[-1])
    item = await admin_requests.get_merch_item_by_id(session, item_id)
    if not item: return await callback.answer(Text.MERCH_ITEM_NOT_FOUND, show_alert=True)

    status_text = '‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω' if item.is_available else '‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω'
    caption = Text.MERCH_CARD_CAPTION.format(
        name=item.name,
        description=item.description,
        price=item.price,
        status=status_text
    )
    # –ò–°–ü–†–ê–í–õ–ï–ù–û: parse_mode="HTML"
    await callback.message.edit_media(media=types.InputMediaPhoto(media=item.photo_file_id, caption=caption, parse_mode="HTML"),
        reply_markup=inline.get_single_merch_management_keyboard(item.id, item.is_available))
    await callback.answer()

@router.callback_query(F.data.startswith("admin_edit_merch_"), RoleFilter('admin'))
async def start_merch_editing(callback: types.CallbackQuery, state: FSMContext, session: AsyncSession):
    await state.clear()
    item_id = int(callback.data.split('_')[-1])
    item = await admin_requests.get_merch_item_by_id(session, item_id)
    if not item: return

    await state.update_data(item_id=item_id)
    await state.set_state(MerchEditing.choosing_field)
    
    fields = {"name": "–ù–∞–∑–≤–∞–Ω–∏–µ", "description": "–û–ø–∏—Å–∞–Ω–∏–µ", "price": "–¶–µ–Ω–∞"}
    builder = InlineKeyboardBuilder()
    for key, name in fields.items():
        builder.row(types.InlineKeyboardButton(text=f"–ò–∑–º–µ–Ω–∏—Ç—å: {name}", callback_data=f"edit_merch_field_{key}"))
    builder.row(types.InlineKeyboardButton(text="‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å", callback_data=f"admin_show_merch_{item_id}"))
    
    # –ò–°–ü–†–ê–í–õ–ï–ù–û: parse_mode="HTML"
    await callback.message.edit_caption(caption=Text.MERCH_EDIT_PROMPT.format(name=item.name), reply_markup=builder.as_markup(), parse_mode="HTML")

@router.callback_query(MerchEditing.choosing_field, F.data.startswith("edit_merch_field_"))
async def choose_merch_field_to_edit(callback: types.CallbackQuery, state: FSMContext):
    field_to_edit = callback.data.split('_', 3)[-1]
    await state.update_data(field_to_edit=field_to_edit)
    await state.set_state(MerchEditing.awaiting_new_value)
    
    prompt = Text.MERCH_EDIT_FIELD_PROMPTS.get(field_to_edit, Text.MERCH_EDIT_NEW_VALUE_PROMPT)
    await callback.message.delete()
    await callback.message.answer(prompt)
    await callback.answer()

@router.message(MerchEditing.awaiting_new_value)
async def process_new_value_for_merch(message: types.Message, state: FSMContext, session: AsyncSession):
    data = await state.get_data()
    field, item_id, new_value_str = data.get("field_to_edit"), data.get("item_id"), message.text
    try:
        update_value = int(new_value_str) if field == "price" else new_value_str
    except ValueError:
        return await message.answer(Text.MERCH_PRICE_NAN_ERROR)

    await admin_requests.update_merch_item_field(session, item_id, field, update_value)
    await session.commit()
    await message.answer(Text.MERCH_EDIT_SUCCESS)
    await state.clear()
    
    item = await admin_requests.get_merch_item_by_id(session, item_id)
    status_text = '‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω' if item.is_available else '‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω'
    caption = Text.MERCH_CARD_CAPTION.format(
        name=item.name,
        description=item.description,
        price=item.price,
        status=status_text
    )
    # –ò–°–ü–†–ê–í–õ–ï–ù–û: parse_mode="HTML"
    await message.answer_photo(photo=item.photo_file_id, caption=caption,
        reply_markup=inline.get_single_merch_management_keyboard(item.id, item.is_available), parse_mode="HTML")

@router.callback_query(F.data.startswith("admin_toggle_merch_"), RoleFilter('admin'))
async def toggle_merch_availability(callback: types.CallbackQuery, session: AsyncSession):
    item_id = int(callback.data.split('_')[-1])
    new_status = await admin_requests.toggle_merch_item_availability(session, item_id)
    await session.commit()
    status_text = '–¥–æ—Å—Ç—É–ø–µ–Ω' if new_status else '–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'
    await callback.answer(Text.MERCH_TOGGLE_AVAILABILITY.format(status=status_text), show_alert=True)
    await show_single_merch_card(callback, session)

@router.callback_query(F.data.startswith("admin_delete_merch_"), RoleFilter('admin'))
async def ask_for_merch_deletion_confirmation(callback: types.CallbackQuery, session: AsyncSession):
    item_id = int(callback.data.split('_')[-1])
    item = await admin_requests.get_merch_item_by_id(session, item_id)
    if not item: return await callback.answer(Text.MERCH_ITEM_NOT_FOUND, show_alert=True)
    
    try: await callback.message.delete()
    except TelegramBadRequest: pass
    
    # –ò–°–ü–†–ê–í–õ–ï–ù–û: parse_mode="HTML"
    await callback.message.answer(
        Text.MERCH_DELETE_CONFIRMATION.format(name=item.name),
        reply_markup=inline.get_merch_deletion_confirmation_keyboard(item_id), parse_mode="HTML")
    await callback.answer()

@router.callback_query(F.data.startswith("admin_confirm_delete_merch_"), RoleFilter('admin'))
async def confirm_and_delete_merch(callback: types.CallbackQuery, session: AsyncSession):
    item_id = int(callback.data.split('_')[-1])
    item = await admin_requests.get_merch_item_by_id(session, item_id)
    if not item: return await callback.answer(Text.MERCH_ITEM_ALREADY_DELETED, show_alert=True)
    
    item_name = item.name
    await admin_requests.delete_merch_item_by_id(session, item_id)
    await session.commit()
    # –ò–°–ü–†–ê–í–õ–ï–ù–û: parse_mode="HTML"
    await callback.message.edit_text(Text.MERCH_DELETE_SUCCESS.format(name=item_name), reply_markup=inline.get_back_to_merch_menu_keyboard(), parse_mode="HTML")
    await callback.answer()

# =============================================================================
# --- üì¶ –û–ë–†–ê–ë–û–¢–ö–ê –ó–ê–ö–ê–ó–û–í ---
# =============================================================================
@router.callback_query(F.data == "admin_process_orders", RoleFilter('admin'))
async def process_orders_list(callback: types.CallbackQuery, session: AsyncSession):
    orders = await admin_requests.get_pending_orders(session)
    if not orders:
        await callback.answer(Text.ADMIN_NO_PENDING_ORDERS, show_alert=True)
        return
    
    text_parts = [Text.ADMIN_PENDING_ORDERS_HEADER]
    builder = InlineKeyboardBuilder()
    for order in orders:
        user_link = hlink(order.user.full_name, f"tg://user?id={order.user.telegram_id}")
        
        if order.user.telegram_username:
            order_info = Text.ADMIN_ORDER_ITEM_TEXT.format(
                order_id=order.id,
                date=order.order_date.strftime('%d.%m %H:%M'),
                item_name=order.item.name,
                user_link=user_link,
                username=order.user.telegram_username,
                phone=order.user.phone_number
            )
        else:
            order_info = Text.ADMIN_ORDER_ITEM_TEXT_NO_USERNAME.format(
                order_id=order.id,
                date=order.order_date.strftime('%d.%m %H:%M'),
                item_name=order.item.name,
                user_link=user_link,
                phone=order.user.phone_number
            )

        text_parts.append(order_info)
        text_parts.append("")
        builder.row(types.InlineKeyboardButton(text=f"‚úÖ –í—ã–¥–∞—Ç—å –∑–∞–∫–∞–∑ ‚Ññ{order.id}", callback_data=f"complete_order_{order.id}"))
    
    builder.row(types.InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="admin_panel"))
    
    await callback.message.edit_text(
        text="\n".join(text_parts), 
        reply_markup=builder.as_markup(), 
        parse_mode="HTML",
        disable_web_page_preview=True
    )
    await callback.answer()
    
@router.callback_query(F.data.startswith("complete_order_"), RoleFilter('admin'))
async def complete_order(callback: types.CallbackQuery, session: AsyncSession, bot: Bot):
    order_id = int(callback.data.split('_')[-1])
    
    admin_user = await user_requests.get_user_by_tg_id(session, callback.from_user.id)
    if not admin_user:
        await callback.answer(Text.ADMIN_COMPLETE_ORDER_ADMIN_ID_ERROR, show_alert=True)
        return

    order = await session.get(MerchOrder, order_id, options=[joinedload(MerchOrder.item), joinedload(MerchOrder.user)])
    if not order or order.status != 'pending_pickup':
        await callback.answer(Text.ADMIN_ORDER_NOT_FOUND_OR_PROCESSED, show_alert=True)
        return

    await admin_requests.complete_order(session, order_id, admin_user.id)
    await session.commit()
    await callback.answer(Text.ADMIN_ORDER_COMPLETED_SUCCESS.format(order_id=order_id), show_alert=True)
    
    try:
        await bot.send_message(
            chat_id=order.user.telegram_id,
            text=Text.USER_ORDER_COMPLETED_NOTIFICATION.format(item_name=order.item.name)
        )
    except Exception as e:
        logger.error(f"Failed to notify user {order.user.id} about order completion: {e}")
    
    await process_orders_list(callback, session)

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/handlers/admin/merch_management.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/handlers/admin/qa_management.py ---

from aiogram import Router, F, types, Bot
from aiogram.fsm.context import FSMContext
from aiogram.utils.keyboard import InlineKeyboardBuilder
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload

from bot.db import question_requests, user_requests
from bot.filters.role import RoleFilter
from bot.states.states import AnswerQuestion
from bot.keyboards import inline
from bot.utils.text_messages import Text

router = Router(name="admin_qa_management")

@router.callback_query(F.data == "admin_answer_questions", RoleFilter('admin'))
async def show_unanswered_questions(callback: types.CallbackQuery, session: AsyncSession):
    questions = await question_requests.get_unanswered_questions(session)
    if not questions:
        await callback.answer("–ù–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç.", show_alert=True)
        return

    builder = InlineKeyboardBuilder()
    for q in questions:
        builder.row(types.InlineKeyboardButton(
            text=f"–û—Ç {q.user.full_name}: {q.question_text[:30]}...",
            callback_data=f"answer_q_{q.id}"
        ))
    builder.row(types.InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="admin_panel"))
    
    await callback.message.edit_text(
        "<b>–ù–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã:</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å, —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å:",
        reply_markup=builder.as_markup(),
        parse_mode="HTML"
    )
    await callback.answer()

@router.callback_query(F.data.startswith("answer_q_"), RoleFilter('admin'))
async def start_answering_question(callback: types.CallbackQuery, state: FSMContext, session: AsyncSession):
    question_id = int(callback.data.split("_")[-1])
    question = await session.get(question_requests.Question, question_id, options=[joinedload(question_requests.Question.user)])
    if not question:
        await callback.answer("–í–æ–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
        return
        
    await state.set_state(AnswerQuestion.awaiting_answer)
    await state.update_data(question_id=question.id, user_to_answer_id=question.user.telegram_id)
    
    await callback.message.edit_text(
        f"<b>–í–æ–ø—Ä–æ—Å –æ—Ç:</b> {question.user.full_name}\n"
        f"<b>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</b>\n<i>{Text.escape_html(question.question_text)}</i>\n\n"
        f"<b>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç:</b>",
        parse_mode="HTML"
    )
    await callback.answer()

@router.message(AnswerQuestion.awaiting_answer)
async def process_answer(message: types.Message, state: FSMContext, session: AsyncSession, bot: Bot):
    data = await state.get_data()
    question_id = data.get("question_id")
    user_to_answer_id = data.get("user_to_answer_id")
    admin_user = await user_requests.get_user_by_tg_id(session, message.from_user.id)
    
    await question_requests.answer_question(session, question_id, message.text, admin_user.id)
    
    question = await session.get(question_requests.Question, question_id)

    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:
        await bot.send_message(
            chat_id=user_to_answer_id,
            text=(
                f"üì® <b>–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –Ω–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å!</b>\n\n"
                f"<b>–í–∞—à –≤–æ–ø—Ä–æ—Å:</b>\n<i>{Text.escape_html(question.question_text)}</i>\n\n"
                f"<b>–û—Ç–≤–µ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–≤:</b>\n{Text.escape_html(message.text)}"
            ),
            parse_mode="HTML"
        )
    except Exception as e:
        await message.answer(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –û—à–∏–±–∫–∞: {e}")

    await state.clear()
    await message.answer("‚úÖ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.", reply_markup=inline.get_back_to_admin_panel_keyboard())

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/handlers/admin/qa_management.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/handlers/admin/system.py ---

import io
import logging
import zipfile
import datetime
import pandas as pd
from aiogram import Router, F, types, Bot
from aiogram.fsm.context import FSMContext  # <-- –í–û–¢ –ù–£–ñ–ù–´–ô –ò–ú–ü–û–†–¢
from sqlalchemy.ext.asyncio import AsyncSession

from bot.db import admin_requests, user_requests
from bot.db.models import User
from bot.filters.role import RoleFilter
from bot.states.states import DataImport
from bot.utils.text_messages import Text

router = Router(name="admin_system")
logger = logging.getLogger(__name__)


# =============================================================================
# --- üíæ –≠–ö–°–ü–û–†–¢ –î–ê–ù–ù–´–• (–¢–û–õ–¨–ö–û –î–õ–Ø –ì–õ–ê–í–ù–û–ì–û –ê–î–ú–ò–ù–ê) ---
# =============================================================================

async def create_full_backup_xlsx(session: AsyncSession) -> io.BytesIO:
    """
    –°–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü, —Å–æ–∑–¥–∞–µ—Ç XLSX-—Ñ–∞–π–ª —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ª–∏—Å—Ç–∞–º–∏.
    """
    all_data_models = await admin_requests.get_all_data_for_export(session)
    
    output_buffer = io.BytesIO()
    with pd.ExcelWriter(output_buffer, engine='openpyxl') as writer:
        for table_name, records in all_data_models.items():
            if not records:
                continue

            data_list = [
                {c.name: getattr(record, c.name) for c in record.__table__.columns}
                for record in records
            ]
            
            df = pd.DataFrame(data_list)
            for col in df.columns:
                if pd.api.types.is_datetime64_any_dtype(df[col]) and df[col].dt.tz is not None:
                    df[col] = df[col].dt.tz_localize(None)
            for col in df.columns:
                if not df[col].dropna().empty:
                    if isinstance(df[col].dropna().iloc[0], (dict, list)):
                        df[col] = df[col].astype(str)
            
            df.to_excel(writer, sheet_name=table_name.capitalize(), index=False)

    output_buffer.seek(0)
    return output_buffer


@router.callback_query(F.data == "ma_export_data", RoleFilter('main_admin'))
async def export_data_start(callback: types.CallbackQuery, session: AsyncSession, bot: Bot):
    """
    –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞ –≤ XLSX.
    """
    msg = await callback.message.edit_text(Text.EXPORT_STARTED)
    await callback.answer()

    try:
        xlsx_archive_bytes = await create_full_backup_xlsx(session)
        
        timestamp = datetime.datetime.now().strftime("%Y-%m-%d_%H-%M")
        filename = f"donor_bot_backup_{timestamp}.xlsx"
        
        await bot.send_document(
            chat_id=callback.from_user.id,
            document=types.BufferedInputFile(xlsx_archive_bytes.read(), filename=filename),
            caption=Text.EXPORT_SUCCESSFUL
        )
        
        await msg.delete()

    except Exception as e:
        logger.error(f"Failed to create data backup: {e}", exc_info=True)
        await msg.edit_text(Text.EXPORT_FAILED)


# =============================================================================
# --- üì• –ò–ú–ü–û–†–¢ –î–ê–ù–ù–´–• (–¢–û–õ–¨–ö–û –î–õ–Ø –ì–õ–ê–í–ù–û–ì–û –ê–î–ú–ò–ù–ê) ---
# =============================================================================

@router.callback_query(F.data == "ma_import_data", RoleFilter('main_admin'))
async def import_data_start(callback: types.CallbackQuery, state: FSMContext):
    await state.set_state(DataImport.awaiting_file)
    await callback.message.edit_text("–û—Ç–ø—Ä–∞–≤—å—Ç–µ .xlsx —Ñ–∞–π–ª –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏: `phone_number` (–¥–ª—è –ø–æ–∏—Å–∫–∞), `full_name`, `university`.")
    await callback.answer()

@router.callback_query(F.data == "ma_import_old_db", RoleFilter('main_admin'))
async def import_old_db_start(callback: types.CallbackQuery, state: FSMContext):
    await state.set_state(DataImport.awaiting_old_db_file)
    await callback.message.edit_text("–û—Ç–ø—Ä–∞–≤—å—Ç–µ .xlsx —Ñ–∞–π–ª –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ —Å—Ç–∞—Ä–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.")
    await callback.answer()


from bot.utils.data_import import import_data_from_file

@router.message(DataImport.awaiting_old_db_file, F.document)
async def process_import_old_db_file(message: types.Message, state: FSMContext, session: AsyncSession, bot: Bot):
    if not message.document.file_name.endswith('.xlsx'):
        await message.answer("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª .xlsx")
        return

    await state.clear()
    status_msg = await message.answer("–§–∞–π–ª –ø–æ–ª—É—á–µ–Ω. –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É...")
    
    file_info = await bot.get_file(message.document.file_id)
    file_bytes = await bot.download_file(file_info.file_path)

    try:
        created_count, updated_count = await import_data_from_file(session, file_bytes)
        await status_msg.edit_text(f"‚úÖ –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!\n\n- –°–æ–∑–¥–∞–Ω–æ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {created_count}\n- –û–±–Ω–æ–≤–ª–µ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö: {updated_count}")
        
    except Exception as e:
        logger.error(f"Error processing XLSX import: {e}", exc_info=True)
        await status_msg.edit_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: {e}")

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/handlers/admin/system.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/handlers/admin/user_management.py ---

import logging
import datetime
from aiogram import Router, F, types, Bot
from aiogram.fsm.context import FSMContext
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.utils.markdown import hbold, hcode
from sqlalchemy.ext.asyncio import AsyncSession

from bot.db import admin_requests, user_requests, event_requests
from bot.filters.role import RoleFilter
from bot.states.states import (
    PointsChange,
    ManualWaiver,
    UserSearch,
    BlockUser,
    AdminAddUser,
)
from bot.keyboards import inline
from bot.utils.text_messages import Text

router = Router(name="admin_user_management")
logger = logging.getLogger(__name__)


# =============================================================================
# --- üë• –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú–ò ---
# =============================================================================

@router.callback_query(F.data == "admin_manage_users", RoleFilter('admin'))
async def manage_users_main_menu(callback: types.CallbackQuery):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏."""
    await callback.message.edit_text(
        Text.ADMIN_USERS_HEADER,
        reply_markup=inline.get_user_management_main_keyboard(),
        parse_mode="HTML"
    )
    await callback.answer()

# --- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π ---
@router.callback_query(F.data.startswith("admin_users_list_page_"), RoleFilter('admin'))
async def show_users_list(callback: types.CallbackQuery, session: AsyncSession):
    page = int(callback.data.split('_')[-1])
    page_size = 10

    users, total_pages = await admin_requests.get_users_page(session, page, page_size)

    if not users:
        await callback.message.edit_text(Text.ADMIN_NO_USERS_IN_DB, reply_markup=inline.get_user_management_main_keyboard())
        await callback.answer()
        return

    text = Text.USERS_LIST_HEADER.format(page=page, total_pages=total_pages)
    builder = InlineKeyboardBuilder()
    for user in users:
        builder.row(types.InlineKeyboardButton(text=f"üë§ {user.full_name}", callback_data=f"admin_show_user_{user.id}"))

    pagination_keyboard = inline.get_users_list_pagination_keyboard(page, total_pages)
    for row in pagination_keyboard.inline_keyboard:
        builder.row(*row)

    await callback.message.edit_text(text, reply_markup=builder.as_markup(), parse_mode="HTML")
    await callback.answer()

# --- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
@router.callback_query(F.data == "admin_search_user", RoleFilter('admin'))
async def search_user_start(callback: types.CallbackQuery, state: FSMContext):
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç FSM –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    await state.clear()
    await state.set_state(UserSearch.awaiting_query)
    await callback.message.edit_text(Text.USER_SEARCH_PROMPT)
    await callback.answer()

@router.message(UserSearch.awaiting_query)
async def process_user_search(message: types.Message, state: FSMContext, session: AsyncSession):
    """–ò—â–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∑–∞–ø—Ä–æ—Å—É –∏ –≤—ã–≤–æ–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç."""
    await state.clear()
    query = message.text
    users_found = await admin_requests.find_user_for_admin(session, query)

    if not users_found:
        await message.answer(Text.USER_SEARCH_NO_RESULTS, reply_markup=inline.get_user_management_main_keyboard())
        return

    text = Text.USER_SEARCH_RESULTS_HEADER.format(query=query)
    builder = InlineKeyboardBuilder()
    for user in users_found:
        builder.row(types.InlineKeyboardButton(text=f"üë§ {user.full_name}", callback_data=f"admin_show_user_{user.id}"))
    builder.row(types.InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="admin_manage_users"))

    await message.answer(text, reply_markup=builder.as_markup(), parse_mode="HTML")

# --- –ö–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–º ---
@router.callback_query(F.data.startswith("admin_show_user_"), RoleFilter('admin'))
async def show_single_user_card(callback: types.CallbackQuery, session: AsyncSession):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π."""
    viewer = await user_requests.get_user_by_tg_id(session, callback.from_user.id)
    if not viewer: return

    target_user_id = int(callback.data.split('_')[-1])
    target_user = await user_requests.get_user_by_id(session, target_user_id)
    if not target_user:
        await callback.answer(Text.USER_NOT_FOUND, show_alert=True)
        return

    block_status = "–ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù" if target_user.is_blocked else "–ê–∫—Ç–∏–≤–µ–Ω"

    text = "\n".join([
        hbold(Text.USER_CARD_HEADER.format(full_name=target_user.full_name)),
        "",
        Text.USER_CARD_TEMPLATE.format(
            full_name=Text.escape_html(target_user.full_name),
            telegram_id=target_user.telegram_id,
            username=Text.escape_html(target_user.telegram_username or '–Ω–µ —É–∫–∞–∑–∞–Ω'),
            phone_number=target_user.phone_number,
            role=target_user.role,
            points=target_user.points,
            block_status=block_status
        )
    ])

    await callback.message.edit_text(
        text,
        reply_markup=inline.get_user_management_keyboard(
            target_user_id=target_user.id,
            target_user_role=target_user.role,
            viewer_role=viewer.role,
            is_blocked=target_user.is_blocked
        ),
        parse_mode="HTML"
    )
    await callback.answer()

# --- +/- –ë–∞–ª–ª—ã (FSM) ---
@router.callback_query(F.data.startswith("admin_points_"), RoleFilter('admin'))
async def change_points_start(callback: types.CallbackQuery, state: FSMContext):
    await state.clear()
    user_id = int(callback.data.split('_')[-1])
    await state.update_data(user_id=user_id)
    await state.set_state(PointsChange.awaiting_points_amount)
    await callback.message.edit_text(Text.CHANGE_POINTS_PROMPT)
    await callback.answer()

@router.message(PointsChange.awaiting_points_amount)
async def change_points_amount(message: types.Message, state: FSMContext):
    try:
        points = int(message.text)
        await state.update_data(points=points)
        await state.set_state(PointsChange.awaiting_reason)
        await message.answer(Text.CHANGE_POINTS_REASON_PROMPT)
    except ValueError:
        await message.answer(Text.EVENT_POINTS_NAN_ERROR)

@router.message(PointsChange.awaiting_reason)
async def change_points_reason(message: types.Message, state: FSMContext, session: AsyncSession, bot: Bot):
    data = await state.get_data()
    reason, user_id, points_change = message.text, data['user_id'], data['points']
    
    user = await user_requests.get_user_by_id(session, user_id)
    if not user:
        await message.answer(Text.USER_NOT_FOUND)
        await state.clear()
        return

    await admin_requests.add_points_to_user(session, user_id, points_change, reason)
    await session.commit()
    await state.clear()

    new_balance = user.points
    await message.answer(
        Text.CHANGE_POINTS_SUCCESS.format(name=user.full_name, balance=new_balance),
        reply_markup=inline.get_back_to_admin_panel_keyboard()
    )

    try:
        await bot.send_message(
            chat_id=user.telegram_id, # –ò–°–ü–†–ê–í–õ–ï–ù–û
            text=Text.USER_POINTS_CHANGED_NOTIFICATION.format(points=points_change, reason=reason, balance=new_balance),
            parse_mode="HTML"
        )
    except Exception as e:
        logger.error(f"Failed to notify user {user_id} about points change: {e}")

# --- –†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏ ---
@router.callback_query(F.data.startswith("admin_promote_volunteer_"), RoleFilter('admin'))
async def promote_to_volunteer(callback: types.CallbackQuery, session: AsyncSession, bot: Bot):
    user_id = int(callback.data.split('_')[-1])
    await admin_requests.change_user_role(session, user_id, 'volunteer')
    await session.commit()
    user = await user_requests.get_user_by_id(session, user_id)
    await callback.answer(Text.USER_PROMOTED_VOLUNTEER.format(name=user.full_name), show_alert=True)
    try:
        await bot.send_message(chat_id=user.telegram_id, text=Text.USER_PROMOTED_VOLUNTEER_NOTIFY)
    except Exception as e:
        logger.error(f"Failed to notify user {user.id} about promotion: {e}")
    await show_single_user_card(callback, session)

@router.callback_query(F.data.startswith("admin_demote_volunteer_"), RoleFilter('admin'))
async def demote_from_volunteer(callback: types.CallbackQuery, session: AsyncSession, bot: Bot):
    user_id = int(callback.data.split('_')[-1])
    await admin_requests.change_user_role(session, user_id, 'student')
    await session.commit()
    user = await user_requests.get_user_by_id(session, user_id)
    await callback.answer(Text.USER_DEMOTED_VOLUNTEER.format(name=user.full_name), show_alert=True)
    try:
        await bot.send_message(chat_id=user.telegram_id, text=Text.USER_DEMOTED_VOLUNTEER_NOTIFY)
    except Exception as e:
        logger.error(f"Failed to notify user {user.id} about demotion: {e}")
    await show_single_user_card(callback, session)

@router.callback_query(F.data.startswith("ma_promote_admin_"), RoleFilter('main_admin'))
async def promote_to_admin(callback: types.CallbackQuery, session: AsyncSession, bot: Bot):
    target_user_id = int(callback.data.split('_')[-1])
    await admin_requests.change_user_role(session, target_user_id, 'admin')
    await session.commit()
    target_user = await user_requests.get_user_by_id(session, target_user_id)
    await callback.answer(Text.USER_PROMOTED_ADMIN.format(name=target_user.full_name), show_alert=True)
    try:
        await bot.send_message(chat_id=target_user.telegram_id, text=Text.USER_PROMOTED_ADMIN_NOTIFY)
    except Exception as e:
        logger.error(f"Failed to notify user {target_user.id} about admin promotion: {e}")
    await show_single_user_card(callback, session)

@router.callback_query(F.data.startswith("ma_demote_admin_"), RoleFilter('main_admin'))
async def demote_from_admin(callback: types.CallbackQuery, session: AsyncSession, bot: Bot):
    target_user_id = int(callback.data.split('_')[-1])
    await admin_requests.change_user_role(session, target_user_id, 'student')
    await session.commit()
    target_user = await user_requests.get_user_by_id(session, target_user_id)
    await callback.answer(Text.USER_DEMOTED_ADMIN.format(name=target_user.full_name), show_alert=True)
    try:
        await bot.send_message(chat_id=target_user.telegram_id, text=Text.USER_DEMOTED_ADMIN_NOTIFY)
    except Exception as e:
        logger.error(f"Failed to notify user {target_user.id} about admin demotion: {e}")
    await show_single_user_card(callback, session)

# --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏ ---
@router.callback_query(F.data.startswith("ma_block_user_"), RoleFilter('main_admin'))
async def block_user_from_card(callback: types.CallbackQuery, state: FSMContext):
    target_user_id = int(callback.data.split('_')[-1])
    await state.clear()
    await state.update_data(user_id=target_user_id)
    await state.set_state(BlockUser.awaiting_reason)
    await callback.message.edit_text(Text.BLOCK_USER_REASON_PROMPT)
    await callback.answer()

@router.message(BlockUser.awaiting_reason)
async def process_block_reason(message: types.Message, state: FSMContext, session: AsyncSession, bot: Bot):
    data = await state.get_data()
    reason = message.text
    target_user_id = data['user_id']

    admin_user = await user_requests.get_user_by_tg_id(session, message.from_user.id)
    if not admin_user:
        await message.answer(Text.ADMIN_ID_ERROR)
        await state.clear()
        return

    target_user = await user_requests.get_user_by_id(session, target_user_id)
    if not target_user:
        await message.answer(Text.BLOCK_TARGET_USER_NOT_FOUND)
        await state.clear()
        return

    await admin_requests.block_user(session, target_user_id, admin_user.id, reason)
    await session.commit()
    await state.clear()

    await message.answer(
        Text.USER_BLOCKED_SUCCESS.format(name=target_user.full_name, reason=reason),
        reply_markup=inline.get_back_to_admin_panel_keyboard()
    )
    try:
        await bot.send_message(chat_id=target_user.telegram_id, text=Text.USER_BLOCKED_NOTIFY.format(reason=reason))
    except Exception as e:
        logger.error(f"Failed to notify user {target_user.id} about block: {e}")

@router.callback_query(F.data.startswith("ma_unblock_user_"), RoleFilter('main_admin'))
async def unblock_user_from_card(callback: types.CallbackQuery, session: AsyncSession, bot: Bot):
    target_user_id = int(callback.data.split('_')[-1])
    await admin_requests.unblock_user(session, target_user_id)
    await session.commit()
    target_user = await user_requests.get_user_by_id(session, target_user_id)
    if not target_user:
        await callback.answer(Text.USER_NOT_FOUND, show_alert=True)
        return

    await callback.answer(Text.USER_UNBLOCKED_SUCCESS.format(name=target_user.full_name), show_alert=True)
    try:
        await bot.send_message(chat_id=target_user.telegram_id, text=Text.USER_UNBLOCKED_NOTIFY)
    except Exception as e:
        logger.error(f"Failed to notify user {target_user.id} about unblock: {e}")
    await show_single_user_card(callback, session)


# --- –†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è–º–∏ ---
@router.callback_query(F.data.startswith("admin_manage_user_regs_"), RoleFilter('admin'))
async def manage_user_registrations_menu(callback: types.CallbackQuery, session: AsyncSession):
    user_id = int(callback.data.split('_')[-1])
    user = await user_requests.get_user_by_id(session, user_id)
    if not user:
        await callback.answer(Text.USER_NOT_FOUND, show_alert=True)
        return

    await callback.message.edit_text(
        Text.MANAGE_USER_REGS_HEADER.format(name=user.full_name),
        reply_markup=inline.get_manual_registration_management_keyboard(user_id),
        parse_mode="HTML"
    )
    await callback.answer()

@router.callback_query(F.data.startswith("admin_reg_start_"), RoleFilter('admin'))
async def show_events_for_manual_registration(callback: types.CallbackQuery, session: AsyncSession):
    user_id = int(callback.data.split('_')[-1])
    events = await event_requests.get_upcoming_events(session)
    if not events:
        await callback.answer(Text.MANUAL_REG_NO_EVENTS, show_alert=True)
        return

    await callback.message.edit_text(
        Text.MANUAL_REG_CHOOSE_EVENT,
        reply_markup=inline.get_events_for_manual_registration_keyboard(user_id, events)
    )
    await callback.answer()

@router.callback_query(F.data.startswith("adminReg_"), RoleFilter('admin'))
async def confirm_manual_registration(callback: types.CallbackQuery, session: AsyncSession, bot: Bot):
    _, user_id_str, event_id_str = callback.data.split('_')
    user_id, event_id = int(user_id_str), int(event_id_str)
    
    user = await user_requests.get_user_by_id(session, user_id)
    event = await event_requests.get_event_by_id(session, event_id)
    if not user or not event:
        await callback.answer(Text.ERROR_GENERIC_ALERT, show_alert=True)
        return

    success, message = await admin_requests.manually_register_user(session, user, event)
    if success:
        await session.commit()
        try:
            await bot.send_message(
                chat_id=user.telegram_id,
                text=Text.MANUAL_REG_SUCCESS_NOTIFY.format(event_name=event.name, date=event.event_datetime.strftime('%d.%m.%Y')),
                parse_mode="HTML"
            )
        except Exception as e:
            logger.error(f"Failed to notify user {user_id} about manual registration: {e}")
            await callback.message.answer(Text.NOTIFY_USER_FAILED.format(name=user.full_name))
    else:
        await session.rollback()

    await callback.answer(message, show_alert=True)
    # This might fail if the original message was deleted, need a robust way to return to menu
    try:
        await manage_user_registrations_menu(callback, session)
    except Exception:
        await callback.message.answer("–í–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é...", reply_markup=inline.get_back_to_admin_panel_keyboard())


@router.callback_query(F.data.startswith("admin_cancel_start_"), RoleFilter('admin'))
async def show_registrations_for_cancellation(callback: types.CallbackQuery, session: AsyncSession):
    user_id = int(callback.data.split('_')[-1])
    registrations = await admin_requests.get_user_registrations(session, user_id)
    
    if not registrations:
        await callback.answer(Text.MANUAL_CANCEL_NO_REGS, show_alert=True)
        return

    await callback.message.edit_text(
        Text.MANUAL_CANCEL_CHOOSE_REG,
        reply_markup=inline.get_registrations_for_cancellation_keyboard(user_id, registrations)
    )
    await callback.answer()

@router.callback_query(F.data.startswith("adminCancel_"), RoleFilter('admin'))
async def confirm_manual_cancellation(callback: types.CallbackQuery, session: AsyncSession, bot: Bot):
    _, user_id_str, event_id_str = callback.data.split('_')
    user_id, event_id = int(user_id_str), int(event_id_str)

    user = await user_requests.get_user_by_id(session, user_id)
    event = await event_requests.get_event_by_id(session, event_id)
    if not user or not event:
        await callback.answer(Text.ERROR_GENERIC_ALERT, show_alert=True)
        return
        
    success = await event_requests.cancel_registration(session, user_id, event_id)
    if success:
        await session.commit()
        await callback.answer(Text.MANUAL_CANCEL_SUCCESS.format(name=user.full_name, event_name=event.name), show_alert=True)
        try:
            await bot.send_message(
                chat_id=user.telegram_id,
                text=Text.MANUAL_CANCEL_SUCCESS_NOTIFY.format(event_name=event.name),
                parse_mode="HTML"
            )
        except Exception as e:
            logger.error(f"Failed to notify user {user_id} about manual cancellation: {e}")
            await callback.message.answer(Text.NOTIFY_USER_FAILED.format(name=user.full_name))
    else:
        await session.rollback()
        await callback.answer(Text.MANUAL_CANCEL_FAIL, show_alert=True)
    
    try:
        await manage_user_registrations_menu(callback, session)
    except Exception:
         await callback.message.answer("–í–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é...", reply_markup=inline.get_back_to_admin_panel_keyboard())


# --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–¥–æ—Ç–≤–æ–¥–∞–º–∏ ---
@router.callback_query(F.data.startswith("admin_manage_waivers_"), RoleFilter('admin'))
async def admin_manage_user_waivers_menu(callback: types.CallbackQuery, session: AsyncSession):
    user_id = int(callback.data.split('_')[-1])
    user = await user_requests.get_user_by_id(session, user_id)
    if not user:
        await callback.answer(Text.USER_NOT_FOUND, show_alert=True)
        return

    waivers = await admin_requests.get_all_user_active_waivers(session, user_id)
    text_header = Text.MANAGE_WAIVERS_HEADER.format(name=user.full_name)
    if not waivers:
        text = text_header + Text.MANAGE_WAIVERS_NO_WAIVERS
    else:
        text = text_header + Text.MANAGE_WAIVERS_WITH_WAIVERS

    await callback.message.edit_text(
        text,
        reply_markup=inline.get_admin_waiver_management_keyboard(user_id, waivers),
        parse_mode="HTML"
    )
    await callback.answer()

@router.callback_query(F.data.startswith("admin_waiver_"), RoleFilter('admin'))
async def set_waiver_start(callback: types.CallbackQuery, state: FSMContext):
    await state.clear()
    user_id = int(callback.data.split('_')[-1])
    await state.update_data(user_id=user_id)
    await state.set_state(ManualWaiver.awaiting_end_date)
    await callback.message.edit_text(Text.MANUAL_WAIVER_DATE_PROMPT)
    await callback.answer()

@router.message(ManualWaiver.awaiting_end_date)
async def set_waiver_date(message: types.Message, state: FSMContext):
    try:
        end_date = datetime.datetime.strptime(message.text, "%d.%m.%Y").date()
        await state.update_data(end_date=end_date)
        await state.set_state(ManualWaiver.awaiting_reason)
        await message.answer(Text.MANUAL_WAIVER_REASON_PROMPT)
    except ValueError:
        await message.answer(Text.DATE_FORMAT_ERROR, parse_mode="HTML")

@router.message(ManualWaiver.awaiting_reason)
async def set_waiver_reason(message: types.Message, state: FSMContext, session: AsyncSession, bot: Bot):
    data = await state.get_data()
    reason, user_id, end_date = message.text, data['user_id'], data['end_date']
    
    admin_user = await user_requests.get_user_by_tg_id(session, message.from_user.id)
    user = await user_requests.get_user_by_id(session, user_id)

    await admin_requests.create_manual_waiver(session, user_id, end_date, reason, admin_user.id)
    await session.commit()
    await state.clear()

    await message.answer(
        Text.MANUAL_WAIVER_SUCCESS.format(name=user.full_name, date=end_date.strftime('%d.%m.%Y')),
        reply_markup=inline.get_back_to_admin_panel_keyboard()
    )
    try:
        await bot.send_message(
            chat_id=user.telegram_id,
            text=Text.MANUAL_WAIVER_NOTIFY.format(date=end_date.strftime('%d.%m.%Y'), reason=reason),
            parse_mode="HTML"
        )
    except Exception as e:
        logger.error(f"Failed to notify user {user_id} about manual waiver: {e}")

@router.callback_query(F.data.startswith("admin_del_waiver_"), RoleFilter('admin'))
async def admin_delete_waiver(callback: types.CallbackQuery, session: AsyncSession, bot: Bot):
    try:
        _, _, _, waiver_id_str, user_id_str = callback.data.split('_')
        waiver_id, user_id = int(waiver_id_str), int(user_id_str)
    except ValueError:
        await callback.answer(Text.ADMIN_DELETE_WAIVER_DATA_ERROR, show_alert=True)
        return

    success = await admin_requests.force_delete_waiver(session, waiver_id)
    if success:
        await session.commit()
        await callback.answer(Text.ADMIN_DELETE_WAIVER_SUCCESS, show_alert=True)
        try:
            user = await user_requests.get_user_by_id(session, user_id)
            if user:
                await bot.send_message(chat_id=user.telegram_id, text=Text.ADMIN_DELETE_WAIVER_NOTIFY)
        except Exception as e:
            logger.error(f"Failed to notify user {user_id} about admin waiver deletion: {e}")
    else:
        await session.rollback()
        await callback.answer(Text.ADMIN_DELETE_WAIVER_FAIL, show_alert=True)
    
    try:
        await admin_manage_user_waivers_menu(callback, session)
    except Exception:
        await callback.message.answer("–í–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é...", reply_markup=inline.get_back_to_admin_panel_keyboard())
        
        
        
        
@router.callback_query(F.data == "admin_add_user_start", RoleFilter('admin'))
async def add_user_start(callback: types.CallbackQuery, state: FSMContext):
    """–ù–∞—á–∞–ª–æ FSM –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    await state.clear()
    await state.set_state(AdminAddUser.awaiting_phone)
    await callback.message.edit_text("<b>–®–∞–≥ 1/8:</b> –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ <code>+7...</code>")
    await callback.answer()

@router.message(AdminAddUser.awaiting_phone)
async def add_user_phone(message: types.Message, state: FSMContext, session: AsyncSession):
    phone_number = message.text
    if not phone_number.startswith('+') or not phone_number[1:].isdigit() or len(phone_number) < 11:
        await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞. –í–≤–µ–¥–∏—Ç–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ <code>+7...</code>")
        return

    existing_user = await user_requests.get_user_by_phone(session, phone_number)
    if existing_user:
        await message.answer(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –Ω–æ–º–µ—Ä–æ–º {phone_number} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: {existing_user.full_name}.")
        await state.clear()
        return

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π ID
    min_user_id = await admin_requests.get_min_user_id(session)
    new_telegram_id = min(0, min_user_id) - 1

    await state.update_data(
        phone_number=phone_number,
        telegram_id=new_telegram_id,
        telegram_username=f"manual_{phone_number}"
    )
    await state.set_state(AdminAddUser.awaiting_full_name)
    await message.answer("<b>–®–∞–≥ 2/8:</b> –í–≤–µ–¥–∏—Ç–µ –§–ò–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")

# –î–∞–ª–µ–µ –º—ã –º–æ–∂–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—á—Ç–∏ —Ç–µ –∂–µ —à–∞–≥–∏, —á—Ç–æ –∏ –ø—Ä–∏ –æ–±—ã—á–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
# –ü—Ä–æ—Å—Ç–æ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∏—Ö –∫ –Ω–∞—à–µ–º—É –Ω–æ–≤–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é AdminAddUser.
# –≠—Ç–æ—Ç –∫–æ–¥ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞ user_management.py

@router.message(AdminAddUser.awaiting_full_name)
async def add_user_full_name(message: types.Message, state: FSMContext):
    await state.update_data(full_name=message.text.strip())
    await state.set_state(AdminAddUser.awaiting_category)
    await message.answer("<b>–®–∞–≥ 3/8:</b> –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.", reply_markup=inline.get_category_keyboard())

@router.callback_query(AdminAddUser.awaiting_category, F.data.startswith('category_'))
async def add_user_category(callback: types.CallbackQuery, state: FSMContext):
    category = callback.data.split('_', 1)[1]
    await state.update_data(category=category)
    await callback.message.edit_text("<b>–®–∞–≥ 4/8:</b> –í—ã–±–µ—Ä–∏—Ç–µ –í–£–ó.", reply_markup=inline.get_university_keyboard())
    await state.set_state(AdminAddUser.awaiting_university)
    await callback.answer()

@router.callback_query(AdminAddUser.awaiting_university, F.data.startswith('university_'))
async def add_user_university(callback: types.CallbackQuery, state: FSMContext):
    choice = callback.data.split('_', 1)[1]
    if choice == 'mifi':
        await state.update_data(university="–ù–ò–Ø–£ –ú–ò–§–ò")
        await callback.message.edit_text("<b>–®–∞–≥ 5/8:</b> –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç.", reply_markup=inline.get_faculties_keyboard())
        await state.set_state(AdminAddUser.awaiting_faculty)
    else:
        await callback.message.edit_text("<b>–®–∞–≥ 5/8:</b> –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –í–£–ó–∞.")
        await state.set_state(AdminAddUser.awaiting_custom_university_name)
    await callback.answer()

@router.message(AdminAddUser.awaiting_custom_university_name)
async def add_user_custom_university(message: types.Message, state: FSMContext):
    await state.update_data(university=message.text)
    await message.answer("<b>–®–∞–≥ 6/8:</b> –í–≤–µ–¥–∏—Ç–µ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç.")
    await state.set_state(AdminAddUser.awaiting_custom_faculty_name)

@router.callback_query(AdminAddUser.awaiting_faculty, F.data.startswith('faculty_'))
async def add_user_faculty(callback: types.CallbackQuery, state: FSMContext):
    faculty = callback.data.split('_', 1)[1]
    if faculty == 'Other':
        await callback.message.edit_text("<b>–®–∞–≥ 6/8:</b> –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∞.")
        await state.set_state(AdminAddUser.awaiting_custom_faculty_name)
    else:
        await state.update_data(faculty=faculty)
        await callback.message.edit_text("<b>–®–∞–≥ 7/8:</b> –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≥—Ä—É–ø–ø—ã (–∏–ª–∏ '–Ω–µ—Ç').")
        await state.set_state(AdminAddUser.awaiting_study_group)
    await callback.answer()
    
@router.message(AdminAddUser.awaiting_custom_faculty_name)
async def add_user_custom_faculty(message: types.Message, state: FSMContext):
    await state.update_data(faculty=message.text)
    await message.answer("<b>–®–∞–≥ 7/8:</b> –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≥—Ä—É–ø–ø—ã (–∏–ª–∏ '–Ω–µ—Ç').")
    await state.set_state(AdminAddUser.awaiting_study_group)

@router.message(AdminAddUser.awaiting_study_group)
async def add_user_study_group(message: types.Message, state: FSMContext):
    await state.update_data(study_group=message.text)
    await state.set_state(AdminAddUser.awaiting_gender)
    await message.answer("<b>–®–∞–≥ 8/8:</b> –£–∫–∞–∂–∏—Ç–µ –ø–æ–ª.", reply_markup=inline.get_gender_inline_keyboard())

@router.callback_query(AdminAddUser.awaiting_gender, F.data.startswith("gender_"))
async def add_user_gender(callback: types.CallbackQuery, state: FSMContext, session: AsyncSession):
    """–ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥ - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ."""
    gender = callback.data.split('_', 1)[1]
    await state.update_data(gender=gender, consent_given=True) # –°–æ–≥–ª–∞—Å–∏–µ –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç—Å—è, —Ç.–∫. –¥–æ–±–∞–≤–ª—è–µ—Ç –∞–¥–º–∏–Ω
    
    user_data = await state.get_data()

    await user_requests.add_user(session, user_data)
    await session.commit()
    await state.clear()
    
    await callback.message.edit_text(
        f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å <b>{user_data['full_name']}</b> —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.",
        reply_markup=inline.get_user_management_main_keyboard()
    )
    await callback.answer("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω!", show_alert=True)

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/handlers/admin/user_management.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/handlers/admin/__init__.py ---

from aiogram import Router, F, types
from sqlalchemy.ext.asyncio import AsyncSession

from bot.filters.role import RoleFilter
from bot.db import user_requests
from bot.keyboards import inline
from bot.utils.text_messages import Text

from .user_management import router as user_management_router
from .event_management import router as event_management_router
from .merch_management import router as merch_management_router
from .mailing import router as mailing_router
from .system import router as system_router
from .analytics import router as analytics_router
from .info_management import router as info_management_router
from .qa_management import router as qa_management_router

admin_router = Router(name="admin")

admin_router.include_routers(
    user_management_router,
    event_management_router,
    merch_management_router,
    mailing_router,
    system_router,
    analytics_router,
    info_management_router,
    qa_management_router,
)

@admin_router.callback_query(F.data == "admin_panel", RoleFilter('admin'))
async def show_admin_panel(callback: types.CallbackQuery, session: AsyncSession):
    """
    –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≥–ª–∞–≤–Ω—É—é –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
    –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥ —Ä–æ–ª—å (admin –∏–ª–∏ main_admin).
    """
    viewer = await user_requests.get_user_by_tg_id(session, callback.from_user.id)
    if not viewer:
        await callback.answer(Text.ERROR_PROFILE_NOT_FOUND, show_alert=True)
        return

    await callback.message.edit_text(
        text=Text.ADMIN_PANEL_HEADER,
        reply_markup=inline.get_admin_panel_keyboard(viewer.role),
        parse_mode="HTML"
    )
    await callback.answer()
    

@admin_router.callback_query(F.data == "admin_manage_events")
async def manage_events_panel_test(callback: types.CallbackQuery):

    await callback.message.edit_text(Text.ADMIN_EVENTS_HEADER, reply_markup=inline.get_events_management_keyboard(), parse_mode="HTML")
    await callback.answer()

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/handlers/admin/__init__.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/keyboards/inline.py ---

from aiogram import types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder
from bot.db.models import MerchItem, InfoText
from aiogram.fsm.context import FSMContext

# --- –ö–õ–ê–í–ò–ê–¢–£–†–´ ---

def get_back_to_main_menu_keyboard():
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main_menu"))
    return builder.as_markup()

def get_category_keyboard():
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="–°—Ç—É–¥–µ–Ω—Ç", callback_data="category_student"))
    builder.row(InlineKeyboardButton(text="–í–Ω–µ—à–Ω–∏–π –¥–æ–Ω–æ—Ä", callback_data="category_external"))
    return builder.as_markup()

def get_consent_keyboard():
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–æ–≥–ª–∞—Å–∏—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ü–î–Ω."""
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="‚úÖ –ü—Ä–∏–Ω–∏–º–∞—é —É—Å–ª–æ–≤–∏—è", callback_data="consent_given"))
    return builder.as_markup()


def get_student_main_menu(viewer_role: str = 'student'):
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –¥–æ–Ω–∞—Ü–∏—é", callback_data="register_donation"))
    builder.row(InlineKeyboardButton(text="üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å", callback_data="my_profile"))
    builder.row(InlineKeyboardButton(text="üéÅ –ú–∞–≥–∞–∑–∏–Ω –º–µ—Ä—á–∞", callback_data="merch_store"))
    builder.row(InlineKeyboardButton(text="‚ÑπÔ∏è –ü–æ–ª–µ–∑–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", callback_data="info"))
    builder.row(InlineKeyboardButton(text="‚öïÔ∏è –ú–æ–∏ –º–µ–¥–æ—Ç–≤–æ–¥—ã", callback_data="my_waivers"))
    builder.row(InlineKeyboardButton(text="‚ùì –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞–º", callback_data="ask_question"))
    
    if viewer_role == 'volunteer':
        builder.row(InlineKeyboardButton(
            text="‚≠ê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞",
            callback_data="volunteer_panel"
        ))
    elif viewer_role in ['admin', 'main_admin']:
        builder.row(InlineKeyboardButton(
            text="‚≠ê –ü–µ—Ä–µ–π—Ç–∏ –≤ —Ä–µ–∂–∏–º –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞",
            callback_data="switch_to_volunteer_view"
        ))
        builder.row(InlineKeyboardButton(
            text="‚öôÔ∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å",
            callback_data="admin_panel"
        ))
        
    return builder.as_markup()

def get_volunteer_main_menu(viewer_role: str = 'volunteer'):
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="‚≠ê –ú–µ–Ω—é –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞", callback_data="volunteer_panel"))
    builder.row(InlineKeyboardButton(text="üë§ –ü–µ—Ä–µ–π—Ç–∏ –≤ —Ä–µ–∂–∏–º –¥–æ–Ω–æ—Ä–∞", callback_data="switch_to_donor_view"))
    return builder.as_markup()

def get_admin_main_menu(viewer_role: str = 'admin'):
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="‚öôÔ∏è –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞", callback_data="admin_panel"))
    return builder.as_markup()  

def get_main_admin_main_menu(viewer_role: str = 'main_admin'):
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="‚öôÔ∏è –û—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞", callback_data="admin_panel"))
    return builder.as_markup()

def get_university_keyboard():
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="–ù–ò–Ø–£ –ú–ò–§–ò", callback_data="university_mifi"))
    return builder.as_markup()


def get_faculties_keyboard():
    faculties = ["–ò–ò–ö–°", "–§–ò–ë–°", "–ò–Ω–Ø–∑", "–ò–§–¢–≠–ë", "–ë–ú–¢", "–ò–§–ò–ë"]
    builder = InlineKeyboardBuilder()
    for faculty in faculties:
        builder.row(InlineKeyboardButton(text=faculty, callback_data=f"faculty_{faculty}"))
    builder.row(InlineKeyboardButton(text="–î—Ä—É–≥–æ–π/–ù–µ –∏–∑ —Å–ø–∏—Å–∫–∞", callback_data="faculty_Other"))
    return builder.as_markup()

def get_gender_inline_keyboard():
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(text="–ú—É–∂—Å–∫–æ–π", callback_data="gender_male"),
        InlineKeyboardButton(text="–ñ–µ–Ω—Å–∫–∏–π", callback_data="gender_female")
    )
    return builder.as_markup()

def get_profile_menu_keyboard():
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="üìä –ú–æ–∏ –¥–∞–Ω–Ω—ã–µ", callback_data="profile_data"))
    builder.row(InlineKeyboardButton(text="ü©∏ –ò—Å—Ç–æ—Ä–∏—è –¥–æ–Ω–∞—Ü–∏–π", callback_data="profile_history"))
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main_menu"))
    return builder.as_markup()

def get_back_to_profile_menu_keyboard():
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥ –≤ –ø—Ä–æ—Ñ–∏–ª—å", callback_data="my_profile"))
    return builder.as_markup()

def get_info_menu_keyboard():
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="–ö–∞–∫ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è?", callback_data="info_prepare"))
    builder.row(InlineKeyboardButton(text="–ü—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è", callback_data="info_contraindications"))
    builder.row(InlineKeyboardButton(text="–ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø–æ—Å–ª–µ?", callback_data="info_after"))
    builder.row(InlineKeyboardButton(text="ü©∏ –û –¥–æ–Ω–æ—Ä—Å—Ç–≤–µ –∫–æ—Å—Ç–Ω–æ–≥–æ –º–æ–∑–≥–∞ (–î–ö–ú)", callback_data="info_dkm"))
    builder.row(InlineKeyboardButton(text="üè• –û –¥–æ–Ω–∞—Ü–∏—è—Ö –≤ –ú–ò–§–ò", callback_data="info_mifi_process"))
    builder.row(InlineKeyboardButton(text="–°–≤—è–∑–∞—Ç—å—Å—è —Å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞–º–∏", callback_data="info_contacts"))
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main_menu"))
    return builder.as_markup()

def get_back_to_info_menu_keyboard():
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ —Ä–∞–∑–¥–µ–ª–∞–º", callback_data="info"))
    return builder.as_markup()

def get_merch_store_keyboard(item: MerchItem, page: int, total_pages: int):
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text=f'–ö—É–ø–∏—Ç—å –∑–∞ {item.price}–ë', callback_data=f"buy_merch_{item.id}"))
    nav_buttons = []
    prev_page = total_pages if page == 1 else page - 1
    nav_buttons.append(InlineKeyboardButton(text="‚óÄÔ∏è", callback_data=f"merch_page_{prev_page}"))
    nav_buttons.append(InlineKeyboardButton(text=f"{page}/{total_pages}", callback_data="ignore"))
    next_page = 1 if page == total_pages else page + 1
    nav_buttons.append(InlineKeyboardButton(text="‚ñ∂Ô∏è", callback_data=f"merch_page_{next_page}"))
    builder.row(*nav_buttons)
    builder.row(InlineKeyboardButton(text="üõçÔ∏è –ú–æ–∏ –∑–∞–∫–∞–∑—ã", callback_data="my_orders"))
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main_menu"))
    return builder.as_markup()

def get_purchase_confirmation_keyboard(item_id: int):
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(text="‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", callback_data=f"confirm_buy_{item_id}"),
        InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="merch_store")
    )
    return builder.as_markup()

def get_back_to_merch_keyboard():
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥ –≤ –º–∞–≥–∞–∑–∏–Ω", callback_data="merch_store"))
    return builder.as_markup()
    
def get_admin_panel_keyboard(viewer_role: str):
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="üóìÔ∏è –£–ø—Ä. –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º–∏", callback_data="admin_manage_events"))
    builder.row(types.InlineKeyboardButton(text="‚ùì –í–æ–ø—Ä–æ—Å—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", callback_data="admin_answer_questions"))
    builder.row(InlineKeyboardButton(text="üë• –£–ø—Ä. –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏", callback_data="admin_manage_users"))
    builder.row(InlineKeyboardButton(text="üõçÔ∏è –£–ø—Ä. –º–∞–≥–∞–∑–∏–Ω–æ–º", callback_data="admin_manage_merch"))
    builder.row(InlineKeyboardButton(text="üì¶ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫–∞–∑–æ–≤", callback_data="admin_process_orders"))
    builder.row(InlineKeyboardButton(text="üì£ –†–∞—Å—Å—ã–ª–∫–∏", callback_data="admin_mailing"))
    builder.row(InlineKeyboardButton(text="üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞", callback_data="admin_analytics"))
    builder.row(InlineKeyboardButton(text="üìù –†–µ–¥. –∏–Ω—Ñ–æ-—Ä–∞–∑–¥–µ–ª—ã", callback_data="admin_edit_info"))
    if viewer_role == 'main_admin':
        builder.row(
        types.InlineKeyboardButton(text="üíæ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö", callback_data="ma_export_data"),
        types.InlineKeyboardButton(text="üì• –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö", callback_data="ma_import_data")
        )
        builder.row(types.InlineKeyboardButton(text="üì• –ò–º–ø–æ—Ä—Ç —Å—Ç–∞—Ä–æ–π –ë–î", callback_data="ma_import_old_db"))
    builder.row(InlineKeyboardButton(text="üë§ –ü–µ—Ä–µ–π—Ç–∏ –≤ —Ä–µ–∂–∏–º –¥–æ–Ω–æ—Ä–∞", callback_data="switch_to_donor_view"))
    return builder.as_markup()



def get_info_sections_for_editing_keyboard(sections: list[InfoText]):
    builder = InlineKeyboardBuilder()
    for section in sections:
        builder.row(types.InlineKeyboardButton(
            text=section.section_title,
            callback_data=f"edit_info_{section.section_key}"
        ))
    builder.row(types.InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="admin_panel"))
    return builder.as_markup()

def get_analytics_main_menu_keyboard():
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="üìà –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (KPI)", callback_data="analytics_kpi"))
    builder.row(InlineKeyboardButton(text="üìÖ –ê–Ω–∞–ª–∏–∑ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π", callback_data="analytics_events_select"))
    builder.row(InlineKeyboardButton(text="üìÑ –û—Ç—á–µ—Ç—ã", callback_data="analytics_reports"))
    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –µ—â–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data="admin_panel"))
    return builder.as_markup()

def get_reports_menu_keyboard():
    builder = InlineKeyboardBuilder()
    # I. –û—Ç—á–µ—Ç—ã –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –¥–æ–Ω–æ—Ä–æ–≤
    builder.row(InlineKeyboardButton(text="–î–æ–Ω–æ—Ä—ã-–æ–¥–Ω–æ–¥–Ω–µ–≤–∫–∏", callback_data="report_churn_donors"))
    builder.row(InlineKeyboardButton(text="–£–≥–∞—Å–∞—é—â–∏–µ –¥–æ–Ω–æ—Ä—ã", callback_data="report_lapsed_donors"))
    builder.row(InlineKeyboardButton(text="–¢–æ–ø-20 –¥–æ–Ω–æ—Ä–æ–≤", callback_data="report_top_donors"))
    # builder.row(InlineKeyboardButton(text="–î–æ–Ω–æ—Ä—ã —Ä–µ–¥–∫–æ–π –∫—Ä–æ–≤–∏", callback_data="report_rare_blood_donors"))
    # II. –û—Ç—á–µ—Ç—ã –ø–æ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏ –¥–µ–º–æ–≥—Ä–∞—Ñ–∏–∏
    builder.row(InlineKeyboardButton(text="–°–∞–º—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç—ã", callback_data="report_top_faculties"))
    builder.row(InlineKeyboardButton(text="–ö–∞–Ω–¥–∏–¥–∞—Ç—ã –≤ —Ä–µ–≥–∏—Å—Ç—Ä –î–ö–ú", callback_data="report_dkm_candidates"))
    # III. –û—Ç—á–µ—Ç—ã –ø–æ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    builder.row(InlineKeyboardButton(text="–ü–æ—Ç–µ—Ä—è –ø–æ—Å–ª–µ –æ–ø—Ä–æ—Å–Ω–∏–∫–∞", callback_data="report_survey_dropoff"))

    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="admin_analytics"))
    return builder.as_markup()

def get_events_for_analysis_keyboard(events: list):
    builder = InlineKeyboardBuilder()
    for event in events:
        builder.row(InlineKeyboardButton(
            text=f"{event.event_datetime.strftime('%d.%m.%y')} - {event.name}",
            callback_data=f"analyze_event_{event.id}"
        ))
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="admin_analytics"))
    return builder.as_markup()

def get_events_management_keyboard():
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="‚ûï –°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ", callback_data="admin_create_event"))
    builder.row(InlineKeyboardButton(text="üìú –ü—Ä–æ—Å–º–æ—Ç—Ä/–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö", callback_data="admin_view_events"))
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="admin_panel"))
    return builder.as_markup()

def get_single_event_management_keyboard(event_id: int, registration_is_open: bool, has_feedback: bool = False):
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"admin_edit_event_{event_id}"))
    reg_status_text = "üîí –ó–∞–∫—Ä—ã—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é" if registration_is_open else "üîì –û—Ç–∫—Ä—ã—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é"
    builder.row(InlineKeyboardButton(text=reg_status_text, callback_data=f"admin_toggle_reg_{event_id}"))
    builder.row(InlineKeyboardButton(text="üë• –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (.csv)", callback_data=f"admin_event_participants_{event_id}"))
    builder.row(InlineKeyboardButton(text="üö® –û—Ç–º–µ–Ω–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ", callback_data=f"admin_cancel_event_{event_id}"))
    if has_feedback:
        builder.row(InlineKeyboardButton(text="üìä –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∑—ã–≤—ã", callback_data=f"admin_view_feedback_{event_id}"))
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ö —Å–ø–∏—Å–∫—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π", callback_data="admin_view_events"))
    return builder.as_markup()

def get_back_to_admin_panel_keyboard():
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –í –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞", callback_data="admin_panel"))
    return builder.as_markup()

def get_user_management_keyboard(target_user_id: int, target_user_role: str, viewer_role: str, is_blocked: bool):
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="üéüÔ∏è –£–ø—Ä. —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è–º–∏", callback_data=f"admin_manage_user_regs_{target_user_id}"))
    builder.row(InlineKeyboardButton(text="‚öïÔ∏è –£–ø—Ä. –º–µ–¥–æ—Ç–≤–æ–¥–∞–º–∏", callback_data=f"admin_manage_waivers_{target_user_id}"))

    builder.row(InlineKeyboardButton(text="+/- –ë–∞–ª–ª—ã", callback_data=f"admin_points_{target_user_id}"))

    if target_user_role == 'student':
        builder.row(InlineKeyboardButton(text="‚≠ê –ù–∞–∑–Ω–∞—á–∏—Ç—å –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–º", callback_data=f"admin_promote_volunteer_{target_user_id}"))
    elif target_user_role == 'volunteer':
        builder.row(InlineKeyboardButton(text="üßë‚Äçüéì –°–Ω—è—Ç—å —Å –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞", callback_data=f"admin_demote_volunteer_{target_user_id}"))
    
    if viewer_role == 'main_admin' and target_user_role != 'main_admin':
        if target_user_role == 'admin':
            builder.row(InlineKeyboardButton(text="üëë‚ûñ –†–∞–∑–∂–∞–ª–æ–≤–∞—Ç—å –∞–¥–º–∏–Ω–∞", callback_data=f"ma_demote_admin_{target_user_id}"))
        else:
            builder.row(InlineKeyboardButton(text="üëë‚ûï –ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–æ–º", callback_data=f"ma_promote_admin_{target_user_id}"))
        if is_blocked:
            builder.row(InlineKeyboardButton(text="‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"ma_unblock_user_{target_user_id}"))
        else:
            builder.row(InlineKeyboardButton(text="üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"ma_block_user_{target_user_id}"))
            
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é", callback_data="admin_manage_users"))
    return builder.as_markup()

def get_donation_type_keyboard():
    builder = InlineKeyboardBuilder()
    types = {'whole_blood': '–¶–µ–ª—å–Ω–∞—è –∫—Ä–æ–≤—å', 'plasma': '–ü–ª–∞–∑–º–∞', 'platelets': '–¢—Ä–æ–º–±–æ—Ü–∏—Ç—ã', 'erythrocytes': '–≠—Ä–∏—Ç—Ä–æ—Ü–∏—Ç—ã'}
    for key, value in types.items():
        builder.row(InlineKeyboardButton(text=value, callback_data=f"settype_{key}"))
    return builder.as_markup()


def get_blood_centers_keyboard(blood_centers, edit_mode=False):
    builder = InlineKeyboardBuilder()
    for center in blood_centers:
        builder.row(InlineKeyboardButton(text=center.name, callback_data=f"select_blood_center_{center.id}"))

    callback_data = "add_new_blood_center_edit" if edit_mode else "add_new_blood_center"
    builder.row(InlineKeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π", callback_data=callback_data))
    return builder.as_markup()

def get_main_admin_panel_keyboard():
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="üëÆ‚Äç‚ôÇÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏", callback_data="ma_manage_admins"))
    builder.row(InlineKeyboardButton(text="üö´ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏", callback_data="ma_manage_blocks"))
    builder.row(InlineKeyboardButton(text="üíæ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö", callback_data="ma_export_data"))
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –í –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞", callback_data="admin_panel"))
    return builder.as_markup()
    
def get_back_to_ma_panel_keyboard():
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –í –ø–∞–Ω–µ–ª—å –≥–ª. –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞", callback_data="main_admin_panel"))
    return builder.as_markup()

def get_admins_management_keyboard():
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="‚ûï –ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞", callback_data="add_admin"))
    builder.row(InlineKeyboardButton(text="‚ûñ –†–∞–∑–∂–∞–ª–æ–≤–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞", callback_data="remove_admin"))
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="main_admin_panel"))
    return builder.as_markup()

def get_blocks_management_keyboard():
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", callback_data="block_user_start"))
    builder.row(InlineKeyboardButton(text="üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", callback_data="unblock_user_start"))
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="main_admin_panel"))
    return builder.as_markup()
    
def get_export_keyboard():
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="–í—ã–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (.csv)", callback_data="export_users_csv"))
    builder.row(InlineKeyboardButton(text="–í—ã–≥—Ä—É–∑–∏—Ç—å –¥–æ–Ω–∞—Ü–∏–∏ (.csv)", callback_data="export_donations_csv"))
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="main_admin_panel"))
    return builder.as_markup()

def get_merch_management_keyboard():
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä", callback_data="admin_create_merch"))
    builder.row(InlineKeyboardButton(text="üìú –ü—Ä–æ—Å–º–æ—Ç—Ä/–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ", callback_data="admin_view_merch"))
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="admin_panel"))
    return builder.as_markup()

def get_event_cancellation_confirmation_keyboard(event_id: int):
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(text="‚ùå –î–∞, –æ—Ç–º–µ–Ω–∏—Ç—å", callback_data=f"admin_confirm_cancel_{event_id}"),
        InlineKeyboardButton(text="‚Ü©Ô∏è –ù–µ—Ç, –Ω–∞–∑–∞–¥", callback_data=f"admin_show_event_{event_id}")
    )
    return builder.as_markup()

def get_back_to_events_menu_keyboard():
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ö —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º–∏", callback_data="admin_manage_events"))
    return builder.as_markup()

def get_single_merch_management_keyboard(item_id: int, is_available: bool):
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"admin_edit_merch_{item_id}"))
    availability_text = "‚úÖ –°–¥–µ–ª–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–º" if not is_available else "‚ùå –°–¥–µ–ª–∞—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º"
    builder.row(InlineKeyboardButton(text=availability_text, callback_data=f"admin_toggle_merch_{item_id}"))
    builder.row(InlineKeyboardButton(text="üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä", callback_data=f"admin_delete_merch_{item_id}"))
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ö —Å–ø–∏—Å–∫—É —Ç–æ–≤–∞—Ä–æ–≤", callback_data="admin_view_merch"))
    return builder.as_markup()

def get_merch_deletion_confirmation_keyboard(item_id: int):
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(text="üóëÔ∏è –î–∞, —É–¥–∞–ª–∏—Ç—å", callback_data=f"admin_confirm_delete_merch_{item_id}"),
        InlineKeyboardButton(text="‚Ü©Ô∏è –ù–µ—Ç, –Ω–∞–∑–∞–¥", callback_data=f"admin_show_merch_{item_id}")
    )
    return builder.as_markup()

def get_back_to_merch_menu_keyboard():
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ö —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –º–∞–≥–∞–∑–∏–Ω–æ–º", callback_data="admin_manage_merch"))
    return builder.as_markup()

def get_already_registered_keyboard(event_id: int):
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(
        text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –º–æ—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é",
        callback_data=f"cancel_reg_{event_id}"
    ))
    builder.row(InlineKeyboardButton(
        text="‚Ü©Ô∏è –ö —Å–ø–∏—Å–∫—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π",
        callback_data="register_donation"
    ))
    return builder.as_markup()

def get_event_creation_confirmation_keyboard():
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="‚úÖ –°–æ–∑–¥–∞—Ç—å –∏ —Ä–∞–∑–æ—Å–ª–∞—Ç—å", callback_data="confirm_create_event"))
    builder.row(InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="admin_manage_events"))
    return builder.as_markup()

def get_mailing_audience_keyboard(current_filters: dict = None):
    """
    –°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ –∞—É–¥–∏—Ç–æ—Ä–∏–∏ —Ä–∞—Å—Å—ã–ª–∫–∏.
    –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ –∫–Ω–æ–ø–∫–∏.
    """
    if current_filters is None:
        current_filters = {}

    builder = InlineKeyboardBuilder()


    builder.row(InlineKeyboardButton(text="üì¢ –í—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º", callback_data="mail_filter_role_all"))
    builder.row(InlineKeyboardButton(text="‚≠ê –í–æ–ª–æ–Ω—Ç–µ—Ä–∞–º –∏ –∞–¥–º–∏–Ω–∞–º", callback_data="mail_filter_role_volunteers"))
    builder.row(InlineKeyboardButton(text="‚öôÔ∏è –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º", callback_data="mail_filter_role_admins"))
    # builder.row(InlineKeyboardButton(text="-"*25, callback_data="ignore")) 

    # builder.row(InlineKeyboardButton(text="üéì –ü–æ –í–£–ó—É", callback_data="mail_audience_type_university"))
    builder.row(InlineKeyboardButton(text="üèõÔ∏è –ü–æ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç—É", callback_data="mail_audience_type_faculty"))
    
    if current_filters:
        builder.row(InlineKeyboardButton(text="‚úÖ –ì–æ—Ç–æ–≤–æ (–ø–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—é)", callback_data="mail_audience_finish"))

    # –ö–Ω–æ–ø–∫–∞ "–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã"
    if current_filters:
        builder.row(InlineKeyboardButton(text="üîÑ –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã", callback_data="mail_audience_reset"))

    builder.row(InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞ —Ä–∞—Å—Å—ã–ª–∫–∏", callback_data="admin_panel"))
    
    return builder.as_markup()



def get_dynamic_mailing_filter_keyboard(items: list[str], filter_key: str, back_callback: str):
    """
    –°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞.
    :param items: –°–ø–∏—Å–æ–∫ –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ (–Ω–∞–ø—Ä., —Å–ø–∏—Å–æ–∫ –í–£–ó–æ–≤).
    :param filter_key: –ö–ª—é—á —Ñ–∏–ª—å—Ç—Ä–∞ (–Ω–∞–ø—Ä., 'university').
    :param back_callback: callback_data –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥".
    """
    builder = InlineKeyboardBuilder()
    for item in items:
        builder.row(InlineKeyboardButton(text=item, callback_data=f"mail_filter_{filter_key}_{item}"))
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data=back_callback))
    return builder.as_markup()

def get_mailing_confirmation_keyboard():
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(text="üöÄ –î–∞, –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É", callback_data="confirm_mailing"),
        InlineKeyboardButton(text="‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç", callback_data="edit_mailing_text"),
        InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="admin_panel")
    )
    return builder.as_markup()

def get_skip_media_keyboard():
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="‚û°Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å", callback_data="skip_media"))
    builder.row(InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="admin_panel"))
    return builder.as_markup()

def get_user_management_main_keyboard():
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="üìú –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", callback_data="admin_users_list_page_1"))
    builder.row(InlineKeyboardButton(text="üîç –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", callback_data="admin_search_user"))
    builder.row(InlineKeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—Ä—É—á–Ω—É—é", callback_data="admin_add_user_start"))
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data="admin_panel"))
    return builder.as_markup()

def get_users_list_pagination_keyboard(page: int, total_pages: int):
    builder = InlineKeyboardBuilder()
    nav_buttons = []
    if page > 1:
        nav_buttons.append(InlineKeyboardButton(text="‚óÄÔ∏è", callback_data=f"admin_users_list_page_{page - 1}"))
    nav_buttons.append(InlineKeyboardButton(text=f"{page}/{total_pages}", callback_data="ignore"))
    if page < total_pages:
        nav_buttons.append(InlineKeyboardButton(text="‚ñ∂Ô∏è", callback_data=f"admin_users_list_page_{page + 1}"))
    builder.row(*nav_buttons)
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="admin_manage_users"))
    return builder.as_markup()

def get_successful_registration_keyboard(event_id: int):
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(
        text="üî≤ –ú–æ–π QR-–∫–æ–¥ –¥–ª—è —ç—Ç–æ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è",
        callback_data=f"get_event_qr_{event_id}"
    ))
    builder.row(InlineKeyboardButton(
        text="üóìÔ∏è –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å",
        callback_data=f"add_to_calendar_{event_id}"
    ))
    builder.row(InlineKeyboardButton(
        text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –º–æ—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é",
        callback_data=f"cancel_reg_{event_id}"
    ))
    builder.row(InlineKeyboardButton(
        text="‚Ü©Ô∏è –ö —Å–ø–∏—Å–∫—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π",
        callback_data="register_donation"
    ))
    return builder.as_markup()

def get_donation_confirmation_keyboard(user_id: int, event_id: int):
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(
            text="‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å",
            callback_data=f"confirm_donation_{user_id}_{event_id}"
        ),
        InlineKeyboardButton(
            text="‚ùå –û—Ç–º–µ–Ω–∞",
            callback_data="volunteer_panel"
        )
    )
    return builder.as_markup()

def get_volunteer_panel_keyboard():
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="üì∑ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–æ–Ω–∞—Ü–∏—é (QR)", callback_data="confirm_donation_qr"))
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é –¥–æ–Ω–æ—Ä–∞", callback_data="switch_to_donor_view"))
    return builder.as_markup()

def get_manual_registration_management_keyboard(user_id: int):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞: –∑–∞–ø–∏—Å–∞—Ç—å –∏–ª–∏ –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å."""
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="‚ûï –ó–∞–ø–∏—Å–∞—Ç—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ", callback_data=f"admin_reg_start_{user_id}"))
    builder.row(InlineKeyboardButton(text="‚ûñ –û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é", callback_data=f"admin_cancel_start_{user_id}"))
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é", callback_data=f"admin_show_user_{user_id}"))
    return builder.as_markup()

def get_events_for_manual_registration_keyboard(user_id: int, events: list):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –¥–ª—è —Ä—É—á–Ω–æ–π –∑–∞–ø–∏—Å–∏."""
    builder = InlineKeyboardBuilder()
    for event in events:
        builder.row(InlineKeyboardButton(
            text=f"{event.event_date.strftime('%d.%m')} - {event.name}",
            callback_data=f"adminReg_{user_id}_{event.id}" 
        ))
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data=f"admin_manage_user_regs_{user_id}"))
    return builder.as_markup()

def get_registrations_for_cancellation_keyboard(user_id: int, registrations: list):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π –¥–ª—è –æ—Ç–º–µ–Ω—ã."""
    builder = InlineKeyboardBuilder()
    for reg in registrations:
        builder.row(InlineKeyboardButton(
            text=f"‚ùå {reg.event.event_date.strftime('%d.%m')} - {reg.event.name}",
            callback_data=f"adminCancel_{user_id}_{reg.event_id}"
        ))
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data=f"admin_manage_user_regs_{user_id}"))
    return builder.as_markup()



def get_my_waivers_keyboard(user_waivers_exist: bool):
    """
    –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –º–µ–Ω—é '–ú–æ–∏ –º–µ–¥–æ—Ç–≤–æ–¥—ã'.
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∏–º –æ—Ç–≤–æ–¥—ã.
    """
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="‚ûï –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ—Ç–≤–æ–¥", callback_data="set_user_waiver"))
    if user_waivers_exist:
        builder.row(InlineKeyboardButton(text="‚ûñ –û—Ç–º–µ–Ω–∏—Ç—å —Å–≤–æ–π –æ—Ç–≤–æ–¥", callback_data="cancel_user_waiver"))
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main_menu"))
    return builder.as_markup()

def get_waiver_cancellation_keyboard(waivers: list):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º –º–µ–¥–æ—Ç–≤–æ–¥–æ–≤, —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –¥–ª—è –æ—Ç–º–µ–Ω—ã."""
    builder = InlineKeyboardBuilder()
    for waiver in waivers:
        builder.row(InlineKeyboardButton(
            text=f"‚ùå –î–æ {waiver.end_date.strftime('%d.%m.%y')}: {waiver.reason[:25]}...",
            callback_data=f"delete_waiver_{waiver.id}"
        ))
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="my_waivers"))
    return builder.as_markup()

def get_admin_waiver_management_keyboard(user_id: int, waivers: list):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º –º–µ–¥–æ—Ç–≤–æ–¥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è."""
    builder = InlineKeyboardBuilder()
    for waiver in waivers:
        creator_map = {'user': 'üë§', 'system': '‚öôÔ∏è', 'admin': 'üëë'}
        creator_icon = creator_map.get(str(waiver.created_by).lower(), '‚ùì')
        
        if str(waiver.created_by).isdigit():
            creator_icon = 'üëë'

        reason_short = (waiver.reason[:20] + '...') if len(waiver.reason) > 20 else waiver.reason
        
        builder.row(InlineKeyboardButton(
            text=f"‚ùå {creator_icon} –î–æ {waiver.end_date.strftime('%d.%m')} - {reason_short}",
            callback_data=f"admin_del_waiver_{waiver.id}_{user_id}"
        ))
        
    builder.row(InlineKeyboardButton(text="‚ûï –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–π –º–µ–¥–æ—Ç–≤–æ–¥", callback_data=f"admin_waiver_{user_id}"))
    builder.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é", callback_data=f"admin_show_user_{user_id}"))
    return builder.as_markup()

def get_feedback_well_being_keyboard():
    builder = InlineKeyboardBuilder()
    buttons = [InlineKeyboardButton(text=str(i), callback_data=f"fb_wb_{i}") for i in range(1, 6)]
    builder.row(*buttons)
    return builder.as_markup()

def get_feedback_organization_keyboard():
    builder = InlineKeyboardBuilder()
    # –î–≤–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ 5 –∫–Ω–æ–ø–æ–∫
    builder.row(*[InlineKeyboardButton(text=str(i), callback_data=f"fb_org_{i}") for i in range(1, 6)])
    builder.row(*[InlineKeyboardButton(text=str(i), callback_data=f"fb_org_{i}") for i in range(6, 11)])
    return builder.as_markup()

def get_feedback_skip_keyboard():
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="‚û°Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å", callback_data="fb_skip_step"))
    return builder.as_markup()



def get_events_for_post_processing_keyboard(events: list):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–æ—à–µ–¥—à–µ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏."""
    builder = InlineKeyboardBuilder()
    for event in events:
        builder.row(types.InlineKeyboardButton(
            text=f"{event.event_datetime.strftime('%d.%m.%y')} - {event.name}",
            callback_data=f"post_process_event_{event.id}"
        ))
    builder.row(types.InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="admin_manage_events"))
    return builder.as_markup()

def get_participant_marking_keyboard(event_id: int, participants: list, marked_donations: set, marked_dkm: set):
    """–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤."""
    builder = InlineKeyboardBuilder()
    for reg in participants:
        user = reg.user
        
        donation_icon = "üü¢" if user.id in marked_donations else "‚ö™Ô∏è"
        dkm_icon = "üü¢" if user.id in marked_dkm else "‚ö™Ô∏è"

        builder.row(
            types.InlineKeyboardButton(text=user.full_name, callback_data="ignore"),
            types.InlineKeyboardButton(
                text=f"{donation_icon} –°–¥–∞–ª –∫—Ä–æ–≤—å", 
                callback_data=f"mark_participant_{event_id}_{user.id}_donation"
            ),
            types.InlineKeyboardButton(
                text=f"{dkm_icon} –í—Å—Ç—É–ø–∏–ª –≤ –î–ö–ú", 
                callback_data=f"mark_participant_{event_id}_{user.id}_dkm"
            )
        )
    builder.row(types.InlineKeyboardButton(text="‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å", callback_data=f"finish_marking_{event_id}"))
    builder.row(types.InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="admin_manage_events"))
    return builder.as_markup()

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/keyboards/inline.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/keyboards/reply.py ---

from aiogram.types import ReplyKeyboardMarkup, KeyboardButton

def get_contact_keyboard():
    return ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–º", request_contact=True)]],
        resize_keyboard=True
    )


def get_home_keyboard():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π '–î–æ–º–æ–π'."""
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="üè† –î–æ–º–æ–π")]
        ],
        resize_keyboard=True
    )


--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/keyboards/reply.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/keyboards/__init__.py ---



--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/keyboards/__init__.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/middlewares/block.py ---

from typing import Callable, Dict, Any, Awaitable
from aiogram import BaseMiddleware
from aiogram.types import TelegramObject, Message, CallbackQuery
from sqlalchemy.ext.asyncio import async_sessionmaker, AsyncSession

from bot.db import user_requests

class BlockUserMiddleware(BaseMiddleware):
    def __init__(self):
        super().__init__()

    async def __call__(
        self,
        handler: Callable[[TelegramObject, Dict[str, Any]], Awaitable[Any]],
        event: TelegramObject,
        data: Dict[str, Any],
    ) -> Any:
        if not isinstance(event, (Message, CallbackQuery)):
            return await handler(event, data)

        session: AsyncSession = data.get("session")
        if not session:
            return await handler(event, data)

        user = await user_requests.get_user_by_tg_id(session, event.from_user.id)

        if user and user.is_blocked:
            if isinstance(event, Message):
                await event.answer("‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –±–æ—Ç–∞.")
            elif isinstance(event, CallbackQuery):
                await event.answer("‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.", show_alert=True)
            return  # –ü—Ä–µ—Ä—ã–≤–∞–µ–º –¥–∞–ª—å–Ω–µ–π—à—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É

        return await handler(event, data)

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/middlewares/block.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/middlewares/db.py ---

from typing import Callable, Dict, Any, Awaitable
from aiogram import BaseMiddleware
from aiogram.types import TelegramObject
from sqlalchemy.ext.asyncio import async_sessionmaker

class DbSessionMiddleware(BaseMiddleware):
    def __init__(self, session_pool: async_sessionmaker):
        super().__init__()
        self.session_pool = session_pool

    async def __call__(
        self,
        handler: Callable[[TelegramObject, Dict[str, Any]], Awaitable[Any]],
        event: TelegramObject,
        data: Dict[str, Any],
    ) -> Any:
        async with self.session_pool() as session:
            data["session"] = session
            return await handler(event, data)

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/middlewares/db.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/middlewares/__init__.py ---



--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/middlewares/__init__.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/states/states.py ---

from aiogram.fsm.state import State, StatesGroup

class Registration(StatesGroup):
    awaiting_full_name = State()
    awaiting_category = State()
    awaiting_consent = State()
    awaiting_university = State()
    awaiting_custom_university_name = State()
    awaiting_faculty = State()
    awaiting_custom_faculty_name = State()
    awaiting_study_group = State()
    awaiting_gender = State()

class EventCreation(StatesGroup):
    awaiting_name = State()
    awaiting_datetime = State()
    awaiting_location_text = State()
    awaiting_location_point = State()
    awaiting_blood_center = State()
    awaiting_new_blood_center_name = State()
    awaiting_donation_type = State()
    awaiting_points = State()
    awaiting_limit = State()
    awaiting_confirmation = State()

class MerchCreation(StatesGroup):
    awaiting_photo = State()
    awaiting_name = State()
    awaiting_description = State()
    awaiting_price = State()

class PointsChange(StatesGroup):
    awaiting_user_id = State()
    awaiting_points_amount = State()
    awaiting_reason = State()

class ManualWaiver(StatesGroup):
    awaiting_end_date = State()
    awaiting_reason = State()

class Mailing(StatesGroup):
    awaiting_message_text = State()
    awaiting_media = State()
    awaiting_audience_type = State()     
    awaiting_audience_value = State()   
    awaiting_audience_choice = State()   
    awaiting_confirmation = State()
class AdminManagement(StatesGroup):
    awaiting_user_to_promote = State()
    awaiting_user_to_demote = State()
    
class BlockUser(StatesGroup):
    awaiting_user_id = State()
    awaiting_reason = State()
    awaiting_user_id_unblock = State()

class VolunteerActions(StatesGroup):
    awaiting_qr_photo = State()
    awaiting_confirmation = State()
    
class EventEditing(StatesGroup):
    choosing_field = State() 
    awaiting_new_value = State()
    awaiting_new_blood_center_name_for_edit = State()
    
class MerchEditing(StatesGroup):
    choosing_field = State()
    awaiting_new_value = State()
    
class UserSearch(StatesGroup):
    awaiting_query = State()
    
class UserWaiver(StatesGroup):
    awaiting_end_date = State()
    awaiting_reason = State()
    
    
class FeedbackSurvey(StatesGroup):
    awaiting_well_being = State()
    awaiting_well_being_comment = State()
    awaiting_organization_score = State()
    awaiting_what_liked = State()
    awaiting_what_disliked = State()
    awaiting_other_suggestions = State()
    
class AdminAnalytics(StatesGroup):
    choosing_event_for_analysis = State()
    
class AdminAddUser(StatesGroup):
    awaiting_phone = State()
    awaiting_full_name = State()
    awaiting_category = State()
    awaiting_consent = State()
    awaiting_university = State()
    awaiting_custom_university_name = State()
    awaiting_faculty = State()
    awaiting_custom_faculty_name = State()
    awaiting_study_group = State()
    awaiting_gender = State()
    
class PostEventProcessing(StatesGroup):
    choosing_event = State()
    marking_participants = State()
    
class EditInfoSection(StatesGroup):
    choosing_section = State()
    awaiting_new_text = State()
    
class AskQuestion(StatesGroup):
    awaiting_question = State()

class AnswerQuestion(StatesGroup):
    awaiting_answer = State()
    
class DataImport(StatesGroup):
    awaiting_file = State()
    awaiting_old_db_file = State()

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/states/states.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/states/__init__.py ---



--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/states/__init__.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/utils/analytics_service.py ---

import io
import matplotlib.pyplot as plt
import datetime
from sqlalchemy.ext.asyncio import AsyncSession
from bot.db import analytics_requests

async def create_report(session: AsyncSession, report_type: str) -> dict:
    """
    –°–æ–∑–¥–∞–µ—Ç –æ—Ç—á–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞.
    """
    report_data = {}
    if report_type == "one_time_donors":
        report_data = await analytics_requests.get_one_time_donors(session)
    elif report_type == "no_show_donors":
        report_data = await analytics_requests.get_no_show_donors(session)
    elif report_type == "dkm_donors":
        report_data = await analytics_requests.get_dkm_donors(session)
    elif report_type == "students":
        report_data = await analytics_requests.get_students(session)
    elif report_type == "employees":
        report_data = await analytics_requests.get_employees(session)
    elif report_type == "external_donors":
        report_data = await analytics_requests.get_external_donors(session)
    elif report_type == "graduated_donors":
        report_data = await analytics_requests.get_graduated_donors(session)
    elif report_type == "churn_donors":
        report_data = await analytics_requests.get_churn_donors(session)
    elif report_type == "lapsed_donors":
        report_data = await analytics_requests.get_lapsed_donors(session)
    elif report_type == "top_donors":
        report_data = await analytics_requests.get_top_donors(session)
    elif report_type == "rare_blood_donors":
        report_data = await analytics_requests.get_rare_blood_donors(session)
    elif report_type == "top_faculties":
        report_data = await analytics_requests.get_top_faculties(session)
    elif report_type == "dkm_candidates":
        report_data = await analytics_requests.get_dkm_candidates(session)
    elif report_type == "survey_dropoff":
        report_data = await analytics_requests.get_survey_dropoff(session)
    return report_data

def plot_donations_by_month(data: list[tuple]) -> io.BytesIO:
    """
    –°–æ–∑–¥–∞–µ—Ç –≥—Ä–∞—Ñ–∏–∫ –≤ –≤–∏–¥–µ —Å—Ç–æ–ª–±—á–∞—Ç–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã –ø–æ –¥–∞–Ω–Ω—ã–º –æ –¥–æ–Ω–∞—Ü–∏—è—Ö.
    :param data: –°–ø–∏—Å–æ–∫ –∫–æ—Ä—Ç–µ–∂–µ–π (datetime.date, int), –≥–¥–µ date - –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞.
    :return: BytesIO –æ–±—ä–µ–∫—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º PNG.
    """
    if not data:
        return None

    # plt.style.use('ggplot') # –ú–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å —Å—Ç–∏–ª—å –ø–æ –≤–∫—É—Å—É
    fig, ax = plt.subplots(figsize=(10, 6))

    months = [item[0].strftime("%b %Y") for item in data]
    counts = [item[1] for item in data]

    ax.bar(months, counts, color='#E53935') # –§–∏—Ä–º–µ–Ω–Ω—ã–π –∫—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç

    ax.set_title('–î–∏–Ω–∞–º–∏–∫–∞ –¥–æ–Ω–∞—Ü–∏–π –ø–æ –º–µ—Å—è—Ü–∞–º', fontsize=16, pad=20)
    ax.set_ylabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–Ω–∞—Ü–∏–π')
    ax.tick_params(axis='x', rotation=45)
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ü–∏—Ñ—Ä—ã –Ω–∞–¥ —Å—Ç–æ–ª–±—Ü–∞–º–∏
    for i, v in enumerate(counts):
        ax.text(i, v + 0.5, str(v), ha='center', fontweight='bold')

    plt.tight_layout()

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –≤ –±—É—Ñ–µ—Ä –≤ –ø–∞–º—è—Ç–∏
    buf = io.BytesIO()
    plt.savefig(buf, format='png')
    buf.seek(0)
    plt.close(fig) # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ñ–∏–≥—É—Ä—É, —á—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –ø–∞–º—è—Ç—å

    return buf

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/utils/analytics_service.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/utils/calendar_service.py ---

import datetime
import pytz
from ics import Calendar, Event as IcsEvent
from ics.alarm import DisplayAlarm
from bot.db.models import Event as DbEvent
from bot.utils.text_messages import Text

def generate_ics_file(event: DbEvent) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ .ics —Ñ–∞–π–ª–∞ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è,
    –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –¥–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –≤ —Ç.—á. —Å Google Calendar.

    :param event: –û–±—ä–µ–∫—Ç –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
    :return: –°—Ç—Ä–æ–∫–∞ —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º .ics —Ñ–∞–π–ª–∞.
    """
    cal = Calendar()
    e = IcsEvent()

    timezone = pytz.timezone("Europe/Moscow")

    if event.event_datetime.tzinfo is None:
        start_time = timezone.localize(event.event_datetime)
    else:
        start_time = event.event_datetime.astimezone(timezone)

    end_time = start_time + datetime.timedelta(hours=2)

    e.name = f"–î–æ–Ω–∞—Ü–∏—è: {event.name}"
    e.begin = start_time
    e.end = end_time
    donation_type_ru = Text.DONATION_TYPE_RU.get(event.donation_type, event.donation_type)
    e.description = (
        f"–¢–∏–ø –¥–æ–Ω–∞—Ü–∏–∏: {donation_type_ru}.\n" # <-- –ò–ó–ú–ï–ù–ï–ù–û
        f"–ù–µ –∑–∞–±—É–¥—å—Ç–µ –≤–∑—è—Ç—å —Å —Å–æ–±–æ–π –ø–∞—Å–ø–æ—Ä—Ç –∏ —Ö–æ—Ä–æ—à–æ —Å–µ–±—è —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å. "
        f"–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à—É –ø–æ–º–æ—â—å!"
    )
    e.location = event.location
    e.created = datetime.datetime.now(tz=timezone)
    
    e.uid = f"{datetime.datetime.now().strftime('%Y%m%dT%H%M%S')}-{event.id}@donor.mifi.ru"
    

    alarm = DisplayAlarm(trigger=datetime.timedelta(hours=-1))
    
    e.alarms.append(alarm)
    
    cal.events.add(e)
    
    return cal.serialize()

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/utils/calendar_service.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/utils/data_import.py ---

import openpyxl
from sqlalchemy.ext.asyncio import AsyncSession
from bot.db.models import User, Donation
from bot.db import user_requests
import datetime
import pandas as pd
import re


def format_full_name(full_name: str) -> str:
    """
    Formats a full name by capitalizing the first letter of each word and removing extra spaces.
    """
    if not isinstance(full_name, str):
        return full_name

    full_name = re.sub(r'\s+', ' ', full_name).strip()
    return ' '.join(word.capitalize() for word in full_name.split())


async def import_data_from_file(session: AsyncSession, file_bytes: bytes) -> tuple[int, int]:
    """
    Imports data from an .xlsx file with the old format into the database.
    Returns a tuple of (created_count, updated_count).
    """
    df = pd.read_excel(file_bytes)

    column_mapping = {
        '–§–ò–û': 'full_name',
        '–¢–µ–ª–µ—Ñ–æ–Ω': 'phone_number',
        '–ì—Ä—É–ø–ø–∞': 'study_group',
        '–ö–æ–ª-–≤–æ –ì–∞–≤—Ä–∏–ª–æ–≤–∞': 'donations_gavrilov',
        '–ö–æ–ª-–≤–æ –§–ú–ë–ê': 'donations_fmba',
    }

    df = df.rename(columns=column_mapping)

    required_cols = ['full_name', 'phone_number']
    if not all(col in df.columns for col in required_cols):
        raise ValueError(f"–û—à–∏–±–∫–∞: –≤ —Ñ–∞–π–ª–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ ({', '.join(required_cols)}).")

    created_count = 0
    updated_count = 0

    for index, row in df.iterrows():
        phone = str(row['phone_number'])
        if not phone.startswith('+'):
            phone = '+' + phone
        user = await user_requests.get_user_by_phone(session, phone)

        study_group = row.get('study_group')
        university = "–ù–ò–Ø–£ –ú–ò–§–ò" if '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫' in str(study_group).lower() or (study_group and study_group != '-') else "–í–Ω–µ—à–Ω–∏–π –¥–æ–Ω–æ—Ä"
        faculty = "–°–æ—Ç—Ä—É–¥–Ω–∏–∫" if '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫' in str(study_group).lower() else None

        user_data = {
            'full_name': format_full_name(row.get('full_name')),
            'university': university,
            'faculty': faculty,
            'study_group': study_group if university == "–ù–ò–Ø–£ –ú–ò–§–ò" and faculty != "–°–æ—Ç—Ä—É–¥–Ω–∏–∫" else None,
            'role': 'student',
        }
        user_data = {k: v for k, v in user_data.items() if pd.notna(v)}

        if user:
            await user_requests.update_user_profile(session, user.id, user_data)
            updated_count += 1
        else:
            full_data = user_data.copy()
            full_data['phone_number'] = phone
            full_data['telegram_id'] = -index  # Use negative index for unique tg_id
            full_data['telegram_username'] = f"import_{phone}"
            user = await user_requests.add_user(session, full_data)
            await session.flush()  # Flush to get the user ID
            created_count += 1

        donations_gavrilov = row.get('donations_gavrilov', 0)
        donations_fmba = row.get('donations_fmba', 0)
        total_donations = (donations_gavrilov if pd.notna(donations_gavrilov) else 0) + \
                          (donations_fmba if pd.notna(donations_fmba) else 0)

        if total_donations > 0:
            for _ in range(int(total_donations)):
                donation = Donation(
                    user_id=user.id,
                    donation_date=datetime.date(2023, 1, 1),
                    donation_type='whole_blood',
                    points_awarded=0,
                    event_id=None
                )
                session.add(donation)

    await session.commit()
    return created_count, updated_count


--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/utils/data_import.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/utils/graduation.py ---

import datetime
from bot.db import user_requests

def calculate_graduation_year(group: str) -> int | None:
    """
    Calculates the graduation year based on the group name.
    Returns None if the group format is not recognized.
    """
    if not group or not isinstance(group, str):
        return None

    group_upper = group.upper()

    try:
        if group_upper.startswith('–ë') or group_upper.startswith('B'):
            # –ë–∞–∫–∞–ª–∞–≤—Ä–∏–∞—Ç - 4 –≥–æ–¥–∞
            year_prefix = int(group_upper[1:3])
            return 2000 + year_prefix + 4
        elif group_upper.startswith('–°') or group_upper.startswith('C'):
            # –°–ø–µ—Ü–∏–∞–ª–∏—Ç–µ—Ç - 5 –ª–µ—Ç
            year_prefix = int(group_upper[1:3])
            return 2000 + year_prefix + 5
        elif group_upper.startswith('–ú') or group_upper.startswith('M'):
            # –ú–∞–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä–∞ - 2 –≥–æ–¥–∞
            year_prefix = int(group_upper[1:3])
            return 2000 + year_prefix + 2
    except (ValueError, IndexError):
        return None

    return None

async def check_graduation_status(bot, session):
    """
    Checks the graduation status of all users and sends a notification
    to those who have graduated.
    """
    today = datetime.date.today()
    if today.month == 9:
        users = await user_requests.get_all_users(session)
        for user in users:
            if user.graduation_year and user.graduation_year <= today.year:
                await bot.send_message(
                    user.telegram_id,
                    "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ü–æ –Ω–∞—à–∏–º –¥–∞–Ω–Ω—ã–º, –≤—ã —É–∂–µ –≤—ã–ø—É—Å—Ç–∏–ª–∏—Å—å. "
                    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å "
                    "–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º."
                )


--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/utils/graduation.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/utils/qr_service.py ---

import io
import hashlib
import qrcode
import json
import logging
from PIL import Image
from pyzbar.pyzbar import decode, ZBarSymbol

from bot.config_reader import config

logger = logging.getLogger(__name__)

def create_secure_payload(data: dict) -> str:
    # –§–æ—Ä–º–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É –¥–ª—è QR-–∫–æ–¥–∞
    json_string = json.dumps(data, sort_keys=True, separators=(',', ':'))
    salt = config.qr_secret_key.get_secret_value()
    string_to_hash = json_string + salt
    # logger.info(f"[CREATE] String to be hashed: '{string_to_hash}'")
    h = hashlib.sha256(string_to_hash.encode()).hexdigest()
    # logger.info(f"[CREATE] Generated hash: {h}")
    return f"{json_string}|{h}"

def verify_secure_payload(payload: str) -> dict | None:
    # –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç—Ä–æ–∫—É –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
    try:
        json_string, received_hash = payload.split('|', 1)
        salt = config.qr_secret_key.get_secret_value()
        string_to_hash = json_string + salt
        # logger.info(f"[VERIFY] String to be hashed: '{string_to_hash}'")
        expected_hash = hashlib.sha256(string_to_hash.encode()).hexdigest()
        # logger.info(f"[VERIFY] Received hash:  {received_hash}")
        # logger.info(f"[VERIFY] Expected hash:  {expected_hash}")
        if received_hash == expected_hash:
            # logger.info("[VERIFY] Hashes MATCH. Verification successful.")
            return json.loads(json_string)
        else:
            # logger.error("[VERIFY] Hashes DO NOT MATCH. Verification failed.")
            return None
    except (ValueError, IndexError, json.JSONDecodeError) as e:
        # logger.error(f"[VERIFY] An exception occurred during verification: {e}")
        return None

async def generate_qr(data: dict) -> bytes:
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç QR-–∫–æ–¥
    # logger.info(f"--- Generating QR for data: {data} ---")
    payload = create_secure_payload(data)
    img = qrcode.make(payload)
    buf = io.BytesIO()
    img.save(buf, 'PNG')
    buf.seek(0)
    return buf.read()

async def read_qr(photo_bytes: bytes) -> dict | None:
    # –ß–∏—Ç–∞–µ—Ç QR-–∫–æ–¥ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
    try:
        image = Image.open(io.BytesIO(photo_bytes)).convert('L')
        decoded_objects = decode(image, symbols=[ZBarSymbol.QRCODE])
        if not decoded_objects:
            # logger.warning("pyzbar failed to find any QR codes on the image.")
            return None
        payload = decoded_objects[0].data.decode('utf-8')
        # logger.info(f"--- Verifying QR with payload: '{payload}' ---")
        verified_data = verify_secure_payload(payload)
        return verified_data
    except Exception as e:
        # logger.error(f"An exception occurred in read_qr: {e}", exc_info=True)
        return None


--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/utils/qr_service.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/utils/scheduler.py ---

import logging
import datetime
from aiogram import Bot
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from sqlalchemy.ext.asyncio import async_sessionmaker
from sqlalchemy import select, and_
from sqlalchemy.orm import joinedload
from bot.db.models import EventRegistration, MedicalWaiver, Event, User, Donation, NoShowReport
from bot.utils.text_messages import Text
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.fsm.context import FSMContext
from aiogram.fsm.storage.base import StorageKey
from bot.states.states import FeedbackSurvey
from bot.keyboards import inline
from bot.utils.graduation import check_graduation_status


logger = logging.getLogger(__name__)

async def send_reminders_for_interval(
    bot: Bot, 
    session_pool: async_sessionmaker, 
    time_from_now: datetime.timedelta, 
    time_window: datetime.timedelta,
    text_template: str
):
    now = datetime.datetime.now()
    start_time = now + time_from_now
    end_time = start_time + time_window

    logger.info(f"Running reminder job. Checking for events between {start_time.strftime('%Y-%m-%d %H:%M')} and {end_time.strftime('%Y-%m-%d %H:%M')}")
    
    async with session_pool() as session:
        stmt = (
            select(EventRegistration)
            .join(Event, EventRegistration.event_id == Event.id)
            .where(
                and_(
                    Event.event_datetime >= start_time,
                    Event.event_datetime < end_time,
                    EventRegistration.status == 'registered',
                    Event.is_active == True
                )
            )
            .options(
                joinedload(EventRegistration.user),
                joinedload(EventRegistration.event)
            )
        )
        
        results = await session.execute(stmt)
        registrations = results.scalars().unique().all()
        
        if not registrations:
            logger.info("No registrations found for this time window.")
            return
            
        logger.info(f"Found {len(registrations)} registrations to notify.")
        success_count = 0
        for reg in registrations:
            try:
                user = reg.user
                event = reg.event
                
                if not user or not event:
                    continue

                formatted_datetime = event.event_datetime.strftime('%d.%m.%Y %H:%M')
                
                safe_event_name = Text.escape_html(event.name)
                safe_datetime = Text.escape_html(formatted_datetime)
                location_link = Text.format_location_link(event.location, event.latitude, event.longitude)
                
                text = text_template.format(
                    event_name=safe_event_name,
                    event_datetime=safe_datetime,
                    event_location=location_link
                )

                await bot.send_message(chat_id=user.telegram_id, text=text, parse_mode="HTML")
                success_count += 1
            except Exception as e:
                logger.error(f"Failed to send reminder to user {reg.user_id} for event {reg.event_id}. Error: {e}", exc_info=True)
        
        logger.info(f"Job finished. Sent {success_count}/{len(registrations)} reminders.")

async def send_post_donation_feedback(bot: Bot, session_pool: async_sessionmaker, storage: MemoryStorage):
    """–ò–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –æ–ø—Ä–æ—Å –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ —á–µ—Ä–µ–∑ –¥–µ–Ω—å –ø–æ—Å–ª–µ –¥–æ–Ω–∞—Ü–∏–∏."""
    yesterday = datetime.date.today() - datetime.timedelta(days=1)
    logger.info(f"Running post-donation feedback job for donations made on {yesterday}.")

    async with session_pool() as session:
        stmt = (
            select(Donation)
            .options(joinedload(Donation.user))
            .where(
                Donation.donation_date == yesterday,
                Donation.feedback_requested == False
            )
        )
        results = await session.execute(stmt)
        donations_to_process = results.scalars().all()

        if not donations_to_process:
            logger.info("No donations found for feedback request.")
            return

        logger.info(f"Found {len(donations_to_process)} donations for feedback request.")
        success_count = 0
        for donation in donations_to_process:
            try:
                user = donation.user
                if not user:
                    continue
                
                storage_key = StorageKey(bot_id=bot.id, chat_id=user.telegram_id, user_id=user.telegram_id)
                state = FSMContext(storage=storage, key=storage_key)               
                
                await state.set_state(FeedbackSurvey.awaiting_well_being)
                await state.update_data(
                    event_id=donation.event_id,
                    donation_id=donation.id
                )
                
                await bot.send_message(
                    chat_id=user.telegram_id,
                    text=Text.FEEDBACK_START,
                    reply_markup=inline.get_feedback_well_being_keyboard()
                )
                
                donation.feedback_requested = True
                success_count += 1
            except Exception as e:
                logger.error(f"Failed to initiate feedback survey for user {donation.user_id}. Error: {e}", exc_info=True)
        
        if success_count > 0:
            await session.commit()
        
        logger.info(f"Post-donation feedback job finished. Initiated {success_count}/{len(donations_to_process)} surveys.")


async def check_waiver_expirations(bot: Bot, session_pool: async_sessionmaker):
    yesterday = datetime.date.today() - datetime.timedelta(days=1)
    async with session_pool() as session:
        stmt = (
            select(MedicalWaiver.user_id)
            .where(MedicalWaiver.end_date == yesterday)
        )
        results = await session.execute(stmt)
        user_ids_to_notify = results.scalars().unique().all()
        if not user_ids_to_notify:
            return
        users_stmt = select(User).where(User.id.in_(user_ids_to_notify))
        users_result = await session.execute(users_stmt)
        users = users_result.scalars().all()
        for user in users:
            try:
                await bot.send_message(chat_id=user.telegram_id, text=Text.WAIVER_EXPIRED_NOTIFICATION)
            except Exception as e:
                logger.error(f"Failed to send waiver expiration notification to user {user.id}. Error: {e}")


async def check_student_status(bot: Bot, session_pool: async_sessionmaker):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ –≤—ã–ø—É—Å—Ç–∏–ª—Å—è –ª–∏ —Å—Ç—É–¥–µ–Ω—Ç."""
    async with session_pool() as session:
        stmt = select(User).where(User.category == "student")
        results = await session.execute(stmt)
        students = results.scalars().all()

        for student in students:
            try:
                if student.study_group:
                    # Very simplified logic. A real implementation would be more complex.
                    study_group_year = int(student.study_group.split("-")[1][:2])
                    current_year = datetime.datetime.now().year % 100
                    if current_year - study_group_year > 4:
                        await bot.send_message(
                            chat_id=student.telegram_id,
                            text="–ü—Ä–∏–≤–µ—Ç! –ü–æ—Ö–æ–∂–µ, —Ç—ã —É–∂–µ –≤—ã–ø—É—Å—Ç–∏–ª—Å—è –∏–∑ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ."
                        )
            except Exception as e:
                logger.error(f"Failed to check student status for user {student.id}. Error: {e}", exc_info=True)

def setup_scheduler(bot: Bot, session_pool: async_sessionmaker, storage: MemoryStorage) -> AsyncIOScheduler:
    scheduler = AsyncIOScheduler(timezone="Europe/Moscow")

    scheduler.add_job(
        send_no_show_surveys,
        trigger='cron',
        hour='*',
        minute=5, 
        args=[bot, session_pool]
    )

    scheduler.add_job(
        send_reminders_for_interval,
        trigger='cron',
        hour=10,
        minute=0,
        args=[bot, session_pool, datetime.timedelta(days=7), datetime.timedelta(days=1), Text.REMINDER_WEEK]
    )
    scheduler.add_job(
        send_reminders_for_interval,
        trigger='cron',
        hour=10,
        minute=30,
        args=[bot, session_pool, datetime.timedelta(days=3), datetime.timedelta(days=1), Text.REMINDER_3_DAYS]
    )
    scheduler.add_job(
        send_reminders_for_interval,
        trigger='cron',
        hour=10,
        minute=30,
        args=[bot, session_pool, datetime.timedelta(days=1), datetime.timedelta(days=1), Text.REMINDER_1_DAY]
    )
    scheduler.add_job(
        send_reminders_for_interval,
        trigger='cron',
        hour='*',
        minute=0,
        args=[bot, session_pool, datetime.timedelta(hours=2), datetime.timedelta(hours=1), Text.REMINDER_2_HOURS]
    )
    scheduler.add_job(
        check_waiver_expirations,
        trigger='cron',
        hour=9,
        minute=0,
        args=[bot, session_pool]
    )
    
    scheduler.add_job(
        send_post_donation_feedback,
        trigger='cron',
        hour=11,
        minute=0,
        args=[bot, session_pool, storage]
    )
    
    scheduler.add_job(
        check_student_status,
        trigger='cron',
        month=9,
        day=1,
        hour=12,
        minute=0,
        args=[bot, session_pool]
    )

    scheduler.add_job(
        check_graduation_status,
        trigger='cron',
        month=9,
        day=1,
        hour=13,
        minute=0,
        args=[bot, session_pool]
    )

    logger.info("Scheduler configured successfully with 7 jobs.")
    return scheduler

async def send_no_show_surveys(bot: Bot, session_pool: async_sessionmaker):
    """–ù–∞—Ö–æ–¥–∏—Ç –Ω–µ—è–≤–∏–≤—à–∏—Ö—Å—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–º –æ–ø—Ä–æ—Å."""
    now = datetime.datetime.now()
    # –ò—â–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å 3-4 —á–∞—Å–∞ –Ω–∞–∑–∞–¥
    start_window = now - datetime.timedelta(hours=4)
    end_window = now - datetime.timedelta(hours=3)

    logger.info(f"Running no-show survey job for events ended between {start_window} and {end_window}")

    async with session_pool() as session:
        stmt = (
            select(EventRegistration)
            .join(Event)
            .where(
                Event.event_datetime.between(start_window, end_window),
                EventRegistration.status == 'registered'
            )
            .options(joinedload(EventRegistration.user), joinedload(EventRegistration.event))
        )
        results = await session.execute(stmt)
        no_shows = results.scalars().unique().all()
        
        if not no_shows:
            logger.info("No participants found for no-show survey.")
            return

        for reg in no_shows:
            try:
                builder = types.InlineKeyboardBuilder()
                reasons = {
                    "medical": "–ú–µ–¥–æ—Ç–≤–æ–¥ (–±–æ–ª–µ–∑–Ω—å)",
                    "personal": "–õ–∏—á–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã",
                    "forgot": "–ó–∞–±—ã–ª(–∞) / –Ω–µ –∑–∞—Ö–æ—Ç–µ–ª(–∞)"
                }
                for key, text in reasons.items():
                    builder.row(types.InlineKeyboardButton(
                        text=text,
                        callback_data=f"no_show_{reg.event_id}_{key}"
                    ))
                
                await bot.send_message(
                    chat_id=reg.user.telegram_id,
                    text=(
                        f"–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –í—ã –±—ã–ª–∏ –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –¥–æ–Ω–æ—Ä—Å–∫—É—é –∞–∫—Ü–∏—é ¬´{reg.event.name}¬ª, "
                        "–Ω–æ –Ω–µ –æ—Ç–º–µ—Ç–∏–ª–∏—Å—å —É –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–≤. –ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ—á–µ–º—É –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –ø—Ä–∏–π—Ç–∏?"
                    ),
                    reply_markup=builder.as_markup()
                )
                # –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å, —á—Ç–æ–±—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ
                reg.status = 'no_show_survey_sent'
            except Exception as e:
                logger.error(f"Failed to send no-show survey to user {reg.user_id}: {e}")
        
        await session.commit()

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/utils/scheduler.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/utils/text_messages.py ---

import html

class Text:
    @staticmethod
    def escape_html(text: str) -> str:
        """–≠–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è parse_mode=HTML."""
        if not isinstance(text, str):
            text = str(text)
        return html.escape(text)

    @staticmethod
    def format_location_link(text: str, latitude: float | None, longitude: float | None) -> str:
        # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –≤–∏–¥–∏–º—É—é —á–∞—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ –¥–ª—è HTML
        safe_visible_text = Text.escape_html(text)
        
        if latitude and longitude:
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º HTML-—Å—Å—ã–ª–∫—É
            url = f"https://yandex.ru/maps/?pt={longitude},{latitude}&z=18&l=map"
            return f'<a href="{url}">{safe_visible_text}</a>'
            
        # –ï—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ—Å—Ç–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        return safe_visible_text

    DONATION_TYPE_RU = {
        'whole_blood': '–¶–µ–ª—å–Ω–∞—è –∫—Ä–æ–≤—å',
        'plasma': '–ü–ª–∞–∑–º–∞',
        'platelets': '–¢—Ä–æ–º–±–æ—Ü–∏—Ç—ã',
        'erythrocytes': '–≠—Ä–∏—Ç—Ä–æ—Ü–∏—Ç—ã'
    }
    WELCOME = "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç –¥–æ–Ω–æ—Ä—Å–∫–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è –ú–ò–§–ò!\n\n–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º –∫–æ–Ω—Ç–∞–∫—Ç–æ–º. –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –≤–∞—à–µ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ —Å–∏—Å—Ç–µ–º–µ –¥–æ–Ω–æ—Ä–æ–≤."
    AUTH_SUCCESS = "‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {name}!"
    START_REGISTRATION = "üîç –ü–æ—Ö–æ–∂–µ, –≤—ã —É –Ω–∞—Å –≤–ø–µ—Ä–≤—ã–µ. –î–∞–≤–∞–π—Ç–µ –ø–æ–∑–Ω–∞–∫–æ–º–∏–º—Å—è!"
    GET_FULL_NAME = "üìù –í–≤–µ–¥–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∞—à–µ –§–ò–û (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á):"
    GET_UNIVERSITY = "üéì –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –í–£–ó:"
    GET_CUSTOM_UNIVERSITY = "–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ –í–£–ó–∞:"
    GET_FACULTY = "üèõÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à —Ñ–∞–∫—É–ª—å—Ç–µ—Ç:"
    GET_CUSTOM_FACULTY = "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∞:"
    GET_GROUP = "üî¢ –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤–∞—à–µ–π —É—á–µ–±–Ω–æ–π –≥—Ä—É–ø–ø—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ë20-505):"
    GET_GENDER = "üöª –£–∫–∞–∂–∏—Ç–µ –≤–∞—à –ø–æ–ª:"
    REGISTRATION_COMPLETE = "üéâ –û—Ç–ª–∏—á–Ω–æ! –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤—Å–µ–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏ –±–æ—Ç–∞."
    ERROR_WRONG_FORMAT = "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."
    INFO_PREPARE = (
        "<b>–ö–∞–∫ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ —Å–¥–∞—á–µ –∫—Ä–æ–≤–∏:</b>\n\n"
        "<b>–ù–∞–∫–∞–Ω—É–Ω–µ –∏ –≤ –¥–µ–Ω—å —Å–¥–∞—á–∏ –∫—Ä–æ–≤–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–æ:</b>\n"
        "‚ñ™Ô∏è –£–ø–æ—Ç—Ä–µ–±–ª—è—Ç—å –∂–∏—Ä–Ω—É—é, –∂–∞—Ä–µ–Ω—É—é, –æ—Å—Ç—Ä—É—é –∏ –∫–æ–ø—á–µ–Ω—É—é –ø–∏—â—É, –∫–æ–ª–±–∞—Å–Ω—ã–µ –∏–∑–¥–µ–ª–∏—è, –∞ —Ç–∞–∫–∂–µ –º—è—Å–Ω—ã–µ, —Ä—ã–±–Ω—ã–µ –∏ –º–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã, —è–π—Ü–∞ –∏ –º–∞—Å–ª–æ (–≤ —Ç.—á. —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–µ), —à–æ–∫–æ–ª–∞–¥, –æ—Ä–µ—Ö–∏ –∏ —Ñ–∏–Ω–∏–∫–∏.\n"
        "‚ñ™Ô∏è –ü—Ä–∏–Ω–∏–º–∞—Ç—å –∞–ª–∫–æ–≥–æ–ª—å –∑–∞ 48 —á–∞—Å–æ–≤ –¥–æ –¥–æ–Ω–∞—Ü–∏–∏.\n"
        "‚ñ™Ô∏è –ü—Ä–∏–Ω–∏–º–∞—Ç—å –ª–µ–∫–∞—Ä—Å—Ç–≤–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –∞—Å–ø–∏—Ä–∏–Ω –∏ –∞–Ω–∞–ª—å–≥–µ—Ç–∏–∫–∏, –∑–∞ 72 —á–∞—Å–∞ –¥–æ –¥–æ–Ω–∞—Ü–∏–∏.\n\n"
        "<b>–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å:</b>\n"
        "‚ñ™Ô∏è –•–æ—Ä–æ—à–æ –≤—ã—Å–ø–∞—Ç—å—Å—è.\n"
        "‚ñ™Ô∏è –õ–µ–≥–∫–æ –ø–æ–∑–∞–≤—Ç—Ä–∞–∫–∞—Ç—å (—Å–ª–∞–¥–∫–∏–π —á–∞–π, —Å—É—Ö–æ–µ –ø–µ—á–µ–Ω—å–µ, –∫–∞—à–∞ –Ω–∞ –≤–æ–¥–µ).\n"
        "‚ñ™Ô∏è –ù–µ –∫—É—Ä–∏—Ç—å –∑–∞ —á–∞—Å –¥–æ –¥–æ–Ω–∞—Ü–∏–∏.\n"
        "‚ñ™Ô∏è –ù–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –Ω–∞ –¥–æ–Ω–∞—Ü–∏—é –ø—Ä–∏ –Ω–µ–¥–æ–º–æ–≥–∞–Ω–∏–∏."
    )
    INFO_CONTRAINDICATIONS = (
        "<b>–ê–±—Å–æ–ª—é—Ç–Ω—ã–µ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è (–æ—Ç–≤–æ–¥ –æ—Ç –¥–æ–Ω–æ—Ä—Å—Ç–≤–∞ –Ω–∞–≤—Å–µ–≥–¥–∞):</b>\n\n"
        "‚ñ™Ô∏è –í–ò–ß-–∏–Ω—Ñ–µ–∫—Ü–∏—è, —Å–∏—Ñ–∏–ª–∏—Å, –≤–∏—Ä—É—Å–Ω—ã–µ –≥–µ–ø–∞—Ç–∏—Ç—ã.\n"
        "‚ñ™Ô∏è –¢—É–±–µ—Ä–∫—É–ª–µ–∑ (–≤—Å–µ —Ñ–æ—Ä–º—ã).\n"
        "‚ñ™Ô∏è –ë–æ–ª–µ–∑–Ω–∏ –∫—Ä–æ–≤–∏.\n"
        "‚ñ™Ô∏è –û–Ω–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è.\n"
        "‚ñ™Ô∏è –ù–∞—Ä–∫–æ–º–∞–Ω–∏—è, –∞–ª–∫–æ–≥–æ–ª–∏–∑–º.\n\n"
        "<b>–í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è:</b>\n"
        "‚ñ™Ô∏è –£–¥–∞–ª–µ–Ω–∏–µ –∑—É–±–∞ (10 –¥–Ω–µ–π).\n"
        "‚ñ™Ô∏è –ù–∞–Ω–µ—Å–µ–Ω–∏–µ —Ç–∞—Ç—É–∏—Ä–æ–≤–∫–∏, –ø–∏—Ä—Å–∏–Ω–≥ (1 –≥–æ–¥).\n"
        "‚ñ™Ô∏è –ê–Ω–≥–∏–Ω–∞, –≥—Ä–∏–ø–ø, –û–†–í–ò (1 –º–µ—Å—è—Ü –ø–æ—Å–ª–µ –≤—ã–∑–¥–æ—Ä–æ–≤–ª–µ–Ω–∏—è).\n"
        "‚ñ™Ô∏è –ü—Ä–∏–≤–∏–≤–∫–∏ (–æ—Ç 10 –¥–Ω–µ–π –¥–æ 1 –≥–æ–¥–∞)."
    )
    INFO_AFTER = (
        "<b>–ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø–æ—Å–ª–µ –¥–æ–Ω–∞—Ü–∏–∏:</b>\n\n"
        "‚ñ™Ô∏è –û—Ç–¥–æ—Ö–Ω–∏—Ç–µ 10‚Äì15 –º–∏–Ω—É—Ç.\n"
        "‚ñ™Ô∏è –ù–µ —Å–Ω–∏–º–∞–π—Ç–µ –ø–æ–≤—è–∑–∫—É 3‚Äì4 —á–∞—Å–∞.\n"
        "‚ñ™Ô∏è –ù–µ –ø–æ–¥–≤–µ—Ä–≥–∞–π—Ç–µ—Å—å —Ñ–∏–∑–∏—á–µ—Å–∫–∏–º –Ω–∞–≥—Ä—É–∑–∫–∞–º –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è.\n"
        "‚ñ™Ô∏è –í–æ–∑–¥–µ—Ä–∂–∏—Ç–µ—Å—å –æ—Ç —É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –∞–ª–∫–æ–≥–æ–ª—è –≤ —Ç–µ—á–µ–Ω–∏–µ —Å—É—Ç–æ–∫.\n"
        "‚ñ™Ô∏è –ü–µ–π—Ç–µ –±–æ–ª—å—à–µ –∂–∏–¥–∫–æ—Å—Ç–∏ –∏ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ –ø–∏—Ç–∞–π—Ç–µ—Å—å –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–≤—É—Ö —Å—É—Ç–æ–∫."
    )
    INFO_CONTACTS = (
        "<b>–°–≤—è–∑–∞—Ç—å—Å—è —Å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞–º–∏:</b>\n\n"
        "–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã, –≤—ã –º–æ–∂–µ—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏:\n"
        "‚ñ™Ô∏è –¢–µ–ª–µ–≥—Ä–∞–º-—á–∞—Ç –¥–ª—è –¥–æ–Ω–æ—Ä–æ–≤: [—Å—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç]\n"
        "‚ñ™Ô∏è –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ –¥–æ–Ω–æ—Ä—Å–∫–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ: [–ê–ª–µ–∫—Å–∞–Ω–¥—Ä, @Alkzaz7]"
    )
    NEW_EVENT_NOTIFICATION = (
        "üéâ <b>–ê–Ω–æ–Ω—Å –Ω–æ–≤–æ–≥–æ –¥–æ–Ω–æ—Ä—Å–∫–æ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è!</b> \n\n"
        "–û—Ç–∫—Ä—ã—Ç–∞ –∑–∞–ø–∏—Å—å –Ω–∞: <b>{event_name}</b>\n"
        "üóìÔ∏è <b>–ö–æ–≥–¥–∞:</b> {event_date} –≤ {event_time}\n"
        "üìç <b>–ì–¥–µ:</b> {event_location}\n\n"
        "–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–∏–Ω—è—Ç—å —É—á–∞—Å—Ç–∏–µ! –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –º–æ–∂–Ω–æ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å —á–µ—Ä–µ–∑ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –±–æ—Ç–∞. "
        "–í–∞—à–∞ –ø–æ–º–æ—â—å –æ—á–µ–Ω—å –≤–∞–∂–Ω–∞!"
    )

    PROFILE_DATA_TEMPLATE = (
        "üìä <b>–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ</b>\n\n"
        "üë§ <b>–§–ò–û:</b> {full_name}\n"
        "üéì <b>–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç:</b> {university}\n"
        "üèõÔ∏è <b>–§–∞–∫—É–ª—å—Ç–µ—Ç:</b> {faculty}, <b>–ì—Ä—É–ø–ø–∞:</b> {study_group}\n"
        "‚≠ê <b>–ë–∞–ª–ª—ã:</b> {points}\n"
        "üíâ <b>–í—Å–µ–≥–æ –¥–æ–Ω–∞—Ü–∏–π:</b> {total_donations}\n"
        "üóìÔ∏è <b>–°–ª–µ–¥—É—é—â–∞—è –¥–æ–Ω–∞—Ü–∏—è –≤–æ–∑–º–æ–∂–Ω–∞ —Å:</b> {next_date}\n"
        "--- --- ---\n"
        "<b>–ü–æ—Å–ª–µ–¥–Ω—è—è –¥–æ–Ω–∞—Ü–∏—è:</b> {last_donation_info}\n"
        "<b>–î–æ–Ω–æ—Ä –∫–æ—Å—Ç–Ω–æ–≥–æ –º–æ–∑–≥–∞ (–î–ö–ú):</b> {dkm_status}"
    )

    INFO_DKM = (
        "<b>ü©∏ –û –¥–æ–Ω–æ—Ä—Å—Ç–≤–µ –∫–æ—Å—Ç–Ω–æ–≥–æ –º–æ–∑–≥–∞ (–î–ö–ú)</b>\n\n"
        "<b>–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ?</b>\n"
        "–¢—Ä–∞–Ω—Å–ø–ª–∞–Ω—Ç–∞—Ü–∏—è –∫–æ—Å—Ç–Ω–æ–≥–æ –º–æ–∑–≥–∞ ‚Äî —ç—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —à–∞–Ω—Å –Ω–∞ –∂–∏–∑–Ω—å –¥–ª—è –º–Ω–æ–≥–∏—Ö –ª—é–¥–µ–π —Å —Ä–∞–∫–æ–º –∫—Ä–æ–≤–∏. –í–∞—à–∏ —Å—Ç–≤–æ–ª–æ–≤—ã–µ –∫–ª–µ—Ç–∫–∏ –º–æ–≥—É—Ç —Å–ø–∞—Å—Ç–∏ —á—å—é-—Ç–æ –∂–∏–∑–Ω—å.\n\n"
        "<b>–ö–∞–∫ –≤—Å—Ç—É–ø–∏—Ç—å –≤ —Ä–µ–≥–∏—Å—Ç—Ä?</b>\n"
        "–ù–∞ –∫–∞–∂–¥–æ–º –î–Ω–µ –î–æ–Ω–æ—Ä–∞ –≤ –ú–ò–§–ò –≤—ã –º–æ–∂–µ—Ç–µ —Å–¥–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–±–∏—Ä–∫—É –∫—Ä–æ–≤–∏ (4-9 –º–ª), —á—Ç–æ–±—ã –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –≤–Ω–µ—Å–ª–∏ –≤ –§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π —Ä–µ–≥–∏—Å—Ç—Ä –¥–æ–Ω–æ—Ä–æ–≤ –∫–æ—Å—Ç–Ω–æ–≥–æ –º–æ–∑–≥–∞. –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ, –±—ã—Å—Ç—Ä–æ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ.\n\n"
        "<b>–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–∞–ª—å—à–µ?</b>\n"
        "–ï—Å–ª–∏ –≤–∞—à–∏ –∫–ª–µ—Ç–∫–∏ —Å–æ–≤–ø–∞–¥—É—Ç —Å –∫–ª–µ—Ç–∫–∞–º–∏ –Ω—É–∂–¥–∞—é—â–µ–≥–æ—Å—è –ø–∞—Ü–∏–µ–Ω—Ç–∞, —Å –≤–∞–º–∏ —Å–≤—è–∂—É—Ç—Å—è. –°–∞–º–∞ –¥–æ–Ω–∞—Ü–∏—è –ø–æ—Ö–æ–∂–∞ –Ω–∞ —Å–¥–∞—á—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∫—Ä–æ–≤–∏ –∏ –∞–±—Å–æ–ª—é—Ç–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–∞ –¥–ª—è –≤–∞—Å."
    )

    INFO_MIFI_PROCESS = (
        "<b>üè• –ö–∞–∫ –ø—Ä–æ—Ö–æ–¥—è—Ç –î–Ω–∏ –î–æ–Ω–æ—Ä–∞ –≤ –ú–ò–§–ò</b>\n\n"
        "<b>1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:</b> –ó–∞—Ä–∞–Ω–µ–µ –∑–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ —É–¥–æ–±–Ω—É—é –¥–∞—Ç—É —á–µ—Ä–µ–∑ —ç—Ç–æ–≥–æ –±–æ—Ç–∞.\n"
        "<b>2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞:</b> –°–æ–±–ª—é–¥–∞–π—Ç–µ –¥–∏–µ—Ç—É –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ —Å–¥–∞—á–µ–π –∫—Ä–æ–≤–∏.\n"
        "<b>3. –í –¥–µ–Ω—å –∞–∫—Ü–∏–∏:</b> –ü—Ä–∏—Ö–æ–¥–∏—Ç–µ –≤ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è —Å –ø–∞—Å–ø–æ—Ä—Ç–æ–º. –í–æ–ª–æ–Ω—Ç–µ—Ä—ã –≤–∞—Å –≤—Å—Ç—Ä–µ—Ç—è—Ç –∏ –ø—Ä–æ–≤–æ–¥—è—Ç.\n"
        "<b>4. –û—Å–º–æ—Ç—Ä:</b> –í—ã –ø—Ä–æ–π–¥–µ—Ç–µ –Ω–µ–±–æ–ª—å—à–æ–π –æ—Å–º–æ—Ç—Ä —É –≤—Ä–∞—á–∞ –∏–∑ –¶–µ–Ω—Ç—Ä–∞ –ö—Ä–æ–≤–∏.\n"
        "<b>5. –î–æ–Ω–∞—Ü–∏—è:</b> –°–∞–º–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ —Å–¥–∞—á–∏ –∫—Ä–æ–≤–∏ –∑–∞–Ω–∏–º–∞–µ—Ç 10-15 –º–∏–Ω—É—Ç.\n"
        "<b>6. –û—Ç–¥—ã—Ö:</b> –ü–æ—Å–ª–µ –¥–æ–Ω–∞—Ü–∏–∏ –æ—Ç–¥–æ—Ö–Ω–∏—Ç–µ, –≤—ã–ø–µ–π—Ç–µ —Å–ª–∞–¥–∫–∏–π —á–∞–π —Å –ø–µ—á–µ–Ω—å–µ–º.\n"
        "<b>7. –ë–∞–ª–ª—ã –∏ –º–µ—Ä—á:</b> –ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥ —É –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –±–∞–ª–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –æ–±–º–µ–Ω—è—Ç—å –Ω–∞ –º–µ—Ä—á!\n\n"
        "–î–∞—Ç–∞ –±–ª–∏–∂–∞–π—à–µ–≥–æ –î–Ω—è –î–æ–Ω–æ—Ä–∞ –±—É–¥–µ—Ç –∞–Ω–æ–Ω—Å–∏—Ä–æ–≤–∞–Ω–∞ –≤ —Ä–∞—Å—Å—ã–ª–∫–µ."
    )

    CONSENT_TEXT = (
        "<b>–°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</b>\n\n"
        "–ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É ¬´–ü—Ä–∏–Ω–∏–º–∞—é —É—Å–ª–æ–≤–∏—è¬ª, –≤—ã –¥–∞–µ—Ç–µ —Å–≤–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–ª–µ–¥—É—é—â–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: –§–ò–û, –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, telegram-username, –¥–∞–Ω–Ω—ã–µ –æ –¥–æ–Ω–∞—Ü–∏—è—Ö.\n\n"
        "–¶–µ–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏: –≤–µ–¥–µ–Ω–∏–µ –±–∞–∑—ã –¥–æ–Ω–æ—Ä–æ–≤, –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö –∏ –Ω–æ–≤–æ—Å—Ç—è—Ö –¥–æ–Ω–æ—Ä—Å–∫–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è –ù–ò–Ø–£ –ú–ò–§–ò, –≤–µ–¥–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.\n\n"
        "–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –±—É–¥—É—Ç –ø–µ—Ä–µ–¥–∞–Ω—ã —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º, –∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º —Å–ª—É—á–∞–µ–≤, –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ–º."
    )

    WELCOME_BACK = "‚úÖ –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {name}!"
    MAIN_MENU_PROMPT = "–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"
    USER_BLOCKED_MESSAGE = "‚ùå –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤—ã –±—ã–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã."
    SWITCH_TO_DONOR_VIEW = "‚úÖ –í—ã –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –≤ —Ä–µ–∂–∏–º –¥–æ–Ω–æ—Ä–∞. –ó–¥–µ—Å—å –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏."
    ERROR_PROFILE_NOT_FOUND = "–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å."
    ALREADY_REGISTERED = "–í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã, {name}!"
    USER_BLOCKED_ON_AUTH = "‚ùå –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω."
    ACTION_CANCELLED = "–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ."
    ADMIN_SWITCH_TO_VOLUNTEER_VIEW = "‚≠ê <b>–í—ã –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –≤ —Ä–µ–∂–∏–º –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞</b>"
    UNKNOWN_COMMAND = "–Ø –Ω–µ –ø–æ–Ω–∏–º–∞—é —ç—Ç—É –∫–æ–º–∞–Ω–¥—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏."
    ERROR_GENERIC_ALERT = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    INFO_SECTION_NOT_FOUND = "–†–∞–∑–¥–µ–ª –Ω–µ –Ω–∞–π–¥–µ–Ω."
    GET_CATEGORY = "–£–∫–∞–∂–∏—Ç–µ –≤–∞—à—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é:"
    FIO_VALIDATION_ERROR = "‚ùå –§–ò–û –Ω–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ü–∏—Ñ—Ä –∏–ª–∏ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ."
    FACULTY_SELECTED = "–í—ã–±—Ä–∞–Ω —Ñ–∞–∫—É–ª—å—Ç–µ—Ç: {faculty}"
    GENDER_SELECTED = "–ü–æ–ª: {gender}"
    DATE_FORMAT_ERROR = "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –í–≤–µ–¥–∏—Ç–µ <b>–î–î.–ú–ú.–ì–ì–ì–ì</b>."
    PROFILE_MENU_HEADER = "üë§ <b>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ, —á—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç:"
    PROFILE_LOAD_ERROR = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å."
    NO_DONATION_HISTORY = "–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ –¥–æ–Ω–∞—Ü–∏—è—Ö."
    DONATION_HISTORY_HEADER = "ü©∏ <b>–í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è –¥–æ–Ω–∞—Ü–∏–π:</b>\n\n"
    DONATION_HISTORY_ITEM = "‚ñ™Ô∏è {date}: {type}, <b>+{points} –±–∞–ª–ª–æ–≤</b>\n"
    NO_ACTIVE_EVENTS = "–ê–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –¥–ª—è –∑–∞–ø–∏—Å–∏ —Å–µ–π—á–∞—Å –Ω–µ—Ç."
    CHOOSE_EVENT_TO_REGISTER = "–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –¥–ª—è –∑–∞–ø–∏—Å–∏:"
    ALREADY_REGISTERED_FOR_EVENT = (
        "–í—ã —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ ¬´<b>{event_name}</b>¬ª.\n\n"
        "üìç <b>–ú–µ—Å—Ç–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è:</b> {event_location}\n"
        "üè¢ <b>–¶–µ–Ω—Ç—Ä –∫—Ä–æ–≤–∏:</b> {blood_center_name}\n\n"
        "–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å QR-–∫–æ–¥ –∏–ª–∏ –æ—Ç–º–µ–Ω–∏—Ç—å —Å–≤–æ—é –∑–∞–ø–∏—Å—å."
    )
    REGISTRATION_SUCCESSFUL = (
        "‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞: <b>{event_name}</b>\n\n"
        "üìç <b>–ú–µ—Å—Ç–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è:</b> {event_location}\n"
        "üè¢ <b>–¶–µ–Ω—Ç—Ä –∫—Ä–æ–≤–∏:</b> {blood_center_name}\n\n"
        "–í–∞—à QR-–∫–æ–¥ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–æ–Ω–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ."
    )
    REGISTRATION_FAILED = "‚ùå –ó–∞–ø–∏—Å—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞.\n–ü—Ä–∏—á–∏–Ω–∞: {reason}"
    REGISTRATION_CANCELLED_SUCCESS = "‚úÖ –í–∞—à–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –±—ã–ª–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞."
    REGISTRATION_CANCELLED_FAIL = "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–∞ —É–∂–µ –±—ã–ª–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞."
    MERCH_NO_ITEMS = "–í –º–∞–≥–∞–∑–∏–Ω–µ –ø–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤."
    MERCH_ITEM_CAPTION = (
        "üõçÔ∏è <b>{item_name}</b>\n\n"
        "{item_description}\n\n"
        "–¶–µ–Ω–∞: <b>{item_price}</b> –±–∞–ª–ª–æ–≤\n"
        "–í–∞—à –±–∞–ª–∞–Ω—Å: <b>{user_points}</b> –±–∞–ª–ª–æ–≤"
    )
    MERCH_PURCHASE_INSUFFICIENT_FUNDS = "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤. –ù—É–∂–Ω–æ {price}, —É –≤–∞—Å {points}."
    MERCH_ITEM_NOT_FOUND = "–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω."
    MERCH_PURCHASE_CONFIRMATION = (
        "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∫—É–ø–∏—Ç—å <b>'{item_name}'</b> –∑–∞ <b>{item_price}</b> –±–∞–ª–ª–æ–≤?\n\n"
        "–í–∞—à –±–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏: <b>{new_balance}</b> –±–∞–ª–ª–æ–≤."
    )
    MERCH_PURCHASE_SUCCESS = "üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –ø–æ–∫—É–ø–∫–æ–π!\n{message}\n\n–ú—ã —Å–æ–æ–±—â–∏–º, –∫–æ–≥–¥–∞ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –∑–∞–±—Ä–∞—Ç—å –∑–∞–∫–∞–∑."
    MERCH_PURCHASE_ERROR = "‚ö†Ô∏è –û—à–∏–±–∫–∞: {message}"
    MERCH_NO_ORDERS = "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤."
    MERCH_ORDERS_HEADER = "üõçÔ∏è <b>–í–∞—à–∏ –∑–∞–∫–∞–∑—ã:</b>\n\n"
    MERCH_ORDER_ITEM = "‚ñ™Ô∏è <b>{item_name}</b> (–æ—Ç {date})\n   –°—Ç–∞—Ç—É—Å: <b>{status}</b>\n"
    MERCH_STATUS_MAP = {'pending_pickup': '–û–∂–∏–¥–∞–µ—Ç –≤—ã–¥–∞—á–∏', 'completed': '–í—ã–¥–∞–Ω'}
    MERCH_UPDATE_ERROR = "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ –≤ –º–∞–≥–∞–∑–∏–Ω –∑–∞–Ω–æ–≤–æ."
    WAIVERS_MENU_HEADER = "‚öïÔ∏è <b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º–∏ –æ—Ç–≤–æ–¥–∞–º–∏</b>\n"
    NO_ACTIVE_WAIVERS = "\n‚úÖ –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ—Ç–≤–æ–¥–æ–≤. –í—ã –º–æ–∂–µ—Ç–µ —Å–ø–∞—Å–∞—Ç—å –∂–∏–∑–Ω–∏! üí™"
    SYSTEM_WAIVERS_HEADER = "\n<b>–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º–æ–π/–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º (–Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å):</b>"
    USER_WAIVERS_HEADER = "\n<b>–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –≤–∞–º–∏ (–º–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å):</b>"
    WAIVER_ITEM_FORMAT = "‚ñ™Ô∏è –î–æ <b>{end_date}</b> –ø–æ –ø—Ä–∏—á–∏–Ω–µ: ¬´{reason}¬ª"
    WAIVER_SET_PROMPT = (
        "–í—ã –º–æ–∂–µ—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ—Ç–≤–æ–¥ –æ—Ç –¥–æ–Ω–æ—Ä—Å—Ç–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ –û–†–í–ò –∏–ª–∏ –ø–ª–æ—Ö–æ–≥–æ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è).\n\n"
        "–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É, –¥–æ –∫–æ—Ç–æ—Ä–æ–π –±—É–¥–µ—Ç –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –æ—Ç–≤–æ–¥, –≤ —Ñ–æ—Ä–º–∞—Ç–µ <b>–î–î.–ú–ú.–ì–ì–ì–ì</b>:"
    )
    WAIVER_DATE_IN_PAST_ERROR = "‚ùå –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ –±—É–¥—É—â–µ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    WAIVER_REASON_PROMPT = "–û—Ç–ª–∏—á–Ω–æ. –¢–µ–ø–µ—Ä—å –∫—Ä–∞—Ç–∫–æ —É–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–ü—Ä–æ—Å—Ç—É–¥–∞', '–ü–ª–æ—Ö–æ–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ'):"
    WAIVER_SET_SUCCESS = "‚úÖ –í–∞—à –ª–∏—á–Ω—ã–π –º–µ–¥–æ—Ç–≤–æ–¥ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–æ {end_date}."
    WAIVER_CANCELLATION_PROMPT = "–í—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫–æ–π –∏–∑ –≤–∞—à–∏—Ö –æ—Ç–≤–æ–¥–æ–≤ –æ—Ç–º–µ–Ω–∏—Ç—å:"
    WAIVER_NOTHING_TO_CANCEL = "–£ –≤–∞—Å –Ω–µ—Ç –æ—Ç–≤–æ–¥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å."
    WAIVER_CANCEL_SUCCESS = "‚úÖ –í–∞—à –º–µ–¥–æ—Ç–≤–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω."
    WAIVER_CANCEL_FAIL = "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –æ—Ç–≤–æ–¥."
    INFO_MENU_HEADER = "‚ÑπÔ∏è <b>–ü–æ–ª–µ–∑–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π –≤–∞—Å —Ä–∞–∑–¥–µ–ª:"
    QR_GENERATING = "–ì–µ–Ω–µ—Ä–∏—Ä—É—é –≤–∞—à QR-–∫–æ–¥..."
    QR_GENERAL_CAPTION = "–≠—Ç–æ—Ç QR-–∫–æ–¥ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏. –î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–æ–Ω–∞—Ü–∏–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ QR-–∫–æ–¥ –∏–∑ –º–µ–Ω—é –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è."
    QR_EVENT_CAPTION = "–ü–æ–∫–∞–∂–∏—Ç–µ —ç—Ç–æ—Ç QR-–∫–æ–¥ –≤–æ–ª–æ–Ω—Ç—ë—Ä—É –ø–æ—Å–ª–µ –¥–æ–Ω–∞—Ü–∏–∏ –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤."
    VOLUNTEER_MENU_HEADER = "‚≠ê <b>–ú–µ–Ω—é –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞</b>"
    VOLUNTEER_SEND_QR_PROMPT = "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é —Å QR-–∫–æ–¥–æ–º –¥–æ–Ω–æ—Ä–∞."
    QR_READ_ERROR = "‚ùå QR-–∫–æ–¥ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∏–ª–∏ –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    QR_INVALID_DATA_ERROR = "‚ùå QR-–∫–æ–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ."
    QR_DB_LOOKUP_ERROR = "‚ùå –û—à–∏–±–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–ª–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∏–∑ QR-–∫–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –±–∞–∑–µ."
    QR_DONOR_NOT_REGISTERED_ERROR = "‚ùå –û—à–∏–±–∫–∞: –î–æ–Ω–æ—Ä <b>{donor_name}</b> –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ —ç—Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ."
    QR_WRONG_DAY_ERROR = "‚ùå –û—à–∏–±–∫–∞: –≠—Ç–æ—Ç QR-–∫–æ–¥ –¥–ª—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –Ω–µ —Å–µ–≥–æ–¥–Ω—è."
    VOLUNTEER_CONFIRMATION_PROMPT = (
        "üîç <b>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–æ–Ω–∞—Ü–∏–∏</b>\n\n"
        "–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–æ–Ω–∞—Ü–∏—é –¥–ª—è:\n"
        "üë§ <b>–î–æ–Ω–æ—Ä:</b> {donor_name}\n"
        "üóìÔ∏è <b>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ:</b> {event_name}\n\n"
        "–í—Å–µ –≤–µ—Ä–Ω–æ?"
    )
    VOLUNTEER_CONFIRMATION_ERROR = "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∑–∞–Ω–æ–≤–æ."
    DONATION_CONFIRMING = "‚è≥ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é –¥–æ–Ω–∞—Ü–∏—é..."
    DONATION_CONFIRM_ERROR_NO_REG = "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–æ–Ω–æ—Ä–∞ –∏–ª–∏ –µ–≥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–∞ –±—ã–ª–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞."
    DONATION_CONFIRM_SUCCESS = (
        "‚úÖ –î–æ–Ω–∞—Ü–∏—è –¥–ª—è <b>{donor_name}</b> –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏ ¬´<b>{event_name}</b>¬ª –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞.\n\n"
        "–ù–∞—á–∏—Å–ª–µ–Ω–æ <b>{points}</b> –±–∞–ª–ª–æ–≤.\n\n–ì–æ—Ç–æ–≤—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π QR-–∫–æ–¥."
    )
    DONATION_CONFIRM_CRITICAL_ERROR = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –¥–æ–Ω–∞—Ü–∏–∏: {error}"
    VOLUNTEER_INVALID_INPUT_QR = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–º–µ–Ω–Ω–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é —Å QR-–∫–æ–¥–æ–º."
    ADMIN_PANEL_HEADER = "‚öôÔ∏è –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"
    ADMIN_EVENTS_HEADER = "üóìÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º–∏"
    EVENT_CREATE_STEP_1_NAME = "–®–∞–≥ 1/7: –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:"
    EVENT_CREATE_STEP_2_DATE = "–®–∞–≥ 2/7: –í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ <b>–î–î.–ú–ú.–ì–ì–ì–ì –ß–ß:–ú–ú</b> (–Ω–∞–ø—Ä–∏–º–µ—Ä, 25.12.2024 10:30):"
    EVENT_CREATE_STEP_3_LOCATION_TEXT = "–®–∞–≥ 3/7: –í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è —Ç–µ–∫—Å—Ç–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –ö–∞—à–∏—Ä—Å–∫–æ–µ —à–æ—Å—Å–µ, –¥. 31'):"
    EVENT_CREATE_STEP_4_LOCATION_POINT = "–®–∞–≥ 4/7: –û—Ç–ª–∏—á–Ω–æ. –¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–µ–æ—Ç–æ—á–∫—É –¥–ª—è —ç—Ç–æ–≥–æ –∞–¥—Ä–µ—Å–∞, —á—Ç–æ–±—ã –¥–æ–Ω–æ—Ä—ã –º–æ–≥–ª–∏ –ª–µ–≥–∫–æ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç."
    EVENT_CREATE_STEP_5_TYPE = "–®–∞–≥ 5/7: –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–æ–Ω–∞—Ü–∏–∏:"
    EVENT_CREATE_STEP_6_POINTS = "–í—ã–±—Ä–∞–Ω —Ç–∏–ø: {donation_type}\n\n–®–∞–≥ 6/7: –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–ª–æ–≤ –∑–∞ –¥–æ–Ω–∞—Ü–∏—é:"
    EVENT_CREATE_STEP_7_LIMIT = "–®–∞–≥ 7/7: –í–≤–µ–¥–∏—Ç–µ –ª–∏–º–∏—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:"
    EVENT_LIMIT_NAN_ERROR = "‚ùå –õ–∏–º–∏—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º."
    EVENT_POINTS_NAN_ERROR = "‚ùå –í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ."
    EVENT_CREATE_CONFIRMATION = (
        "‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–±—Ä–∞–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:\n\n"
        "‚ñ™Ô∏è –ù–∞–∑–≤–∞–Ω–∏–µ: {name}\n"
        "‚ñ™Ô∏è –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è: {datetime}\n"
        "‚ñ™Ô∏è –ê–¥—Ä–µ—Å: {location}\n"
        "‚ñ™Ô∏è –¶–µ–Ω—Ç—Ä –∫—Ä–æ–≤–∏: {blood_center_name}\n"
        "‚ñ™Ô∏è –¢–æ—á–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ: {location_set}\n"
        "‚ñ™Ô∏è –¢–∏–ø: {type}\n"
        "‚ñ™Ô∏è –ë–∞–ª–ª—ã: {points}\n"
        "‚ñ™Ô∏è –õ–∏–º–∏—Ç: {limit}\n\n"
        "–°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É?"
    )
    EVENT_CREATING_IN_PROGRESS = "–ü—Ä–∏–Ω—è—Ç–æ. –°–æ–∑–¥–∞—é –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ..."
    EVENT_CREATE_SUCCESS = "‚úÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!"
    MAILING_STARTED_NOTIFICATION = "‚è≥ –ù–∞—á–∏–Ω–∞—é —Ä–∞—Å—Å—ã–ª–∫—É. –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è..."
    MAILING_FINISHED_NOTIFICATION = "‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.\n\n–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {success}\n–û—à–∏–±–æ–∫: {fail}"
    MAILING_ERROR = "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è —Ä–∞—Å—Å—ã–ª–∫–∏."
    ADMIN_NO_ACTIVE_EVENTS = "–ê–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –Ω–µ—Ç."
    ADMIN_CHOOSE_EVENT_TO_MANAGE = "–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:\n(‚úÖ - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞, üîí - –∑–∞–∫—Ä—ã—Ç–∞)"
    EVENT_NOT_FOUND = "–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."
    EVENT_CARD_TEMPLATE = (
        "üóìÔ∏è {name}\n\n"
        "‚ñ™Ô∏è {date_header} {datetime}\n" 
        "‚ñ™Ô∏è {location_header} {location}\n"
        "‚ñ™Ô∏è <b>–¶–µ–Ω—Ç—Ä –∫—Ä–æ–≤–∏:</b> {blood_center_name}\n"
        "‚ñ™Ô∏è {type_header} {donation_type}\n"
        "‚ñ™Ô∏è {points_header} {points_per_donation}\n"
        "‚ñ™Ô∏è {limit_header} {reg_count}/{participant_limit}\n"
        "‚ñ™Ô∏è {status_header} {is_active}\n"
        "‚ñ™Ô∏è {reg_status_header} {reg_is_open}"
    )
    EVENT_TOGGLE_REG_OPEN = "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —Ç–µ–ø–µ—Ä—å –æ—Ç–∫—Ä—ã—Ç–∞."
    EVENT_TOGGLE_REG_CLOSED = "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —Ç–µ–ø–µ—Ä—å –∑–∞–∫—Ä—ã—Ç–∞."
    EVENT_EDIT_PROMPT = "–í—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç–µ: <b>{event_name}</b>\n\n–ö–∞–∫–æ–µ –ø–æ–ª–µ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å?"
    EVENT_EDIT_FIELD_PROMPTS = {
        "name": "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:",
        "event_date": "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –¥–∞—Ç—É (–î–î.–ú–ú.–ì–ì–ì–ì):",
        "location": "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –º–µ—Å—Ç–æ:",
        "points_per_donation": "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∫–æ–ª-–≤–æ –±–∞–ª–ª–æ–≤:",
        "participant_limit": "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ª–∏–º–∏—Ç:"
    }
    EVENT_EDIT_INVALID_FORMAT = "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    EVENT_EDIT_SUCCESS = "‚úÖ –ü–æ–ª–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!"
    EVENT_NO_PARTICIPANTS = "–ù–∞ '{event_name}' –ø–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –∑–∞–ø–∏—Å–∞–ª—Å—è."
    EVENT_PARTICIPANTS_CAPTION = "–£—á–∞—Å—Ç–Ω–∏–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è '{event_name}'"
    EVENT_CANCEL_CONFIRMATION = "üö® <b>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–º–µ–Ω—ã</b>\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å ¬´<b>{event_name}</b>¬ª?\n\n–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ <b>{reg_count}</b> —É—á–∞—Å—Ç–Ω–∏–∫–∞–º."
    EVENT_CANCELLING_IN_PROGRESS = "‚è≥ –ù–∞—á–∏–Ω–∞—é –ø—Ä–æ—Ü–µ—Å—Å –æ—Ç–º–µ–Ω—ã..."
    EVENT_CANCEL_NOTIFICATION_TEXT = "‚ùóÔ∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ, –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ!</b>\n\n–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, ¬´<b>{event_name}</b>¬ª, –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞ {datetime}, –±—ã–ª–æ –æ—Ç–º–µ–Ω–µ–Ω–æ."
    EVENT_CANCEL_SUCCESS_REPORT = "‚úÖ <b>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ ¬´{event_name}¬ª –æ—Ç–º–µ–Ω–µ–Ω–æ.</b>\n\n<b>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</b>\n- –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {success}\n- –û—à–∏–±–æ–∫: {fail}"
    MAILING_STEP_1_TEXT_PROMPT = (
        "–í—ã –Ω–∞—á–∞–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏.\n\n"
        "<b>–®–∞–≥ 1/3:</b> –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è. –û–Ω –±—É–¥–µ—Ç –ø–æ–¥–ø–∏—Å—å—é, –µ—Å–ª–∏ –≤—ã –¥–æ–±–∞–≤–∏—Ç–µ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ. "
        "–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTML-—Ç–µ–≥–∏: <b>–∂–∏—Ä–Ω—ã–π</b>, <i>–∫—É—Ä—Å–∏–≤</i>, <code>–∫–æ–¥</code>, <a href='...'>—Å—Å—ã–ª–∫–∞</a>.\n\n"
        "–ß—Ç–æ–±—ã –æ—Ç–º–µ–Ω–∏—Ç—å, –Ω–∞–∂–º–∏—Ç–µ /cancel."
    )
    MAILING_STEP_2_MEDIA_PROMPT = (
        "–¢–µ–∫—Å—Ç –ø–æ–ª—É—á–µ–Ω.\n\n"
        "<b>–®–∞–≥ 2/3:</b> –¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ, –∫–æ—Ç–æ—Ä–æ–µ –Ω—É–∂–Ω–æ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∫ —Ä–∞—Å—Å—ã–ª–∫–µ. "
        "–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç, –Ω–∞–∂–º–∏—Ç–µ '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å'."
    )
    MAILING_PHOTO_RECEIVED = "–§–æ—Ç–æ –ø–æ–ª—É—á–µ–Ω–æ.\n\n<b>–®–∞–≥ 3/3:</b> –í—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏—Ç–æ—Ä–∏—é –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏:"
    MAILING_VIDEO_RECEIVED = "–í–∏–¥–µ–æ –ø–æ–ª—É—á–µ–Ω–æ.\n\n<b>–®–∞–≥ 3/3:</b> –í—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏—Ç–æ—Ä–∏—é –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏:"
    MAILING_STEP_3_AUDIENCE_PROMPT = "<b>–®–∞–≥ 3/3:</b> –í—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏—Ç–æ—Ä–∏—é –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏:"
    MAILING_AUDIENCE_MAP = {
        "all": "–í—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º",
        "can_donate": "–î–æ–Ω–æ—Ä–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Å–¥–∞–≤–∞—Ç—å",
        "volunteers": "–í–æ–ª–æ–Ω—Ç–µ—Ä–∞–º",
        "admins": "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º"
    }
    MAILING_PREVIEW_HEADER = (
    "<b>üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞—Å—Å—ã–ª–∫—É –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º</b>\n\n"
    "<b>üë§ –ê—É–¥–∏—Ç–æ—Ä–∏—è:</b> {audience}\n"
    "<b>üë• –ü–æ–ª—É—á–∞—Ç–µ–ª–µ–π:</b> {count}\n"
    )
    MAILING_PREVIEW_WITH_PHOTO = "üñºÔ∏è <b>–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ —Ñ–æ—Ç–æ</b>\n"
    MAILING_PREVIEW_WITH_VIDEO = "üìπ <b>–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ –≤–∏–¥–µ–æ</b>\n"
    MAILING_PREVIEW_TEXT_HEADER = "\n<b>‚úâÔ∏è –¢–µ–∫—Å—Ç/–ø–æ–¥–ø–∏—Å—å:</b>\n------------------------------------\n{text}\n------------------------------------"
    MAILING_EDIT_TEXT_PROMPT = "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏:"
    MAILING_CONFIRMED_AND_RUNNING = "‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ. –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º."
    ADMIN_MERCH_HEADER = "üõçÔ∏è <b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–æ–º</b>"
    MERCH_CREATE_STEP_1_PHOTO = "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞."
    MERCH_PHOTO_RECEIVED = "–§–æ—Ç–æ –ø–æ–ª—É—á–µ–Ω–æ. –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:"
    MERCH_NAME_RECEIVED = "–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:"
    MERCH_DESC_RECEIVED = "–û–ø–∏—Å–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –≤ –±–∞–ª–ª–∞—Ö:"
    MERCH_PRICE_NAN_ERROR = "‚ùå –¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º."
    MERCH_CREATE_PHOTO_ID_ERROR = "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ID —Ñ–æ—Ç–æ –Ω–µ –±—ã–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ."
    MERCH_CREATE_SUCCESS = "‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!"
    ADMIN_NO_MERCH_ITEMS = "–í –º–∞–≥–∞–∑–∏–Ω–µ –ø–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤."
    ADMIN_CHOOSE_MERCH_TO_MANAGE = "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:"
    MERCH_CARD_CAPTION = (
        "üõçÔ∏è <b>–¢–æ–≤–∞—Ä: {name}</b>\n\n"
        "‚ñ™Ô∏è <b>–û–ø–∏—Å–∞–Ω–∏–µ:</b> {description}\n"
        "‚ñ™Ô∏è <b>–¶–µ–Ω–∞:</b> {price} –±–∞–ª–ª–æ–≤\n"
        "‚ñ™Ô∏è <b>–°—Ç–∞—Ç—É—Å:</b> {status}"
    )
    MERCH_EDIT_PROMPT = "–í—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç–µ: <b>{name}</b>\n\n–ö–∞–∫–æ–µ –ø–æ–ª–µ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å?"
    MERCH_EDIT_FIELD_PROMPTS = {
        "name": "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:",
        "description": "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:",
        "price": "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Ü–µ–Ω—É –≤ –±–∞–ª–ª–∞—Ö:"
    }
    MERCH_EDIT_NEW_VALUE_PROMPT = "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:"
    MERCH_EDIT_SUCCESS = "‚úÖ –ü–æ–ª–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!"
    MERCH_TOGGLE_AVAILABILITY = "–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: {status}."
    MERCH_DELETE_CONFIRMATION = "üóëÔ∏è <b>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</b>\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ <b>–±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ</b> —É–¥–∞–ª–∏—Ç—å ¬´<b>{name}</b>¬ª?"
    MERCH_DELETE_SUCCESS = "‚úÖ –¢–æ–≤–∞—Ä ¬´<b>{name}</b>¬ª –±—ã–ª —É–¥–∞–ª–µ–Ω."
    MERCH_ITEM_ALREADY_DELETED = "–¢–æ–≤–∞—Ä —É–∂–µ —É–¥–∞–ª–µ–Ω."
    ADMIN_NO_PENDING_ORDERS = "–ù–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç."
    ADMIN_PENDING_ORDERS_HEADER = "üì¶ <b>–ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã –Ω–∞ –≤—ã–¥–∞—á—É:</b>\n\n"
    ADMIN_ORDER_ITEM_TEXT = (
        "üîπ <b>–ó–∞–∫–∞–∑ ‚Ññ{order_id}</b> –æ—Ç {date}\n"
        "   –¢–æ–≤–∞—Ä: ¬´{item_name}¬ª\n"
        "   –ó–∞–∫–∞–∑–∞–ª: {user_link} (@{username})\n"
        "   –¢–µ–ª–µ—Ñ–æ–Ω: {phone}"
    )
    ADMIN_ORDER_ITEM_TEXT_NO_USERNAME = (
        "üîπ <b>–ó–∞–∫–∞–∑ ‚Ññ{order_id}</b> –æ—Ç {date}\n"
        "   –¢–æ–≤–∞—Ä: ¬´{item_name}¬ª\n"
        "   –ó–∞–∫–∞–∑–∞–ª: {user_link}\n"
        "   –¢–µ–ª–µ—Ñ–æ–Ω: {phone}"
    )
    ADMIN_COMPLETE_ORDER_ADMIN_ID_ERROR = "–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞."
    ADMIN_ORDER_NOT_FOUND_OR_PROCESSED = "–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω."
    ADMIN_ORDER_COMPLETED_SUCCESS = "‚úÖ –ó–∞–∫–∞–∑ ‚Ññ{order_id} –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –≤—ã–¥–∞–Ω–Ω—ã–π."
    USER_ORDER_COMPLETED_NOTIFICATION = "üéâ –í–∞—à –∑–∞–∫–∞–∑ ¬´{item_name}¬ª –±—ã–ª –≤—ã–¥–∞–Ω. –ü—Ä–∏—è—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è!"
    EXPORT_STARTED = "‚è≥ –ù–∞—á–∏–Ω–∞—é —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è."
    EXPORT_SUCCESSFUL = "‚úÖ –ü–æ–ª–Ω—ã–π –±—ç–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤."
    EXPORT_FAILED = "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—ç–∫–∞–ø–∞. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –ª–æ–≥–∞—Ö."
    ADMIN_USERS_HEADER = "üë• <b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</b>"
    ADMIN_NO_USERS_IN_DB = "–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."
    USERS_LIST_HEADER = "üìú <b>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–°—Ç—Ä–∞–Ω–∏—Ü–∞ {page}/{total_pages})</b>\n\n"
    USER_SEARCH_PROMPT = "üîç –í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ (–§–ò–û, username, ID, —Ç–µ–ª–µ—Ñ–æ–Ω):"
    USER_SEARCH_NO_RESULTS = "ü§∑‚Äç‚ôÇÔ∏è –ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏–∫–æ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."
    USER_SEARCH_RESULTS_HEADER = "üîç <b>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É ¬´{query}¬ª:</b>\n\n"
    USER_CARD_HEADER = "üë§ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {full_name}"
    USER_CARD_TEMPLATE = (
        "  <b>–§–ò–û:</b> {full_name}\n"
        "  <b>ID:</b> <code>{telegram_id}</code>\n"
        "  <b>Username:</b> @{username}\n"
        "  <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> <code>{phone_number}</code>\n"
        "  <b>–†–æ–ª—å:</b> <code>{role}</code>\n"
        "  <b>–ë–∞–ª–ª—ã:</b> <b>{points}</b>\n"
        "  <b>–°—Ç–∞—Ç—É—Å:</b> <b>{block_status}</b>"
    )
    USER_NOT_FOUND = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω."
    CHANGE_POINTS_PROMPT = "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –±–∞–ª–ª–æ–≤ –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 50) –∏–ª–∏ —Å–ø–∏—Å–∞–Ω–∏—è (-50):"
    CHANGE_POINTS_REASON_PROMPT = "–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è/—Å–ø–∏—Å–∞–Ω–∏—è:"
    CHANGE_POINTS_SUCCESS = "‚úÖ –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {name} –∏–∑–º–µ–Ω–µ–Ω. –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: {balance}"
    USER_POINTS_CHANGED_NOTIFICATION = "‚öôÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∏–∑–º–µ–Ω–∏–ª –≤–∞—à –±–∞–ª–∞–Ω—Å –Ω–∞ {points} –±–∞–ª–ª–æ–≤.\n<b>–ü—Ä–∏—á–∏–Ω–∞:</b> {reason}\n<b>–í–∞—à –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å:</b> {balance}"
    USER_PROMOTED_VOLUNTEER = "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {name} –Ω–∞–∑–Ω–∞—á–µ–Ω –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–º."
    USER_PROMOTED_VOLUNTEER_NOTIFY = "‚≠ê –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–∞–∑–Ω–∞—á–∏–ª –≤–∞—Å –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–º. –í–∞–º –¥–æ—Å—Ç—É–ø–Ω–æ –º–µ–Ω—é –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞."
    USER_DEMOTED_VOLUNTEER = "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {name} —Å–Ω—è—Ç —Å –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞."
    USER_DEMOTED_VOLUNTEER_NOTIFY = "‚öôÔ∏è –í–∞—à–∞ —Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ '—Å—Ç—É–¥–µ–Ω—Ç'. –ú–µ–Ω—é –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞ –±–æ–ª—å—à–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ."
    USER_PROMOTED_ADMIN = "‚úÖ {name} –Ω–∞–∑–Ω–∞—á–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º."
    USER_PROMOTED_ADMIN_NOTIFY = "–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í–∞—Å –Ω–∞–∑–Ω–∞—á–∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –±–æ—Ç–∞."
    USER_DEMOTED_ADMIN = "‚úÖ {name} —Ä–∞–∑–∂–∞–ª–æ–≤–∞–Ω –¥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞."
    USER_DEMOTED_ADMIN_NOTIFY = "–í–∞—à–∞ —Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ '—Å—Ç—É–¥–µ–Ω—Ç'."
    BLOCK_USER_REASON_PROMPT = "–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:"
    ADMIN_ID_ERROR = "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –≤–∞—Å."
    BLOCK_TARGET_USER_NOT_FOUND = "–û—à–∏–±–∫–∞: —Ü–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω."
    USER_BLOCKED_SUCCESS = "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {name} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –ü—Ä–∏—á–∏–Ω–∞: {reason}"
    USER_BLOCKED_NOTIFY = "–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –±—ã–ª –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.\n–ü—Ä–∏—á–∏–Ω–∞: {reason}"
    USER_UNBLOCKED_SUCCESS = "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {name} —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω."
    USER_UNBLOCKED_NOTIFY = "üéâ –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –±—ã–ª —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –¢–µ–ø–µ—Ä—å –≤—ã —Å–Ω–æ–≤–∞ –º–æ–∂–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º."
    MANAGE_USER_REGS_HEADER = "üéüÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è–º–∏ –¥–ª—è: <b>{name}</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
    MANUAL_REG_CHOOSE_EVENT = "–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ –Ω—É–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:"
    MANUAL_REG_NO_EVENTS = "–ù–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –¥–ª—è –∑–∞–ø–∏—Å–∏."
    MANUAL_REG_SUCCESS_NOTIFY = "‚öôÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∞–ª –≤–∞—Å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ ¬´<b>{event_name}</b>¬ª –Ω–∞ {datetime}."
    NOTIFY_USER_FAILED = "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {name}."
    MANUAL_CANCEL_CHOOSE_REG = "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å:"
    MANUAL_CANCEL_NO_REGS = "–£ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π –Ω–∞ –±—É–¥—É—â–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è."
    MANUAL_CANCEL_SUCCESS = "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {name} –Ω–∞ {event_name} –æ—Ç–º–µ–Ω–µ–Ω–∞."
    MANUAL_CANCEL_SUCCESS_NOTIFY = "‚öôÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–º–µ–Ω–∏–ª –≤–∞—à—É –∑–∞–ø–∏—Å—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ ¬´<b>{event_name}</b>¬ª."
    MANUAL_CANCEL_FAIL = "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ –æ—Ç–º–µ–Ω–µ–Ω–∞)."
    MANAGE_WAIVERS_HEADER = "‚öïÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–¥–æ—Ç–≤–æ–¥–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è <b>{name}</b>.\n\n"
    MANAGE_WAIVERS_NO_WAIVERS = "–ê–∫—Ç–∏–≤–Ω—ã—Ö –º–µ–¥–æ—Ç–≤–æ–¥–æ–≤ –Ω–µ—Ç. –í—ã –º–æ–∂–µ—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–π."
    MANAGE_WAIVERS_WITH_WAIVERS = "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –º–µ–¥–æ—Ç–≤–æ–¥, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å, –∏–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–æ–≤—ã–π:"
    MANUAL_WAIVER_DATE_PROMPT = "–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –º–µ–¥–æ—Ç–≤–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì:"
    MANUAL_WAIVER_REASON_PROMPT = "–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –º–µ–¥–æ—Ç–≤–æ–¥–∞:"
    MANUAL_WAIVER_SUCCESS = "‚úÖ –ú–µ–¥–æ—Ç–≤–æ–¥ –¥–ª—è {name} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–æ {date}."
    MANUAL_WAIVER_NOTIFY = "‚öïÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É—Å—Ç–∞–Ω–æ–≤–∏–ª –≤–∞–º –º–µ–¥–æ—Ç–≤–æ–¥ –¥–æ {date}.\n<b>–ü—Ä–∏—á–∏–Ω–∞:</b> {reason}"
    ADMIN_DELETE_WAIVER_DATA_ERROR = "–û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    ADMIN_DELETE_WAIVER_SUCCESS = "‚úÖ –ú–µ–¥–æ—Ç–≤–æ–¥ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω."
    ADMIN_DELETE_WAIVER_FAIL = "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –º–µ–¥–æ—Ç–≤–æ—Ç."
    ADMIN_DELETE_WAIVER_NOTIFY = "‚öôÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–º–µ–Ω–∏–ª –æ–¥–∏–Ω –∏–∑ –≤–∞—à–∏—Ö –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –æ—Ç–≤–æ–¥–æ–≤."
    WAIVER_EXPIRED_NOTIFICATION = "üéâ –û—Ç–ª–∏—á–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏! –°—Ä–æ–∫ –≤–∞—à–µ–≥–æ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –æ—Ç–≤–æ–¥–∞ –∏—Å—Ç–µ–∫. –í—ã —Å–Ω–æ–≤–∞ –º–æ–∂–µ—Ç–µ —Å–ø–∞—Å–∞—Ç—å –∂–∏–∑–Ω–∏, —É—á–∞—Å—Ç–≤—É—è –≤ –¥–æ–Ω–∞—Ü–∏—è—Ö! üí™"
    REMINDER_WEEK = (
        "üëã <b>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –¥–æ–Ω–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é!</b> \n\n"
        "–í—ã –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ ¬´<b>{event_name}</b>¬ª, –∫–æ—Ç–æ—Ä–æ–µ —Å–æ—Å—Ç–æ–∏—Ç—Å—è —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é - <b>{event_datetime}</b>.\n\n"
        "üìç <b>–ú–µ—Å—Ç–æ:</b> {event_location}\n\n"
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ –≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ –¥–æ–Ω–∞—Ü–∏–∏ –∑–∞—Ä–∞–Ω–µ–µ –∏ —Å–ª–µ–¥–∏—Ç–µ –∑–∞ —Å–≤–æ–∏–º —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ–º. –°–ø–∞—Å–∏–±–æ!"
    )
    REMINDER_3_DAYS = (
        "üëã <b>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –¥–æ–Ω–∞—Ü–∏–∏!</b> \n\n"
        "–í—ã –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ ¬´<b>{event_name}</b>¬ª, –∫–æ—Ç–æ—Ä–æ–µ —Å–æ—Å—Ç–æ–∏—Ç—Å—è —á–µ—Ä–µ–∑ 3 –¥–Ω—è - <b>{event_datetime}</b>.\n\n"
        "üìç <b>–ú–µ—Å—Ç–æ:</b> {event_location}\n\n"
        "–ù–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ –∑–∞ 48 —á–∞—Å–æ–≤ –¥–æ –¥–æ–Ω–∞—Ü–∏–∏ –Ω–µ–ª—å–∑—è –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ª–µ–∫–∞—Ä—Å—Ç–≤–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –∞—Å–ø–∏—Ä–∏–Ω –∏ –∞–Ω–∞–ª—å–≥–µ—Ç–∏–∫–∏."
    )
    REMINDER_2_DAYS = (
        "üëã <b>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –¥–æ–Ω–∞—Ü–∏–∏!</b> \n\n"
        "–í—ã –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ ¬´<b>{event_name}</b>¬ª, –∫–æ—Ç–æ—Ä–æ–µ —Å–æ—Å—Ç–æ–∏—Ç—Å—è —á–µ—Ä–µ–∑ 2 –¥–Ω—è - <b>{event_datetime}</b>.\n\n"
        "üìç <b>–ú–µ—Å—Ç–æ:</b> {event_location}\n\n"
        "–ù–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ –∑–∞ 48 —á–∞—Å–æ–≤ –¥–æ –¥–æ–Ω–∞—Ü–∏–∏ –Ω–µ–ª—å–∑—è –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ª–µ–∫–∞—Ä—Å—Ç–≤–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –∞—Å–ø–∏—Ä–∏–Ω –∏ –∞–Ω–∞–ª—å–≥–µ—Ç–∏–∫–∏."
    )
    REMINDER_1_DAY = (
        "üëã <b>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –¥–æ–Ω–∞—Ü–∏–∏!</b> \n\n"
        "–í—ã –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ ¬´<b>{event_name}</b>¬ª, –∫–æ—Ç–æ—Ä–æ–µ —Å–æ—Å—Ç–æ–∏—Ç—Å—è –∑–∞–≤—Ç—Ä–∞, <b>{event_datetime}</b>.\n\n"
        "üìç <b>–ú–µ—Å—Ç–æ:</b> {event_location}\n\n"
        "–ù–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ –∑–∞ 24 —á–∞—Å–∞ –¥–æ –¥–æ–Ω–∞—Ü–∏–∏ –Ω–µ–ª—å–∑—è —É–ø–æ—Ç—Ä–µ–±–ª—è—Ç—å –ë–ê–î—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –∑–∞–±—É–¥—å—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç –∏ —Ö–æ—Ä–æ—à–æ –≤—ã—Å–ø–∏—Ç–µ—Å—å. –°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç–µ!"
    )
    REMINDER_2_HOURS = (
        "‚ùóÔ∏è<b>–î–æ–Ω–∞—Ü–∏—è —É–∂–µ —Å–∫–æ—Ä–æ!</b> \n\n"
        "–ù–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ –≤—ã –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ ¬´<b>{event_name}</b>¬ª, –∫–æ—Ç–æ—Ä–æ–µ –Ω–∞—á–Ω–µ—Ç—Å—è —É–∂–µ —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞, –≤ <b>{event_datetime}</b>.\n\n"
        "–ñ–¥–µ–º –≤–∞—Å –ø–æ –∞–¥—Ä–µ—Å—É: {event_location}"
    )
    POST_DONATION_FEEDBACK = "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ —Ç—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å?\n\n–û—Ü–µ–Ω–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è 1/5"
    FEEDBACK_START = "üëã –ü—Ä–∏–≤–µ—Ç! –°–ø–∞—Å–∏–±–æ –∑–∞ —Ç–≤–æ—é –¥–æ–Ω–∞—Ü–∏—é –≤—á–µ—Ä–∞. –ú—ã –±—ã–ª–∏ –±—ã –æ—á–µ–Ω—å –ø—Ä–∏–∑–Ω–∞—Ç–µ–ª—å–Ω—ã, –µ—Å–ª–∏ –±—ã —Ç—ã –æ—Ç–≤–µ—Ç–∏–ª(–∞) –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –Ω–∞–º —Å—Ç–∞—Ç—å –ª—É—á—à–µ!\n\n–î–ª—è –Ω–∞—á–∞–ª–∞, –∫–∞–∫ —Ç—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å –ø–æ—Å–ª–µ –¥–æ–Ω–∞—Ü–∏–∏? –û—Ü–µ–Ω–∏ –ø–æ —à–∫–∞–ª–µ –æ—Ç 1 (–æ—á–µ–Ω—å –ø–ª–æ—Ö–æ) –¥–æ 5 (–æ—Ç–ª–∏—á–Ω–æ)."
    FEEDBACK_WELL_BEING_BAD = "–ù–∞–º –∂–∞–ª—å —ç—Ç–æ —Å–ª—ã—à–∞—Ç—å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω–µ —Ç–∞–∫? (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–∫—Ä—É–∂–∏—Ç—Å—è –≥–æ–ª–æ–≤–∞', '—Å–ª–∞–±–æ—Å—Ç—å'). –ï—Å–ª–∏ —Ç–µ–±–µ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–≤—è–∂–∏—Å—å —Å –Ω–∞–º–∏!"
    FEEDBACK_GET_ORGANIZATION_SCORE = "–ü–æ–Ω—è—Ç–Ω–æ, —Å–ø–∞—Å–∏–±–æ! –¢–µ–ø–µ—Ä—å –æ—Ü–µ–Ω–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é —Å–∞–º–æ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –ø–æ —à–∫–∞–ª–µ –æ—Ç 1 (–æ—á–µ–Ω—å –ø–ª–æ—Ö–æ) –¥–æ 10 (–æ—Ç–ª–∏—á–Ω–æ)."
    FEEDBACK_GET_WHAT_LIKED = "–û—Ç–ª–∏—á–Ω–æ! –†–∞—Å—Å–∫–∞–∂–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —á—Ç–æ —Ç–µ–±–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ?"
    FEEDBACK_GET_WHAT_DISLIKED = "–°–ø–∞—Å–∏–±–æ! –ê —á—Ç–æ –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã —É–ª—É—á—à–∏—Ç—å? –ß—Ç–æ –Ω–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å?"
    FEEDBACK_GET_OTHER_SUGGESTIONS = "–ü—Ä–∏–Ω—è—Ç–æ. –ò –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å: –µ—Å—Ç—å –ª–∏ —É —Ç–µ–±—è –∫–∞–∫–∏–µ-–ª–∏–±–æ –¥—Ä—É–≥–∏–µ –∏–¥–µ–∏ –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è?"
    FEEDBACK_FINISH = "üéâ –û–ø—Ä–æ—Å –∑–∞–≤–µ—Ä—à—ë–Ω! –û–≥—Ä–æ–º–Ω–æ–µ —Å–ø–∞—Å–∏–±–æ –∑–∞ —Ç–≤–æ—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å. –û–Ω–∞ –æ—á–µ–Ω—å –≤–∞–∂–Ω–∞ –¥–ª—è –Ω–∞—Å!"
    FEEDBACK_ADMIN_HEADER = "üìä <b>–û—Ç–∑—ã–≤—ã –ø–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é ¬´{event_name}¬ª</b>\n\n"
    FEEDBACK_ADMIN_NO_FEEDBACK = "–ü–æ —ç—Ç–æ–º—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é –ø–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤."
    FEEDBACK_ADMIN_ITEM = (
        "--- –û—Ç–∑—ã–≤ –æ—Ç {user_name} ---\n"
        "<b>–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ:</b> {wb_score}/5\n"
        "<i>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</i> {wb_comment}\n"
        "<b>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è:</b> {org_score}/10\n"
        "<b>üëç –ü–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å:</b> {liked}\n"
        "<b>üëé –ù–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å:</b> {disliked}\n"
        "<b>üí¨ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:</b> {suggestions}\n\n"
    )

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/utils/text_messages.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: bot/utils/__init__.py ---



--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: bot/utils/__init__.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: donor_bot_telegram.egg-info/dependency_links.txt ---




--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: donor_bot_telegram.egg-info/dependency_links.txt ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: donor_bot_telegram.egg-info/SOURCES.txt ---

README.md
pyproject.toml
bot/__init__.py
bot/config_reader.py
bot/db/__init__.py
bot/db/admin_requests.py
bot/db/analytics_requests.py
bot/db/engine.py
bot/db/event_requests.py
bot/db/info_requests.py
bot/db/merch_requests.py
bot/db/models.py
bot/db/qa_management.py
bot/db/question_requests.py
bot/db/user_requests.py
bot/filters/role.py
bot/handlers/__init__.py
bot/handlers/common.py
bot/handlers/main_admin.py
bot/handlers/other.py
bot/handlers/student.py
bot/handlers/volunteer.py
bot/handlers/admin/__init__.py
bot/handlers/admin/analytics.py
bot/handlers/admin/event_management.py
bot/handlers/admin/info_management.py
bot/handlers/admin/mailing.py
bot/handlers/admin/merch_management.py
bot/handlers/admin/qa_management.py
bot/handlers/admin/system.py
bot/handlers/admin/user_management.py
bot/keyboards/__init__.py
bot/keyboards/inline.py
bot/keyboards/reply.py
bot/middlewares/__init__.py
bot/middlewares/block.py
bot/middlewares/db.py
bot/states/__init__.py
bot/states/states.py
bot/utils/__init__.py
bot/utils/analytics_service.py
bot/utils/calendar_service.py
bot/utils/graduation.py
bot/utils/qr_service.py
bot/utils/scheduler.py
bot/utils/text_messages.py
donor_bot_telegram.egg-info/PKG-INFO
donor_bot_telegram.egg-info/SOURCES.txt
donor_bot_telegram.egg-info/dependency_links.txt
donor_bot_telegram.egg-info/top_level.txt
tests/test_admin_fsm.py
tests/test_analytics.py
tests/test_calendar_service.py
tests/test_db_requests.py
tests/test_filters.py
tests/test_graduation.py
tests/test_handlers_logic.py
tests/test_keyboards.py
tests/test_mailing_logic.py
tests/test_middlewares.py
tests/test_registration_logic.py
tests/test_scheduler_logic.py
tests/test_security.py
tests/test_survey_logic.py
tests/test_utils.py
tests/test_volunteer_fsm.py

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: donor_bot_telegram.egg-info/SOURCES.txt ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: donor_bot_telegram.egg-info/top_level.txt ---

bot


--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: donor_bot_telegram.egg-info/top_level.txt ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: logs/pytest-logs.txt ---

ERROR    main:main.py:95 Telegram WebApp data validation failed: Invalid hash. Raw auth_data: 'auth_date=1700000000&query_id=AAg123456789&user=%7B%22id%22%3A123%2C%22username%22%3A%22test%22%7D&hash=125b98532e863d708dcf6141ea32692de0537a3a4a18cbe18b38e5abcdefghij'
ERROR    main:main.py:95 Telegram WebApp data validation failed: Hash not found in auth data. Raw auth_data: 'user=%7B%22id%22%3A+123%7D&auth_date=1700000000'
ERROR    main:main.py:95 Telegram WebApp data validation failed: Invalid hash. Raw auth_data: 'auth_date=1700000000&query_id=AAg123456789&user=%7B%22id%22%3A123%7D&hash=40f05e5ab6663c9f1ef8c1ce079b8ae543366d3c47562462714dcd19790c2116&new_param=hacker'


--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: logs/pytest-logs.txt ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: tests/conftest.py ---

# tests/conftest.py

import pytest
import pytest_asyncio
import sys
from pathlib import Path
from typing import AsyncGenerator

from sqlalchemy.ext.asyncio import (
    create_async_engine,
    async_sessionmaker,
    AsyncSession,
    AsyncEngine,
)

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É—Ç–µ–π ---
# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –≤ sys.path, —á—Ç–æ–±—ã pytest –º–æ–≥ –Ω–∞–π—Ç–∏ –º–æ–¥—É–ª–∏ –±–æ—Ç–∞.
# –≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∏–º–ø–æ—Ä—Ç–æ–≤ –≤ —Ç–µ—Å—Ç–∞—Ö.
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from bot.db.models import Base

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î ---

# URL –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö SQLite –≤ –ø–∞–º—è—Ç–∏.
# –≠—Ç–æ –∏–¥–µ–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤,
# —Ç–∞–∫ –∫–∞–∫ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ –∏ –∏—Å—á–µ–∑–∞–µ—Ç –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤.
TEST_DATABASE_URL = "sqlite+aiosqlite:///:memory:"

# –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –¥–≤–∏–∂–æ–∫ –ë–î. –û–Ω –±—É–¥–µ—Ç –∂–∏—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ –≤—Å–µ–π —Ç–µ—Å—Ç–æ–≤–æ–π —Å–µ—Å—Å–∏–∏.
test_engine: AsyncEngine = create_async_engine(TEST_DATABASE_URL, echo=False)

# –°–æ–∑–¥–∞–µ–º —Ñ–∞–±—Ä–∏–∫—É —Å–µ—Å—Å–∏–π –¥–ª—è —Ç–µ—Å—Ç–æ–≤.
# –û–Ω–∞ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–µ—Å—Å–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞.
TestSessionMaker = async_sessionmaker(
    bind=test_engine, class_=AsyncSession, expire_on_commit=False
)


@pytest_asyncio.fixture(scope="session", autouse=True)
async def setup_database() -> AsyncGenerator[None, None]:
    """
    –§–∏–∫—Å—Ç—É—Ä–∞ —É—Ä–æ–≤–Ω—è —Å–µ—Å—Å–∏–∏ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

    `scope="session"`: –∫–æ–¥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤.
    `autouse=True`: —Ñ–∏–∫—Å—Ç—É—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –µ–µ –Ω–µ –Ω—É–∂–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å –≤ —Ç–µ—Å—Ç–∞—Ö.

    –î–µ–π—Å—Ç–≤–∏—è:
    1. –ü–µ—Ä–µ–¥ —Ç–µ—Å—Ç–∞–º–∏: —Å–æ–∑–¥–∞–µ—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–æ–¥–µ–ª–µ–π SQLAlchemy.
    2. –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤: —É–¥–∞–ª—è–µ—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã, –æ—á–∏—â–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏–µ.
    """
    async with test_engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
    
    yield  # –í —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤—Å–µ —Ç–µ—Å—Ç—ã

    async with test_engine.begin() as conn:
        await conn.run_sync(Base.metadata.drop_all)


@pytest_asyncio.fixture(scope="function")
async def session(setup_database: None) -> AsyncGenerator[AsyncSession, None]:
    """
    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –≤ –∫–∞–∂–¥—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –∫–µ–π—Å.

    `scope="function"`: –∫–æ–¥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–π –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–µ—Å—Ç–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏.
    `setup_database`: –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Ñ–∏–∫—Å—Ç—É—Ä—ã, –∫–æ—Ç–æ—Ä–∞—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ç–∞–±–ª–∏—Ü—ã —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã.

    –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤:
    1. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î.
    2. –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è.
    3. –°–æ–∑–¥–∞–µ—Ç—Å—è —Å–µ—Å—Å–∏—è, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–∞—è –∫ —ç—Ç–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
    4. –°–µ—Å—Å–∏—è –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ —Ç–µ—Å—Ç (`yield session`).
    5. –¢–µ—Å—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–≤–æ–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ, –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö).
    6. –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Å—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è (`rollback`), –æ—Ç–º–µ–Ω—è—è –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è,
       —Å–¥–µ–ª–∞–Ω–Ω—ã–µ –≤ —Ç–µ—Å—Ç–µ.
    7. –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è.

    –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –∫–∞–∂–¥—ã–π —Ç–µ—Å—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –∞–±—Å–æ–ª—é—Ç–Ω–æ —á–∏—Å—Ç–æ–π –ë–î.
    """
    connection = await test_engine.connect()
    transaction = await connection.begin()

    try:
        # –°–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—É—é –∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        session_for_test = TestSessionMaker(bind=connection)
        yield session_for_test
    finally:
        # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
        await transaction.rollback()
        await connection.close()
        
@pytest.fixture(scope="session")
def session_pool() -> async_sessionmaker:
    """
    –§–∏–∫—Å—Ç—É—Ä–∞, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ñ–∞–±—Ä–∏–∫—É —Å–µ—Å—Å–∏–π (session maker).
    –û–Ω–∞ –Ω—É–∂–Ω–∞ –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Å–∞–º–∏ —É–ø—Ä–∞–≤–ª—è—é—Ç —Å–æ–∑–¥–∞–Ω–∏–µ–º —Å–µ—Å—Å–∏–π,
    –Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞.
    """
    return TestSessionMaker

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: tests/conftest.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: tests/test_admin_fsm.py ---

import pytest
import datetime
from unittest.mock import AsyncMock, Mock

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from aiogram import Bot

from bot.handlers.admin import merch_management as merch_handlers
from bot.handlers.admin import user_management as user_handlers
from bot.handlers.admin import event_management as event_handlers
from bot.handlers.admin import mailing as mailing_handlers
from bot.states.states import MerchCreation, BlockUser, ManualWaiver, EventEditing, UserSearch, Mailing, AdminAddUser, EditInfoSection, PostEventProcessing

from bot.db.models import MerchItem, User, UserBlock, MedicalWaiver, Event, InfoText, Donation, EventRegistration
from bot.handlers.admin import info_management as info_handlers


pytestmark = pytest.mark.asyncio

class MockMessage:
    def __init__(self, text=None, from_user_id=1, photo=None):
        self.text = text
        self.from_user = Mock(id=from_user_id)
        self.photo = [Mock(file_id="photo_file_id_123")] if photo else None
        self.html_text = text
        self.answer = AsyncMock()
        self.delete = AsyncMock()

class MockCallbackQuery:
    def __init__(self, data, from_user_id=1, message=None):
        self.data = data
        self.from_user = Mock(id=from_user_id)
        if not message:
            self.message = MockMessage(from_user_id=from_user_id)
        else:
            self.message = message
        for method_name in ['edit_text', 'delete', 'answer']:
            if not hasattr(self.message, method_name):
                setattr(self.message, method_name, AsyncMock())
        self.answer = AsyncMock()

class MockFSMContext:
    def __init__(self):
        self._state = None
        self._data = {}
    async def get_state(self): return self._state
    async def set_state(self, state): self._state = state
    async def get_data(self): return self._data.copy()
    async def update_data(self, **kwargs): self._data.update(kwargs)
    async def clear(self):
        self._state = None
        self._data = {}

async def test_merch_creation_fsm_full_path(session: AsyncSession):
    admin_user_id = 1001
    state = MockFSMContext()
    callback_start = MockCallbackQuery(data="admin_create_merch", from_user_id=admin_user_id)
    await merch_handlers.start_merch_creation(callback_start, state)
    assert await state.get_state() == MerchCreation.awaiting_photo
    msg_photo = MockMessage(from_user_id=admin_user_id, photo=True)
    await merch_handlers.process_merch_photo(msg_photo, state)
    assert await state.get_state() == MerchCreation.awaiting_name
    msg_name = MockMessage(text="–ö—Ä—É—Ç–∞—è –∫—Ä—É–∂–∫–∞", from_user_id=admin_user_id)
    await merch_handlers.process_merch_name(msg_name, state)
    assert await state.get_state() == MerchCreation.awaiting_description
    msg_desc = MockMessage(text="–û—á–µ–Ω—å –∫—Ä—É—Ç–∞—è –∫—Ä—É–∂–∫–∞ –¥–ª—è –¥–æ–Ω–æ—Ä–æ–≤", from_user_id=admin_user_id)
    await merch_handlers.process_merch_description(msg_desc, state)
    assert await state.get_state() == MerchCreation.awaiting_price
    msg_price = MockMessage(text="150", from_user_id=admin_user_id)
    await merch_handlers.process_merch_price(msg_price, state, session)
    assert await state.get_state() is None
    created_item = (await session.execute(select(MerchItem))).scalar_one_or_none()
    assert created_item is not None
    assert created_item.name == "–ö—Ä—É—Ç–∞—è –∫—Ä—É–∂–∫–∞"

async def test_block_user_fsm_full_path(session: AsyncSession, mocker):
    mock_bot = Mock(spec=Bot)
    mock_bot.send_message = AsyncMock()
    main_admin = User(phone_number="+1", telegram_id=1001, full_name="Main Admin", university="Test")
    target_user = User(phone_number="+2", telegram_id=2002, full_name="Target User", university="Test")
    session.add_all([main_admin, target_user])
    await session.commit()
    state = MockFSMContext()
    callback_start = MockCallbackQuery(data=f"ma_block_user_{target_user.id}", from_user_id=main_admin.telegram_id)
    await user_handlers.block_user_from_card(callback_start, state)
    assert await state.get_state() == BlockUser.awaiting_reason
    msg_reason = MockMessage(text="–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª", from_user_id=main_admin.telegram_id)
    await user_handlers.process_block_reason(msg_reason, state, session, mock_bot)
    assert await state.get_state() is None
    await session.refresh(target_user)
    assert target_user.is_blocked is True
    mock_bot.send_message.assert_called_once()

async def test_manual_waiver_fsm_full_path(session: AsyncSession, mocker):
    mock_bot = Mock(spec=Bot)
    mock_bot.send_message = AsyncMock()
    admin = User(phone_number="+1", telegram_id=1001, full_name="Admin", university="Test")
    target_user = User(phone_number="+2", telegram_id=2002, full_name="Target User", university="Test")
    session.add_all([admin, target_user])
    await session.commit()
    state = MockFSMContext()
    callback_start = MockCallbackQuery(data=f"admin_waiver_{target_user.id}", from_user_id=admin.telegram_id)
    await user_handlers.set_waiver_start(callback_start, state)
    assert await state.get_state() == ManualWaiver.awaiting_end_date
    msg_date = MockMessage(text="01.01.2099", from_user_id=admin.telegram_id)
    await user_handlers.set_waiver_date(msg_date, state)
    assert await state.get_state() == ManualWaiver.awaiting_reason
    msg_reason = MockMessage(text="–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è", from_user_id=admin.telegram_id)
    await user_handlers.set_waiver_reason(msg_reason, state, session, mock_bot)
    assert await state.get_state() is None
    waiver_record = (await session.execute(select(MedicalWaiver))).scalar_one_or_none()
    assert waiver_record is not None
    mock_bot.send_message.assert_called_once()

async def test_user_search_fsm_full_path(session: AsyncSession):
    admin_id = 1001
    user_to_find = User(phone_number="+7123", telegram_id=123, full_name="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω", university="Test")
    session.add(user_to_find)
    await session.commit()
    state = MockFSMContext()
    callback = MockCallbackQuery(data="admin_search_user", from_user_id=admin_id)
    await user_handlers.search_user_start(callback, state)
    assert await state.get_state() == UserSearch.awaiting_query
    message = MockMessage(text="–ò–≤–∞–Ω–æ–≤", from_user_id=admin_id)
    await user_handlers.process_user_search(message, state, session)
    assert await state.get_state() is None
    message.answer.assert_called_once()
    args, kwargs = message.answer.call_args
    assert "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞" in args[0]
    assert "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω" in str(kwargs['reply_markup'])

async def test_event_editing_fsm_full_path(session: AsyncSession, mocker):
    admin_id = 1001
    event = Event(name="–°—Ç–∞—Ä–æ–µ –ù–∞–∑–≤–∞–Ω–∏–µ", event_datetime=datetime.datetime.now(), location="Test", donation_type="d", points_per_donation=1, participant_limit=1)
    session.add(event)
    await session.commit()
    state = MockFSMContext()
    callback_start = MockCallbackQuery(data=f"admin_edit_event_{event.id}", from_user_id=admin_id)
    await event_handlers.start_event_editing(callback_start, state, session)
    assert await state.get_state() == EventEditing.choosing_field
    callback_choose_field = MockCallbackQuery(data="edit_field_name", from_user_id=admin_id)
    await event_handlers.choose_field_to_edit(callback_choose_field, state)
    assert await state.get_state() == EventEditing.awaiting_new_value
    message = MockMessage(text="–ù–æ–≤–æ–µ –®–∏–∫–∞—Ä–Ω–æ–µ –ù–∞–∑–≤–∞–Ω–∏–µ", from_user_id=admin_id)
    await event_handlers.process_new_value_for_event(message, state, session)
    assert await state.get_state() is None
    await session.refresh(event)
    assert event.name == "–ù–æ–≤–æ–µ –®–∏–∫–∞—Ä–Ω–æ–µ –ù–∞–∑–≤–∞–Ω–∏–µ"
    message.answer.assert_called_once_with("‚úÖ –ü–æ–ª–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!", reply_markup=mocker.ANY)

async def test_mailing_fsm_full_path(session: AsyncSession, mocker):
    mock_do_mailing = mocker.patch("bot.handlers.admin.mailing.do_mailing", new_callable=AsyncMock)
    admin = User(id=1001, phone_number="+1", telegram_id=1001, full_name="Admin", university="–ù–ò–Ø–£ –ú–ò–§–ò", role="admin")
    user_mifi = User(id=1, phone_number="+2", telegram_id=1, full_name="User1", university="–ù–ò–Ø–£ –ú–ò–§–ò", role="student")
    user_mgu = User(id=2, phone_number="+3", telegram_id=2, full_name="User2", university="–ú–ì–£", role="student")
    session.add_all([admin, user_mifi, user_mgu])
    await session.commit()
    state = MockFSMContext()
    cb_start = MockCallbackQuery(data="admin_mailing", from_user_id=admin.id)
    await mailing_handlers.start_mailing(cb_start, state)
    assert await state.get_state() == Mailing.awaiting_message_text
    msg_text = MockMessage(text="<b>–í—Å–µ–º –ø—Ä–∏–≤–µ—Ç!</b>", from_user_id=admin.id)
    await mailing_handlers.get_mailing_text(msg_text, state)
    assert await state.get_state() == Mailing.awaiting_media
    msg_photo = MockMessage(from_user_id=admin.id, photo=True)
    await mailing_handlers.get_mailing_photo(msg_photo, state)
    assert await state.get_state() == Mailing.awaiting_audience_choice
    cb_choose_filter = MockCallbackQuery(data="mail_audience_type_university", from_user_id=admin.id)
    await mailing_handlers.choose_audience_filter_type(cb_choose_filter, state, session)
    cb_set_filter = MockCallbackQuery(data="mail_filter_university_–ù–ò–Ø–£ –ú–ò–§–ò", from_user_id=admin.id)
    await mailing_handlers.set_audience_filter(cb_set_filter, state)
    cb_finish_audience = MockCallbackQuery(data="mail_audience_finish", from_user_id=admin.id)
    await mailing_handlers.finish_audience_selection(cb_finish_audience, state, session)
    assert await state.get_state() == Mailing.awaiting_confirmation
    cb_finish_audience.message.answer.assert_called_once()
    args, _ = cb_finish_audience.message.answer.call_args
    assert "<b>üë• –ü–æ–ª—É—á–∞—Ç–µ–ª–µ–π:</b> 2" in args[0]
    assert "–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ —Ñ–æ—Ç–æ" in args[0]
    cb_confirm = MockCallbackQuery(data="confirm_mailing", from_user_id=admin.id)
    await mailing_handlers.confirm_and_start_mailing(cb_confirm, state, Mock(spec=Bot))
    assert await state.get_state() is None
    mock_do_mailing.assert_called_once()

async def test_admin_add_user_fsm_full_path(session: AsyncSession):
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—É—é FSM-—Ü–µ–ø–æ—á–∫—É —Ä—É—á–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.
    """
    admin_user_id = 1001
    state = MockFSMContext()

    callback_start = MockCallbackQuery(data="admin_add_user_start", from_user_id=admin_user_id)
    await user_handlers.add_user_start(callback_start, state)
    assert await state.get_state() == AdminAddUser.awaiting_phone
    callback_start.message.edit_text.assert_called_once()

    await user_handlers.add_user_phone(MockMessage(text="+79876543210"), state, session)
    assert await state.get_state() == AdminAddUser.awaiting_full_name

    await user_handlers.add_user_full_name(MockMessage(text="–ú–∞–Ω—É–∞–ª–æ–≤ –ú–∞–Ω—É–∞–ª –ú–∞–Ω—É–∞–ª–æ–≤–∏—á"), state)
    assert await state.get_state() == AdminAddUser.awaiting_category

    await user_handlers.add_user_category(MockCallbackQuery(data="category_student"), state)
    assert await state.get_state() == AdminAddUser.awaiting_university
    
    await user_handlers.add_user_university(MockCallbackQuery(data="university_mifi"), state)
    assert await state.get_state() == AdminAddUser.awaiting_faculty

    await user_handlers.add_user_faculty(MockCallbackQuery(data="faculty_–ò–ò–ö–°"), state)
    assert await state.get_state() == AdminAddUser.awaiting_study_group

    await user_handlers.add_user_study_group(MockMessage(text="–ë21-123"), state)
    assert await state.get_state() == AdminAddUser.awaiting_gender

    callback_gender = MockCallbackQuery(data="gender_male")
    await user_handlers.add_user_gender(callback_gender, state, session)
    
    assert await state.get_state() is None

    created_user = (await session.execute(
        select(User).where(User.phone_number == "+79876543210")
    )).scalar_one_or_none()

    assert created_user is not None
    assert created_user.full_name == "–ú–∞–Ω—É–∞–ª–æ–≤ –ú–∞–Ω—É–∞–ª –ú–∞–Ω—É–∞–ª–æ–≤–∏—á"
    assert created_user.university == "–ù–ò–Ø–£ –ú–ò–§–ò"
    assert created_user.faculty == "–ò–ò–ö–°"
    assert created_user.study_group == "–ë21-123"
    assert created_user.telegram_id == 0
    assert created_user.consent_given is True


async def test_edit_info_section_fsm(session: AsyncSession):
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç FSM —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞.
    """
    admin_user_id = 1001
    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–ø–∏—Å—å –≤ –ë–î
    info_section = InfoText(
        section_key="prepare",
        section_title="–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞",
        section_text="–°—Ç–∞—Ä—ã–π —Ç–µ–∫—Å—Ç"
    )
    session.add(info_section)
    await session.commit()

    state = MockFSMContext()
    
    callback_start = MockCallbackQuery(data="admin_edit_info", from_user_id=admin_user_id)
    await info_handlers.start_info_editing(callback_start, state, session)
    assert await state.get_state() == EditInfoSection.choosing_section
    
    callback_choose = MockCallbackQuery(data="edit_info_prepare", from_user_id=admin_user_id)
    await info_handlers.choose_section_to_edit(callback_choose, state, session)
    assert await state.get_state() == EditInfoSection.awaiting_new_text
    
    new_text = "<b>–≠—Ç–æ –Ω–æ–≤—ã–π, –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç!</b>"
    message_new_text = MockMessage(text=new_text, from_user_id=admin_user_id)
    # –ò–º–∏—Ç–∏—Ä—É–µ–º, —á—Ç–æ message.html_text —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ—Ç –∂–µ —Ç–µ–∫—Å—Ç
    message_new_text.html_text = new_text 
    await info_handlers.process_new_info_text(message_new_text, state, session)
    assert await state.get_state() is None

    await session.refresh(info_section) 
    assert info_section.section_text == new_text
    
    
    
      
async def test_post_event_processing_fsm(session: AsyncSession, mocker):
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—É—é FSM-—Ü–µ–ø–æ—á–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ—à–µ–¥—à–µ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:
    - –í—ã–±–æ—Ä –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
    - –û—Ç–º–µ—Ç–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (—Å–¥–∞–ª –∫—Ä–æ–≤—å / –≤—Å—Ç—É–ø–∏–ª –≤ –î–ö–ú)
    - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –ë–î
    """
    # 1. –ü–û–î–ì–û–¢–û–í–ö–ê –î–ê–ù–ù–´–•
    admin = User(phone_number="+0", telegram_id=1000, full_name="Admin", university="Test")
    user1 = User(phone_number="+1", telegram_id=1001, full_name="User One", university="Test", is_dkm_donor=False, points=0, gender="male")
    user2 = User(phone_number="+2", telegram_id=1002, full_name="User Two", university="Test", is_dkm_donor=False, points=0, gender="female")
    
    past_event = Event(
        name="Past Event", 
        event_datetime=datetime.datetime.now() - datetime.timedelta(days=5),
        location="Test", donation_type="whole_blood", points_per_donation=100, participant_limit=10
    )
    session.add_all([admin, user1, user2, past_event])
    await session.commit()
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
    reg1 = EventRegistration(user_id=user1.id, event_id=past_event.id)
    reg2 = EventRegistration(user_id=user2.id, event_id=past_event.id)
    session.add_all([reg1, reg2])
    await session.commit()

    state = MockFSMContext()
    
    # 2. –ü–†–û–•–û–ñ–î–ï–ù–ò–ï FSM
    
    # --- –®–∞–≥ 1: –í—ã–±–æ—Ä –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è ---
    callback_start = MockCallbackQuery(data=f"post_process_event_{past_event.id}", from_user_id=admin.telegram_id)
    await event_handlers.choose_event_for_processing(callback_start, state, session)
    assert await state.get_state() == PostEventProcessing.marking_participants
    
    # --- –®–∞–≥ 2: –û—Ç–º–µ—á–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ---
    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 1: —Å–¥–∞–ª –∫—Ä–æ–≤—å
    cb_mark1 = MockCallbackQuery(data=f"mark_participant_{past_event.id}_{user1.id}_donation", from_user_id=admin.telegram_id, message=callback_start.message)
    await event_handlers.mark_participant(cb_mark1, state, session)
    
    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 2: —Å–¥–∞–ª –∫—Ä–æ–≤—å
    cb_mark2_don = MockCallbackQuery(data=f"mark_participant_{past_event.id}_{user2.id}_donation", from_user_id=admin.telegram_id, message=callback_start.message)
    await event_handlers.mark_participant(cb_mark2_don, state, session)
    
    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 2: –≤—Å—Ç—É–ø–∏–ª –≤ –î–ö–ú
    cb_mark2_dkm = MockCallbackQuery(data=f"mark_participant_{past_event.id}_{user2.id}_dkm", from_user_id=admin.telegram_id, message=callback_start.message)
    await event_handlers.mark_participant(cb_mark2_dkm, state, session)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ FSM
    fsm_data = await state.get_data()
    assert fsm_data["marked_donations"] == {user1.id, user2.id}
    assert fsm_data["marked_dkm"] == {user2.id}

    # --- –®–∞–≥ 3: –ó–∞–≤–µ—Ä—à–∞–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º ---
    callback_finish = MockCallbackQuery(data=f"finish_marking_{past_event.id}", from_user_id=admin.telegram_id, message=callback_start.message)
    await event_handlers.finish_marking(callback_finish, state, session)

    # 3. –ü–†–û–í–ï–†–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –í –ë–î
    assert await state.get_state() is None
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 1
    await session.refresh(user1)
    donations_user1 = (await session.execute(select(Donation).where(Donation.user_id == user1.id))).scalars().all()
    assert len(donations_user1) == 1
    assert user1.points == 100
    assert user1.is_dkm_donor is False # –ù–µ –æ—Ç–º–µ—á–∞–ª–∏ –î–ö–ú

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 2
    await session.refresh(user2)
    donations_user2 = (await session.execute(select(Donation).where(Donation.user_id == user2.id))).scalars().all()
    assert len(donations_user2) == 1
    assert user2.points == 100
    assert user2.is_dkm_donor is True # –û—Ç–º–µ—á–∞–ª–∏ –î–ö–ú

    

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: tests/test_admin_fsm.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: tests/test_analytics.py ---

# tests/test_analytics.py

import pytest
import datetime
from sqlalchemy.ext.asyncio import AsyncSession

# –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –º–æ–¥—É–ª—è
from bot.db import analytics_requests
from bot.db.models import User, Donation, MedicalWaiver, Survey, Event, EventRegistration

pytestmark = pytest.mark.asyncio

# --- –¢–µ—Å—Ç—ã –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π –∏–∑ analytics_requests.py ---

async def test_get_churn_donors(session: AsyncSession):
    """
    –¢–µ—Å—Ç: –ù–∞—Ö–æ–¥–∏—Ç –¥–æ–Ω–æ—Ä–æ–≤-–æ–¥–Ω–æ–¥–Ω–µ–≤–æ–∫ (1 –¥–æ–Ω–∞—Ü–∏—è, >6 –º–µ—Å. –Ω–∞–∑–∞–¥).
    """
    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 1: –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ —É—Å–ª–æ–≤–∏—è
    user1 = User(id=1, full_name="Churn Donor", telegram_id=111, phone_number="111", university="Test")
    donation1 = Donation(user_id=1, donation_date=datetime.date.today() - datetime.timedelta(days=200), donation_type='whole_blood', points_awarded=10)
    
    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 2: –¥–æ–Ω–∞—Ü–∏—è –±—ã–ª–∞ –Ω–µ–¥–∞–≤–Ω–æ
    user2 = User(id=2, full_name="Active Donor", telegram_id=222, phone_number="222", university="Test")
    donation2 = Donation(user_id=2, donation_date=datetime.date.today() - datetime.timedelta(days=30), donation_type='whole_blood', points_awarded=10)
    
    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 3: –∏–º–µ–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–æ–Ω–∞—Ü–∏–π
    user3 = User(id=3, full_name="Multiple Donor", telegram_id=333, phone_number="333", university="Test")
    donation3_1 = Donation(user_id=3, donation_date=datetime.date.today() - datetime.timedelta(days=200), donation_type='whole_blood', points_awarded=10)
    donation3_2 = Donation(user_id=3, donation_date=datetime.date.today() - datetime.timedelta(days=30), donation_type='plasma', points_awarded=10)

    session.add_all([user1, donation1, user2, donation2, user3, donation3_1, donation3_2])
    await session.commit()

    churn_donors = await analytics_requests.get_churn_donors(session)

    assert len(churn_donors) == 1
    assert churn_donors[0]['full_name'] == "Churn Donor"


async def test_get_lapsed_donors(session: AsyncSession):
    """
    –¢–µ—Å—Ç: –ù–∞—Ö–æ–¥–∏—Ç —É–≥–∞—Å–∞—é—â–∏—Ö –¥–æ–Ω–æ—Ä–æ–≤ (2+ –¥–æ–Ω–∞—Ü–∏–∏, –ø–æ—Å–ª–µ–¥–Ω—è—è >9 –º–µ—Å. –Ω–∞–∑–∞–¥, –±–µ–∑ –º–µ–¥–æ—Ç–≤–æ–¥–∞).
    """
    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 1: –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ —É—Å–ª–æ–≤–∏—è
    user1 = User(id=4, full_name="Lapsed Donor", telegram_id=444, phone_number="444", university="Test")
    d1_1 = Donation(user_id=4, donation_date=datetime.date.today() - datetime.timedelta(days=300), donation_type='whole_blood', points_awarded=10)
    d1_2 = Donation(user_id=4, donation_date=datetime.date.today() - datetime.timedelta(days=400), donation_type='whole_blood', points_awarded=10)

    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 2: –ø–æ—Å–ª–µ–¥–Ω—è—è –¥–æ–Ω–∞—Ü–∏—è –±—ã–ª–∞ –Ω–µ–¥–∞–≤–Ω–æ
    user2 = User(id=5, full_name="Active Donor", telegram_id=555, phone_number="555", university="Test")
    d2_1 = Donation(user_id=5, donation_date=datetime.date.today() - datetime.timedelta(days=30), donation_type='whole_blood', points_awarded=10)
    d2_2 = Donation(user_id=5, donation_date=datetime.date.today() - datetime.timedelta(days=60), donation_type='plasma', points_awarded=10)

    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 3: –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ –¥–∞—Ç–∞–º, –Ω–æ –∏–º–µ–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–π –º–µ–¥–æ—Ç–≤–æ–¥
    user3 = User(id=6, full_name="Lapsed With Waiver", telegram_id=666, phone_number="666", university="Test")
    d3_1 = Donation(user_id=6, donation_date=datetime.date.today() - datetime.timedelta(days=300), donation_type='whole_blood', points_awarded=10)
    d3_2 = Donation(user_id=6, donation_date=datetime.date.today() - datetime.timedelta(days=400), donation_type='whole_blood', points_awarded=10)
    waiver = MedicalWaiver(user_id=6, start_date=datetime.date.today(), end_date=datetime.date.today() + datetime.timedelta(days=30), reason="test", created_by="system")

    session.add_all([user1, d1_1, d1_2, user2, d2_1, d2_2, user3, d3_1, d3_2, waiver])
    await session.commit()

    lapsed_donors = await analytics_requests.get_lapsed_donors(session)

    assert len(lapsed_donors) == 1
    assert lapsed_donors[0]['full_name'] == "Lapsed Donor"

async def test_get_survey_dropoff(session: AsyncSession):
    """
    –¢–µ—Å—Ç: –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø—Ä–æ—à–µ–¥—à–∏—Ö –æ–ø—Ä–æ—Å, –Ω–æ –Ω–µ –∑–∞–ø–∏—Å–∞–≤—à–∏—Ö—Å—è –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ.
    """
    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 1: –ø—Ä–æ—à–µ–ª –æ–ø—Ä–æ—Å, –Ω–µ –∑–∞–ø–∏—Å–∞–ª—Å—è -> –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Å–ø–∏—Å–∫–µ
    user1 = User(id=38, full_name="Dropoff User", telegram_id=380, phone_number="380", university="Test")
    survey1 = Survey(user_id=38, passed=True, answers_json={}, created_at=datetime.datetime.now() - datetime.timedelta(days=10))

    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 2: –ø—Ä–æ—à–µ–ª –æ–ø—Ä–æ—Å –∏ –∑–∞–ø–∏—Å–∞–ª—Å—è –ü–û–°–õ–ï
    user2 = User(id=39, full_name="Registered User", telegram_id=390, phone_number="390", university="Test")
    survey2 = Survey(user_id=39, passed=True, answers_json={}, created_at=datetime.datetime.now() - datetime.timedelta(days=10))
    event1 = Event(name="event 1", event_datetime=datetime.datetime.now(), location="–¶–µ–Ω—Ç—Ä –∫—Ä–æ–≤–∏", donation_type="d", points_per_donation=1, participant_limit=1)
    session.add(event1)
    await session.commit()
    reg2 = EventRegistration(user_id=39, event_id=event1.id, registration_date=datetime.datetime.now() - datetime.timedelta(days=5))

    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 3: –æ–ø—Ä–æ—Å –Ω–µ –ø—Ä–æ–π–¥–µ–Ω
    user3 = User(id=40, full_name="Failed Survey User", telegram_id=400, phone_number="400", university="Test")
    survey3 = Survey(user_id=40, passed=False, answers_json={}, created_at=datetime.datetime.now() - datetime.timedelta(days=10))

    session.add_all([user1, survey1, user2, survey2, reg2, user3, survey3])
    await session.commit()
    
    dropoff_users = await analytics_requests.get_survey_dropoff(session)

    assert len(dropoff_users) == 1
    assert dropoff_users[0]['full_name'] == "Dropoff User"

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: tests/test_analytics.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: tests/test_calendar_service.py ---

import pytest
import datetime
from bot.utils.calendar_service import generate_ics_file
from bot.db.models import Event

def test_generate_ics_file():
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ .ics —Ñ–∞–π–ª–∞.
    –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –¥–ª—è ics==0.7.2, –∫–æ—Ç–æ—Ä—ã–π –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤—Ä–µ–º—è –≤ UTC.
    """
    # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ "—Ñ–µ–π–∫–æ–≤–æ–≥–æ" –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –∫–ª—é—á, –∫–∞–∫ –≤ –ë–î.
    mock_event = Event(
        id=123,
        name="–¢–µ—Å—Ç–æ–≤–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ",
        event_datetime=datetime.datetime(2025, 10, 26, 14, 0, 0), 
        location="–ù–ò–Ø–£ –ú–ò–§–ò, –ö–∞—à–∏—Ä—Å–∫–æ–µ —à. 31",
        donation_type="plasma" 
    )

    # 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    ics_string = generate_ics_file(mock_event)

    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∏
    assert "BEGIN:VCALENDAR" in ics_string
    assert "SUMMARY:–î–æ–Ω–∞—Ü–∏—è: –¢–µ—Å—Ç–æ–≤–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ" in ics_string
    assert "LOCATION:–ù–ò–Ø–£ –ú–ò–§–ò\\, –ö–∞—à–∏—Ä—Å–∫–æ–µ —à. 31" in ics_string
    assert "DESCRIPTION:–¢–∏–ø –¥–æ–Ω–∞—Ü–∏–∏: –ü–ª–∞–∑–º–∞" in ics_string
    assert "DTSTART:20251026T110000Z" in ics_string
    assert "DTEND:20251026T130000Z" in ics_string

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –±—É–¥–∏–ª—å–Ω–∏–∫–∞
    assert "ACTION:DISPLAY" in ics_string
    assert "TRIGGER:-PT1H" in ics_string

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: tests/test_calendar_service.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: tests/test_db_requests.py ---

import pytest
import datetime
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select

from bot.db import user_requests, admin_requests, event_requests, merch_requests, info_requests
from bot.db.models import User, Event, EventRegistration, MedicalWaiver, Donation, MerchItem, UserBlock, MerchOrder, InfoText

# –ú–∞—Ä–∫–∏—Ä—É–µ–º –≤—Å–µ —Ç–µ—Å—Ç—ã –≤ —ç—Ç–æ–º —Ñ–∞–π–ª–µ –¥–ª—è pytest-asyncio
pytestmark = pytest.mark.asyncio

async def test_add_user_with_custom_university(session: AsyncSession):
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º –í–£–ó–æ–º –∏ –µ–≥–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ.
    """
    # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    user_data = {
        "phone_number": "+79991112233",
        "telegram_id": 987654321,
        "telegram_username": "msu_student",
        "full_name": "–°—Ç—É–¥–µ–Ω—Ç –î—Ä—É–≥–æ–≥–æ –í–£–ó–∞",
        "university": "–ú–ì–£ –∏–º. –õ–æ–º–æ–Ω–æ—Å–æ–≤–∞", 
        "faculty": "–í–ú–ö",
        "study_group": "101",
        "gender": "male"
    }

    # 2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    new_user = await user_requests.add_user(session, user_data)
    await session.commit()
    
    retrieved_user = await user_requests.get_user_by_tg_id(session, 987654321)

    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞
    assert new_user.id is not None
    assert retrieved_user is not None
    assert retrieved_user.full_name == "–°—Ç—É–¥–µ–Ω—Ç –î—Ä—É–≥–æ–≥–æ –í–£–ó–∞"
    assert retrieved_user.university == "–ú–ì–£ –∏–º. –õ–æ–º–æ–Ω–æ—Å–æ–≤–∞" # –ì–ª–∞–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    assert retrieved_user.role == "student"


# --- –ù–û–í–´–ô –¢–ï–°–¢ –î–õ–Ø –ü–†–û–í–ï–†–ö–ò –°–û–•–†–ê–ù–ï–ù–ò–Ø –ö–û–û–†–î–ò–ù–ê–¢ ---
async def test_create_event_with_location(session: AsyncSession):
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –∏ –∏—Ö –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î.
    """
    # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    event_data = {
        "name": "Event with Location",
        "event_datetime": datetime.datetime(2030, 5, 20, 10, 0),
        "location": "–ù–ò–Ø–£ –ú–ò–§–ò, –ö–∞—à–∏—Ä—Å–∫–æ–µ —à. 31",
        "latitude": 55.649917,
        "longitude": 37.662128,
        "donation_type": "whole_blood",
        "points_per_donation": 100,
        "participant_limit": 50,
    }

    # 2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    new_event = await admin_requests.create_event(session, event_data)
    await session.commit()

    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞
    retrieved_event = await session.get(Event, new_event.id)
    assert retrieved_event is not None
    assert retrieved_event.name == "Event with Location"
    assert retrieved_event.latitude == 55.649917
    assert retrieved_event.longitude == 37.662128
# --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –¢–ï–°–¢–ê ---


async def test_add_and_get_user(session: AsyncSession):
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –∏ –µ–≥–æ –ø–æ—Å–ª–µ–¥—É—é—â–µ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ.
    """
    # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    user_data = {
        "phone_number": "+79991234567",
        "telegram_id": 123456789,
        "telegram_username": "testuser",
        "full_name": "–¢–µ—Å—Ç–æ–≤—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
        "university": "–ù–ò–Ø–£ –ú–ò–§–ò",
    }

    # 2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    new_user = await user_requests.add_user(session, user_data)
    await session.commit()
    
    retrieved_user = await user_requests.get_user_by_tg_id(session, 123456789)

    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞
    assert new_user.id is not None
    assert retrieved_user is not None
    assert retrieved_user.full_name == "–¢–µ—Å—Ç–æ–≤—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    assert retrieved_user.telegram_id == 123456789

async def test_find_user_for_admin(session: AsyncSession):
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Ä–∞–∑–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º.
    """
    # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (—Å–æ–∑–¥–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
    users_to_add = [
        User(phone_number="+7001", telegram_id=1, telegram_username="john_doe", full_name="John Doe", university="A"),
        User(phone_number="+7002", telegram_id=2, telegram_username="jane_smith", full_name="Jane Smith", university="B"),
        User(phone_number="+7003", telegram_id=3, telegram_username="tester", full_name="Another Tester", university="C"),
    ]
    session.add_all(users_to_add)
    await session.commit()

    # 2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –ü—Ä–æ–≤–µ—Ä–∫–∞
    # –ü–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç–∏ –§–ò–û
    found_by_name = await admin_requests.find_user_for_admin(session, "Smith")
    assert len(found_by_name) == 1
    assert found_by_name[0].full_name == "Jane Smith"

    # –ü–æ–∏—Å–∫ –ø–æ username
    found_by_username = await admin_requests.find_user_for_admin(session, "john_doe")
    assert len(found_by_username) == 1
    assert found_by_username[0].telegram_id == 1

    # –ü–æ–∏—Å–∫ –ø–æ ID
    found_by_id = await admin_requests.find_user_for_admin(session, "3")
    assert len(found_by_id) == 1
    assert found_by_id[0].full_name == "Another Tester"

    # –ü–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    found_by_phone = await admin_requests.find_user_for_admin(session, "001")
    assert len(found_by_phone) == 1
    assert found_by_phone[0].telegram_id == 1

async def test_check_registration_eligibility(session: AsyncSession):
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ª–æ–≥–∏–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ.
    """
    # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
    user = User(
        phone_number="+7111", telegram_id=111, full_name="Eligible User", gender="male",
        is_blocked=False, university="TestUni"
    )
    event = Event(
        name="Test Event",
        event_datetime=datetime.datetime.now() + datetime.timedelta(days=10),
        location="–¢–µ—Å—Ç–æ–≤–∞—è –ª–æ–∫–∞—Ü–∏—è, –≥. –ú–æ—Å–∫–≤–∞",
        donation_type="whole_blood",
        participant_limit=5,
        registration_is_open=True,
        points_per_donation=10
    )
    session.add_all([user, event])
    await session.commit()

    # 2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –ü—Ä–æ–≤–µ—Ä–∫–∞
    # –°—Ü–µ–Ω–∞—Ä–∏–π 1: –£—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    is_eligible, reason = await event_requests.check_registration_eligibility(session, user, event)
    assert is_eligible is True
    assert "–ø—Ä–æ–π–¥–µ–Ω—ã" in reason

    # –°—Ü–µ–Ω–∞—Ä–∏–π 2: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞
    event.registration_is_open = False
    await session.commit()
    is_eligible, reason = await event_requests.check_registration_eligibility(session, user, event)
    assert is_eligible is False
    assert "–∑–∞–∫—Ä—ã—Ç–∞" in reason
    event.registration_is_open = True 
    await session.commit()

    # –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
    reg = EventRegistration(user_id=user.id, event_id=event.id)
    session.add(reg)
    await session.commit()
    is_eligible, reason = await event_requests.check_registration_eligibility(session, user, event)
    assert is_eligible is False
    assert "—É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã" in reason
    await session.delete(reg) 
    await session.commit()

    # –°—Ü–µ–Ω–∞—Ä–∏–π 4: –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –º–µ–¥–æ—Ç–≤–æ–¥
    waiver = MedicalWaiver(
        user_id=user.id,
        start_date=datetime.date.today(),
        end_date=datetime.date.today() + datetime.timedelta(days=30), 
        reason="Test Waiver",
        created_by="system"
    )
    session.add(waiver)
    await session.commit()
    is_eligible, reason = await event_requests.check_registration_eligibility(session, user, event)
    assert is_eligible is False
    assert "–¥–µ–π—Å—Ç–≤—É–µ—Ç –æ—Ç–≤–æ–¥" in reason


# --- –ù–û–í–´–ï –¢–ï–°–¢–´ ---

async def test_change_user_role(session: AsyncSession):
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–æ–≤—ã—à–µ–Ω–∏–µ –∏ –ø–æ–Ω–∏–∂–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
    user = User(phone_number="+7111", telegram_id=111, full_name="Test User", role="student", university="TestUni")
    session.add(user)
    await session.commit()

    # 2. –ü–æ–≤—ã—à–∞–µ–º –¥–æ –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞
    await admin_requests.change_user_role(session, user.id, "volunteer")
    
    # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º
    updated_user_1 = await session.get(User, user.id)
    assert updated_user_1.role == "volunteer"

    # 4. –ü–æ–Ω–∏–∂–∞–µ–º –¥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
    await admin_requests.change_user_role(session, user.id, "student")

    # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º
    updated_user_2 = await session.get(User, user.id)
    assert updated_user_2.role == "student"


async def test_block_and_unblock_user(session: AsyncSession):
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
    admin = User(phone_number="+7_admin", telegram_id=999, full_name="Admin", university="TestUni")
    target_user = User(phone_number="+7_target", telegram_id=123, full_name="Target", university="TestUni")
    session.add_all([admin, target_user])
    await session.commit()

    # 2. –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await admin_requests.block_user(session, target_user.id, admin.id, "Test block reason")
    
    # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º
    blocked_user = await session.get(User, target_user.id)
    block_record = (await session.execute(select(UserBlock))).scalar_one_or_none()
    assert blocked_user.is_blocked is True
    assert block_record is not None
    assert block_record.reason == "Test block reason"
    assert block_record.is_active is True

    # 4. –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º
    await admin_requests.unblock_user(session, target_user.id)
    
    # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º
    unblocked_user = await session.get(User, target_user.id)
    await session.refresh(block_record) # –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –∏–∑ –ë–î
    assert unblocked_user.is_blocked is False
    assert block_record.is_active is False


async def test_confirm_donation_transaction(session: AsyncSession):
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–æ–Ω–∞—Ü–∏–∏."""
    # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
    user = User(phone_number="+7", telegram_id=1, full_name="Donor", gender="male", points=0, university="TestUni")
    event_date = datetime.date.today()
    event_dt = datetime.datetime.combine(event_date, datetime.time.min)
    event = Event(
        name="Transaction Test Event",
        event_datetime=event_dt,
        location="Test",
        donation_type="whole_blood",
        points_per_donation=50,
        participant_limit=5
    )
    session.add_all([user, event])
    await session.commit()
    registration = EventRegistration(user_id=user.id, event_id=event.id)
    session.add(registration)
    await session.commit()

    # 2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    points, waiver_end_date = await event_requests.confirm_donation_transaction(session, user, registration)
    
    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤
    updated_user = await session.get(User, user.id)
    assert points == 50
    assert updated_user.points == 50
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø–∏—Å—å –æ –¥–æ–Ω–∞—Ü–∏–∏
    donation = (await session.execute(select(Donation))).scalar_one()
    assert donation.user_id == user.id
    assert donation.points_awarded == 50
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –º–µ–¥–æ—Ç–≤–æ–¥–∞
    waiver = (await session.execute(select(MedicalWaiver))).scalar_one()
    expected_end_date = event_date + datetime.timedelta(days=60) # 60 –¥–Ω–µ–π –¥–ª—è –º—É–∂—á–∏–Ω—ã
    assert waiver.end_date == expected_end_date
    assert waiver_end_date == expected_end_date
    assert waiver.created_by == "system"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    updated_reg = await session.get(EventRegistration, registration.id)
    assert updated_reg.status == "attended"


async def test_create_merch_order_success_and_fail(session: AsyncSession):
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –∏ –æ—Ç–∫–∞–∑ –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ –±–∞–ª–ª–æ–≤."""
    # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
    user_rich = User(phone_number="+1", telegram_id=1, full_name="Rich", points=100, university="TestUni")
    user_poor = User(phone_number="+2", telegram_id=2, full_name="Poor", points=10, university="TestUni")
    item = MerchItem(name="Test Mug", description="A mug", price=50, photo_file_id="123")
    session.add_all([user_rich, user_poor, item])
    await session.commit()

    # 2. –£—Å–ø–µ—à–Ω–∞—è –ø–æ–∫—É–ø–∫–∞
    success, msg = await merch_requests.create_merch_order(session, user_rich, item)
    await session.commit()

    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –ø–æ–∫—É–ø–∫–∏
    order = (await session.execute(select(MerchOrder).where(MerchOrder.user_id == user_rich.id))).scalar_one()
    assert success is True
    assert "–ü–æ–∫—É–ø–∫–∞ —Å–æ–≤–µ—Ä—à–µ–Ω–∞" in msg
    assert user_rich.points == 50
    assert order is not None

    # 4. –ù–µ—É—Å–ø–µ—à–Ω–∞—è –ø–æ–∫—É–ø–∫–∞
    success_fail, msg_fail = await merch_requests.create_merch_order(session, user_poor, item)
    await session.commit()

    # 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ—É—Å–ø–µ—à–Ω–æ–π –ø–æ–∫—É–ø–∫–∏
    order_fail = (await session.execute(select(MerchOrder).where(MerchOrder.user_id == user_poor.id))).scalar_one_or_none()
    assert success_fail is False
    assert "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤" in msg_fail
    assert user_poor.points == 10 # –ë–∞–ª–ª—ã –Ω–µ –¥–æ–ª–∂–Ω—ã –±—ã–ª–∏ —Å–ø–∏—Å–∞—Ç—å—Å—è
    assert order_fail is None


async def test_user_can_delete_own_waiver_but_not_system(session: AsyncSession):
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π –º–µ–¥–æ—Ç–≤–æ–¥, –Ω–æ –Ω–µ —Å–∏—Å—Ç–µ–º–Ω—ã–π.
    """
    # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
    user = User(phone_number="+1", telegram_id=1, full_name="Waiver User", university="TestUni")
    session.add(user)
    await session.commit()

    # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–û–ë–ê–í–õ–Ø–ï–ú start_date ---
    today = datetime.date.today()
    waiver_by_user = MedicalWaiver(
        user_id=user.id,
        start_date=today, # <-- –î–æ–±–∞–≤–ª–µ–Ω–æ
        end_date=datetime.date.max,
        reason="self",
        created_by="user"
    )
    waiver_by_system = MedicalWaiver(
        user_id=user.id,
        start_date=today, # <-- –î–æ–±–∞–≤–ª–µ–Ω–æ
        end_date=datetime.date.max,
        reason="donation",
        created_by="system"
    )
    # ----------------------------------------
    
    session.add_all([waiver_by_user, waiver_by_system])
    await session.commit()
    
    # 2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞
    # –ü—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π
    can_delete_own = await user_requests.delete_user_waiver(session, waiver_by_user.id, user.id)
    assert can_delete_own is True
    
    # –ü—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π
    can_delete_system = await user_requests.delete_user_waiver(session, waiver_by_system.id, user.id)
    assert can_delete_system is False

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤ –ë–î –æ—Å—Ç–∞–ª—Å—è —Ç–æ–ª—å–∫–æ —Å–∏—Å—Ç–µ–º–Ω—ã–π
    remaining_waivers = (await session.execute(select(MedicalWaiver))).scalars().all()
    assert len(remaining_waivers) == 1
    assert remaining_waivers[0].id == waiver_by_system.id
    
@pytest.mark.parametrize(
    "user_data, donations, waivers, expected_in_list",
    [
        # –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ß–∏—Å—Ç—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞—Å—Ç—å –≤ —Ä–∞—Å—Å—ã–ª–∫—É
        ({"gender": "male", "id": 1, "tg_id": 1}, [], [], True),
        
        # –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –∞–∫—Ç–∏–≤–Ω—ã–º –º–µ–¥–æ—Ç–≤–æ–¥–æ–º, –ù–ï –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞—Å—Ç—å
        ({"gender": "male", "id": 2, "tg_id": 2}, [], [{"days_ago": 10, "duration": 30}], False),
        
        # –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ú—É–∂—á–∏–Ω–∞, —Å–¥–∞—á–∞ –∫—Ä–æ–≤–∏ < 60 –¥–Ω–µ–π –Ω–∞–∑–∞–¥, –ù–ï –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞—Å—Ç—å
        ({"gender": "male", "id": 3, "tg_id": 3}, [{"type": "whole_blood", "days_ago": 45}], [], False),
        
        # –°—Ü–µ–Ω–∞—Ä–∏–π 4: –ú—É–∂—á–∏–Ω–∞, —Å–¥–∞—á–∞ –∫—Ä–æ–≤–∏ > 60 –¥–Ω–µ–π –Ω–∞–∑–∞–¥, –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞—Å—Ç—å
        ({"gender": "male", "id": 4, "tg_id": 4}, [{"type": "whole_blood", "days_ago": 70}], [], True),
        
        # –°—Ü–µ–Ω–∞—Ä–∏–π 5: –ñ–µ–Ω—â–∏–Ω–∞, —Å–¥–∞—á–∞ –∫—Ä–æ–≤–∏ 80 –¥–Ω–µ–π –Ω–∞–∑–∞–¥. –ò–Ω—Ç–µ—Ä–≤–∞–ª 90 –¥–Ω–µ–π. 80+15=95 > 90. –î–û–õ–ñ–ù–ê –ü–û–ü–ê–°–¢–¨.
        ({"gender": "female", "id": 5, "tg_id": 5}, [{"type": "whole_blood", "days_ago": 80}], [], True), 

        # –°—Ü–µ–Ω–∞—Ä–∏–π 6: –ñ–µ–Ω—â–∏–Ω–∞, —Å–¥–∞—á–∞ –∫—Ä–æ–≤–∏ 100 –¥–Ω–µ–π –Ω–∞–∑–∞–¥. –î–û–õ–ñ–ù–ê –ü–û–ü–ê–°–¢–¨.
        ({"gender": "female", "id": 6, "tg_id": 6}, [{"type": "whole_blood", "days_ago": 100}], [], True),

        # –°—Ü–µ–Ω–∞—Ä–∏–π 7: –°–¥–∞—á–∞ –ø–ª–∞–∑–º—ã 10 –¥–Ω–µ–π –Ω–∞–∑–∞–¥. –ò–Ω—Ç–µ—Ä–≤–∞–ª 14 –¥–Ω–µ–π. 10+15=25 > 14. –î–û–õ–ñ–ï–ù –ü–û–ü–ê–°–¢–¨.
        ({"gender": "male", "id": 7, "tg_id": 7}, [{"type": "plasma", "days_ago": 10}], [], True),
        
        # –°—Ü–µ–Ω–∞—Ä–∏–π 8: –°–¥–∞—á–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ > 14 –¥–Ω–µ–π –Ω–∞–∑–∞–¥, –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞—Å—Ç—å
        ({"gender": "male", "id": 8, "tg_id": 8}, [{"type": "plasma", "days_ago": 20}], [], True),

        # –°—Ü–µ–Ω–∞—Ä–∏–π 9: –ú—É–∂—á–∏–Ω–∞, –¥–æ—Å—Ç–∏–≥ –ª–∏–º–∏—Ç–∞ (5) –ø–æ —Ü–µ–ª—å–Ω–æ–π –∫—Ä–æ–≤–∏, –ù–ï –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞—Å—Ç—å
        ({"gender": "male", "id": 9, "tg_id": 9}, [{"type": "whole_blood", "days_ago": d} for d in [70, 140, 210, 280, 350]], [], False),

        # –°—Ü–µ–Ω–∞—Ä–∏–π 10: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ —Å—Ç–∞—Ä—ã–º –º–µ–¥–æ—Ç–≤–æ–¥–æ–º, –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞—Å—Ç—å
        ({"gender": "male", "id": 10, "tg_id": 10}, [], [{"days_ago": 100, "duration": 30}], True),
    ]
)
async def test_get_users_for_event_notification(session: AsyncSession, user_data, donations, waivers, expected_in_list):
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Å–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤–æ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—é –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.
    """
    # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
    today = datetime.date.today()
    
    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –¥–ª—è —Å–¥–∞—á–∏ —Ü–µ–ª—å–Ω–æ–π –∫—Ä–æ–≤–∏ —á–µ—Ä–µ–∑ 15 –¥–Ω–µ–π
    event = Event(
        name="Notification Test Event",
        event_datetime=datetime.datetime.now() + datetime.timedelta(days=15),
        location="Test",
        donation_type="whole_blood",
        points_per_donation=10,
        participant_limit=100
    )
    
    # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user = User(
        id=user_data["id"],
        telegram_id=user_data["tg_id"],
        phone_number=f"+{user_data['id']}",
        full_name=f"User {user_data['id']}",
        gender=user_data["gender"],
        university="TestUni"
    )
    session.add(user)

    # –°–æ–∑–¥–∞–µ–º –µ–≥–æ –∏—Å—Ç–æ—Ä–∏—é –¥–æ–Ω–∞—Ü–∏–π
    for don in donations:
        donation = Donation(
            user_id=user.id,
            donation_type=don["type"],
            donation_date=today - datetime.timedelta(days=don["days_ago"]),
            points_awarded=10
        )
        session.add(donation)
    
    # –°–æ–∑–¥–∞–µ–º –µ–≥–æ –∏—Å—Ç–æ—Ä–∏—é –º–µ–¥–æ—Ç–≤–æ–¥–æ–≤
    for wav in waivers:
        waiver = MedicalWaiver(
            user_id=user.id,
            start_date=today - datetime.timedelta(days=wav["days_ago"]),
            end_date=today - datetime.timedelta(days=wav["days_ago"]) + datetime.timedelta(days=wav["duration"]),
            reason="test",
            created_by="system"
        )
        session.add(waiver)
        
    await session.commit()

    # 2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    users_to_notify = await user_requests.get_users_for_event_notification(session, event)
    user_ids_to_notify = {u.id for u in users_to_notify}

    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞
    if expected_in_list:
        assert user.id in user_ids_to_notify, f"User {user.id} should be in the list but was NOT"
    else:
        assert user.id not in user_ids_to_notify, f"User {user.id} should NOT be in the list but was"
        
        
async def test_admin_create_manual_waiver(session: AsyncSession):
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –º–µ–¥–æ—Ç–≤–æ–¥–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.
    """
    # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
    admin = User(phone_number="+1", telegram_id=101, full_name="Admin", university="TestUni")
    user = User(phone_number="+2", telegram_id=102, full_name="User", university="TestUni")
    session.add_all([admin, user])
    await session.commit()
    
    end_date = datetime.date.today() + datetime.timedelta(days=30)
    
    # 2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    await admin_requests.create_manual_waiver(session, user_id=user.id, end_date=end_date, reason="Manual by admin", admin_id=admin.id)
    
    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞
    waiver = (await session.execute(select(MedicalWaiver))).scalar_one_or_none()
    
    assert waiver is not None
    assert waiver.user_id == user.id
    assert waiver.reason == "Manual by admin"
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ ID –∞–¥–º–∏–Ω–∞ –∑–∞–ø–∏—Å–∞–ª—Å—è –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞
    assert waiver.created_by == str(admin.id)
    
    
async def test_create_event_with_datetime(session: AsyncSession):
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º –∏ –∏—Ö –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ.
    """
    event_dt = datetime.datetime(2030, 11, 25, 15, 30)
    event_data = {
        "name": "Event with Time",
        "event_datetime": event_dt,
        "location": "–ù–ò–Ø–£ –ú–ò–§–ò",
        "donation_type": "platelets",
        "points_per_donation": 200,
        "participant_limit": 20,
    }

    new_event = await admin_requests.create_event(session, event_data)
    await session.commit()

    retrieved_event = await session.get(Event, new_event.id)
    assert retrieved_event is not None
    assert retrieved_event.name == "Event with Time"
    assert retrieved_event.event_datetime == event_dt
    
    
async def test_update_info_text(session: AsyncSession):
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø—Ä—è–º–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏–Ω—Ñ–æ-—Ä–∞–∑–¥–µ–ª–∞ —á–µ—Ä–µ–∑ DB-–∑–∞–ø—Ä–æ—Å.
    """
    # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
    section_key = "test_section"
    original_text = "This is the original text."
    new_text = "This is the updated text."
    
    session.add(InfoText(
        section_key=section_key, 
        section_title="Test Section", 
        section_text=original_text
    ))
    await session.commit()
    
    # 2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    await info_requests.update_info_text(session, section_key, new_text)
    
    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞
    updated_section = await session.get(InfoText, section_key)
    assert updated_section is not None
    assert updated_section.section_text == new_text

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: tests/test_db_requests.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: tests/test_filters.py ---

import pytest
from unittest.mock import Mock
from sqlalchemy.ext.asyncio import AsyncSession

from bot.db.models import User
from bot.filters.role import RoleFilter

# –ú–∞—Ä–∫–∏—Ä—É–µ–º –≤—Å–µ —Ç–µ—Å—Ç—ã –≤ —ç—Ç–æ–º —Ñ–∞–π–ª–µ –¥–ª—è pytest-asyncio
pytestmark = pytest.mark.asyncio

# –°–æ–∑–¥–∞–¥–∏–º "–∑–∞–≥–ª—É—à–∫—É" –¥–ª—è –æ–±—ä–µ–∫—Ç–∞ CallbackQuery, —á—Ç–æ–±—ã –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å aiogram
class MockUser:
    def __init__(self, id):
        self.id = id

class MockCallback:
    def __init__(self, user_id):
        self.from_user = MockUser(id=user_id)

async def test_role_filter(session: AsyncSession):
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ª–æ–≥–∏–∫—É —Ñ–∏–ª—å—Ç—Ä–∞ RoleFilter –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–æ–ª–µ–π –∏ —Å—Ç–∞—Ç—É—Å–æ–≤.
    """
    # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞: —Å–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–æ–ª—è–º–∏
    # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ university ---
    student = User(phone_number="+1", telegram_id=101, full_name="Student", role="student", university="TestUni")
    volunteer = User(phone_number="+2", telegram_id=102, full_name="Volunteer", role="volunteer", university="TestUni")
    admin = User(phone_number="+3", telegram_id=103, full_name="Admin", role="admin", university="TestUni")
    main_admin = User(phone_number="+4", telegram_id=104, full_name="Main Admin", role="main_admin", university="TestUni")
    blocked_admin = User(phone_number="+5", telegram_id=105, full_name="Blocked Admin", role="admin", is_blocked=True, university="TestUni")
    # --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---

    session.add_all([student, volunteer, admin, main_admin, blocked_admin])
    await session.commit()

    # 2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –ü—Ä–æ–≤–µ—Ä–∫–∞
    
    # --- –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ "admin" —É—Ä–æ–≤–Ω—é ---
    admin_filter = RoleFilter(required_role="admin")
    
    # –°—Ç—É–¥–µ–Ω—Ç –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏
    assert not await admin_filter(MockCallback(user_id=101), session)
    # –í–æ–ª–æ–Ω—Ç–µ—Ä –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏
    assert not await admin_filter(MockCallback(user_id=102), session)
    # –ê–¥–º–∏–Ω –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏
    assert await admin_filter(MockCallback(user_id=103), session)
    # –ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω —Ç–æ–∂–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏ (–∏–µ—Ä–∞—Ä—Ö–∏—è)
    assert await admin_filter(MockCallback(user_id=104), session)
    # –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–¥–º–∏–Ω –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏
    assert not await admin_filter(MockCallback(user_id=105), session)
    # –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏
    assert not await admin_filter(MockCallback(user_id=999), session)

    # --- –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ "volunteer" —É—Ä–æ–≤–Ω—é ---
    volunteer_filter = RoleFilter(required_role="volunteer")
    
    # –°—Ç—É–¥–µ–Ω—Ç –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏
    assert not await volunteer_filter(MockCallback(user_id=101), session)
    # –í–æ–ª–æ–Ω—Ç–µ—Ä –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏
    assert await volunteer_filter(MockCallback(user_id=102), session)
    # –ê–¥–º–∏–Ω –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏ (–∏–µ—Ä–∞—Ä—Ö–∏—è)
    assert await volunteer_filter(MockCallback(user_id=103), session)

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: tests/test_filters.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: tests/test_graduation.py ---

import pytest
from bot.utils.graduation import calculate_graduation_year

@pytest.mark.parametrize(
    "group, expected_year",
    [
        ("–ë20-505", 2024),
        ("–°20-2131", 2025),
        ("–ú22-1232", 2024),
        ("b20-505", 2024),
        ("c20-2131", 2025),
        ("m22-1232", 2024),
        ("asdf", None),
        (None, None),
        ("", None),
    ],
)
def test_calculate_graduation_year(group, expected_year):
    assert calculate_graduation_year(group) == expected_year


--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: tests/test_graduation.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: tests/test_handlers_logic.py ---

import pytest
from unittest.mock import AsyncMock, Mock
import datetime

from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession
from aiogram import Bot, types
from aiogram.fsm.context import FSMContext
from aiogram.fsm.storage.memory import MemoryStorage

from bot.db.models import User, Event, MedicalWaiver, Feedback
from bot.states.states import Registration, EventCreation, PointsChange, FeedbackSurvey
from bot.handlers import common as common_handlers
from bot.handlers.admin import event_management
from bot.handlers.admin import user_management as user_management_handlers
from bot.handlers import student as student_handlers
from bot.keyboards import inline
from bot.utils.text_messages import Text

pytestmark = pytest.mark.asyncio

class MockMessage:
    """–ü–æ–ª–Ω–æ—Å—Ç—å—é –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–∞—è –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è Message, –Ω–µ –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç Mock."""
    def __init__(self, text=None, from_user_id=123, from_user_username=None, location=None, contact=None):
        self.text = text
        self.from_user = Mock(id=from_user_id, username=from_user_username)
        self.location = location
        self.contact = contact
        self.message_id = 12345
        # –Ø–≤–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—Å–µ –º–µ—Ç–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω—ã
        self.answer = AsyncMock()
        self.edit_text = AsyncMock()
        self.delete = AsyncMock()
        self.answer_photo = AsyncMock()
        self.answer_document = AsyncMock()
        self.edit_reply_markup = AsyncMock()

class MockCallbackQuery:
    """–ü–æ–ª–Ω–æ—Å—Ç—å—é –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–∞—è –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è CallbackQuery."""
    def __init__(self, data, from_user_id=123, from_user_username=None, message=None):
        self.data = data
        self.from_user = Mock(id=from_user_id, username=from_user_username)
        self.message = message if message else MockMessage(from_user_id=from_user_id)
        self.answer = AsyncMock()

class MockFSMContext:
    """–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è FSMContext, —Ö—Ä–∞–Ω—è—â–∞—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ —Å–ª–æ–≤–∞—Ä–µ"""
    def __init__(self):
        self._state = None
        self._data = {}
    async def get_state(self): return self._state
    async def set_state(self, state): self._state = state
    async def get_data(self): return self._data.copy()
    async def update_data(self, **kwargs): self._data.update(kwargs)
    async def clear(self):
        self._state = None
        self._data = {}

class MockLocation:
    """–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è –æ–±—ä–µ–∫—Ç–∞ Location aiogram"""
    def __init__(self, latitude, longitude):
        self.latitude = latitude
        self.longitude = longitude



@pytest.mark.parametrize(
    "scenario, user_inputs, expected_fsm_data",
    [
        (
            "mifi_standard_faculty",
            [
                ("callback", "category_student"),
                ("callback", "university_mifi"), 
                ("callback", "faculty_–ò–ò–ö–°"),
                ("message", "–ë20-505"),
                ("callback", "gender_male"),
                ("callback", "consent_given"),
            ],
            {"category": "student", "university": "–ù–ò–Ø–£ –ú–ò–§–ò", "faculty": "–ò–ò–ö–°", "study_group": "–ë20-505"}
        ),
        (
            "mifi_custom_faculty",
            [
                ("callback", "category_employee"),
                ("callback", "university_mifi"),
                ("callback", "faculty_Other"),
                ("message", "–ò–Ω—Å—Ç–∏—Ç—É—Ç –õ–∞–ü–ª–∞–∑"),
                ("message", "–õ2-101"),
                ("callback", "gender_female"),
                ("callback", "consent_given"),
            ],
            {"category": "employee", "university": "–ù–ò–Ø–£ –ú–ò–§–ò", "faculty": "–ò–Ω—Å—Ç–∏—Ç—É—Ç –õ–∞–ü–ª–∞–∑", "study_group": "–õ2-101"}
        ),
        (
            "other_university_external_donor",
            [
                ("callback", "category_external"),
                ("callback", "gender_male"),
                ("callback", "consent_given"),
            ],
            {
                "category": "external",
                "university": "–í–Ω–µ—à–Ω–∏–π –¥–æ–Ω–æ—Ä", 
                "faculty": "–ù–µ –ø—Ä–∏–º–µ–Ω–∏–º–æ", 
                "study_group": "-"
            }
        )
    ]
)
async def test_registration_fsm_scenarios(scenario, user_inputs, expected_fsm_data, session: AsyncSession):
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ FSM (–û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø).
    """
    state = MockFSMContext()
    
    contact_mock = Mock(phone_number="+71234567890")
    start_message = MockMessage(contact=contact_mock, from_user_id=123, from_user_username="test_user_fsm")
    await common_handlers.handle_contact(start_message, session, state)
    assert await state.get_state() == Registration.awaiting_full_name
    
    fio_message = MockMessage("–¢–µ—Å—Ç–æ–≤—ã–π –¢–µ—Å—Ç –¢–µ—Å—Ç–æ–≤–∏—á")
    await common_handlers.process_full_name(fio_message, state)
    assert await state.get_state() == Registration.awaiting_category
    

    for input_type, value in user_inputs:
        current_state_before = await state.get_state()
        
        if input_type == "callback":
            callback = MockCallbackQuery(data=value)
            
            if current_state_before == Registration.awaiting_category:
                await common_handlers.process_category(callback, state)
            elif current_state_before == Registration.awaiting_university:
                await common_handlers.process_university_choice(callback, state)
            elif current_state_before == Registration.awaiting_faculty:
                await common_handlers.process_faculty(callback, state)
            elif current_state_before == Registration.awaiting_gender:
                await common_handlers.process_gender(callback, state)
            elif current_state_before == Registration.awaiting_consent:
                await common_handlers.process_consent(callback, state, session)
        
        elif input_type == "message":
            message = MockMessage(text=value)
            
            if current_state_before == Registration.awaiting_custom_university_name:
                await common_handlers.process_custom_university_name(message, state)
            elif current_state_before == Registration.awaiting_custom_faculty_name:
                await common_handlers.process_custom_faculty_name(message, state)
            elif current_state_before == Registration.awaiting_study_group:
                await common_handlers.process_study_group(message, state)
                
    assert await state.get_state() is None 
    
    created_user = (await session.execute(select(User).where(User.telegram_id == 123))).scalar_one()
    assert created_user is not None
    assert created_user.university == expected_fsm_data["university"]
    assert created_user.faculty == expected_fsm_data["faculty"]
    assert created_user.study_group == expected_fsm_data["study_group"]
    assert created_user.category == expected_fsm_data["category"]
    assert created_user.consent_given is True
    assert created_user.full_name == "–¢–µ—Å—Ç–æ–≤—ã–π –¢–µ—Å—Ç –¢–µ—Å—Ç–æ–≤–∏—á"
    assert created_user.telegram_username == "test_user_fsm"


async def test_add_points_to_user(session: AsyncSession, mocker):
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ª–æ–≥–∏–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º, –≤–∫–ª—é—á–∞—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.
    """
    mock_bot = Mock()
    mock_bot.send_message = AsyncMock()
    
    user = User(phone_number="+1", telegram_id=101, full_name="User For Points", points=100, university="TestUni")
    session.add(user)
    await session.commit()
    
    state = MockFSMContext()
    await state.set_state(PointsChange.awaiting_reason)
    await state.update_data(user_id=user.id, points=50)
    
    msg_reason = MockMessage("–ó–∞ —Ö–æ—Ä–æ—à—É—é —Ä–∞–±–æ—Ç—É")
    await user_management_handlers.change_points_reason(msg_reason, state, session, mock_bot)
    
    await session.refresh(user)
    assert user.points == 150
    
    mock_bot.send_message.assert_called_once()
    call_args = mock_bot.send_message.call_args
    assert call_args.kwargs['chat_id'] == user.telegram_id
    assert "–∏–∑–º–µ–Ω–∏–ª –≤–∞—à –±–∞–ª–∞–Ω—Å –Ω–∞ 50" in call_args.kwargs['text']
    assert call_args.kwargs['parse_mode'] == "HTML"


async def test_user_receives_location_link_on_registration(session: AsyncSession, mocker):
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –ª–æ–∫–∞—Ü–∏—é
    –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏.
    """
    # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
    mock_callback_message = MockMessage()
    mock_callback_message.edit_text = AsyncMock()

    user = User(phone_number="+1", telegram_id=101, full_name="Location User", university="TestUni")
    event = Event(
        name="Event With Coords",
        event_datetime=datetime.datetime.now() + datetime.timedelta(days=5),
        location="–ú–æ—Å–∫–≤–∞, —É–ª. –ü—É—à–∫–∏–Ω–∞, –¥. –ö–æ–ª–æ—Ç—É—à–∫–∏–Ω–∞",
        latitude=55.123,
        longitude=37.456,
        donation_type="plasma",
        points_per_donation=1,
        participant_limit=10,
        registration_is_open=True
    )
    session.add_all([user, event])
    await session.commit()
    
    callback = MockCallbackQuery(
        data=f"reg_event_{event.id}",
        from_user_id=user.telegram_id,
        message=mock_callback_message
    )
    
    # 2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    await student_handlers.process_event_registration(callback, session)

    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞
    mock_callback_message.edit_text.assert_called_once()
    call_args = mock_callback_message.edit_text.call_args.kwargs
    sent_text = call_args['text']
    
    expected_link_part = f'href="https://yandex.ru/maps/?pt={event.longitude},{event.latitude}&z=18&l=map"'
    assert expected_link_part in sent_text
    
    assert ">–ú–æ—Å–∫–≤–∞, —É–ª. –ü—É—à–∫–∏–Ω–∞, –¥. –ö–æ–ª–æ—Ç—É—à–∫–∏–Ω–∞</a>" in sent_text
    assert call_args['parse_mode'] == "HTML"


async def test_add_to_calendar_handler(session: AsyncSession, mocker):
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ö–µ–Ω–¥–ª–µ—Ä 'add_to_calendar' –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç .ics —Ñ–∞–π–ª.
    """
    user = User(phone_number="+987", telegram_id=987, full_name="Calendar User", university="Test")
    event = Event(
        name="Calendar Event",
        event_datetime=datetime.datetime.now(),
        location="Test Location",
        donation_type="blood", points_per_donation=1, participant_limit=1
    )
    session.add_all([user, event])
    await session.commit()

    mock_message = MockMessage()
    mock_message.answer_document = AsyncMock()

    callback = MockCallbackQuery(
        data=f"add_to_calendar_{event.id}",
        from_user_id=user.telegram_id,
        message=mock_message
    )

    await student_handlers.send_calendar_file(callback, session)

    mock_message.answer_document.assert_called_once()
    
    call_args = mock_message.answer_document.call_args.kwargs
    document = call_args['document']
    
    assert "–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π —Ñ–∞–π–ª" in call_args['caption']
    assert f"event_{event.id}.ics" == document.filename
    
    mock_bot = Mock(spec=Bot)
    
    file_chunks = []
    async for chunk in document.read(bot=mock_bot):
        file_chunks.append(chunk)
    
    file_content_bytes = b"".join(file_chunks)
    file_content = file_content_bytes.decode('utf-8')

    assert "BEGIN:VCALENDAR" in file_content
    assert "SUMMARY:–î–æ–Ω–∞—Ü–∏—è: Calendar Event" in file_content
    
async def test_feedback_survey_fsm_full_pass(session: AsyncSession, mocker):
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—É—é —Ü–µ–ø–æ—á–∫—É FSM –æ–ø—Ä–æ—Å–∞ —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º –≤—Å–µ—Ö –ø–æ–ª–µ–π.
    """
    # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
    user = User(phone_number="+1", telegram_id=101, full_name="Feedback User", university="TestUni")
    session.add(user)
    await session.commit()

    state = MockFSMContext()
    await state.set_state(FeedbackSurvey.awaiting_well_being)
    await state.update_data(event_id=1, donation_id=1)

    mock_message_to_edit = MockMessage()

    # 2. –ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ FSM
    # –®–∞–≥ 1: –û—Ü–µ–Ω–∫–∞ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è
    cb_wb = MockCallbackQuery(data="fb_wb_5", from_user_id=user.telegram_id, message=mock_message_to_edit)
    await student_handlers.process_well_being(cb_wb, state)
    assert await state.get_state() == FeedbackSurvey.awaiting_organization_score

    # –®–∞–≥ 2: –û—Ü–µ–Ω–∫–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
    cb_org = MockCallbackQuery(data="fb_org_9", from_user_id=user.telegram_id, message=mock_message_to_edit)
    await student_handlers.process_org_score(cb_org, state)
    assert await state.get_state() == FeedbackSurvey.awaiting_what_liked

    # –®–∞–≥ 3: –ß—Ç–æ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å (–æ—Ç–≤–µ—á–∞–µ–º —Ç–µ–∫—Å—Ç–æ–º)
    msg_liked = MockMessage(text="–í–∫—É—Å–Ω—ã–π —á–∞–π", from_user_id=user.telegram_id)
    await student_handlers.process_what_liked(msg_liked, state)
    assert await state.get_state() == FeedbackSurvey.awaiting_what_disliked

    # –®–∞–≥ 4: –ß—Ç–æ –Ω–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º)
    cb_skip_disliked = MockCallbackQuery(data="fb_skip_step", from_user_id=user.telegram_id, message=mock_message_to_edit)
    await student_handlers.process_what_disliked(cb_skip_disliked, state)
    assert await state.get_state() == FeedbackSurvey.awaiting_other_suggestions

    # –®–∞–≥ 5: –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (–æ—Ç–≤–µ—á–∞–µ–º —Ç–µ–∫—Å—Ç–æ–º)
    msg_suggestions = MockMessage(text="–î–∞–≤–∞—Ç—å –±–æ–ª—å—à–µ –ø–µ—á–µ–Ω—å—è", from_user_id=user.telegram_id)
    await student_handlers.process_other_suggestions(msg_suggestions, state, session)

    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞
    assert await state.get_state() is None

    feedback_entry = (await session.execute(select(Feedback))).scalar_one_or_none()
    assert feedback_entry is not None
    assert feedback_entry.user_id == user.id
    assert feedback_entry.event_id == 1
    assert feedback_entry.well_being_score == 5
    assert feedback_entry.well_being_comment is None
    assert feedback_entry.organization_score == 9
    assert feedback_entry.what_liked == "–í–∫—É—Å–Ω—ã–π —á–∞–π"
    assert feedback_entry.what_disliked == "–ü—Ä–æ–ø—É—â–µ–Ω–æ"
    assert feedback_entry.other_suggestions == "–î–∞–≤–∞—Ç—å –±–æ–ª—å—à–µ –ø–µ—á–µ–Ω—å—è"

async def test_admin_can_view_feedback(session: AsyncSession):
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—Ç–∑—ã–≤–æ–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.
    """
    admin = User(phone_number="+0", telegram_id=100, full_name="Admin", university="TestUni")
    user1 = User(phone_number="+1", telegram_id=101, full_name="User One", university="TestUni")
    event = Event(name="Event With Feedback", event_datetime=datetime.datetime.now(), location="Loc", donation_type="d", points_per_donation=1, participant_limit=1)
    session.add_all([admin, user1, event])
    await session.commit()

    fb1 = Feedback(user_id=user1.id, event_id=event.id, organization_score=10, what_liked="–í—Å—ë")
    session.add(fb1)
    await session.commit()

    mock_message = MockMessage()
    callback = MockCallbackQuery(data=f"admin_view_feedback_{event.id}", from_user_id=admin.telegram_id, message=mock_message)

    await event_management.view_event_feedback(callback, session)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—ã–ª–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ
    mock_message.answer.assert_called_once()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    call_args = mock_message.answer.call_args
    sent_text = call_args.args[0]
    
    assert "–û—Ç–∑—ã–≤—ã –ø–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é" in sent_text
    assert "Event With Feedback" in sent_text
    assert "User One" in sent_text
    assert "–í—Å—ë" in sent_text

@pytest.mark.asyncio
async def test_process_category_external_donor():
    # Arrange
    storage = MemoryStorage()
    state = FSMContext(storage, key=Mock(bot_id=1, chat_id=1, user_id=1))

    message = Mock(
        edit_text=AsyncMock()
    )
    callback = Mock(
        data="category_external",
        message=message,
        answer=AsyncMock()
    )

    # Act
    await common_handlers.process_category(callback, state)

    # Assert
    data = await state.get_data()
    assert data['category'] == 'external'
    assert data['university'] == '–í–Ω–µ—à–Ω–∏–π –¥–æ–Ω–æ—Ä'
    assert data['faculty'] == '–ù–µ –ø—Ä–∏–º–µ–Ω–∏–º–æ'
    assert data['study_group'] == '-'

    current_state = await state.get_state()
    assert current_state == Registration.awaiting_gender

    message.edit_text.assert_called_once_with(
        Text.GET_GENDER,
        reply_markup=inline.get_gender_inline_keyboard()
    )
    callback.answer.assert_called_once()

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: tests/test_handlers_logic.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: tests/test_keyboards.py ---

import pytest
from bot.keyboards import inline

def get_button_texts(keyboard):
    """–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫."""
    return [button.text for row in keyboard.inline_keyboard for button in row]

def test_get_student_main_menu():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –≤ –º–µ–Ω—é —Å—Ç—É–¥–µ–Ω—Ç–∞ –µ—Å—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏, –≤ —Ç.—á. –¥–ª—è –∞–¥–º–∏–Ω–∞."""
    # –°—Ü–µ–Ω–∞—Ä–∏–π 1: –û–±—ã—á–Ω—ã–π —Å—Ç—É–¥–µ–Ω—Ç
    student_keyboard = inline.get_student_main_menu(viewer_role='student')
    student_buttons = get_button_texts(student_keyboard)
    
    assert "üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –¥–æ–Ω–∞—Ü–∏—é" in student_buttons
    assert "üéÅ –ú–∞–≥–∞–∑–∏–Ω –º–µ—Ä—á–∞" in student_buttons
    assert "‚öôÔ∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å" not in student_buttons

    # –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ê–¥–º–∏–Ω –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç –º–µ–Ω—é –∫–∞–∫ —Å—Ç—É–¥–µ–Ω—Ç
    admin_keyboard = inline.get_student_main_menu(viewer_role='admin')
    admin_buttons = get_button_texts(admin_keyboard)

    assert "üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –¥–æ–Ω–∞—Ü–∏—é" in admin_buttons
    assert "‚≠ê –ü–µ—Ä–µ–π—Ç–∏ –≤ —Ä–µ–∂–∏–º –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞" in admin_buttons
    assert "‚öôÔ∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å" in admin_buttons

def test_get_admin_panel_keyboard():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —É –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∞ –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞, –∞ —É –æ–±—ã—á–Ω–æ–≥–æ - –Ω–µ—Ç."""
    # –°—Ü–µ–Ω–∞—Ä–∏–π 1: –û–±—ã—á–Ω—ã–π –∞–¥–º–∏–Ω
    admin_keyboard = inline.get_admin_panel_keyboard(viewer_role='admin')
    admin_buttons = get_button_texts(admin_keyboard)
    
    assert "üë• –£–ø—Ä. –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏" in admin_buttons
    assert "üíæ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö" not in admin_buttons

    # –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω
    main_admin_keyboard = inline.get_admin_panel_keyboard(viewer_role='main_admin')
    main_admin_buttons = get_button_texts(main_admin_keyboard)

    assert "üë• –£–ø—Ä. –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏" in main_admin_buttons
    assert "üíæ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö" in main_admin_buttons

def test_get_user_management_keyboard_permissions():
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ª–æ–≥–∏–∫—É –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–µ–π —Å–º–æ—Ç—Ä—è—â–µ–≥–æ –∏ —Ü–µ–ª–∏.
    """
    # –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ –æ–±—ã—á–Ω–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
    kbd1 = inline.get_user_management_keyboard(
        target_user_id=1, target_user_role='student', viewer_role='main_admin', is_blocked=False
    )
    btn1 = get_button_texts(kbd1)
    assert "üëë‚ûï –ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–æ–º" in btn1
    assert "üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å" in btn1
    assert "üëë‚ûñ –†–∞–∑–∂–∞–ª–æ–≤–∞—Ç—å –∞–¥–º–∏–Ω–∞" not in btn1

    # –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ –æ–±—ã—á–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∞
    kbd2 = inline.get_user_management_keyboard(
        target_user_id=1, target_user_role='admin', viewer_role='main_admin', is_blocked=False
    )
    btn2 = get_button_texts(kbd2)
    assert "üëë‚ûñ –†–∞–∑–∂–∞–ª–æ–≤–∞—Ç—å –∞–¥–º–∏–Ω–∞" in btn2
    assert "üëë‚ûï –ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–æ–º" not in btn2

    # –°—Ü–µ–Ω–∞—Ä–∏–π 3: –û–±—ã—á–Ω—ã–π –∞–¥–º–∏–Ω —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞ (–Ω–µ –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –∞–¥–º–∏–Ω–∞–º–∏/–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏)
    kbd3 = inline.get_user_management_keyboard(
        target_user_id=1, target_user_role='volunteer', viewer_role='admin', is_blocked=False
    )
    btn3 = get_button_texts(kbd3)
    assert "üßë‚Äçüéì –°–Ω—è—Ç—å —Å –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞" in btn3
    assert "üëë‚ûï –ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–æ–º" not in btn3
    assert "üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å" not in btn3
    
    
def test_admin_panel_keyboard_for_admin():
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –æ–±—ã—á–Ω—ã–π –∞–¥–º–∏–Ω –≤–∏–¥–∏—Ç —Å–≤–æ—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ë–ï–ó –∫–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞.
    """
    keyboard = inline.get_admin_panel_keyboard(viewer_role='admin')
    
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤ –ø—Ä–æ—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ callback_data –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
    callbacks = []
    for row in keyboard.inline_keyboard:
        for button in row:
            callbacks.append(button.callback_data)

    assert "admin_manage_users" in callbacks
    assert "ma_export_data" not in callbacks # –ì–ª–∞–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

def test_admin_panel_keyboard_for_main_admin():
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –≥–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω –≤–∏–¥–∏—Ç —Å–≤–æ—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –° –∫–Ω–æ–ø–∫–æ–π —ç–∫—Å–ø–æ—Ä—Ç–∞.
    """
    keyboard = inline.get_admin_panel_keyboard(viewer_role='main_admin')
    
    callbacks = []
    for row in keyboard.inline_keyboard:
        for button in row:
            callbacks.append(button.callback_data)

    assert "admin_manage_users" in callbacks
    assert "ma_export_data" in callbacks # –ì–ª–∞–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

def test_user_management_keyboard_roles():
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–æ–ª—è–º–∏ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è/–∏—Å—á–µ–∑–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ.
    """
    # –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ –æ–±—ã—á–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∞
    kb1 = inline.get_user_management_keyboard(
        target_user_id=1, target_user_role='admin', viewer_role='main_admin', is_blocked=False
    )
    cb1 = {b.callback_data for r in kb1.inline_keyboard for b in r}
    assert "ma_demote_admin_1" in cb1
    assert "ma_promote_admin_1" not in cb1
    assert "ma_block_user_1" in cb1

    # –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞
    kb2 = inline.get_user_management_keyboard(
        target_user_id=2, target_user_role='volunteer', viewer_role='main_admin', is_blocked=False
    )
    cb2 = {b.callback_data for r in kb2.inline_keyboard for b in r}
    assert "ma_promote_admin_2" in cb2
    assert "admin_demote_volunteer_2" in cb2

    # –°—Ü–µ–Ω–∞—Ä–∏–π 3: –û–±—ã—á–Ω—ã–π –∞–¥–º–∏–Ω —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞ (–Ω–µ –¥–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å –∫–Ω–æ–ø–∫–∏ –≥–ª. –∞–¥–º–∏–Ω–∞)
    kb3 = inline.get_user_management_keyboard(
        target_user_id=3, target_user_role='volunteer', viewer_role='admin', is_blocked=False
    )
    cb3 = {b.callback_data for r in kb3.inline_keyboard for b in r}
    assert "ma_promote_admin_3" not in cb3
    assert "ma_block_user_3" not in cb3
    assert "admin_demote_volunteer_3" in cb3

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: tests/test_keyboards.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: tests/test_mailing_logic.py ---

# tests/test_mailing_logic.py

import pytest
from sqlalchemy import select, func
from sqlalchemy.ext.asyncio import AsyncSession

from bot.db.models import User
from bot.db import user_requests, admin_requests

# –ú–∞—Ä–∫–∏—Ä—É–µ–º –≤—Å–µ —Ç–µ—Å—Ç—ã –≤ —ç—Ç–æ–º —Ñ–∞–π–ª–µ –¥–ª—è pytest-asyncio
pytestmark = pytest.mark.asyncio

# –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
users_data = [
    # ... (–¥–∞–Ω–Ω—ã–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...
    {"id": 1, "university": "–ù–ò–Ø–£ –ú–ò–§–ò", "faculty": "–ò–ò–ö–°", "role": "student"},
    {"id": 2, "university": "–ù–ò–Ø–£ –ú–ò–§–ò", "faculty": "–ò–ò–ö–°", "role": "student"},
    {"id": 3, "university": "–ù–ò–Ø–£ –ú–ò–§–ò", "faculty": "–ò–§–ò–ë", "role": "volunteer"},
    {"id": 4, "university": "–ú–ì–£", "faculty": "–í–ú–ö", "role": "student"},
    {"id": 5, "university": "–ú–ì–£", "faculty": "–í–ú–ö", "role": "admin"},
    {"id": 6, "university": "–î—Ä—É–≥–æ–π –í–£–ó", "faculty": None, "role": "student"},
    {"id": 7, "university": "–ù–ò–Ø–£ –ú–ò–§–ò", "faculty": "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è", "role": "main_admin"},
]

# --- –ò–ó–ú–ï–ù–ï–ù–ò–ï –§–ò–ö–°–¢–£–†–´ ---
@pytest.fixture(scope="function", autouse=True)
async def setup_users(session: AsyncSession):
    """
    –§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º –≤ —ç—Ç–æ–º —Ñ–∞–π–ª–µ.
    –¢–µ–ø–µ—Ä—å –∏–º–µ–µ—Ç scope="function" –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–∏–∫—Å—Ç—É—Ä—É session.
    """
    users_to_add = [
        User(
            id=u["id"], phone_number=f"+{u['id']}", telegram_id=u["id"],
            full_name=f"User {u['id']}", university=u["university"],
            faculty=u.get("faculty"), role=u.get("role")
        ) for u in users_data
    ]
    session.add_all(users_to_add)
    await session.commit()
    yield # –ü–µ—Ä–µ–¥–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç—É
# --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô –í –§–ò–ö–°–¢–£–†–ï ---


@pytest.mark.parametrize(
    "filters, expected_user_ids",
    [
        # --- –ü–†–û–°–¢–´–ï –§–ò–õ–¨–¢–†–´ ---
        ({}, {1, 2, 3, 4, 5, 6, 7}), # –§–∏–ª—å—Ç—Ä 'all' –∏–ª–∏ –ø—É—Å—Ç–æ–π -> –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
        ({"role": "all"}, {1, 2, 3, 4, 5, 6, 7}),
        ({"university": "–ù–ò–Ø–£ –ú–ò–§–ò"}, {1, 2, 3, 7}),
        ({"faculty": "–ò–ò–ö–°"}, {1, 2}),
        
        # --- –†–û–õ–ï–í–´–ï –§–ò–õ–¨–¢–†–´ ---
        ({"role": "volunteers"}, {3, 5, 7}), # volunteer, admin, main_admin
        ({"role": "admins"}, {5, 7}), # admin, main_admin
        
        # --- –ö–û–ú–ü–õ–ï–ö–°–ù–´–ï –§–ò–õ–¨–¢–†–´ –° –†–û–õ–Ø–ú–ò ---
        # –°—Ü–µ–Ω–∞—Ä–∏–π 1: –í–æ–ª–æ–Ω—Ç–µ—Ä—ã –∏–∑ –ù–ò–Ø–£ –ú–ò–§–ò
        ({"role": "volunteers", "university": "–ù–ò–Ø–£ –ú–ò–§–ò"}, {3, 7}),

        # –°—Ü–µ–Ω–∞—Ä–∏–π 3: –í–æ–ª–æ–Ω—Ç–µ—Ä—ã —Å —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∞ –í–ú–ö -> —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 5 (—Ç.–∫. –∞–¥–º–∏–Ω - —Ç–æ–∂–µ –≤–æ–ª–æ–Ω—Ç–µ—Ä)
        ({"role": "volunteers", "faculty": "–í–ú–ö"}, {5}),

        # –°—Ü–µ–Ω–∞—Ä–∏–π 5: –ê–¥–º–∏–Ω—ã –∏–∑ –ù–ò–Ø–£ –ú–ò–§–ò
        ({"role": "admins", "university": "–ù–ò–Ø–£ –ú–ò–§–ò"}, {7}),
    ]
)
# --- –í–ê–ñ–ù–û: –£–ë–ò–†–ê–ï–ú session –ò–ó –ü–ê–†–ê–ú–ï–¢–†–û–í –¢–ï–°–¢–ê, –¢.–ö. –û–ù –ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø –ù–ê–ü–†–Ø–ú–£–Æ, –ê –ù–£–ñ–ï–ù –§–ò–ö–°–¢–£–†–ï ---
async def test_get_users_for_mailing_complex_with_roles(session: AsyncSession, filters, expected_user_ids):
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏, –≤–∫–ª—é—á–∞—è —Ä–æ–ª–∏.
    """
    # –§–∏–∫—Å—Ç—É—Ä–∞ setup_users —É–∂–µ –≤—ã–ø–æ–ª–Ω–∏–ª–∞—Å—å –∏ —Å–æ–∑–¥–∞–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    users = await user_requests.get_users_for_mailing(session, filters)
    actual_user_ids = {user.id for user in users}
    assert actual_user_ids == expected_user_ids

# –≠—Ç–æ—Ç —Ç–µ—Å—Ç —Ç–∞–∫–∂–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–∏–∫—Å—Ç—É—Ä—É setup_users
async def test_get_distinct_faculties(session: AsyncSession):
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–æ–≤, –∏—Å–∫–ª—é—á–∞—è None."""
    faculties = await admin_requests.get_distinct_faculties(session)
    assert sorted(faculties) == ["–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è", "–í–ú–ö", "–ò–ò–ö–°", "–ò–§–ò–ë"]

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: tests/test_mailing_logic.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: tests/test_middlewares.py ---

# tests/test_middlewares.py

import pytest
from unittest.mock import AsyncMock, Mock

from sqlalchemy.ext.asyncio import AsyncSession
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º Message, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –∫–∞–∫ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é –¥–ª—è Mock
from aiogram.types import Message, CallbackQuery 

from bot.db.models import User
from bot.middlewares.block import BlockUserMiddleware
from bot.middlewares.db import DbSessionMiddleware

# –ü–æ–º–µ—á–∞–µ–º –≤—Å–µ —Ç–µ—Å—Ç—ã –∫–∞–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ
pytestmark = pytest.mark.asyncio


# --- –§–∏–∫—Å—Ç—É—Ä—ã –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ---

@pytest.fixture
async def blocked_user(session: AsyncSession) -> User:
    """–°–æ–∑–¥–∞–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î."""
    user = User(
        phone_number="+7-blocked", telegram_id=9001, full_name="Blocked User",
        university="Test", is_blocked=True
    )
    session.add(user)
    await session.commit()
    await session.refresh(user)
    return user

@pytest.fixture
async def active_user(session: AsyncSession) -> User:
    """–°–æ–∑–¥–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ (–Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î."""
    user = User(
        phone_number="+7-active", telegram_id=9002, full_name="Active User",
        university="Test", is_blocked=False
    )
    session.add(user)
    await session.commit()
    await session.refresh(user)
    return user


# --- –¢–µ—Å—Ç—ã Middleware (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø) ---

async def test_block_middleware_for_blocked_user(session: AsyncSession, blocked_user: User):
    """
    –¢–µ—Å—Ç: Middleware –¥–æ–ª–∂–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    block_mw = BlockUserMiddleware()
    handler_mock = AsyncMock()
    
    # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–æ–∑–¥–∞–µ–º mock, –∫–æ—Ç–æ—Ä—ã–π —è–≤–ª—è–µ—Ç—Å—è "–ø–æ—Ö–æ–∂–∏–º" –Ω–∞ Message
    # –∏ –±—É–¥–µ—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É isinstance(event, Message)
    event = Mock(spec=Message)
    event.from_user = Mock(id=blocked_user.telegram_id)
    event.answer = AsyncMock()

    await block_mw(
        handler=handler_mock, 
        event=event, 
        data={"session": session}
    )
    
    # –¢–µ–ø–µ—Ä—å handler –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω
    handler_mock.assert_not_called()
    # –ê –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ
    event.answer.assert_called_once()
    assert "–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã" in event.answer.call_args.args[0]


async def test_block_middleware_for_active_user(session: AsyncSession, active_user: User):
    """
    –¢–µ—Å—Ç: Middleware –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    block_mw = BlockUserMiddleware()
    handler_mock = AsyncMock()

    # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π mock
    event = Mock(spec=Message)
    event.from_user = Mock(id=active_user.telegram_id)
    event.answer = AsyncMock()
    
    await block_mw(
        handler=handler_mock, 
        event=event, 
        data={"session": session}
    )
    
    # Handler –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω, —Ç.–∫. –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–µ–Ω
    handler_mock.assert_called_once()
    # –°–æ–æ–±—â–µ–Ω–∏–µ –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
    event.answer.assert_not_called()


async def test_block_middleware_for_unregistered_user(session: AsyncSession):
    """
    –¢–µ—Å—Ç: Middleware –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–≥–æ –µ—â–µ –Ω–µ—Ç –≤ –ë–î.
    """
    block_mw = BlockUserMiddleware()
    handler_mock = AsyncMock()
    
    # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π mock
    event = Mock(spec=Message)
    event.from_user = Mock(id=999999) # ID, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç –≤ –ë–î
    event.answer = AsyncMock()
    
    await block_mw(
        handler=handler_mock, 
        event=event, 
        data={"session": session}
    )
    
    # Handler –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω, —Ç.–∫. –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
    handler_mock.assert_called_once()
    event.answer.assert_not_called()


async def test_db_middleware_adds_session(session_pool):  # <--- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨
    """
    –¢–µ—Å—Ç –¥–ª—è DbSessionMiddleware: –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–µ—Å—Å–∏—é –≤ –¥–∞–Ω–Ω—ã–µ.
    """
    # session_maker –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ session_pool
    db_mw = DbSessionMiddleware(session_pool=session_pool)  # <--- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨
    handler_mock = AsyncMock()
    event = Mock()
    data = {}

    await db_mw(handler=handler_mock, event=event, data=data)

    handler_mock.assert_called_once()
    data_passed_to_handler = handler_mock.call_args.args[1]
    assert 'session' in data_passed_to_handler
    assert isinstance(data_passed_to_handler['session'], AsyncSession)

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: tests/test_middlewares.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: tests/test_registration_logic.py ---

import pytest
import pytest_asyncio
import datetime
from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker, AsyncSession

from bot.db.models import Base, User, Event, EventRegistration, Donation, MedicalWaiver
from bot.db.event_requests import check_registration_eligibility, add_event_registration
from bot.db.models import Event as DbEvent # –ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –∏–º–µ–Ω

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ –ø–∞–º—è—Ç–∏ ---

TEST_DATABASE_URL = "sqlite+aiosqlite:///file:memdb1?mode=memory&cache=shared&uri=true"
test_engine = create_async_engine(TEST_DATABASE_URL, echo=False)
test_async_session_maker = async_sessionmaker(test_engine, class_=AsyncSession, expire_on_commit=False)

@pytest_asyncio.fixture(scope="function")
async def db_session() -> AsyncSession:
    async with test_engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
    async with test_async_session_maker() as session:
        yield session
    async with test_engine.begin() as conn:
        await conn.run_sync(Base.metadata.drop_all)

# --- –§–∏–∫—Å—Ç—É—Ä—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö ---

@pytest_asyncio.fixture
async def male_user(db_session: AsyncSession) -> User:
    user = User(
        phone_number="+79991112233",
        telegram_id=1,
        full_name="–¢–µ—Å—Ç–æ–≤—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ú—É–∂—á–∏–Ω–∞",
        gender="male",
        university="–¢–µ—Å—Ç–æ–≤—ã–π –í–£–ó"  # <-- –ò–°–ü–†–ê–í–õ–ï–ù–û
    )
    db_session.add(user)
    await db_session.commit()
    return user

@pytest_asyncio.fixture
async def female_user(db_session: AsyncSession) -> User:
    user = User(
        phone_number="+79994445566",
        telegram_id=2,
        full_name="–¢–µ—Å—Ç–æ–≤—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ñ–µ–Ω—â–∏–Ω–∞",
        gender="female",
        university="–¢–µ—Å—Ç–æ–≤—ã–π –í–£–ó" # <-- –ò–°–ü–†–ê–í–õ–ï–ù–û
    )
    db_session.add(user)
    await db_session.commit()
    return user

# --- –¢–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏ ---

@pytest.mark.asyncio
async def test_successful_registration(db_session: AsyncSession, male_user: User):
    """–¢–µ—Å—Ç: –£—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤."""
    event_date = datetime.date.today() + datetime.timedelta(days=10)
    event = DbEvent(  # <-- –ò–°–ü–†–ê–í–õ–ï–ù–û: –Ø–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏
        name="–¢–µ—Å—Ç–æ–≤–∞—è –¥–æ–Ω–∞—Ü–∏—è",
        event_datetime=datetime.datetime.combine(event_date, datetime.time(10, 0)), # <-- –ò–°–ü–†–ê–í–õ–ï–ù–û
        donation_type="whole_blood",
        participant_limit=10,
        location="–¢–µ—Å—Ç–æ–≤–∞—è –ª–æ–∫–∞—Ü–∏—è",
        points_per_donation=100
    )
    db_session.add(event)
    await db_session.commit()

    is_eligible, reason = await check_registration_eligibility(db_session, male_user, event)
    
    assert is_eligible is True
    assert reason == "–í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã."

@pytest.mark.asyncio
async def test_blocked_by_potential_waiver(db_session: AsyncSession, male_user: User):
    """
    –¢–µ—Å—Ç: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏–∑-–∑–∞ –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–û–ì–û –º–µ–¥–æ—Ç–≤–æ–¥–∞ –æ—Ç –¥—Ä—É–≥–æ–π –±—É–¥—É—â–µ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
    """
    event_A_date = datetime.date.today() + datetime.timedelta(days=10)
    event_B_date = datetime.date.today() + datetime.timedelta(days=15)
    
    event_A = DbEvent(
        name="–î–æ–Ω–∞—Ü–∏—è –ê",
        event_datetime=datetime.datetime.combine(event_A_date, datetime.time(10, 0)), # <-- –ò–°–ü–†–ê–í–õ–ï–ù–û
        donation_type="whole_blood",
        participant_limit=10,
        location="–õ–æ–∫–∞—Ü–∏—è –ê",
        points_per_donation=100
    )
    event_B = DbEvent(
        name="–î–æ–Ω–∞—Ü–∏—è –ë",
        event_datetime=datetime.datetime.combine(event_B_date, datetime.time(10, 0)), # <-- –ò–°–ü–†–ê–í–õ–ï–ù–û
        donation_type="plasma",
        participant_limit=10,
        location="–õ–æ–∫–∞—Ü–∏—è –ë",
        points_per_donation=50
    )
    db_session.add_all([event_A, event_B])
    await db_session.commit()
    
    await add_event_registration(db_session, male_user.id, event_A.id)

    is_eligible, reason = await check_registration_eligibility(db_session, male_user, event_B)
    
    assert is_eligible is False
    assert "–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –¥–æ–Ω–∞—Ü–∏—è" in reason
    assert "–î–æ–Ω–∞—Ü–∏—è –ê" in reason

@pytest.mark.asyncio
async def test_not_blocked_if_waiver_ends(db_session: AsyncSession, male_user: User):
    """
    –¢–µ—Å—Ç: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∞, –µ—Å–ª–∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –º–µ–¥–æ—Ç–≤–æ–¥ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è.
    """
    event_A_date = datetime.date.today() + datetime.timedelta(days=10)
    event_C_date = datetime.date.today() + datetime.timedelta(days=80)

    event_A = DbEvent(
        name="–î–æ–Ω–∞—Ü–∏—è –ê",
        event_datetime=datetime.datetime.combine(event_A_date, datetime.time(10, 0)), # <-- –ò–°–ü–†–ê–í–õ–ï–ù–û
        donation_type="whole_blood",
        participant_limit=10,
        location="–õ–æ–∫–∞—Ü–∏—è –ê",
        points_per_donation=100
    )
    event_C = DbEvent(
        name="–î–æ–Ω–∞—Ü–∏—è –°",
        event_datetime=datetime.datetime.combine(event_C_date, datetime.time(10, 0)), # <-- –ò–°–ü–†–ê–í–õ–ï–ù–û
        donation_type="plasma",
        participant_limit=10,
        location="–õ–æ–∫–∞—Ü–∏—è C",
        points_per_donation=50
    )
    db_session.add_all([event_A, event_C])
    await db_session.commit()
    
    await add_event_registration(db_session, male_user.id, event_A.id)

    is_eligible, reason = await check_registration_eligibility(db_session, male_user, event_C)
    
    assert is_eligible is True

@pytest.mark.asyncio
async def test_blocked_by_yearly_limit_combined(db_session: AsyncSession, female_user: User):
    """
    –¢–µ—Å—Ç: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏–∑-–∑–∞ –≥–æ–¥–æ–≤–æ–≥–æ –ª–∏–º–∏—Ç–∞, —É—á–∏—Ç—ã–≤–∞—è –ø—Ä–æ—à–ª—ã–µ –∏ –±—É–¥—É—â–∏–µ –¥–æ–Ω–∞—Ü–∏–∏.
    """
    # 2 –ø—Ä–æ—à–ª—ã–µ –¥–æ–Ω–∞—Ü–∏–∏
    db_session.add_all([
        Donation(user_id=female_user.id, donation_date=datetime.date.today() - datetime.timedelta(days=200), donation_type="whole_blood", points_awarded=10),
        Donation(user_id=female_user.id, donation_date=datetime.date.today() - datetime.timedelta(days=300), donation_type="whole_blood", points_awarded=10)
    ])

    # 1 –±—É–¥—É—â–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–¥–æ–Ω–∞—Ü–∏—è ‚Ññ3)
    future_event_1_date = datetime.date.today() + datetime.timedelta(days=20)
    future_event_1 = DbEvent(
        name="–ë—É–¥—É—â–∞—è 1", event_datetime=datetime.datetime.combine(future_event_1_date, datetime.time(10,0)), # <-- –ò–°–ü–†–ê–í–õ–ï–ù–û
        donation_type="whole_blood", participant_limit=10, location="–õ–æ–∫–∞—Ü–∏—è 1", points_per_donation=100
    )
    db_session.add(future_event_1)
    await db_session.commit()
    await add_event_registration(db_session, female_user.id, future_event_1.id)

    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ 4-—é –¥–æ–Ω–∞—Ü–∏—é. –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —É—Å–ø–µ—à–Ω–æ.
    event_ok_date = datetime.date.today() + datetime.timedelta(days=120)
    event_to_register_ok = DbEvent(
        name="–ë—É–¥—É—â–∞—è 2 (OK)", event_datetime=datetime.datetime.combine(event_ok_date, datetime.time(10,0)), # <-- –ò–°–ü–†–ê–í–õ–ï–ù–û
        donation_type="whole_blood", participant_limit=10, location="–õ–æ–∫–∞—Ü–∏—è 2", points_per_donation=100
    )
    db_session.add(event_to_register_ok)
    await db_session.commit()

    is_eligible, reason = await check_registration_eligibility(db_session, female_user, event_to_register_ok)
    assert is_eligible is True, f"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ 4-—é –¥–æ–Ω–∞—Ü–∏—é –¥–æ–ª–∂–Ω–∞ –±—ã–ª–∞ –ø—Ä–æ–π—Ç–∏. –ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞: {reason}"
    
    await add_event_registration(db_session, female_user.id, event_to_register_ok.id)

    # –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ 5-—é. –î–æ–ª–∂–Ω—ã –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–∫–∞–∑ –∏–º–µ–Ω–Ω–æ –ø–æ –ø—Ä–∏—á–∏–Ω–µ –ª–∏–º–∏—Ç–∞.
    event_fail_date = datetime.date.today() + datetime.timedelta(days=220)
    event_to_register_fail = DbEvent(
        name="–ë—É–¥—É—â–∞—è 3 (FAIL)", event_datetime=datetime.datetime.combine(event_fail_date, datetime.time(10,0)), # <-- –ò–°–ü–†–ê–í–õ–ï–ù–û
        donation_type="whole_blood", participant_limit=10, location="–õ–æ–∫–∞—Ü–∏—è 3", points_per_donation=100
    )
    db_session.add(event_to_register_fail)
    await db_session.commit()

    is_eligible_fail, reason_fail = await check_registration_eligibility(db_session, female_user, event_to_register_fail)
    
    assert is_eligible_fail is False
    assert "–≥–æ–¥–æ–≤–æ–≥–æ –ª–∏–º–∏—Ç–∞" in reason_fail, f"–û–∂–∏–¥–∞–ª–∞—Å—å –æ—à–∏–±–∫–∞ –ª–∏–º–∏—Ç–∞, –Ω–æ –ø–æ–ª—É—á–µ–Ω–æ: '{reason_fail}'"

@pytest.mark.asyncio
async def test_yearly_limit_not_blocked_by_other_type(db_session: AsyncSession, male_user: User):
    """
    –¢–µ—Å—Ç: –ì–æ–¥–æ–≤–æ–π –ª–∏–º–∏—Ç –Ω–µ –¥–æ–ª–∂–µ–Ω –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å, –µ—Å–ª–∏ —Ç–∏–ø—ã –¥–æ–Ω–∞—Ü–∏–π —Ä–∞–∑–Ω—ã–µ.
    """
    for i in range(5):
         db_session.add(Donation(user_id=male_user.id, donation_date=datetime.date.today() - datetime.timedelta(days=30*(i+1)), donation_type="plasma", points_awarded=10))
    await db_session.commit()

    blood_event_date = datetime.date.today() + datetime.timedelta(days=10)
    blood_event = DbEvent(
        name="–î–æ–Ω–∞—Ü–∏—è –∫—Ä–æ–≤–∏",
        event_datetime=datetime.datetime.combine(blood_event_date, datetime.time(10,0)), # <-- –ò–°–ü–†–ê–í–õ–ï–ù–û
        donation_type="whole_blood",
        participant_limit=10,
        location="–¢–µ—Å—Ç–æ–≤–∞—è –ª–æ–∫–∞—Ü–∏—è",
        points_per_donation=100
    )
    db_session.add(blood_event)
    await db_session.commit()

    is_eligible, reason = await check_registration_eligibility(db_session, male_user, blood_event)

    assert is_eligible is True

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: tests/test_registration_logic.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: tests/test_scheduler_logic.py ---

import pytest
import datetime
from unittest.mock import AsyncMock, Mock
from aiogram import Bot
from aiogram.fsm.context import FSMContext
from aiogram.fsm.storage.memory import MemoryStorage
from sqlalchemy.ext.asyncio import AsyncSession

from bot.utils.scheduler import send_reminders_for_interval, send_post_donation_feedback
from bot.db.models import User, Event, EventRegistration, Donation
from bot.states.states import FeedbackSurvey
from bot.utils.text_messages import Text
from bot.keyboards import inline

pytestmark = pytest.mark.asyncio

@pytest.mark.parametrize(
    "time_delta_to_event, check_interval, check_window, expected_text_template, should_be_called",
    [
        (datetime.timedelta(days=7), datetime.timedelta(days=7), datetime.timedelta(days=1), Text.REMINDER_WEEK, True),
        (datetime.timedelta(days=2), datetime.timedelta(days=2), datetime.timedelta(days=1), Text.REMINDER_2_DAYS, True),
        (datetime.timedelta(hours=2), datetime.timedelta(hours=2), datetime.timedelta(hours=1), Text.REMINDER_2_HOURS, True),
        (datetime.timedelta(days=3), datetime.timedelta(days=2), datetime.timedelta(days=1), None, False),
        (datetime.timedelta(days=8), datetime.timedelta(days=7), datetime.timedelta(days=1), None, False),
        (datetime.timedelta(hours=3), datetime.timedelta(hours=2), datetime.timedelta(hours=1), None, False),
        (datetime.timedelta(days=-1), datetime.timedelta(days=2), datetime.timedelta(days=1), None, False),
    ]
)
async def test_send_event_reminders_multi_interval(
    session: AsyncSession,
    session_pool,
    mocker,
    time_delta_to_event,
    check_interval,
    check_window,
    expected_text_template,
    should_be_called
):
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤.
    """
    fixed_now = datetime.datetime(2024, 1, 1, 12, 0, 0)
    mocker.patch('datetime.datetime', Mock(now=lambda: fixed_now))

    mock_send_message = mocker.patch('aiogram.Bot.send_message', new_callable=AsyncMock)
    mock_bot = Mock(spec=Bot)
    mock_bot.send_message = mock_send_message

    user = User(phone_number="+1", telegram_id=101, full_name="UserToRemind", university="TestUni")
    event_time = fixed_now + time_delta_to_event
    event = Event(name="Test-Event", event_datetime=event_time, location="Test Location", donation_type="plasma", points_per_donation=10, participant_limit=5, is_active=True)
    session.add_all([user, event])
    await session.commit()
    registration = EventRegistration(user_id=user.id, event_id=event.id)
    session.add(registration)
    await session.commit()

    await send_reminders_for_interval(
        bot=mock_bot,
        session_pool=session_pool,  
        time_from_now=check_interval,
        time_window=check_window,
        text_template=expected_text_template or "dummy"
    )
    
    if should_be_called:
        mock_send_message.assert_called_once()
        call_args = mock_send_message.call_args.kwargs
        sent_text = call_args['text']
        
        assert call_args['parse_mode'] == "HTML"
        assert "<b>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ" in sent_text or "<b>–î–æ–Ω–∞—Ü–∏—è —É–∂–µ —Å–∫–æ—Ä–æ" in sent_text
        assert "Test-Event" in sent_text
        assert "Test Location" in sent_text
    else:
        mock_send_message.assert_not_called()

async def test_send_post_donation_feedback(session: AsyncSession, session_pool, mocker):
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –ø–æ—Å–ª–µ –¥–æ–Ω–∞—Ü–∏–∏.
    """
    # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
    fixed_today = datetime.date(2024, 10, 27)
    fixed_yesterday = fixed_today - datetime.timedelta(days=1)
    fixed_day_before = fixed_today - datetime.timedelta(days=2)
    mocker.patch('datetime.date', Mock(today=lambda: fixed_today))

    mock_send_message = mocker.patch('aiogram.Bot.send_message', new_callable=AsyncMock)
    mock_bot = Mock(spec=Bot)
    mock_bot.send_message = mock_send_message

    user_to_notify = User(phone_number="+1", telegram_id=101, full_name="Feedback User", university="TestUni")
    user_to_ignore_old = User(phone_number="+2", telegram_id=102, full_name="Old Donor", university="TestUni")
    user_to_ignore_duplicate = User(phone_number="+3", telegram_id=103, full_name="Duplicate", university="TestUni")
    session.add_all([user_to_notify, user_to_ignore_old, user_to_ignore_duplicate])
    await session.commit()
    
    donation_to_notify = Donation(user_id=user_to_notify.id, event_id=1, donation_date=fixed_yesterday, donation_type="plasma", points_awarded=1)
    donation_to_ignore_old = Donation(user_id=user_to_ignore_old.id, event_id=2, donation_date=fixed_day_before, donation_type="plasma", points_awarded=1)
    donation_to_ignore_duplicate = Donation(user_id=user_to_ignore_duplicate.id, event_id=3, donation_date=fixed_yesterday, donation_type="plasma", points_awarded=1, feedback_requested=True)
    session.add_all([donation_to_notify, donation_to_ignore_old, donation_to_ignore_duplicate])
    await session.commit()

    # 2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    await send_post_donation_feedback(
        bot=mock_bot,
        session_pool=session_pool, 
        storage=MemoryStorage()
    )

    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞
    mock_send_message.assert_called_once_with(
        chat_id=user_to_notify.telegram_id,
        text=Text.FEEDBACK_START,
        reply_markup=inline.get_feedback_well_being_keyboard()
    )
    
    await session.refresh(donation_to_notify)
    await session.refresh(donation_to_ignore_old)
    await session.refresh(donation_to_ignore_duplicate)
    
    assert donation_to_notify.feedback_requested is True
    assert donation_to_ignore_old.feedback_requested is False
    assert donation_to_ignore_duplicate.feedback_requested is True

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: tests/test_scheduler_logic.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: tests/test_security.py ---

# tests/test_security.py

import pytest
import hmac
import hashlib
import json
from urllib.parse import urlencode
from fastapi import HTTPException

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–µ—Å—Ç–∏—Ä—É–µ–º—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏ –∫–æ–Ω—Ñ–∏–≥
from main import validate_telegram_data
from bot.config_reader import config

# --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ---
def generate_test_auth_data(user_data_dict: dict, bot_token: str) -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤–∞–ª–∏–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É initData –¥–ª—è —Ç–µ—Å—Ç–æ–≤."""
    
    # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º json.dumps –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Python-—Å–ª–æ–≤–∞—Ä—è –≤ JSON-—Å—Ç—Ä–æ–∫—É.
    # separators —É–±–∏—Ä–∞–µ—Ç –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã, sort_keys –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫ –∫–ª—é—á–µ–π.
    user_data_str = json.dumps(user_data_dict, separators=(',', ':'), sort_keys=True)
    
    # –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è (–∫—Ä–æ–º–µ —Å–∞–º–æ–≥–æ —Ö–µ—à–∞)
    data_to_sign = {
        'auth_date': '1700000000',
        'query_id': 'AAg123456789',
        'user': user_data_str
    }
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (data_check_string)
    sorted_items = sorted(data_to_sign.items())
    data_check_string = "\n".join([f"{k}={v}" for k, v in sorted_items])
    
    # –í—ã—á–∏—Å–ª—è–µ–º —Ö–µ—à —Ç–æ—á–Ω–æ —Ç–∞–∫ –∂–µ, –∫–∞–∫ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç Telegram
    secret_key = hmac.new("WebAppData".encode(), bot_token.encode(), hashlib.sha256).digest()
    calculated_hash = hmac.new(secret_key, data_check_string.encode(), hashlib.sha256).hexdigest()
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ö–µ—à –∫ –¥–∞–Ω–Ω—ã–º –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É
    data_to_sign['hash'] = calculated_hash
    
    return urlencode(data_to_sign)


# --- –¢–µ—Å—Ç—ã ---

def test_validate_telegram_data_success():
    """–¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏."""
    bot_token = config.bot_token.get_secret_value()
    user_data = {
        "id": 12345678,
        "first_name": "John",
        "last_name": "Doe",
        "username": "johndoe",
        "language_code": "en",
        "is_premium": True
    }
    
    auth_string = generate_test_auth_data(user_data, bot_token)
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é
    validated_user_data = validate_telegram_data(auth_string)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∏—Å—Ö–æ–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    assert validated_user_data['id'] == user_data['id']
    assert validated_user_data['username'] == user_data['username']
    assert validated_user_data['is_premium'] is True


def test_validate_telegram_data_invalid_hash():
    """–¢–µ—Å—Ç –ø—Ä–æ–≤–∞–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏–∑-–∑–∞ –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ —Ö–µ—à–∞."""
    bot_token = config.bot_token.get_secret_value()
    user_data = {"id": 123, "username": "test"}
    
    auth_string = generate_test_auth_data(user_data, bot_token)
    
    # –ò—Å–∫–∞–∂–∞–µ–º —Ö–µ—à
    tampered_auth_string = auth_string[:-10] + "abcdefghij"
    
    with pytest.raises(HTTPException) as excinfo:
        validate_telegram_data(tampered_auth_string)
        
    assert excinfo.value.status_code == 403
    # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, –∞ –Ω–µ –æ–±—â–µ–µ
    assert "Invalid hash" in str(excinfo.value.detail)


def test_validate_telegram_data_missing_hash():
    """–¢–µ—Å—Ç –ø—Ä–æ–≤–∞–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Ö–µ—à–∞."""
    auth_string = "user=%7B%22id%22%3A+123%7D&auth_date=1700000000"
    
    with pytest.raises(HTTPException) as excinfo:
        validate_telegram_data(auth_string)
        
    assert excinfo.value.status_code == 403
    assert "Hash not found" in str(excinfo.value.detail)


def test_validate_telegram_data_tampered_data():
    """–¢–µ—Å—Ç –ø—Ä–æ–≤–∞–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã –±–µ–∑ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Ö–µ—à–∞."""
    bot_token = config.bot_token.get_secret_value()
    user_data = {"id": 123}
    
    auth_string = generate_test_auth_data(user_data, bot_token)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å—Ç—Ä–æ–∫—É –Ω–æ–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ —É—á–∞—Å—Ç–≤–æ–≤–∞–ª –≤ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–∏
    tampered_auth_string = auth_string + "&new_param=hacker"
    
    with pytest.raises(HTTPException) as excinfo:
        validate_telegram_data(tampered_auth_string)
        
    assert excinfo.value.status_code == 403
    assert "Invalid hash" in str(excinfo.value.detail)

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: tests/test_security.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: tests/test_survey_logic.py ---

import pytest
import datetime
from unittest.mock import AsyncMock, Mock

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select

# –ú—ã —Ç–µ—Å—Ç–∏—Ä—É–µ–º process_survey_rules –∏–∑ main, —Ç–∞–∫ —á—Ç–æ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Ç—Ç—É–¥–∞
from main import process_survey_rules, SurveyAnswers
# –ê –≤–æ—Ç submit_survey_logic –º—ã —Ç–µ–ø–µ—Ä—å —Ç–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ-–Ω–æ–≤–æ–º—É
from main import submit_survey_logic, SurveyPayload 
from bot.db.models import User, Survey, MedicalWaiver, UserBlock

# –ú–∞—Ä–∫–∏—Ä—É–µ–º –≤—Å–µ —Ç–µ—Å—Ç—ã –≤ —ç—Ç–æ–º —Ñ–∞–π–ª–µ –¥–ª—è pytest-asyncio
pytestmark = pytest.mark.asyncio

# –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π –Ω–∞–±–æ—Ä "–∑–¥–æ—Ä–æ–≤—ã—Ö" –æ—Ç–≤–µ—Ç–æ–≤
default_answers = {
    "feeling": "good", "weight": "no", "symptoms": "no",
    "tattoo": "no", "tooth": "no", "vaccine": "no", "vaccine_type": None,
    "antibiotics": "no", "aspirin": "no", "contact_hepatitis": "no",
    "diseases_absolute": "no", "diseases_chronic": "no",
    "travel": "no", "alcohol": "no"
}

# --- –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ "–¥–≤–∏–∂–∫–∞ –ø—Ä–∞–≤–∏–ª" ---
@pytest.mark.parametrize("modified_answer, expected_status, expected_days, expected_reason_part", [
    # –°—Ü–µ–Ω–∞—Ä–∏–π "OK"
    ({}, "ok", 0, "–ü—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏–π –Ω–µ –≤—ã—è–≤–ª–µ–Ω–æ"),
    # –°—Ü–µ–Ω–∞—Ä–∏–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—Ç–≤–æ–¥–æ–≤
    ({"symptoms": "yes"}, "temp_waiver", 14, "–°–∏–º–ø—Ç–æ–º—ã –û–†–í–ò"),
    ({"feeling": "bad"}, "temp_waiver", 3, "–ü–ª–æ—Ö–æ–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ"),
    ({"tattoo": "yes"}, "temp_waiver", 120, "—Ç–∞—Ç—É–∏—Ä–æ–≤–∫–∏"),
    ({"alcohol": "yes"}, "temp_waiver", 2, "–∞–ª–∫–æ–≥–æ–ª—è"),
    ({"vaccine": "yes", "vaccine_type": "live"}, "temp_waiver", 30, "–≤–∞–∫—Ü–∏–Ω–∞—Ü–∏—è"),
    ({"vaccine": "yes", "vaccine_type": "killed"}, "temp_waiver", 10, "–≤–∞–∫—Ü–∏–Ω–∞—Ü–∏—è"),
    
    # --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –°–¶–ï–ù–ê–†–ò–ò "–ü–û–°–¢–û–Ø–ù–ù–´–•" –û–¢–í–û–î–û–í ---
    # –¢–µ–ø–µ—Ä—å —ç—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ—Ç–≤–æ–¥ –Ω–∞ 1000 –ª–µ—Ç
    ({"diseases_absolute": "yes"}, "temp_waiver", 365000, "–ê–±—Å–æ–ª—é—Ç–Ω–æ–µ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏–µ"),
    # –≠—Ç–æ —Ç–æ–∂–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ—Ç–≤–æ–¥ –Ω–∞ 1000 –ª–µ—Ç
    ({"weight": "yes"}, "temp_waiver", 365000, "–í–µ—Å –º–µ–Ω–µ–µ 50 –∫–≥"),
])
async def test_process_survey_rules(modified_answer, expected_status, expected_days, expected_reason_part):
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –¥–≤–∏–∂–æ–∫ –ø—Ä–∞–≤–∏–ª."""
    answers_dict = default_answers.copy()
    answers_dict.update(modified_answer)
    answers_obj = SurveyAnswers(**answers_dict)
    
    status, days, reason = await process_survey_rules(answers_obj)
    
    assert status == expected_status
    assert days == expected_days
    assert expected_reason_part in reason

# --- –¢–µ—Å—Ç—ã 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏ submit_survey_logic ---

async def create_test_user(session: AsyncSession, tg_id=123, is_blocked=False):
    """–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    user = User(
        phone_number=f"+{tg_id}", telegram_id=tg_id, full_name="Test User",
        university="Test", is_blocked=is_blocked
    )
    session.add(user)
    await session.commit()
    return user

async def test_api_submit_survey_ok(session: AsyncSession):
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç —É—Å–ø–µ—à–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: submit_survey_logic –¥–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è."""
    user = await create_test_user(session)
    answers = SurveyAnswers(**default_answers)
    payload = SurveyPayload(survey_data=answers, auth_string="valid_auth_string")
    
    # –ú–æ–∫–∞–µ–º –≤–∞–ª–∏–¥–∞—Ç–æ—Ä, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ö–µ—à–∏ –≤ —ç—Ç–æ–º —é–Ω–∏—Ç-—Ç–µ—Å—Ç–µ
    with pytest.MonkeyPatch.context() as m:
        m.setattr("main.validate_telegram_data", lambda auth_data: {'id': user.telegram_id})
        
        # –í—ã–∑—ã–≤–∞–µ–º –ª–æ–≥–∏–∫—É –∏ –ø–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        chat_id, text, markup = await submit_survey_logic(session, payload)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤ –ë–î –ø–æ—è–≤–∏–ª–∞—Å—å –∑–∞–ø–∏—Å—å –æ–± –æ–ø—Ä–æ—Å–µ
    survey_record = (await session.execute(select(Survey).where(Survey.user_id == user.id))).scalar_one()
    assert survey_record.passed is True
    assert "–ü—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏–π –Ω–µ –≤—ã—è–≤–ª–µ–Ω–æ" in survey_record.verdict_text
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ —Å–æ–∑–¥–∞–ª—Å—è –º–µ–¥–æ—Ç–≤–æ–¥
    waiver = (await session.execute(select(MedicalWaiver))).scalar_one_or_none()
    assert waiver is None
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –≤–µ—Ä–Ω—É–ª–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    assert chat_id == user.telegram_id
    assert "–ü—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ" in text
    assert "–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –¥–ª—è –∑–∞–ø–∏—Å–∏ —Å–µ–π—á–∞—Å –Ω–µ—Ç" in text # —Ç.–∫. –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –º—ã –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª–∏
    assert markup is None # –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –Ω–µ—Ç, —Ç.–∫. –Ω–µ—Ç –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π

async def test_api_submit_survey_temp_waiver(session: AsyncSession):
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–π –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –æ—Ç–≤–æ–¥–∞: submit_survey_logic –¥–æ–ª–∂–Ω–∞ —Å–æ–∑–¥–∞—Ç—å –º–µ–¥–æ—Ç–≤–æ–¥."""
    user = await create_test_user(session)
    answers_dict = default_answers.copy()
    answers_dict["symptoms"] = "yes"
    answers = SurveyAnswers(**answers_dict)
    payload = SurveyPayload(survey_data=answers, auth_string="valid_auth_string")

    with pytest.MonkeyPatch.context() as m:
        m.setattr("main.validate_telegram_data", lambda auth_data: {'id': user.telegram_id})
        chat_id, text, markup = await submit_survey_logic(session, payload)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–∑–¥–∞–ª—Å—è –º–µ–¥–æ—Ç–≤–æ–¥ –Ω–∞ 14 –¥–Ω–µ–π
    waiver = (await session.execute(select(MedicalWaiver))).scalar_one()
    expected_end_date = datetime.date.today() + datetime.timedelta(days=14)
    assert waiver is not None
    assert waiver.user_id == user.id
    assert waiver.end_date == expected_end_date
    assert "–°–∏–º–ø—Ç–æ–º—ã –û–†–í–ò" in waiver.reason
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–≤—Ä–∞—â–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    assert chat_id == user.telegram_id
    # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1 ---
    assert "–≤—ã—è–≤–ª–µ–Ω–æ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏–µ" in text
    assert expected_end_date.strftime('%d.%m.%Y') in text

async def test_api_submit_survey_perm_waiver_is_now_temp(session: AsyncSession):
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –æ—Ç–≤–æ–¥ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω—ã–π –Ω–∞ 1000 –ª–µ—Ç."""
    user = await create_test_user(session)
    answers_dict = default_answers.copy()
    answers_dict["diseases_absolute"] = "yes"
    answers = SurveyAnswers(**answers_dict)
    payload = SurveyPayload(survey_data=answers, auth_string="valid_auth_string")

    with pytest.MonkeyPatch.context() as m:
        m.setattr("main.validate_telegram_data", lambda auth_data: {'id': user.telegram_id})
        chat_id, text, markup = await submit_survey_logic(session, payload)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ù–ï —Å–æ–∑–¥–∞–ª–∞—Å—å –∑–∞–ø–∏—Å—å –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ
    block_record = (await session.execute(select(UserBlock).where(UserBlock.user_id == user.id))).scalar_one_or_none()      
    assert block_record is None

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
    await session.refresh(user)
    assert user.is_blocked is False

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–∑–¥–∞–ª—Å—è –º–µ–¥–æ—Ç–≤–æ–¥ –Ω–∞ 365000 –¥–Ω–µ–π
    waiver = (await session.execute(select(MedicalWaiver))).scalar_one()
    expected_end_date = datetime.date.today() + datetime.timedelta(days=365000)
    assert waiver is not None
    assert waiver.reason == "–ê–±—Å–æ–ª—é—Ç–Ω–æ–µ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏–µ (—Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ/–∏–Ω—Ñ–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è)."
    assert waiver.end_date == expected_end_date

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–≤—Ä–∞—â–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2 ---
    assert "—É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –≤–∞–º –º–µ–¥–æ—Ç–≤–æ–¥" in text
    assert expected_end_date.strftime('%d.%m.%Y') in text

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: tests/test_survey_logic.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: tests/test_utils.py ---

import pytest
import datetime
from unittest.mock import AsyncMock, Mock, patch

import datetime
from sqlalchemy import select 
from aiogram import Bot

from bot.utils.qr_service import create_secure_payload, verify_secure_payload
from bot.utils.scheduler import check_waiver_expirations
from bot.db.models import User, Event, EventRegistration, MedicalWaiver


# --- –¢–µ—Å—Ç—ã QR-–∫–æ–¥–æ–≤ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
def test_qr_payload_creation_and_verification():
    original_data = {"user_id": 12345, "event_id": 678}
    payload = create_secure_payload(original_data)
    verified_data = verify_secure_payload(payload)
    assert isinstance(payload, str)
    assert verified_data is not None
    assert verified_data == original_data

def test_qr_verification_failure_with_bad_hash():
    original_data = {"user_id": 999}
    payload = create_secure_payload(original_data)
    tampered_payload = payload[:-5] + "abcde"
    verified_data = verify_secure_payload(tampered_payload)
    assert verified_data is None

def test_qr_verification_failure_with_bad_format():
    bad_payload = "this_is_not_a_valid_payload"
    verified_data = verify_secure_payload(bad_payload)
    assert verified_data is None


@pytest.mark.asyncio
async def test_check_waiver_expirations(mocker, session_pool): # <-- –£–±–∏—Ä–∞–µ–º —Ñ–∏–∫—Å—Ç—É—Ä—É session
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –º–µ–¥–æ—Ç–≤–æ–¥–æ–≤."""
    
    fixed_today = datetime.date(2024, 5, 20)
    
    # –ú–æ–∫–∏—Ä—É–µ–º `datetime.date` –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ
    with patch('bot.utils.scheduler.datetime.date') as mock_date:
        
        mock_date.today.return_value = fixed_today
        yesterday_in_test = fixed_today - datetime.timedelta(days=1)
    
        # --- –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤–Ω—É—Ç—Ä–∏ –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏, –∫–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞–ª–∞ –±—ã —Ä–µ–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è ---
        async with session_pool() as session:
            user_expired = User(phone_number="+7771", telegram_id=7771, full_name="Expired", university="TestUni")
            user_active = User(phone_number="+7772", telegram_id=7772, full_name="Active", university="TestUni")
            session.add_all([user_expired, user_active])
            await session.flush()
    
            waiver_expired = MedicalWaiver(
                user_id=user_expired.id, 
                start_date=yesterday_in_test - datetime.timedelta(days=30),
                end_date=yesterday_in_test,
                reason="test", created_by="system"
            )
            waiver_active = MedicalWaiver(
                user_id=user_active.id,
                start_date=fixed_today - datetime.timedelta(days=10),
                end_date=fixed_today,
                reason="test", created_by="system"
            )
            session.add_all([waiver_expired, waiver_active])
            await session.commit() # –ó–¥–µ—Å—å –∫–æ–º–º–∏—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º, —á—Ç–æ–±—ã –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π —Å–µ—Å—Å–∏–∏

        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–æ–∫–∏ –¥–ª—è –≤—ã–∑–æ–≤–∞
        mock_send_message = mocker.patch('aiogram.Bot.send_message', new_callable=AsyncMock)
        mock_bot = Mock(spec=Bot)
        mock_bot.send_message = mock_send_message

        # –í—ã–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–∏—Ä—É–µ–º—É—é —Ñ—É–Ω–∫—Ü–∏—é
        await check_waiver_expirations(mock_bot, session_pool)
    
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        mock_send_message.assert_called_once()
        call_args = mock_send_message.call_args
        assert call_args.kwargs['chat_id'] == 7771
        
        expected_phrase = "—Å—Ä–æ–∫ –≤–∞—à–µ–≥–æ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –æ—Ç–≤–æ–¥–∞ –∏—Å—Ç–µ–∫"
        actual_text = call_args.kwargs['text']
        assert expected_phrase.lower() in actual_text.lower()

        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –≤ –ë–î –≤—Å–µ —á–∏—Å—Ç–æ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç–µ—Å—Ç–∞
        async with session_pool() as session:
            res = await session.execute(select(User))
            assert len(res.scalars().all()) > 0 # –î–∞–Ω–Ω—ã–µ –µ—Å—Ç—å
    # –ü–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –∏–∑ async with —Ñ–∏–∫—Å—Ç—É—Ä–∞ session –≤ conftest.py –æ—á–∏—Å—Ç–∏—Ç –¥–∞–Ω–Ω—ã–µ

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: tests/test_utils.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: tests/test_volunteer_fsm.py ---

import pytest
import datetime
from unittest.mock import AsyncMock, Mock

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select 
from aiogram import Bot

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–æ–¥–µ–ª–∏ –∏ –∑–∞–ø—Ä–æ—Å—ã
from bot.db.models import User, Event, EventRegistration, Donation, MedicalWaiver
from bot.db import event_requests

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ —Ö–µ–Ω–¥–ª–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥–µ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
from bot.states.states import VolunteerActions
from bot.handlers.volunteer import (
    start_qr_confirmation, 
    process_qr_photo, 
    process_donation_confirmation,
    process_qr_invalid_input
)
from bot.utils.text_messages import Text

# –ü–æ–º–µ—á–∞–µ–º –≤—Å–µ —Ç–µ—Å—Ç—ã –∫–∞–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ
pytestmark = pytest.mark.asyncio

# --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã-–∑–∞–≥–ª—É—à–∫–∏ (Mocks) ---

class MockMessage:
    """–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è –æ–±—ä–µ–∫—Ç–∞ Message."""
    def __init__(self, text=None, from_user_id=1, photo=None):
        self.text = text
        self.from_user = Mock(id=from_user_id)
        # –ò–º–∏—Ç–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É F.photo (—Å–ø–∏—Å–æ–∫ —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º —ç–ª–µ–º–µ–Ω—Ç–æ–º –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞)
        self.photo = [Mock(file_id="photo_file_id_123")] if photo else None
        self.answer = AsyncMock()
        self.edit_text = AsyncMock()

class MockCallbackQuery:
    """–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è –æ–±—ä–µ–∫—Ç–∞ CallbackQuery."""
    def __init__(self, data, from_user_id=1, message=None):
        self.data = data
        self.from_user = Mock(id=from_user_id)
        self.message = message if message else MockMessage(from_user_id=from_user_id)
        self.answer = AsyncMock()

class MockFSMContext:
    """–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è FSMContext."""
    def __init__(self):
        self._state = None
        self._data = {}
    async def get_state(self): return self._state
    async def set_state(self, state): self._state = state
    async def get_data(self): return self._data.copy()
    async def update_data(self, **kwargs): self._data.update(kwargs)
    async def clear(self):
        self._state = None
        self._data = {}

# --- –§–∏–∫—Å—Ç—É—Ä—ã –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î ---

@pytest.fixture
async def volunteer_user(session: AsyncSession) -> User:
    user = User(
        phone_number="+7-volunteer", telegram_id=1001, full_name="–í–æ–ª–æ–Ω—Ç–µ—Ä –¢–µ—Å—Ç–æ–≤", 
        role="volunteer", university="TestUni"
    )
    session.add(user)
    await session.commit()
    return user

@pytest.fixture
async def donor_user(session: AsyncSession) -> User:
    user = User(
        phone_number="+7-donor", telegram_id=2002, full_name="–î–æ–Ω–æ—Ä –¢–µ—Å—Ç–æ–≤", 
        role="student", university="TestUni", gender="male", points=0
    )
    session.add(user)
    await session.commit()
    return user

@pytest.fixture
async def today_event(session: AsyncSession) -> Event:
    event = Event(
        name="–°–µ–≥–æ–¥–Ω—è—à–Ω–µ–µ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ", 
        event_datetime=datetime.datetime.now(), 
        location="–¢–µ—Å—Ç–æ–≤–∞—è –ª–æ–∫–∞—Ü–∏—è", donation_type="whole_blood", 
        points_per_donation=50, participant_limit=10
    )
    session.add(event)
    await session.commit()
    return event

@pytest.fixture
async def future_event(session: AsyncSession) -> Event:
    event = Event(
        name="–ë—É–¥—É—â–µ–µ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ", 
        event_datetime=datetime.datetime.now() + datetime.timedelta(days=5), 
        location="–î—Ä—É–≥–∞—è –ª–æ–∫–∞—Ü–∏—è", donation_type="plasma", 
        points_per_donation=20, participant_limit=5
    )
    session.add(event)
    await session.commit()
    return event

@pytest.fixture
async def registration(session: AsyncSession, donor_user: User, today_event: Event) -> EventRegistration:
    """–°–æ–∑–¥–∞–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –¥–æ–Ω–æ—Ä–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ."""
    reg = EventRegistration(user_id=donor_user.id, event_id=today_event.id)
    session.add(reg)
    await session.commit()
    return reg



async def test_volunteer_fsm_happy_path(
    session: AsyncSession, mocker, volunteer_user: User, donor_user: User, today_event: Event, registration: EventRegistration
):
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π —É—Å–ø–µ—à–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: –æ—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR –¥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–æ–Ω–∞—Ü–∏–∏.
    """
    state = MockFSMContext()
    
    # –ú–æ–∫–∞–µ–º Bot –∏ –µ–≥–æ –º–µ—Ç–æ–¥ download, —Ç.–∫. –º—ã –Ω–µ –±—É–¥–µ–º —Ä–µ–∞–ª—å–Ω–æ —Å–∫–∞—á–∏–≤–∞—Ç—å —Ñ–∞–π–ª
    mock_bot = Mock(spec=Bot)
    mock_bot.download.return_value = AsyncMock(read=AsyncMock(return_value=b'fake_photo_bytes'))

    # –ú–æ–∫–∞–µ–º `read_qr`, —á—Ç–æ–±—ã –æ–Ω –≤–æ–∑–≤—Ä–∞—â–∞–ª –Ω—É–∂–Ω—ã–µ –Ω–∞–º –¥–∞–Ω–Ω—ã–µ –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ QR
    qr_data = {"user_id": donor_user.telegram_id, "event_id": today_event.id}
    mocker.patch('bot.handlers.volunteer.read_qr', new_callable=AsyncMock, return_value=qr_data)
    
    # 2. ACT & ASSERT (–î–µ–π—Å—Ç–≤–∏–µ –∏ –ü—Ä–æ–≤–µ—Ä–∫–∞)
    
    # --- –®–∞–≥ 1: –í–æ–ª–æ–Ω—Ç–µ—Ä –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å ---
    callback_start = MockCallbackQuery(data="confirm_donation_qr", from_user_id=volunteer_user.telegram_id)
    await start_qr_confirmation(callback_start, state)
    
    assert await state.get_state() == VolunteerActions.awaiting_qr_photo
    callback_start.message.edit_text.assert_called_once_with(Text.VOLUNTEER_SEND_QR_PROMPT)

    # --- –®–∞–≥ 2: –í–æ–ª–æ–Ω—Ç–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ —Å QR ---
    message_photo = MockMessage(from_user_id=volunteer_user.telegram_id, photo=True)
    await process_qr_photo(message_photo, state, session, mock_bot)

    assert await state.get_state() == VolunteerActions.awaiting_confirmation
    message_photo.answer.assert_called_once()
    
    # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ ---
    # –ü–æ–ª—É—á–∞–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã –≤—ã–∑–æ–≤–∞ mock'–∞
    args, kwargs = message_photo.answer.call_args
    # –¢–µ–∫—Å—Ç –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∫–∞–∫ –ø–µ—Ä–≤—ã–π –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç
    sent_text = args[0] 
    
    assert donor_user.full_name in sent_text
    assert today_event.name in sent_text
    assert kwargs['parse_mode'] == "HTML"
    
    # --- –®–∞–≥ 3: –í–æ–ª–æ–Ω—Ç–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –¥–æ–Ω–∞—Ü–∏—é ---
    callback_confirm = MockCallbackQuery(
        data=f"confirm_donation_{donor_user.id}_{today_event.id}",
        from_user_id=volunteer_user.telegram_id
    )
    await process_donation_confirmation(callback_confirm, state, session, mock_bot)
    
    assert await state.get_state() is None # –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å—Å—è
    callback_confirm.message.edit_text.assert_called_with(
        Text.DONATION_CONFIRM_SUCCESS.format(
            donor_name=donor_user.full_name,
            event_name=today_event.name,
            points=today_event.points_per_donation
        ),
        reply_markup=mocker.ANY, # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –±—ã–ª–∞, –Ω–µ –≤–∞–∂–µ–Ω –µ–µ —Ç–∏–ø
        parse_mode="HTML"
    )

    # --- –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ë–î ---
    await session.refresh(donor_user)
    await session.refresh(registration)
    
    assert donor_user.points == today_event.points_per_donation
    
    # –¢–µ–ø–µ—Ä—å —ç—Ç–æ—Ç –∫–æ–¥ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, —Ç–∞–∫ –∫–∞–∫ select –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω
    donation_record_query = await session.execute(
        select(Donation).where(
            Donation.user_id == donor_user.id,
            Donation.event_id == today_event.id
        )
    )
    donation_record = donation_record_query.scalar_one_or_none()
    
    waiver_record_query = await session.execute(
        select(MedicalWaiver).where(MedicalWaiver.user_id == donor_user.id)
    )
    waiver_record = waiver_record_query.scalar_one_or_none()

    assert donation_record is not None
    assert donation_record.user_id == donor_user.id
    
    assert waiver_record is not None
    assert waiver_record.user_id == donor_user.id

# --- –¢–µ—Å—Ç—ã "–Ω–µ—Å—á–∞—Å—Ç–ª–∏–≤—ã—Ö" –ø—É—Ç–µ–π ---

async def test_volunteer_fsm_invalid_input(volunteer_user: User):
    """–¢–µ—Å—Ç: –≤–æ–ª–æ–Ω—Ç–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –≤–º–µ—Å—Ç–æ —Ñ–æ—Ç–æ."""
    message = MockMessage(text="—ç—Ç–æ –Ω–µ —Ñ–æ—Ç–æ", from_user_id=volunteer_user.telegram_id)
    await process_qr_invalid_input(message)
    message.answer.assert_called_once_with(Text.VOLUNTEER_INVALID_INPUT_QR)


async def test_volunteer_fsm_qr_read_fails(mocker, session, volunteer_user: User):
    """–¢–µ—Å—Ç: QR-–∫–æ–¥ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω."""
    state = MockFSMContext()
    mocker.patch('bot.handlers.volunteer.read_qr', new_callable=AsyncMock, return_value=None)
    mock_bot = Mock(spec=Bot)
    mock_bot.download.return_value = AsyncMock(read=AsyncMock(return_value=b''))

    message_photo = MockMessage(from_user_id=volunteer_user.telegram_id, photo=True)
    await process_qr_photo(message_photo, state, session, mock_bot)

    assert await state.get_state() is None # –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
    message_photo.answer.assert_called_once_with(Text.QR_READ_ERROR)


async def test_volunteer_fsm_donor_not_registered(mocker, session, volunteer_user, donor_user, today_event):
    """–¢–µ—Å—Ç: –î–æ–Ω–æ—Ä –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ —ç—Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ."""
    # –í–∞–∂–Ω–æ: —Ñ–∏–∫—Å—Ç—É—Ä–∞ 'registration' –∑–¥–µ—Å—å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, —Ç.–µ. –∑–∞–ø–∏—Å–∏ –≤ –ë–î –Ω–µ—Ç
    state = MockFSMContext()
    qr_data = {"user_id": donor_user.telegram_id, "event_id": today_event.id}
    mocker.patch('bot.handlers.volunteer.read_qr', new_callable=AsyncMock, return_value=qr_data)
    mock_bot = Mock(spec=Bot)
    mock_bot.download.return_value = AsyncMock(read=AsyncMock(return_value=b''))

    message_photo = MockMessage(from_user_id=volunteer_user.telegram_id, photo=True)
    await process_qr_photo(message_photo, state, session, mock_bot)

    assert await state.get_state() is None
    message_photo.answer.assert_called_once_with(
        Text.QR_DONOR_NOT_REGISTERED_ERROR.format(donor_name=donor_user.full_name),
        parse_mode="HTML"
    )

async def test_volunteer_fsm_wrong_day(mocker, session, volunteer_user, donor_user, future_event):
    """–¢–µ—Å—Ç: QR-–∫–æ–¥ –æ—Ç –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –Ω–µ —Å–µ–≥–æ–¥–Ω—è."""
    state = MockFSMContext()
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –¥–æ–Ω–æ—Ä–∞ –Ω–∞ –ë–£–î–£–©–ï–ï –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
    reg = EventRegistration(user_id=donor_user.id, event_id=future_event.id)
    session.add(reg)
    await session.commit()

    qr_data = {"user_id": donor_user.telegram_id, "event_id": future_event.id}
    mocker.patch('bot.handlers.volunteer.read_qr', new_callable=AsyncMock, return_value=qr_data)
    mock_bot = Mock(spec=Bot)
    mock_bot.download.return_value = AsyncMock(read=AsyncMock(return_value=b''))

    message_photo = MockMessage(from_user_id=volunteer_user.telegram_id, photo=True)
    await process_qr_photo(message_photo, state, session, mock_bot)

    assert await state.get_state() is None
    message_photo.answer.assert_called_once_with(Text.QR_WRONG_DAY_ERROR)

--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: tests/test_volunteer_fsm.py ---

--- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê: tests/__init__.py ---



--- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê: tests/__init__.py ---

    –í–Ω–µ–¥—Ä–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–∫—Ä—ã—Ç–∏—è (Coverage):

        –ü—Ä–æ–±–ª–µ–º–∞: –°–µ–π—á–∞—Å –æ—Ü–µ–Ω–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è ‚Äî —ç—Ç–æ —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–µ –º–Ω–µ–Ω–∏–µ. –í—ã –Ω–µ –∑–Ω–∞–µ—Ç–µ —Ç–æ—á–Ω–æ, –∫–∞–∫–∏–µ —Å—Ç—Ä–æ–∫–∏ –∏–ª–∏ –≤–µ—Ç–∫–∏ –∫–æ–¥–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–æ–≤.

        –†–µ—à–µ–Ω–∏–µ: –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π—Ç–µ pytest-cov. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç—ã –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ –∏ –≤–∏–¥–µ—Ç—å "—Å–ª–µ–ø—ã–µ –∑–æ–Ω—ã".

            –£—Å—Ç–∞–Ω–æ–≤–∫–∞: pip install pytest-cov

            –ó–∞–ø—É—Å–∫: pytest --cov=bot

        –ü–æ–ª—å–∑–∞: –í—ã —Å—Ä–∞–∑—É —É–≤–∏–¥–∏—Ç–µ, –∫–∞–∫–∏–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã, —É—Å–ª–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã (if/else) –∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –≤–æ–æ–±—â–µ –Ω–µ —Ç–µ—Å—Ç–∏—Ä—É—é—Ç—Å—è.

    –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ "–Ω–µ—Å—á–∞—Å—Ç–Ω—ã—Ö –ø—É—Ç–µ–π" (Unhappy Paths) –≤ FSM:

        –ü—Ä–æ–±–ª–µ–º–∞: –í–∞—à–∏ —Ç–µ—Å—Ç—ã FSM –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø—Ä–æ–≤–µ—Ä—è—é—Ç, —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.

        –†–µ—à–µ–Ω–∏–µ: –î–æ–±–∞–≤—å—Ç–µ —Ç–µ—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –Ω–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–≤–æ–¥.

            –ß—Ç–æ –µ—Å–ª–∏ –≤ FSM —Å–æ–∑–¥–∞–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –≤–º–µ—Å—Ç–æ –¥–∞—Ç—ã –î–î.–ú–ú.–ì–ì–ì–ì –ß–ß:–ú–ú –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–¥–µ—Ç "–∑–∞–≤—Ç—Ä–∞"?

            –ß—Ç–æ –µ—Å–ª–∏ –≤ FSM —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –≤–º–µ—Å—Ç–æ —Ü–µ–Ω—ã –≤ –±–∞–ª–ª–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–¥–µ—Ç "—Å—Ç–æ"?

            –ß—Ç–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–º–µ—Ç –∫–Ω–æ–ø–∫—É /cancel –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –ø—Ä–æ—Ü–µ—Å—Å–∞?

        –ü–æ–ª—å–∑–∞: –≠—Ç–æ —Å–¥–µ–ª–∞–µ—Ç –±–æ—Ç–∞ –±–æ–ª–µ–µ —É—Å—Ç–æ–π—á–∏–≤—ã–º –∫ –æ—à–∏–±–∫–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é.

    –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API-—Å–ª–æ—è (FastAPI –≤ main.py):

        –ü—Ä–æ–±–ª–µ–º–∞: –õ–æ–≥–∏–∫–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ submit_survey –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞, –Ω–æ —Å–∞–º HTTP-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚Äî –Ω–µ—Ç.

        –†–µ—à–µ–Ω–∏–µ: –î–æ–±–∞–≤—å—Ç–µ —Ç–µ—Å—Ç—ã –¥–ª—è FastAPI —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º httpx –∏ AsyncClient.

            –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç /api/submit_survey, –æ—Ç–ø—Ä–∞–≤–ª—è—è –Ω–∞ –Ω–µ–≥–æ —Ä–µ–∞–ª—å–Ω—ã–µ HTTP POST-–∑–∞–ø—Ä–æ—Å—ã —Å —Ä–∞–∑–Ω—ã–º–∏ —Ç–µ–ª–∞–º–∏ (–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º, –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º JSON, –±–µ–∑ auth_string).

            –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ HTTP-—Å—Ç–∞—Ç—É—Å—ã (200, 400, 403, 404).

            –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –¥–ª—è —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ /health.

        –ü–æ–ª—å–∑–∞: –í—ã –±—É–¥–µ—Ç–µ —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ –Ω–µ —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ª–æ–≥–∏–∫–∞, –Ω–æ –∏ —Å–∞–º –≤–µ–±-—Å–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ.

    –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–∞/—ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö:

        –ü—Ä–æ–±–ª–µ–º–∞: –í bot/utils/data_import.py –∏ bot/handlers/admin/system.py –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞—è, –Ω–æ –Ω–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞.

        –†–µ—à–µ–Ω–∏–µ: –°–æ–∑–¥–∞–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª tests/test_data_io.py.

            –î–ª—è –∏–º–ø–æ—Ä—Ç–∞: –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∞–ª–µ–Ω—å–∫–∏—Ö .xlsx —Ñ–∞–π–ª–æ–≤ (–≤–∞–ª–∏–¥–Ω—ã–π, —Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏, —Å "–≥—Ä—è–∑–Ω—ã–º–∏" –¥–∞–Ω–Ω—ã–º–∏) –∏ —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é import_data_from_file, –ø—Ä–æ–≤–µ—Ä—è—è, –∫–∞–∫ –æ–Ω–∞ –º–µ–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ë–î.

            –î–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞: –ù–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –ë–î –¥–∞–Ω–Ω—ã–º–∏, –≤—ã–∑–æ–≤–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é create_full_backup_xlsx –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π .xlsx —Ñ–∞–π–ª –º–æ–∂–Ω–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å –ø–æ–º–æ—â—å—é pandas) –∏ —á—Ç–æ –æ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–∂–∏–¥–∞–µ–º—ã–µ –ª–∏—Å—Ç—ã –∏ –¥–∞–Ω–Ω—ã–µ.

        –ü–æ–ª—å–∑–∞: –ó–∞—â–∏—Ç–∏—Ç –æ—Ç –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å —Ñ–∞–π–ª–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø–æ–≤—Ä–µ–¥–∏—Ç—å –≤—Å—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.

    –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ (scheduler):

        –ü—Ä–æ–±–ª–µ–º–∞: –õ–æ–≥–∏–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–∑—ã–≤–∞–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫, –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ (test_scheduler_logic.py), –Ω–æ —Å–∞–º–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (setup_scheduler) ‚Äî –Ω–µ—Ç.

        –†–µ—à–µ–Ω–∏–µ: –≠—Ç–æ –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è –∑–∞–¥–∞—á–∞. –ú–æ–∂–Ω–æ —Å –ø–æ–º–æ—â—å—é mocker "–∑–∞–º–æ–∫–∞—Ç—å" AsyncIOScheduler –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –º–µ—Ç–æ–¥ add_job –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏ (cron, hour, minute).

        –ü–æ–ª—å–∑–∞: –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Ç–æ–º, —á—Ç–æ —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –±—É–¥—É—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –∏–º–µ–Ω–Ω–æ —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ –≤—ã —ç—Ç–æ–≥–æ –æ–∂–∏–¥–∞–µ—Ç–µ.